<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifier un rendu d'intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card {
      border: 2px solid #e5e7eb; border-radius: 12px; background: #fff;
      transition: all 0.3s ease; cursor: pointer; overflow: hidden; height: 100%;
      display: flex; flex-direction: column;
    }
    .attachment-card:hover { border-color:#3b82f6; box-shadow:0 8px 24px rgba(59,130,246,0.15); transform: translateY(-2px); }
    .attachment-preview { width:100%; height:200px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; }
    .attachment-preview img { width:100%; height:100%; object-fit:cover; }
    .attachment-preview.doc-preview { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; font-size:3rem; }
    .attachment-info { padding:16px; flex:1; display:flex; flex-direction:column; }
    .attachment-comment { font-size:0.875rem; color:#374151; margin-bottom:8px; flex:1; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient: vertical; }
    .attachment-meta { font-size:0.75rem; color:#6b7280; display:flex; align-items:center; gap:8px; }
    .badge-source { font-size:0.7rem; padding:4px 8px; }
    .add-card { border:2px dashed #cbd5e1; border-radius:12px; background:#f8fafc; display:flex; align-items:center; justify-content:center; min-height:300px; cursor:pointer; transition:all 0.3s ease; }
    .add-card:hover { border-color:#3b82f6; background:#eff6ff; }
    .add-card-content { text-align:center; color:#64748b; }
    .add-card-content i { font-size:3rem; margin-bottom:12px; }
    @media print { .no-print{display:none!important;} body{background:#fff;} .attachment-card{page-break-inside:avoid;} }
  </style>
</head>
<body>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="h4 mb-0"><i class="bi bi-file-text me-2"></i>Modifier un rendu d'intervention</h1>
      <div class="d-flex gap-2 no-print">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <form id="rendu-edit-form" novalidate>
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Résumé détaillé (Markdown)</h5>
              <small class="text-muted">Markdown autorisé</small>
            </div>
            <div class="row g-3">
              <div class="col-lg-6">
                <textarea class="form-control" id="resume" rows="10" placeholder="Saisissez le résumé en Markdown..."></textarea>
              </div>
              <div class="col-lg-6">
                <div class="border rounded p-3 bg-light" style="min-height: 240px;" id="resume-preview">
                  <em class="text-muted">Le résumé apparaîtra ici...</em>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-4" id="attachments-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes</h5>
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary" id="attachments-count">0 pièce(s)</span>
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-file-btn">
                  <i class="bi bi-plus-circle me-1"></i> Ajouter un fichier
                </button>
                <input type="file" id="add-file-input" class="d-none">
              </div>
            </div>
            <p class="text-muted small mb-3">Cliquez sur une carte pour ouvrir la pièce jointe. Ajoutez de nouveaux fichiers via le bouton + (redirigé vers l’éditeur avancé).</p>
            <div class="row g-2 align-items-center mb-3">
              <div class="col-md-4">
                <input type="text" class="form-control form-control-sm" id="filter-search" placeholder="Rechercher (nom, commentaire)...">
              </div>
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filter-source">
                  <option value="">Toutes les sources</option>
                  <option value="Ticket">Ticket</option>
                  <option value="Site">Site</option>
                  <option value="DemandeClient">Demande client</option>
                  <option value="Message">Pièces jointes des messages</option>
                  <option value="Intervention">Intervention</option>
                  <option value="Upload">Upload/Nouveau</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filter-kind">
                  <option value="">Images + Docs</option>
                  <option value="image">Images</option>
                  <option value="doc">Documents</option>
                </select>
              </div>
            </div>
            <div class="row g-3" id="attachments-grid"></div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="save-rendu-btn"><i class="bi bi-save me-2"></i>Enregistrer</button>
            <a href="intervention-view.html" class="btn btn-secondary" id="cancel-button">Annuler</a>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Modal édition pièce jointe -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-paperclip me-2"></i>Modifier la pièce jointe</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Titre / Nom du fichier</label>
            <input type="text" class="form-control" id="att-title-input" placeholder="Titre de la pièce jointe">
          </div>
          <div class="mb-3">
            <label class="form-label">Commentaire</label>
            <textarea class="form-control" id="att-comment-input" rows="3" placeholder="Commentaire sur la pièce jointe"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Remplacer le fichier</label>
            <input type="file" class="form-control" id="att-file-input">
            <small class="text-muted">Le remplacement est uploadé immédiatement.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger me-auto" id="delete-att-btn"><i class="bi bi-trash"></i> Supprimer</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="save-att-btn"><i class="bi bi-check"></i> Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(location.search);
      const renduId = params.get('id');
      const token = localStorage.getItem('token');
      if (!token) { alert('Session expirée'); return location.href='/login.html'; }
      if (!renduId) { alert('ID du rendu manquant'); return location.href='/interventions.html'; }

      const headers = { 'Authorization': 'Bearer '+token, 'Content-Type': 'application/json' };
      const form = document.getElementById('rendu-edit-form');
      const resumeInput = document.getElementById('resume');
      const resumePreview = document.getElementById('resume-preview');
      const attachmentsGrid = document.getElementById('attachments-grid');
      const countBadge = document.getElementById('attachments-count');
      const filterSearch = document.getElementById('filter-search');
      const filterSource = document.getElementById('filter-source');
      const filterKind = document.getElementById('filter-kind');
      const cancelBtn = document.getElementById('cancel-button');
      const backBtn = document.getElementById('back-btn');
      const addFileBtn = document.getElementById('add-file-btn');
      const addFileInput = document.getElementById('add-file-input');
      const attModalEl = document.getElementById('attachmentModal');
      const attModal = attModalEl ? new bootstrap.Modal(attModalEl) : null;
      const attTitleInput = document.getElementById('att-title-input');
      const attCommentInput = document.getElementById('att-comment-input');
      const attFileInput = document.getElementById('att-file-input');
      const saveAttBtn = document.getElementById('save-att-btn');
      const deleteAttBtn = document.getElementById('delete-att-btn');

      let interventionId = null;
      let attachments = [];
      let currentEditIndex = null;
      let mainResumeEditor = null;

      // Vérifie qu'un lien /view répond (pour nettoyer les entrées orphelines 404)
      const validateAttachments = async (list) => {
        const checks = await Promise.all(list.map(async (att) => {
          if (att.url && att.kind === 'doc') {
            try {
              const res = await fetch(att.url, { method: 'HEAD', headers });
              return res.ok;
            } catch (_) { return false; }
          }
          return true;
        }));
        return list.filter((_, idx) => checks[idx]);
      };

      // Éditeur markdown (résumé détaillé)
      if (typeof EasyMDE !== 'undefined') {
        mainResumeEditor = new EasyMDE({
          element: resumeInput,
          spellChecker: false,
          forceSync: true,
          placeholder: 'Rédigez un résumé détaillé en Markdown...',
          toolbar: ['bold','italic','heading','|','quote','unordered-list','ordered-list','|','link','preview'],
          status: false,
          minHeight: '180px'
        });
        mainResumeEditor.codemirror.on('change', () => {
          const txt = mainResumeEditor.value();
          resumePreview.innerHTML = txt ? marked.parse(txt) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        });
      } else {
        resumeInput.addEventListener('input', () => {
          const text = resumeInput.value;
          resumePreview.innerHTML = text ? marked.parse(text) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        });
      }

      const fetchJSON = async (url) => {
        const res = await fetch(url, { headers });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        return res.json();
      };

      const toBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      // Upload générique (image => /api/images, sinon /api/documents) en conservant titre/commentaire
      const uploadDocument = async (file, { titre = '', commentaire = '' } = {}) => {
        const isImage = file.type && file.type.startsWith('image/');
        const base64 = await toBase64(file);
        const payload = {
          base64,
          nom_fichier: file.name,
          type_mime: file.type || (isImage ? 'image/png' : 'application/octet-stream'),
          cible_type: 'RenduIntervention',
          cible_id: renduId
        };
        if (isImage) {
          payload.commentaire_image = commentaire || '';
          if (titre) payload.titre = titre;
        } else {
          payload.nature = commentaire || file.type || 'Document';
          if (titre) payload.titre = titre;
        }

        const endpoint = isImage ? '/api/images' : '/api/documents';
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...headers },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

        const created = {
          id: data.id,
          kind: isImage ? 'image' : 'doc',
          url: `${endpoint}/${data.id || ''}/view`,
          nom_fichier: file.name,
          titre: titre || file.name,
          commentaire_image: isImage ? (commentaire || '') : (commentaire || 'Document'),
          type: 'Upload',
          type_mime: payload.type_mime
        };
        attachments.push(created);
        refreshAttachments();
        return created;
      };

      if (saveAttBtn) {
        saveAttBtn.addEventListener('click', async () => {
          if (currentEditIndex === null) return;
          const att = attachments[currentEditIndex];
          if (!att) return;
          const newComment = attCommentInput ? attCommentInput.value : att.commentaire_image;
          const file = attFileInput && attFileInput.files && attFileInput.files[0];
          try {
          if (file) {
            // upload immédiat du nouveau fichier (image ou doc)
            const created = await uploadDocument(file, {
              titre: (attTitleInput?.value || file.name || 'Fichier'),
              commentaire: newComment || file.type || ''
            });
            // remplacer l'ancienne entrée par la nouvelle
            attachments.splice(currentEditIndex, 1, created);
            refreshAttachments();
          } else {
            attachments[currentEditIndex].commentaire_image = newComment;
            if (attTitleInput?.value) {
              attachments[currentEditIndex].titre = attTitleInput.value;
              attachments[currentEditIndex].nom_fichier = attTitleInput.value;
            }
            // Patch meta côté API si on dispose d'un id
            const target = attachments[currentEditIndex];
            if (target.id) {
              const endpoint = target.kind === 'image' ? '/api/images/' : '/api/documents/';
              try {
                await fetch(endpoint + target.id, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify(target.kind === 'image'
                    ? {
                        titre: target.titre || target.nom_fichier,
                        nom_fichier: target.nom_fichier,
                        commentaire_image: target.commentaire_image
                      }
                    : {
                        titre: target.titre || target.nom_fichier,
                        nom_fichier: target.nom_fichier,
                        nature: target.commentaire_image || target.nature || 'Document',
                        commentaire_image: target.commentaire_image
                      })
                });
              } catch (_) {
                // en cas d'échec, on garde les valeurs locales (affichage) mais l'API restera inchangée
              }
            }
          }
          refreshAttachments();
          if (attModal) attModal.hide();
        } catch (e) {
            console.error(e);
            alert(`Échec de l'ajout du fichier: ${e.message}`);
          } finally {
            if (attFileInput) attFileInput.value = '';
          }
        });
      }

      // Suppression d'une pièce jointe
      if (deleteAttBtn) {
        deleteAttBtn.addEventListener('click', async () => {
          if (currentEditIndex === null) return;
          const att = attachments[currentEditIndex];
          if (!att) return;
          if (!confirm('Supprimer cette pièce jointe ?')) return;
          try {
            if (att.id) {
              const endpoint = att.kind === 'image' ? '/api/images/' : '/api/documents/';
              await fetch(endpoint + att.id, { method: 'DELETE', headers });
            }
            attachments.splice(currentEditIndex, 1);
            refreshAttachments();
            attModal?.hide();
          } catch (err) {
            console.error(err);
            alert(`Échec de la suppression: ${err.message}`);
          }
        });
      }

      if (addFileBtn && addFileInput) {
        addFileBtn.addEventListener('click', () => addFileInput.click());
        addFileInput.addEventListener('change', async () => {
          const file = addFileInput.files && addFileInput.files[0];
          if (!file) return;
          try {
            await uploadDocument(file);
            alert('Fichier ajouté au rendu.');
          } catch (e) {
            console.error(e);
            alert(`Échec de l\'ajout du fichier: ${e.message}`);
          } finally {
            addFileInput.value = '';
          }
        });
      }

      const openEditModal = (idx) => {
        currentEditIndex = idx;
        const att = attachments[idx];
        if (!att || !attModal) return;
        if (attTitleInput) attTitleInput.value = att.titre || att.nom_fichier || '';
        if (attCommentInput) attCommentInput.value = att.commentaire_image || '';
        if (attFileInput) attFileInput.value = '';
        attModal.show();
      };

      const refreshAttachments = () => {
        if (!attachmentsGrid) return;
        attachmentsGrid.innerHTML = '';
        const term = (filterSearch?.value || '').toLowerCase();
        const src  = filterSource?.value || '';
        const kind = filterKind?.value || '';
        const filtered = attachments.filter(att => {
          const txt = `${att.titre||att.nom_fichier||''} ${att.commentaire_image||''}`.toLowerCase();
          const matchTerm = !term || txt.includes(term);
          const matchSrc  = !src || att.type === src;
          const matchKind = !kind || att.kind === kind;
          return matchTerm && matchSrc && matchKind;
        });

        filtered.forEach((att, idx) => {
          const col = document.createElement('div');
          col.className = 'col-12 col-sm-6 col-lg-4';
          const card = document.createElement('div');
          card.className = 'attachment-card';
          card.onclick = () => openEditModal(idx);
          const prev = document.createElement('div');
          prev.className = 'attachment-preview' + (att.kind === 'doc' ? ' doc-preview' : '');
          prev.innerHTML = att.kind === 'image'
            ? `<img src="${att.url}" alt="${att.nom_fichier || att.titre || ''}">`
            : '<i class="bi bi-file-earmark-text"></i>';
          const info = document.createElement('div');
          info.className = 'attachment-info';
          info.innerHTML = `
            <div class="fw-semibold">${att.titre || att.nom_fichier || 'Fichier'}</div>
            <div class="attachment-comment">${att.commentaire_image || 'Aucun commentaire'}</div>
            <div class="attachment-meta">
              <span class="badge badge-source bg-secondary">${att.type || 'Upload'}</span>
              <span><i class="bi bi-file-earmark"></i> ${att.nom_fichier || att.titre || 'Fichier'}</span>
            </div>`;
          card.append(prev, info);
          col.append(card);
          attachmentsGrid.append(col);
        });

          const addCol = document.createElement('div');
          addCol.className = 'col-12 col-sm-6 col-lg-4';
          const addCard = document.createElement('div');
          addCard.className = 'add-card';
          addCard.onclick = () => addFileInput && addFileInput.click();
          addCard.innerHTML = `
          <div class="add-card-content">
            <i class="bi bi-plus-circle"></i>
            <div class="fw-bold">Ajouter un fichier</div>
            <div class="small">Cliquez pour ajouter</div>
          </div>`;
          addCol.append(addCard);
          attachmentsGrid.append(addCol);
          countBadge.textContent = `${filtered.length} / ${attachments.length} pièce(s)`;
      };

      const loadData = async () => {
        const { rendu, images, documents, message_attachments } = await fetchJSON(`/api/rendus/${renduId}`);
        interventionId = rendu.intervention_id;
        if (mainResumeEditor) {
          mainResumeEditor.value(rendu.resume || '');
          resumePreview.innerHTML = rendu.resume ? marked.parse(rendu.resume) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        } else {
          resumeInput.value = rendu.resume || '';
          resumePreview.innerHTML = rendu.resume ? marked.parse(rendu.resume) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        }
        cancelBtn.href = `intervention-view.html?id=${interventionId}`;
        backBtn.onclick = () => location.href = `intervention-view.html?id=${interventionId}`;

        attachments = [];
        (images || []).forEach(img => attachments.push({
          id: img.id,
          kind: (img.type_mime && img.type_mime.startsWith('image/')) ? 'image' : 'image',
          url: `/api/images/${img.id}/view`,
          nom_fichier: img.nom_fichier,
          titre: img.titre || img.nom_fichier,
          commentaire_image: img.commentaire_image,
          type: 'Image',
          type_mime: img.type_mime || ''
        }));
        (documents || []).forEach(doc => attachments.push({
          id: doc.id,
          kind: (doc.type_mime && doc.type_mime.startsWith('image/')) ? 'image' : 'doc',
          url: `/api/documents/${doc.id}/view`,
          nom_fichier: doc.nom_fichier,
          titre: doc.titre || doc.nom_fichier,
          commentaire_image: doc.nature || 'Document',
          type: 'Document',
          type_mime: doc.type_mime || ''
        }));
        (message_attachments || []).forEach(att => {
          const kind = (att.file_type || '').startsWith('image/') ? 'image' : 'doc';
          attachments.push({
            id: att.id,
            kind,
            url: `/api/attachments/${att.id}/view`,
            nom_fichier: att.file_name,
            titre: att.titre || att.file_name,
            commentaire_image: `PJ message: ${(att.message || '').substring(0,50)}...`,
            type: 'Message',
            type_mime: att.file_type || ''
          });
        });
        attachments = await validateAttachments(attachments);
        refreshAttachments();
      };

      resumeInput.addEventListener('input', () => {
        const text = resumeInput.value;
        resumePreview.innerHTML = text ? marked.parse(text) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
      });
      if (filterSearch) filterSearch.addEventListener('input', refreshAttachments);
      if (filterSource) filterSource.addEventListener('change', refreshAttachments);
      if (filterKind) filterKind.addEventListener('change', refreshAttachments);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const resumeVal = mainResumeEditor ? mainResumeEditor.value() : (resumeInput.value || '');
        const payload = { resume: resumeVal };
        const trySave = async (method) => {
          const res = await fetch(`/api/rendus/${renduId}`, { method, headers, body: JSON.stringify(payload) });
          if (!res.ok) {
            const err = await res.json().catch(()=>({}));
            throw new Error(err.error || `HTTP ${res.status}`);
          }
        };
        try {
          try {
            await trySave('PATCH');
          } catch (_) {
            try {
              await trySave('PUT');
            } catch (_) {
              await trySave('POST');
            }
          }
          alert('Rendu mis à jour avec succès');
          if (interventionId) location.href = `intervention-view.html?id=${interventionId}`; else location.href='interventions.html';
        } catch (err) {
          alert(`Échec de la mise à jour: ${err.message}`);
        }
      });

      try { await loadData(); } catch (e) { console.error(e); alert(e.message); }
    });
  </script>
</body>
</html>
