<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifier un rendu d'intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card {
      border: 2px solid #e5e7eb; border-radius: 12px; background: #fff;
      transition: all 0.3s ease; cursor: pointer; overflow: hidden; height: 100%;
      display: flex; flex-direction: column;
    }
    .attachment-card:hover { border-color:#3b82f6; box-shadow:0 8px 24px rgba(59,130,246,0.15); transform: translateY(-2px); }
    .attachment-preview { width:100%; height:200px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; }
    .attachment-preview img { width:100%; height:100%; object-fit:cover; }
    .attachment-preview.doc-preview { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; font-size:3rem; }
    .attachment-info { padding:16px; flex:1; display:flex; flex-direction:column; }
    .attachment-comment { font-size:0.875rem; color:#374151; margin-bottom:8px; flex:1; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient: vertical; }
    .attachment-meta { font-size:0.75rem; color:#6b7280; display:flex; align-items:center; gap:8px; }
    .badge-source { font-size:0.7rem; padding:4px 8px; }
    .add-card { border:2px dashed #cbd5e1; border-radius:12px; background:#f8fafc; display:flex; align-items:center; justify-content:center; min-height:300px; cursor:pointer; transition:all 0.3s ease; }
    .add-card:hover { border-color:#3b82f6; background:#eff6ff; }
    .add-card-content { text-align:center; color:#64748b; }
    .add-card-content i { font-size:3rem; margin-bottom:12px; }
    @media print { .no-print{display:none!important;} body{background:#fff;} .attachment-card{page-break-inside:avoid;} }
  </style>
</head>
<body>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="h4 mb-0"><i class="bi bi-file-text me-2"></i>Modifier un rendu d'intervention</h1>
      <div class="d-flex gap-2 no-print">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Imprimer</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <form id="rendu-edit-form" novalidate>
          <div class="mb-4">
            <label class="form-label fw-bold">Valeur de l'intervention</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-currency-euro"></i></span>
              <input type="text" class="form-control" id="valeur" placeholder="Ex: 1500">
            </div>
          </div>

          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Résumé</h5>
              <small class="text-muted">Markdown autorisé</small>
            </div>
            <div class="row g-3">
              <div class="col-lg-6">
                <textarea class="form-control" id="resume" rows="10" placeholder="Saisissez le résumé en Markdown..."></textarea>
              </div>
              <div class="col-lg-6">
                <div class="border rounded p-3 bg-light" style="min-height: 240px;" id="resume-preview">
                  <em class="text-muted">Le résumé apparaîtra ici...</em>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-4" id="attachments-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes</h5>
              <span class="badge bg-primary" id="attachments-count">0 pièce(s)</span>
            </div>
            <p class="text-muted small mb-3">Cliquez sur une carte pour ouvrir la pièce jointe. Ajoutez de nouveaux fichiers via le bouton + (redirigé vers l’éditeur avancé).</p>
            <div class="row g-2 align-items-center mb-3">
              <div class="col-md-4">
                <input type="text" class="form-control form-control-sm" id="filter-search" placeholder="Rechercher (nom, commentaire, note)...">
              </div>
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filter-source">
                  <option value="">Toutes les sources</option>
                  <option value="Ticket">Ticket</option>
                  <option value="Site">Site</option>
                  <option value="DemandeClient">Demande client</option>
                  <option value="Message">Pièces jointes des messages</option>
                  <option value="Intervention">Intervention</option>
                  <option value="Upload">Upload/Nouveau</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filter-kind">
                  <option value="">Images + Docs</option>
                  <option value="image">Images</option>
                  <option value="doc">Documents</option>
                </select>
              </div>
            </div>
            <div class="row g-3" id="attachments-grid"></div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="save-rendu-btn"><i class="bi bi-save me-2"></i>Enregistrer</button>
            <a href="intervention-view.html" class="btn btn-secondary" id="cancel-button">Annuler</a>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(location.search);
      const renduId = params.get('id');
      const token = localStorage.getItem('token');
      if (!token) { alert('Session expirée'); return location.href='/login.html'; }
      if (!renduId) { alert('ID du rendu manquant'); return location.href='/interventions.html'; }

      const headers = { 'Authorization': 'Bearer '+token, 'Content-Type': 'application/json' };
      const form = document.getElementById('rendu-edit-form');
      const valeurInput = document.getElementById('valeur');
      const resumeInput = document.getElementById('resume');
      const resumePreview = document.getElementById('resume-preview');
      const attachmentsGrid = document.getElementById('attachments-grid');
      const countBadge = document.getElementById('attachments-count');
      const filterSearch = document.getElementById('filter-search');
      const filterSource = document.getElementById('filter-source');
      const filterKind = document.getElementById('filter-kind');
      const cancelBtn = document.getElementById('cancel-button');
      const backBtn = document.getElementById('back-btn');

      let interventionId = null;
      let attachments = [];

      const fetchJSON = async (url) => {
        const res = await fetch(url, { headers });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        return res.json();
      };

      const refreshAttachments = () => {
        if (!attachmentsGrid) return;
        attachmentsGrid.innerHTML = '';
        const term = (filterSearch?.value || '').toLowerCase();
        const src  = filterSource?.value || '';
        const kind = filterKind?.value || '';
        const filtered = attachments.filter(att => {
          const txt = `${att.nom_fichier||''} ${att.commentaire_image||''} ${att.note||''}`.toLowerCase();
          const matchTerm = !term || txt.includes(term);
          const matchSrc  = !src || att.type === src;
          const matchKind = !kind || att.kind === kind;
          return matchTerm && matchSrc && matchKind;
        });

        filtered.forEach(att => {
          const col = document.createElement('div');
          col.className = 'col-12 col-sm-6 col-lg-4';
          const card = document.createElement('div');
          card.className = 'attachment-card';
          card.onclick = () => window.open(att.url, '_blank');
          const prev = document.createElement('div');
          prev.className = 'attachment-preview' + (att.kind === 'doc' ? ' doc-preview' : '');
          prev.innerHTML = att.kind === 'image' ? `<img src="${att.url}" alt="${att.nom_fichier}">` : '<i class="bi bi-file-earmark-text"></i>';
          const info = document.createElement('div');
          info.className = 'attachment-info';
          info.innerHTML = `
            <div class="attachment-comment">${att.commentaire_image || 'Aucun commentaire'}</div>
            <div class="attachment-meta">
              <span class="badge badge-source bg-secondary">${att.type || 'Upload'}</span>
              <span><i class="bi bi-file-earmark"></i> ${att.nom_fichier || 'Fichier'}</span>
            </div>`;
          card.append(prev, info);
          col.append(card);
          attachmentsGrid.append(col);
        });

        const addCol = document.createElement('div');
        addCol.className = 'col-12 col-sm-6 col-lg-4';
        const addCard = document.createElement('div');
        addCard.className = 'add-card';
        addCard.onclick = () => {
          if (interventionId) location.href = `rendu-intervention-new.html?id=${interventionId}`;
        };
        addCard.innerHTML = `
          <div class="add-card-content">
            <i class="bi bi-plus-circle"></i>
            <div class="fw-bold">Ajouter un fichier</div>
            <div class="small">Ouvre l'éditeur avancé.</div>
          </div>`;
        addCol.append(addCard);
        attachmentsGrid.append(addCol);
        countBadge.textContent = `${filtered.length} / ${attachments.length} pièce(s)`;
      };

      const loadData = async () => {
        const { rendu, images, documents, message_attachments } = await fetchJSON(`/api/rendus/${renduId}`);
        interventionId = rendu.intervention_id;
        valeurInput.value = rendu.valeur || '';
        resumeInput.value = rendu.resume || '';
        resumePreview.innerHTML = rendu.resume ? marked.parse(rendu.resume) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        cancelBtn.href = `intervention-view.html?id=${interventionId}`;
        backBtn.onclick = () => location.href = `intervention-view.html?id=${interventionId}`;

        attachments = [];
        (images || []).forEach(img => attachments.push({
          kind: 'image',
          url: `/api/images/${img.id}/view`,
          nom_fichier: img.nom_fichier,
          commentaire_image: img.commentaire_image,
          type: 'Image',
          note: img.note || ''
        }));
        (documents || []).forEach(doc => attachments.push({
          kind: 'doc',
          url: `/api/documents/${doc.id}/view`,
          nom_fichier: doc.nom_fichier,
          commentaire_image: doc.nature || 'Document',
          type: 'Document',
          note: doc.note || ''
        }));
        (message_attachments || []).forEach(att => {
          const kind = (att.file_type || '').startsWith('image/') ? 'image' : 'doc';
          attachments.push({
            kind,
            url: `/api/attachments/${att.id}/view`,
            nom_fichier: att.file_name,
            commentaire_image: `PJ message: ${(att.message || '').substring(0,50)}...`,
            type: 'Message',
            note: att.note || att.message || ''
          });
        });
        refreshAttachments();
      };

      resumeInput.addEventListener('input', () => {
        const text = resumeInput.value;
        resumePreview.innerHTML = text ? marked.parse(text) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
      });
      if (filterSearch) filterSearch.addEventListener('input', refreshAttachments);
      if (filterSource) filterSource.addEventListener('change', refreshAttachments);
      if (filterKind) filterKind.addEventListener('change', refreshAttachments);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = { valeur: valeurInput.value || '', resume: resumeInput.value || '' };
        try {
          const res = await fetch(`/api/rendus/${renduId}`, { method:'PUT', headers, body: JSON.stringify(payload) });
          if (!res.ok) {
            const err = await res.json().catch(()=>({}));
            throw new Error(err.error || `HTTP ${res.status}`);
          }
          alert('Rendu mis à jour avec succès');
          if (interventionId) location.href = `intervention-view.html?id=${interventionId}`; else location.href='interventions.html';
        } catch (err) {
          alert(`Échec de la mise à jour: ${err.message}`);
        }
      });

      try { await loadData(); } catch (e) { console.error(e); alert(e.message); }
    });
  </script>
</body>
</html>
