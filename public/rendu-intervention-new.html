<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveau Rendu Intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 6px 12px rgba(0,0,0,0.03); position: relative; }
    .attachment-thumb { width: 100%; max-height: 180px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb; }
    .attachment-actions { position:absolute; top:8px; right:8px; }
    .textarea-small { min-height: 80px; }
    @media print { .no-print { display:none!important; } body { background:#fff; } }
  </style>
</head>
<body>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h1 class="h4 mb-0">Nouveau rendu d'intervention</h1>
      <div class="d-flex gap-2 no-print">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Imprimer</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <form id="rendu-new-form" novalidate>
          <div class="mb-3">
            <label class="form-label fw-bold">Résumé (Markdown) <span class="text-danger">*</span></label>
            <textarea id="resume" required></textarea>
            <div class="text-muted small" id="resume-counter">0 caractères</div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Aperçu du rendu</label>
            <div id="resume-preview" class="p-3 border rounded bg-light" style="min-height:150px;">
              <em class="text-muted">L'aperçu apparaîtra ici...</em>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Valeur</label>
            <input type="text" class="form-control" id="valeur" placeholder="Ex: 1500€">
          </div>

          <h3 class="h5 mt-4 mb-2">Pièces jointes liées (Ticket / Site / Demande)</h3>
          <p class="text-muted small">Chaque carte affiche l'image/doc, le commentaire et un résumé (markdown) modifiables. Le bouton + ajoute un nouveau fichier.</p>
          <div class="row g-3" id="linked-attachments"></div>
          <div id="linked-empty" class="text-muted small mb-3">Aucune pièce jointe trouvée.</div>
          <div class="d-flex justify-content-end gap-2 mb-4 no-print">
            <button type="button" class="btn btn-outline-primary btn-sm" id="build-from-linked"><i class="bi bi-markdown me-1"></i> Générer un brouillon</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="add-new-upload"><i class="bi bi-plus-circle me-1"></i> Ajouter un fichier</button>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="save-rendu-btn"><i class="bi bi-save me-1"></i>Enregistrer</button>
            <button type="button" class="btn btn-secondary" id="cancel-rendu-btn">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) { alert('Session expirée'); return location.href='/login.html'; }
    const params = new URLSearchParams(location.search);
    const interventionId = params.get('id') || params.get('intervention_id');
    if (!interventionId) { alert('Intervention inconnue'); return location.href='interventions.html'; }

    let relatedTicketId = null;
    let relatedSiteId = null;
    let demandeId = params.get('demande_id');
    let linkedAttachments = []; // {id, type, cible_id, nom_fichier, commentaire_image, note, url, kind}

    const linkedContainer = document.getElementById('linked-attachments');
    const linkedEmpty = document.getElementById('linked-empty');
    const addUploadBtn = document.getElementById('add-new-upload');
    const buildFromLinkedBtn = document.getElementById('build-from-linked');

    const easyMDE = new EasyMDE({
      element: document.getElementById('resume'),
      spellChecker: false,
      forceSync: true,
      placeholder: "Rédigez ici le résumé de l'intervention...",
      toolbar: ["bold","italic","heading","|","quote","code","unordered-list","ordered-list","|","link","image","|","preview","side-by-side","fullscreen","|","guide"],
      previewRender: (text) => EasyMDE.prototype.markdown(text || '')
    });
    const previewEl = document.getElementById('resume-preview');
    const counterEl = document.getElementById('resume-counter');
    const updatePreview = () => {
      if (previewEl) previewEl.innerHTML = easyMDE.options.previewRender(easyMDE.value() || '') || '<em class="text-muted">L\'aperçu apparaîtra ici...</em>';
      if (counterEl) counterEl.textContent = `${easyMDE.value().length} caractères`;
    };
    easyMDE.codemirror.on('change', updatePreview);
    updatePreview();

    const renderAttachmentCard = (att, isNewUpload=false) => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.innerHTML = `
        <div class="attachment-card h-100">
          <div class="attachment-actions no-print">
            <button class="btn btn-sm btn-outline-danger remove-card"><i class="bi bi-x"></i></button>
          </div>
          <div class="mb-2">
            ${att.kind === 'image' ? `<img class="attachment-thumb" src="${att.url || ''}" alt="${att.commentaire_image || att.nom_fichier || ''}">` :
             `<div class="d-flex align-items-center gap-2 text-muted"><i class="bi bi-file-earmark-richtext fs-4"></i><span>${att.nom_fichier||'Document'}</span></div>`}
          </div>
          ${att.kind === 'upload' ? `
            <div class="mb-2">
              <label class="form-label small">Fichier</label>
              <input type="file" class="form-control form-control-sm upload-file">
            </div>` : ''}
          <div class="mb-2">
            <label class="form-label small">Commentaire</label>
            <textarea class="form-control form-control-sm att-comment textarea-small" placeholder="Commentaire...">${att.commentaire_image||''}</textarea>
          </div>
          <div>
            <label class="form-label small">Résumé (Markdown)</label>
            <textarea class="form-control form-control-sm att-note textarea-small" placeholder="Résumé markdown...">${att.note||''}</textarea>
          </div>
          <div class="text-muted small mt-2">Source: ${att.type||'-'} #${att.cible_id||''}</div>
        </div>
      `;
      linkedContainer.appendChild(col);
      col.querySelector('.remove-card').addEventListener('click', () => {
        col.remove();
        linkedAttachments = linkedAttachments.filter(x => x.__dom !== col);
        toggleEmpty();
      });
      att.__dom = col;
    };

    const toggleEmpty = () => {
      const hasCards = linkedContainer && linkedContainer.children.length > 0;
      if (linkedEmpty) linkedEmpty.classList.toggle('d-none', hasCards);
    };

    const fetchJSON = async (url) => {
      const r = await fetch(url, { headers:{'Authorization':`Bearer ${token}`}, credentials:'same-origin' });
      if (!r.ok) return null;
      return r.json().catch(()=>null);
    };

    const loadRelations = async () => {
      const rel = await fetchJSON(`/api/interventions/${interventionId}/relations`);
      if (rel && rel.ticket) {
        relatedTicketId = rel.ticket.id || rel.ticket.ticket_id || null;
        if (rel.ticket.site_id) relatedSiteId = rel.ticket.site_id;
      }
      if (rel && rel.site) relatedSiteId = relatedSiteId || rel.site.id || rel.site.site_id;
    };

    const loadAttachments = async () => {
      linkedAttachments = [];
      const pushImgs = async (type,id) => {
        if (!id) return;
        const data = await fetchJSON(`/api/images?cible_type=${encodeURIComponent(type)}&cible_id=${id}`);
        if (Array.isArray(data)) {
          data.forEach(img => linkedAttachments.push({
            id: img.id, type, cible_id:id, nom_fichier: img.nom_fichier, commentaire_image: img.commentaire_image||'', note: img.note || '',
            url: `/api/images/${img.id}/view`, kind:'image'
          }));
        }
      };
      const pushDocs = async (type,id) => {
        if (!id) return;
        const data = await fetchJSON(`/api/documents?cible_type=${encodeURIComponent(type)}&cible_id=${id}`);
        if (Array.isArray(data)) {
          data.forEach(doc => linkedAttachments.push({
            id: doc.id, type, cible_id:id, nom_fichier: doc.nom_fichier, commentaire_image: doc.commentaire || '', note: doc.note || '',
            url: `/api/documents/${doc.id}/view`, kind:'doc'
          }));
        }
      };
      await loadRelations();
      await pushImgs('Ticket', relatedTicketId);
      await pushImgs('Site', relatedSiteId);
      await pushImgs('DemandeClient', demandeId);
      await pushDocs('DemandeClient', demandeId);
      await pushDocs('Site', relatedSiteId);

      linkedContainer.innerHTML = '';
      linkedAttachments.forEach(att => renderAttachmentCard(att));
      toggleEmpty();
    };

    if (addUploadBtn) {
      addUploadBtn.addEventListener('click', () => {
        const att = { kind:'upload', type:'Upload', cible_id:'', nom_fichier:'', commentaire_image:'', note:'' };
        renderAttachmentCard(att, true);
        linkedAttachments.push(att);
        toggleEmpty();
      });
    }

    if (buildFromLinkedBtn) {
      buildFromLinkedBtn.addEventListener('click', () => {
        const lines = [];
        lines.push('## Pièces jointes');
        linkedAttachments.forEach(att => {
          const commentEl = att.__dom?.querySelector('.att-comment');
          const noteEl = att.__dom?.querySelector('.att-note');
          const comment = commentEl?.value || att.commentaire_image || '';
          const note = noteEl?.value || att.note || '';
          const label = att.nom_fichier || 'Pièce jointe';
          if (att.kind === 'image') {
            lines.push(`![${comment || label}](${att.url})`);
          } else {
            lines.push(`- [${label}](${att.url}) ${comment ? ' — ' + comment : ''}`);
          }
          if (note) lines.push(note);
          lines.push('');
        });
        easyMDE.value((easyMDE.value() || '') + '\n\n' + lines.join('\n'));
        updatePreview();
        alert('Brouillon généré à partir des cartes.');
      });
    }

    // Sauvegarde
    const formEl = document.getElementById('rendu-new-form');
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData();
      fd.append('resume', easyMDE.value());
      fd.append('valeur', document.getElementById('valeur').value || '');

      // Nouvelles uploads
      linkedAttachments.forEach(att => {
        if (att.kind === 'upload') {
          const file = att.__dom?.querySelector('.upload-file')?.files[0];
          const comment = att.__dom?.querySelector('.att-comment')?.value || '';
          const note = att.__dom?.querySelector('.att-note')?.value || '';
          if (file) {
            fd.append('image_files[]', file);
            fd.append('image_commentaires[]', comment);
            fd.append('image_notes[]', note);
          }
        }
      });

      try {
        const res = await fetch(`/api/interventions/${interventionId}/rendus`, {
          method:'POST',
          headers:{ 'Authorization':`Bearer ${token}` },
          body: fd
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        alert('Rendu enregistré');
        location.href = `intervention-view.html?id=${interventionId}`;
      } catch (err) {
        console.error(err);
        alert('Erreur de sauvegarde');
      }
    });

    document.getElementById('cancel-rendu-btn')?.addEventListener('click', () => {
      if (confirm('Annuler ?')) location.href = `intervention-view.html?id=${interventionId}`;
    });
    document.getElementById('back-btn')?.addEventListener('click', () => {
      if (document.referrer) history.back(); else location.href = `intervention-view.html?id=${interventionId}`;
    });

    loadAttachments();
  });
  </script>
</body>
</html>
