<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveau Rendu Intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <style>
    body { 
      background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .card { 
      border: none; 
      border-radius: 16px; 
      box-shadow: 0 10px 24px rgba(0,0,0,0.06); 
    }
    
    .attachment-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      transition: all 0.3s ease;
      cursor: pointer;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .attachment-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
      transform: translateY(-2px);
    }
    
    .attachment-card.selected {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .attachment-preview {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .attachment-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .attachment-preview.doc-preview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 3rem;
    }
    
    .attachment-info {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .attachment-comment {
      font-size: 0.875rem;
      color: #374151;
      margin-bottom: 8px;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    
    .attachment-meta {
      font-size: 0.75rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .add-card {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .add-card:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .add-card-content {
      text-align: center;
      color: #64748b;
    }
    
    .add-card-content i {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    
    /* Modal pour édition */
    .modal-dialog-large {
      max-width: 900px;
    }
    
    .edit-preview {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .resume-editor {
      min-height: 300px;
    }
    
    .badge-source {
      font-size: 0.7rem;
      padding: 4px 8px;
    }
    
    @media print { 
      .no-print { display: none !important; } 
      body { background: #fff; }
      .attachment-card { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <main class="container my-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="h4 mb-0"><i class="bi bi-file-text me-2"></i>Nouveau rendu d'intervention</h1>
      <div class="d-flex gap-2 no-print">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn">
          <i class="bi bi-arrow-left"></i> Retour
        </button>
        <button class="btn btn-outline-primary btn-sm" id="download-html-btn">
          <i class="bi bi-download"></i> Télécharger HTML
        </button>
      </div>
    </div>

    <!-- Formulaire principal -->
    <div class="card mb-4">
      <div class="card-body">
        <form id="rendu-form" novalidate>
          <!-- Résumé (Markdown + preview) -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Résumé détaillé (Markdown)</h5>
              <small class="text-muted">Utilisez Markdown pour un résumé détaillé</small>
            </div>
            <textarea class="form-control" id="resume" rows="10" placeholder="Rédigez un résumé détaillé en Markdown..."></textarea>
            <div class="border rounded p-3 bg-light mt-2" style="min-height: 200px;" id="resume-preview">
              <em class="text-muted">Le résumé apparaîtra ici...</em>
            </div>
            <div class="form-text">Prévisualisation du résumé</div>
          </div>

          <!-- Section Pièces jointes -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes</h5>
              <span class="badge bg-primary" id="attachments-count">0 pièce(s)</span>
            </div>
            <p class="text-muted small mb-3">
              Cliquez sur une carte pour modifier l'image/document et son commentaire. 
              Utilisez le bouton + pour ajouter un nouveau fichier.
            </p>
            <div class="row g-2 align-items-center mb-3">
              <div class="col-md-4">
                <input type="text" class="form-control form-control-sm" id="filter-search" placeholder="Rechercher (nom, commentaire)...">
              </div>
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filter-source">
                  <option value="">Toutes les sources</option>
                  <option value="Ticket">Ticket</option>
                  <option value="Site">Site</option>
                  <option value="DemandeClient">Demande client</option>
                  <option value="Message">Pièces jointes des messages</option>
                  <option value="Intervention">Intervention</option>
                  <option value="Upload">Upload/Nouveau</option>
                  <option value="Exemple">Exemple</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filter-kind">
                  <option value="">Images et documents</option>
                  <option value="image">Images</option>
                  <option value="doc">Documents</option>
                </select>
              </div>
            </div>

            <!-- Grille des pièces jointes -->
            <div class="row g-3" id="attachments-grid">
              <!-- Les cards seront ajoutées ici dynamiquement -->
            </div>
          </div>

          <!-- Boutons d'action -->
          <div class="d-flex gap-2 no-print">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save me-1"></i>Enregistrer le rendu
            </button>
            <button type="button" class="btn btn-secondary" id="cancel-btn">
              Annuler
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Modal d'édition -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-large modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil-square me-2"></i>Modifier la pièce jointe
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Colonne gauche : Aperçu et upload -->
            <div class="col-md-5">
            <div class="mb-3">
              <label class="form-label fw-bold">Aperçu</label>
              <div id="edit-preview-container" class="border rounded p-3 bg-light text-center">
                <div id="edit-preview"></div>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Remplacer le fichier</label>
              <input type="file" class="form-control" id="edit-file-input" accept="image/*,.pdf,.doc,.docx">
              <div class="form-text">Laissez vide pour conserver le fichier actuel</div>
            </div>

            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label mb-0">Source</label>
                <button type="button" class="btn btn-sm btn-outline-primary" id="open-source-modal" data-bs-toggle="modal" data-bs-target="#sourcesModal"><i class="bi bi-folder2-open me-1"></i>Voir les sources</button>
              </div>
              <div id="edit-source-info" class="d-flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>

            <!-- Colonne droite : Commentaire -->
            <div class="col-md-7">
              <div class="mb-3">
                <label class="form-label fw-bold">Titre de la pièce (facultatif)</label>
                <input type="text" class="form-control" id="edit-title" placeholder="Ex: Dalle GTB couloir">
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Commentaire</label>
                <textarea class="form-control" id="edit-comment" rows="4" 
                  placeholder="Ajoutez un commentaire sur cette pièce jointe..."></textarea>
                <div class="form-text">Commentaire court visible sur la carte</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="delete-attachment-btn">
            <i class="bi bi-trash"></i> Supprimer
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Annuler
          </button>
          <button type="button" class="btn btn-primary" id="save-edit-btn">
            <i class="bi bi-check-lg"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Sources -->
  <div class="modal fade" id="sourcesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-collection me-2"></i>Sources disponibles</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <label class="form-label small mb-1" for="source-search">Filtrer</label>
              <input type="text" class="form-control form-control-sm" id="source-search" placeholder="Rechercher...">
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1" for="source-filter">Source</label>
              <select class="form-select form-select-sm" id="source-filter">
                <option value="">Toutes les sources</option>
                <option value="Ticket">Ticket</option>
                <option value="Site">Site</option>
                <option value="DemandeClient">Demande client</option>
                <option value="Message">Pièces jointes des messages</option>
                <option value="Intervention">Intervention</option>
                <option value="Upload">Upload/Nouveau</option>
                <option value="Exemple">Exemple</option>
              </select>
            </div>
                          <div class="col-md-4">
                            <label class="form-label small mb-1" for="source-kind">Type de fichier</label>
                            <select class="form-select form-select-sm" id="source-kind">
                              <option value="">Images et documents</option>
                              <option value="image">Images</option>
                              <option value="doc">Documents</option>
                            </select>
                          </div>          </div>
          <div class="row g-3" id="sources-list"></div>
          <div id="sources-empty" class="text-muted small">Aucune source trouvée.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="/js/rapport-intervention.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) { 
      alert('Session expirée'); 
      return location.href = '/login.html'; 
    }

    const params = new URLSearchParams(location.search);
    const interventionId = params.get('id') || params.get('intervention_id');
    if (!interventionId) { 
      alert('Intervention inconnue'); 
      return location.href = 'interventions.html'; 
    }

    let attachments = [];
    let currentEditIndex = -1;
    let editModal = null;
    let sourcesModal = null; // modal instance lazily created
    let mainResumeEditor = null;
    let meta = {
      client: 'Non renseigné',
      site: 'Non renseigné',
      contrat: 'Non renseigné',
      intervention: 'Rendu intervention',
    };
    let ticketIdRef = null;
    let siteIdRef = null;
    let associationIdRef = null;

    const grid = document.getElementById('attachments-grid');
    const countBadge = document.getElementById('attachments-count');
    const filterSearch = document.getElementById('filter-search');
    const filterSource = document.getElementById('filter-source');
    const filterKind = document.getElementById('filter-kind');
    const resumeInput = document.getElementById('resume');
    const resumePreview = document.getElementById('resume-preview');
    const sourceSearch = document.getElementById('source-search');
    const sourceFilter = document.getElementById('source-filter');
    const sourceKind = document.getElementById('source-kind');
    const sourcesList = document.getElementById('sources-list');
    const sourcesEmpty = document.getElementById('sources-empty');

    // Initialisation de l'éditeur Markdown principal (résumé)
    const initMainResumeEditor = () => {
      if (!mainResumeEditor && typeof EasyMDE !== 'undefined') {
        mainResumeEditor = new EasyMDE({
          element: document.getElementById('resume'),
          spellChecker: false,
          forceSync: true,
          placeholder: "Rédigez un résumé détaillé en Markdown...",
          toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "preview"],
          status: false,
          minHeight: "180px"
        });
        mainResumeEditor.codemirror.on('change', () => {
          const txt = mainResumeEditor.value();
          resumePreview.innerHTML = txt ? marked.parse(txt) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        });
      }
    };

    // Preview du résumé principal
    // Preview du résumé principal (fallback si EasyMDE indisponible)
    const updateResumePreview = () => {
      if (!resumePreview) return;
      const txt = mainResumeEditor ? mainResumeEditor.value() : (resumeInput?.value || '');
      resumePreview.innerHTML = txt ? (typeof marked !== 'undefined' ? marked.parse(txt) : txt) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
    };
    resumeInput?.addEventListener('input', updateResumePreview);

    // Fonction pour créer une card de pièce jointe
    const createAttachmentCard = (att, index) => {
      const col = document.createElement('div');
      col.className = 'col-12 col-sm-6 col-lg-4';
      
      const card = document.createElement('div');
      card.className = 'attachment-card';
      card.onclick = () => openEditModal(index);

      // Aperçu
      const preview = document.createElement('div');
      preview.className = 'attachment-preview';
      
      if (att.kind === 'image') {
        preview.innerHTML = `<img src="${att.url || att.previewUrl || ''}" alt="${att.nom_fichier}">`;
      } else {
        preview.className += ' doc-preview';
        preview.innerHTML = '<i class="bi bi-file-earmark-text"></i>';
      }

      // Info
     const info = document.createElement('div');
     info.className = 'attachment-info';
      const title = document.createElement('div');
      title.className = 'fw-semibold';
      title.textContent = att.titre || att.nom_fichier || 'Fichier';
      
      const comment = document.createElement('div');
      comment.className = 'attachment-comment';
      comment.textContent = att.commentaire_image || 'Aucun commentaire';
      
      const meta = document.createElement('div');
      meta.className = 'attachment-meta';
      
      const sourceSpan = document.createElement('span');
      sourceSpan.className = 'badge badge-source bg-secondary';
      sourceSpan.textContent = att.type || 'Upload';
      
      const nameSpan = document.createElement('span');
      nameSpan.innerHTML = `<i class="bi bi-file-earmark"></i> ${att.nom_fichier || 'Fichier'}`;
      
      meta.appendChild(sourceSpan);
      meta.appendChild(nameSpan);
      
      info.appendChild(title);
      info.appendChild(comment);
      info.appendChild(meta);
      
      card.appendChild(preview);
      card.appendChild(info);
      col.appendChild(card);
      
      return col;
    };

    // Créer la card "Ajouter"
    const createAddCard = () => {
      const col = document.createElement('div');
      col.className = 'col-12 col-sm-6 col-lg-4';
      
      const card = document.createElement('div');
      card.className = 'add-card';
      card.onclick = () => addNewAttachment();
      
      card.innerHTML = `
        <div class="add-card-content">
          <i class="bi bi-plus-circle"></i>
          <div class="fw-bold">Ajouter un fichier</div>
          <div class="small">Cliquez pour ajouter</div>
        </div>
      `;
      
      col.appendChild(card);
      return col;
    };

    // Rafraîchir la grille
    const refreshGrid = () => {
      grid.innerHTML = '';
      const term = (filterSearch?.value || '').toLowerCase();
      const src = filterSource?.value || '';
      const kind = filterKind?.value || '';

      const filtered = attachments.filter((att) => {
        const txt = `${att.nom_fichier||''} ${att.commentaire_image||''}`.toLowerCase();
        const matchTerm = !term || txt.includes(term);
        const matchSrc = !src || att.type === src;
        const matchKind = !kind || att.kind === kind;
        return matchTerm && matchSrc && matchKind;
      });

      filtered.forEach((att, index) => {
        grid.appendChild(createAttachmentCard(att, index));
      });
      
      if (!filtered.length) {
        const empty = document.createElement('div');
        empty.className = 'col-12 text-muted small';
        empty.textContent = 'Aucune pièce jointe pour ces filtres.';
        grid.appendChild(empty);
      }

      grid.appendChild(createAddCard());
      
      countBadge.textContent = `${filtered.length} / ${attachments.length} pièce(s)`;
    };

    // Ajouter un nouveau fichier
    const addNewAttachment = () => {
      const newAtt = {
        kind: 'upload',
        type: 'Nouveau',
        cible_id: '',
        nom_fichier: 'Nouveau fichier',
        commentaire_image: '',
        url: '',
        previewUrl: '',
        isNew: true
      };
      
      attachments.push(newAtt);
      refreshGrid();
      openEditModal(attachments.length - 1);
      // Préparer le modal des sources pour ce nouvel élément
      if (sourceFilter) sourceFilter.value = newAtt.type;
      if (sourceKind) sourceKind.value = '';
      if (sourceSearch) sourceSearch.value = '';
    };

    // Rendu des sources (modal)
    const renderSources = () => {
      if (!sourcesList) return;
      sourcesList.innerHTML = '';
      const term = (sourceSearch?.value || '').toLowerCase();
      const src = sourceFilter?.value || '';
      const kind = sourceKind?.value || '';

      const filtered = attachments.filter(att => {
        const txt = `${att.nom_fichier||''} ${att.commentaire_image||''}`.toLowerCase();
        const matchTerm = !term || txt.includes(term);
        const matchSrc = !src || att.type === src;
        const matchKind = !kind 
          || (kind === 'message' ? att.type === 'Message' : att.kind === kind);
        return matchTerm && matchSrc && matchKind;
      });

      if (!filtered.length) {
        sourcesEmpty?.classList.remove('d-none');
        return;
      }
      sourcesEmpty?.classList.add('d-none');

      filtered.forEach((att, idx) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6';
        const color = (att.type==='Ticket' && 'primary')
          || (att.type==='Site' && 'success')
          || (att.type==='DemandeClient' && 'warning')
          || (att.type==='Message' && 'secondary')
          || (att.type==='Intervention' && 'info')
          || 'secondary';
        const kindLabel = att.kind === 'image' ? 'PJ' : 'Doc';
        col.innerHTML = `
          <div class="border rounded p-2 h-100 d-flex gap-2 align-items-start">
            <div class="flex-shrink-0">
              ${att.kind === 'image' 
                ? `<img src="${att.url||att.previewUrl||''}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;">`
                : `<div class="d-flex align-items-center justify-content-center" style="width:70px;height:70px;border-radius:8px;border:1px solid #e5e7eb;"><i class="bi bi-file-earmark-text"></i></div>`}
            </div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${att.nom_fichier||'Fichier'}</div>
              <div class="text-muted small">${att.commentaire_image||''}</div>
              <div class="d-flex flex-wrap gap-1 mt-1">
                <span class="badge bg-${color}">${att.type||'Upload'}</span>
                <span class="badge bg-dark">${kindLabel}</span>
                ${att.cible_id ? `<span class="badge bg-light text-dark">#${att.cible_id}</span>` : ''}
              </div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary source-select" data-idx="${idx}"><i class="bi bi-check-lg"></i></button>
            </div>
          </div>
        `;
        sourcesList.appendChild(col);
      });

      sourcesList.querySelectorAll('.source-select').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          const att = filtered[idx];
          if (currentEditIndex >= 0 && attachments[currentEditIndex]) {
            const target = attachments[currentEditIndex];
            target.nom_fichier = att.nom_fichier;
            target.commentaire_image = att.commentaire_image;
            target.type = att.type;
            target.kind = att.kind;
            target.url = att.url;
            target.cible_id = att.cible_id;
            target.isNew = false;
            target.file = null;
            refreshGrid();
            openEditModal(currentEditIndex);
          }
          sourcesModal?.hide();
        });
      });
    };

    // Ouvrir le modal d'édition
    const openEditModal = (index) => {
      currentEditIndex = index;
      const att = attachments[index];
      
      if (!editModal) {
        editModal = new bootstrap.Modal(document.getElementById('editModal'));
      }

      // Remplir le modal
      document.getElementById('edit-title').value = att.titre || att.nom_fichier || '';
      document.getElementById('edit-comment').value = att.commentaire_image || '';
      
      // Aperçu
      const previewContainer = document.getElementById('edit-preview');
      if (att.kind === 'image') {
        previewContainer.innerHTML = `<img src="${att.url || att.previewUrl || ''}" class="edit-preview" alt="${att.nom_fichier}">`;
      } else {
        previewContainer.innerHTML = `
          <div class="text-center p-4">
            <i class="bi bi-file-earmark-text" style="font-size: 4rem; color: #667eea;"></i>
            <div class="mt-2">${att.nom_fichier}</div>
          </div>
        `;
      }
      
      // Source
      const sourceInfo = document.getElementById('edit-source-info');
      const typeLabel = att.type || 'Upload';
      const kindLabel = att.kind === 'image' ? 'PJ' : 'Doc';
      const map = { Ticket:'primary', Site:'success', DemandeClient:'warning', Message:'secondary', Intervention:'info', Exemple:'secondary', Upload:'secondary', Nouveau:'primary' };
      const color = map[typeLabel] || 'secondary';
      sourceInfo.innerHTML = `
        <span class="badge bg-${color}">${typeLabel}</span>
        <span class="badge bg-dark">${kindLabel}</span>
        ${att.cible_id ? `<span class="badge bg-light text-dark">#${att.cible_id}</span>` : ''}
      `;
      
      // Réinitialiser le file input
      document.getElementById('edit-file-input').value = '';
      
      editModal.show();
    };

    // Sauvegarder les modifications
    document.getElementById('save-edit-btn').addEventListener('click', () => {
      const att = attachments[currentEditIndex];
      
      const titleVal = document.getElementById('edit-title').value.trim();
      if (titleVal) {
        att.titre = titleVal;
        att.nom_fichier = titleVal;
      }
      att.commentaire_image = document.getElementById('edit-comment').value;
      
      const fileInput = document.getElementById('edit-file-input');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        att.nom_fichier = file.name;
        att.file = file;
        att.kind = file.type.startsWith('image/') ? 'image' : 'doc';
        
        // Créer une preview
        if (att.kind === 'image') {
          const reader = new FileReader();
          reader.onload = (e) => {
            att.previewUrl = e.target.result;
            refreshGrid();
          };
          reader.readAsDataURL(file);
        }
      }
      
      editModal.hide();
      refreshGrid();
    });

    // Supprimer une pièce jointe
    document.getElementById('delete-attachment-btn').addEventListener('click', () => {
      if (confirm('Voulez-vous vraiment supprimer cette pièce jointe ?')) {
        attachments.splice(currentEditIndex, 1);
        editModal.hide();
        refreshGrid();
      }
    });

    // Charger les pièces jointes existantes
    const loadAttachments = async () => {
      const fetchJSON = async (url) => {
        try {
          const r = await fetch(url, { 
            headers: { 'Authorization': `Bearer ${token}` }, 
            credentials: 'same-origin' 
          });
          if (!r.ok) return null;
          return await r.json();
        } catch (e) {
          return null;
        }
      };

      // Récupérer les relations
      const rel = await fetchJSON(`/api/interventions/${interventionId}/relations`);
      let ticketId = null, siteId = null, demandeId = params.get('demande_id');
      
      if (rel?.ticket) {
        ticketId = rel.ticket.id || rel.ticket.ticket_id;
        siteId = rel.ticket.site_id;
        if (!demandeId && rel.ticket.demande_id) demandeId = rel.ticket.demande_id;
        meta.client = rel.ticket.nom_client || rel.ticket.client_nom || rel.ticket.client || meta.client;
        meta.intervention = rel.ticket.titre || rel.ticket.ticket_titre || meta.intervention;
        meta.site = rel.ticket.nom_site || meta.site;
        if (rel.ticket.contrat_titre) meta.contrat = rel.ticket.contrat_titre;
      }
      if (rel?.demande && !demandeId) demandeId = rel.demande.id || rel.demande.demande_id;
      if (rel?.site) siteId = siteId || rel.site.id || rel.site.site_id;
      if (rel?.site?.nom_site) meta.site = rel.site.nom_site;
      if (rel?.intervention?.titre) meta.intervention = rel.intervention.titre;
      if (rel?.contrat?.titre) meta.contrat = rel.contrat.titre;
      if (rel?.association) {
        if (rel.association.client_nom) meta.client = rel.association.client_nom;
        if (rel.association.contrat_titre) meta.contrat = rel.association.contrat_titre;
        if (rel.association.contrat && rel.association.contrat.titre) meta.contrat = rel.association.contrat.titre;
        if (rel.association.id) associationIdRef = rel.association.id;
      }

      // Fallback direct via l'intervention si dispo
      try {
        const interData = await fetchJSON(`/api/interventions/${interventionId}`);
        if (interData) {
          if (!ticketId && interData.ticket_id) ticketId = interData.ticket_id;
          if (!siteId && interData.site_id) siteId = interData.site_id;
          if (!demandeId && interData.demande_id) demandeId = interData.demande_id;
          if (interData.titre) meta.intervention = interData.titre;
        }
      } catch(_) {}

      // Si on n'a toujours pas la demande/site, tenter de la récupérer via le ticket
      if ((!demandeId || !siteId) && ticketId) {
        const ticketData = await fetchJSON(`/api/tickets/${ticketId}`);
        if (ticketData?.demande_id && !demandeId) demandeId = ticketData.demande_id;
        if (ticketData?.site_id && !siteId) siteId = ticketData.site_id;
        if (ticketData?.nom_client) meta.client = ticketData.nom_client;
        if (ticketData?.nom_site) meta.site = ticketData.nom_site;
        if (ticketData?.titre) meta.intervention = ticketData.titre;
        if (ticketData?.contrat_titre) meta.contrat = ticketData.contrat_titre;
        if (ticketData?.association) {
          meta.client = ticketData.association.client_nom || meta.client;
          meta.contrat = ticketData.association.contrat_titre || meta.contrat;
        }
      }
      ticketIdRef = ticketId;
      siteIdRef = siteId;

      // Charger images et documents
      const loadItems = async (type, id, endpoint) => {
        if (!id) return;
        const data = await fetchJSON(`/api/${endpoint}?cible_type=${encodeURIComponent(type)}&cible_id=${id}`);
        if (Array.isArray(data)) {
          data.forEach(item => {
            attachments.push({
              id: item.id,
              type,
              cible_id: id,
              nom_fichier: item.nom_fichier,
              titre: item.nom_fichier,
              commentaire_image: item.commentaire_image || item.commentaire || '',
              url: `/api/${endpoint}/${item.id}/view`,
              kind: endpoint === 'images' ? 'image' : 'doc'
            });
          });
        }
      };

      // Pièces jointes provenant des messages de la demande (conversation)
      const loadConversationAttachments = async (demandeId) => {
        if (!demandeId) return;
        const msgs = await fetchJSON(`/api/conversations/demande-${demandeId}`);
        if (!Array.isArray(msgs)) return;
        msgs.forEach(m => {
          if (!Array.isArray(m.attachments)) return;
          m.attachments.forEach(att => {
            const path = String(att.file_path || '');
            const url = path ? '/' + path.replace(/^public\//, '') : '';
            const name = att.file_name || path.split('/').pop() || 'Pièce jointe';
            const mime = att.type_mime || '';
            const lower = name.toLowerCase();
            const kind = (mime && mime.startsWith('image/')) || /\.(png|jpe?g|gif|webp)$/i.test(lower) ? 'image' : 'doc';
            attachments.push({
              id: att.id || `conv-${demandeId}-${name}`,
              type: 'Message',
              cible_id: demandeId,
              nom_fichier: name,
              titre: name,
              commentaire_image: att.commentaire || m.message || '',
              url,
              kind,
              isNew: false,
              file: null
            });
          });
        });
      };

      // Pièces liées
      await loadItems('Ticket', ticketId, 'images');
      await loadItems('Site', siteId, 'images');
      await loadItems('DemandeClient', demandeId, 'images');
      await loadItems('Intervention', interventionId, 'images');
      await loadItems('DemandeClient', demandeId, 'documents');
      await loadItems('Site', siteId, 'documents');
      await loadItems('Intervention', interventionId, 'documents');
      // Pièces des messages de la demande
      await loadConversationAttachments(demandeId);

      // Exemples si rien trouvé
      if (!attachments.length) {
        attachments.push({
          id: 'ex1',
          type: 'Exemple',
          cible_id: 'N/A',
          nom_fichier: 'Exemple photo',
          titre: 'Exemple photo',
          commentaire_image: 'Commentaire exemple',
          url: 'data:image/svg+xml,%3Csvg%20width%3D%22400%22%20height%3D%22250%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20400%20250%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16b2e1b10a5%20text%20%7B%20fill%3Argba(255%2C255%2C255%2C.75)%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A20pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16b2e1b10a5%22%3E%3Crect%20width%3D%22400%22%20height%3D%22250%22%20fill%3D%22%23868e96%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22148.5%22%20y%3D%22133.6%22%3EPhoto%20exemple%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E',
          kind: 'image'
        });
        attachments.push({
          id: 'ex2',
          type: 'Exemple',
          cible_id: 'N/A',
          nom_fichier: 'Doc exemple',
          titre: 'Doc exemple',
          commentaire_image: 'Description du document',
          url: 'https://example.com/doc.pdf',
          kind: 'doc'
        });
      }

      refreshGrid();
      renderSources();
    };

    // Soumettre le formulaire
    document.getElementById('rendu-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fd = new FormData();
      
      // Résumé simple (sans concaténer les pièces jointes dans le texte)
      const resumeText = (mainResumeEditor ? mainResumeEditor.value() : (resumeInput?.value || '')).trim();
      fd.append('resume', resumeText);
      
      // Ajouter uniquement les nouveaux fichiers et leurs métadonnées
      attachments.forEach((att) => {
        if (att.isNew && att.file) {
          fd.append('image_files[]', att.file);
          fd.append('image_commentaires[]', att.commentaire_image || '');
          fd.append('image_titles[]', att.titre || att.nom_fichier || '');
        }
      });

      try {
        const res = await fetch(`/api/interventions/${interventionId}/rendus`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: fd
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        alert('Rendu enregistré avec succès !');
        location.href = `intervention-view.html?id=${interventionId}`;
      } catch (err) {
        console.error(err);
        alert('Erreur lors de l\'enregistrement du rendu');
      }
    });

    // Télécharger en HTML (rapport)
    const downloadHtmlBtn = document.getElementById('download-html-btn');
    if (downloadHtmlBtn) {
      downloadHtmlBtn.addEventListener('click', async () => {
        const images = attachments.filter(att => att.kind === 'image').map(att => ({
          ...att,
          url: att.url || att.previewUrl || ''
        }));
        const resumeMd = (mainResumeEditor ? mainResumeEditor.value() : (document.getElementById('resume')?.value || '')).trim();
        const resumeHtml = resumeMd ? (typeof marked !== 'undefined' ? marked.parse(resumeMd) : resumeMd) : '';
        const metaForReport = await window.fetchInterventionMeta({
          interventionId,
          ticketId: ticketIdRef,
          siteId: siteIdRef,
          token
        });
        metaForReport.dateStr = new Date().toLocaleDateString('fr-FR');
        const html = await window.buildInterventionReportHTML({
          meta: metaForReport,
          images,
          resumeHtml,
          token,
          logoUrl: '/logo_logicielle.png'
        });
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `rapport-intervention-${interventionId}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    // Boutons d'action
    document.getElementById('cancel-btn').addEventListener('click', () => {
      if (confirm('Voulez-vous vraiment annuler ? Les modifications seront perdues.')) {
        location.href = `intervention-view.html?id=${interventionId}`;
      }
    });

    document.getElementById('back-btn').addEventListener('click', () => {
      if (document.referrer) {
        history.back();
      } else {
        location.href = `intervention-view.html?id=${interventionId}`;
      }
    });

    // Initialisation
    initMainResumeEditor();
    updateResumePreview();
    loadAttachments();

    // Filtres
    [filterSearch, filterSource, filterKind].forEach(el => {
      el?.addEventListener('input', refreshGrid);
      el?.addEventListener('change', refreshGrid);
    });

    // Sources modal
    document.getElementById('open-source-modal')?.addEventListener('click', () => {
      // Pré-filtrer selon la pièce jointe en cours d'édition
      const att = attachments[currentEditIndex] || {};
      if (sourceFilter) sourceFilter.value = att.type || '';
      if (sourceKind) sourceKind.value = att.kind || '';
      if (sourceSearch && att.cible_id) sourceSearch.value = String(att.cible_id);

      if (!sourcesModal) {
        const el = document.getElementById('sourcesModal');
        if (el) {
          sourcesModal = bootstrap.Modal.getOrCreateInstance(el);
          el.addEventListener('show.bs.modal', renderSources);
        }
      }
      renderSources();
      sourcesModal?.show();
    });
    ['input','change'].forEach(evt => {
      sourceSearch?.addEventListener(evt, renderSources);
      sourceFilter?.addEventListener(evt, renderSources);
      sourceKind?.addEventListener(evt, renderSources);
    });
  });
  </script>
</body>
</html>
