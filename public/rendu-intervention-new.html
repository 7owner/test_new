<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveau Rendu Intervention</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Custom -->
  <link href="/custom.css?v=1" rel="stylesheet">

  <!-- EasyMDE -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>

  <!-- Nav -->
  <script src="/nav.js?v=1"></script>
</head>

<body>

  <!-- Menu -->
  <div class="offcanvas offcanvas-end" id="offcanvasNavbar">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav">
        <li><a class="nav-link" href="/dashboard.html">Dashboard</a></li>
        <li><a class="nav-link" href="/agents.html">Agents</a></li>
        <li><a class="nav-link" href="/sites.html">Sites</a></li>
        <li><a class="nav-link active" href="/interventions.html">Interventions</a></li>
        <li><a class="nav-link" href="/rendezvous.html">Rendez-vous</a></li>
        <li><a class="nav-link" href="/achats.html">Achats</a></li>
        <li><a class="nav-link" href="/factures.html">Factures</a></li>
        <li><a class="nav-link" href="#" id="logout-link">Déconnexion</a></li>
      </ul>
    </div>
  </div>

  <main class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h1 class="mb-0">Créer un nouveau rendu d'intervention</h1>
      <button type="button" class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
    </div>

    <div class="card">
      <div class="card-body">

        <form id="rendu-new-form">

          <!-- Résumé Markdown -->
          <div class="mb-3">
            <label class="form-label">Résumé (Markdown)</label>
            <textarea id="resume"></textarea>
          </div>

          <!-- Aperçu Markdown externe -->
          <div class="mb-4">
            <label class="form-label fw-bold">Aperçu du rendu :</label>
            <div id="resume-preview" class="p-3 border bg-light rounded" style="min-height:150px;"></div>
          </div>

          <!-- Valeur -->
          <div class="mb-3">
            <label class="form-label">Valeur</label>
            <input type="text" class="form-control" id="valeur">
          </div>

          <!-- Images -->
          <h3 class="mt-4 mb-3">Images associées</h3>
          <div id="rendu-images-container">

            <div class="rendu-image-entry mb-4 p-3 border rounded bg-light">
              <div class="d-flex justify-content-end">
                <button type="button" class="btn-close remove-image"></button>
              </div>

              <label class="form-label">Image</label>
              <input class="form-control" type="file" name="image_file[]">

              <label class="form-label mt-2">Commentaire</label>
              <textarea class="form-control" name="image_commentaire[]" rows="2"></textarea>
            </div>

          </div>

          <button type="button" id="add-new-image-btn" class="btn btn-outline-secondary mb-3">
            <i class="bi bi-plus-circle"></i> Ajouter une image
          </button>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary" id="save-rendu-btn"><i class="bi bi-save me-2"></i>Enregistrer</button>
            <button type="button" class="btn btn-secondary" id="cancel-rendu-btn">Annuler</button>
          </div>

        </form>

      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", () => {

  /* ========= AUTHENTIFICATION ========= */
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login.html";

  let isAdmin = false;
  let actorEmail = "";

  try {
    const payload = JSON.parse(atob(token.split(".")[1]));
    isAdmin = payload.roles?.includes("ROLE_ADMIN");
    actorEmail = payload.email || "";
    document.getElementById("logged-in-user-email").textContent = actorEmail;
  } catch {}

  /* ========= PARAMS ========= */
  const params = new URLSearchParams(location.search);
  const interventionId = params.get("id") || params.get("intervention_id");

  if (!interventionId) {
    alert("Intervention inconnue.");
    return location.href = "interventions.html";
  }

  /* ========= INIT EDITOR EasyMDE ========= */
  const preview = document.getElementById("resume-preview");

  const easyMDE = new EasyMDE({
    element: document.getElementById("resume"),
    spellChecker: false,
    forceSync: true,
    placeholder: "Rédigez ici le résumé de l'intervention...",
    toolbar: [
      "bold", "italic", "heading",
      "|",
      "quote", "code", "table",
      "unordered-list", "ordered-list",
      "|",
      "link", "image",
      "|",
      "preview", "side-by-side", "fullscreen",
      "|",
      "guide"
    ],
    previewRender: text => {
      const html = EasyMDE.prototype.markdown(text);
      preview.innerHTML = html;
      return html;
    }
  });
  const updatePreview = () => {
    try {
      const html = easyMDE.options.previewRender(easyMDE.value());
      preview.innerHTML = html;
    } catch (_) {}
  };
  try { easyMDE.codemirror.on("change", updatePreview); } catch(_){}
  updatePreview();

  const backBtn = document.getElementById("back-btn");
  if (backBtn) {
    backBtn.addEventListener("click", () => window.history.back());
  }

  /* ========= GESTION DES IMAGES ========= */
  const imagesContainer = document.getElementById("rendu-images-container");
  const addImageBtn = document.getElementById("add-new-image-btn");

  addImageBtn.addEventListener("click", () => {
    const tpl = imagesContainer.querySelector(".rendu-image-entry").cloneNode(true);
    tpl.querySelectorAll("input,textarea").forEach(e => e.value = "");
    imagesContainer.appendChild(tpl);
  });

  imagesContainer.addEventListener("click", e => {
    if (e.target.classList.contains("remove-image")) {
      const entries = imagesContainer.querySelectorAll(".rendu-image-entry");
      if (entries.length > 1) {
        e.target.closest(".rendu-image-entry").remove();
      }
    }
  });

  /* ========= SAUVEGARDE ========= */
  document.getElementById("rendu-new-form").addEventListener("submit", async e => {
    e.preventDefault();
    if (!isAdmin) return alert("Action réservée aux administrateurs.");

    try {
      let fd = new FormData();
      fd.append("resume", document.getElementById("resume").value);
      fd.append("valeur", document.getElementById("valeur").value);

      imagesContainer.querySelectorAll(".rendu-image-entry").forEach(entry => {
        const file = entry.querySelector("input[type='file']").files[0];
        const comment = entry.querySelector("textarea").value;

        if (file) {
          fd.append("image_files[]", file);
          fd.append("image_commentaires[]", comment);
        }
      });

      const res = await fetch(`/api/interventions/${interventionId}/rendus`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "X-Actor-Email": actorEmail
        },
        body: fd
      });

      if (!res.ok) {
        const body = await res.json().catch(() => null);
        throw new Error(body?.error || "Erreur API");
      }

      alert("Rendu enregistré !");
      location.href = `intervention-view.html?id=${interventionId}`;

    } catch (err) {
      console.error(err);
      alert("Erreur : " + err.message);
    }
  });

  const cancelBtn = document.getElementById("cancel-rendu-btn");
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (id) {
        location.href = `intervention-view.html?id=${id}`;
      } else {
        location.href = '/interventions.html';
      }
    });
  }

});
  </script>

</body>
</html>

<!DOCTYPE html>
