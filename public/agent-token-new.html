<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générer un Jeton d'Accès</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
  <style>
    body { padding-bottom: 40px; }
  </style>
</head>
<body>
  <header class="header d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 m-0 d-flex align-items-center">
      <img src="/logo_logicielle.png" alt="Logo Système de Maintenance" style="height: 40px; margin-right: 10px;"> Génération de jeton
    </h1>
    <div id="user-info-container" class="d-flex align-items-center">
      <span class="me-2">Bienvenue, <span id="logged-in-user-email"></span></span>
      <button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
        Menu
      </button>
    </div>
  </header>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item"><a class="nav-link" href="/dashboard.html"><i class="bi bi-house-door-fill me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/agents.html"><i class="bi bi-people-fill me-2"></i>Agents</a></li>
        <li class="nav-item"><a class="nav-link" href="/sites.html"><i class="bi bi-building-fill me-2"></i>Sites</a></li>
        <li class="nav-item"><a class="nav-link" href="/interventions.html"><i class="bi bi-tools me-2"></i>Interventions</a></li>
        <li class="nav-item"><a class="nav-link" href="/rendezvous.html"><i class="bi bi-calendar-event-fill me-2"></i>Rendez-vous</a></li>
        <li class="nav-item"><a class="nav-link" href="/achats.html"><i class="bi bi-cart-fill me-2"></i>Achats</a></li>
        <li class="nav-item"><a class="nav-link" href="/factures.html"><i class="bi bi-receipt-cutoff me-2"></i>Factures</a></li>
        <li class="nav-item"><a class="nav-link" href="#" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
      </ul>
    </div>
  </div>

  <main class="container mt-5">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="agents.html">Gestion des Agents</a></li>
        <li class="breadcrumb-item active" aria-current="page">Générer Jeton</li>
      </ol>
    </nav>

    <h1 class="mb-2">Générer un Jeton d'Accès pour <span id="agent-name"></span></h1>
    <div id="agent-email-warning" class="text-danger mb-4 d-none"></div>

    <div class="card">
      <div class="card-body">
        <h2 class="card-title mb-4 h5">Paramètres du Jeton</h2>
        <form id="token-generation-form">
          <div class="mb-3">
            <label for="intervention-filter" class="form-label">Filtrer les interventions</label>
            <input type="text" class="form-control mb-2" id="intervention-filter" placeholder="Rechercher par titre ou ID...">
            <label for="intervention-id" class="form-label">Intervention à attribuer</label>
            <select id="intervention-id" class="form-select" required>
              <option value="" selected disabled>— Sélectionner une intervention —</option>
            </select>
            <div class="form-text">Sélection via ID et titre. Expiration fixée à 24h automatiquement.</div>
          </div>

          <div class="mt-4 d-flex align-items-center gap-2">
            <button type="button" id="generate-token-btn" class="btn btn-primary"><i class="bi bi-key me-2"></i>Générer et Envoyer Jeton</button>
            <a href="agents.html" class="btn btn-secondary">Retour aux agents</a>
          </div>

          <div id="generated-token-display" class="alert alert-success d-none mt-3" role="alert">
            <strong>Jeton généré:</strong> <span id="generated-token"></span>
            <p class="mt-2 mb-0">Un email a été envoyé à l'agent avec les instructions pour définir son mot de passe.</p>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const agentMatricule = urlParams.get('matricule');

      const agentNameEl = document.getElementById('agent-name');
      const emailWarningEl = document.getElementById('agent-email-warning');
      const generateTokenBtn = document.getElementById('generate-token-btn');
      const generatedTokenDisplay = document.getElementById('generated-token-display');
      const generatedTokenSpan = document.getElementById('generated-token');

      const isValidEmail = (em) => {
        if (!em) return false;
        const s = String(em).trim();
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
      };

      let agent = null;
      let interventionsCache = [];

      const updateEmailValidityUI = () => {
        if (!agent || !agent.email) {
          emailWarningEl.textContent = "Email de l'agent introuvable.";
          emailWarningEl.classList.remove('d-none');
          generateTokenBtn.setAttribute('disabled', 'true');
          return;
        }
        if (!isValidEmail(agent.email)) {
          emailWarningEl.textContent = `Email invalide: ${agent.email}. Corrigez l'email de l'agent avant d'envoyer le jeton.`;
          emailWarningEl.classList.remove('d-none');
          generateTokenBtn.setAttribute('disabled', 'true');
        } else {
          emailWarningEl.textContent = '';
          emailWarningEl.classList.add('d-none');
          generateTokenBtn.removeAttribute('disabled');
        }
      };

      // Charger l'agent puis mettre à jour le nom et la validité de l'email
      (async () => {
        try {
          const token = localStorage.getItem('token');
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          const res = await fetch('/api/agents', { headers, credentials:'same-origin' });
          const data = res.ok ? await res.json() : [];
          const list = Array.isArray(data) ? data : [];
          agent = list.find(a => String(a.matricule) === String(agentMatricule)) || null;
          agentNameEl.textContent = agent ? (agent.nom || agent.email || agent.matricule) : 'Agent introuvable';
        } catch(e) {
          console.error('Erreur chargement /api/agents:', e);
          agentNameEl.textContent = 'Agent introuvable';
        } finally {
          updateEmailValidityUI();
        }
      })();

      const renderInterventionsOptions = (term = '') => {
        const select = document.getElementById('intervention-id');
        if (!select) return;
        const norm = s => (s || '').toString().toLowerCase();
        const t = norm(term);
        select.innerHTML = '<option value="" disabled selected>— Sélectionner une intervention —</option>';
        interventionsCache
          .filter(it => {
            const label = `${it.id} ${it.titre} ${it.description}`.toLowerCase();
            return !t || label.includes(t);
          })
          .forEach(it => {
            const opt = document.createElement('option');
            opt.value = String(it.id);
            opt.textContent = `#${it.id} — ${it.titre || it.description || ''}`.trim();
            select.appendChild(opt);
          });
      };

      // Charger les interventions pour la sélection
      (async () => {
        const select = document.getElementById('intervention-id');
        const filterInput = document.getElementById('intervention-filter');
        const presetId = new URLSearchParams(location.search).get('intervention_id');
        try {
          const token = localStorage.getItem('token');
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          const res = await fetch('/api/interventions', { headers, credentials: 'same-origin' });
          const data = res.ok ? await res.json() : [];
          const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
          interventionsCache = items.map(it => ({
            id: it.id ?? it.intervention_id ?? it.ID,
            titre: it.titre || it.title || '',
            description: it.description || ''
          })).filter(it => it.id);
          renderInterventionsOptions('');
          if (filterInput) {
            filterInput.addEventListener('input', () => renderInterventionsOptions(filterInput.value));
          }
        } catch(e) {
          console.warn('Erreur chargement /api/interventions:', e);
        } finally {
          if (presetId && select) {
            const exists = Array.from(select.options).some(o => o.value === String(presetId));
            if (!exists) {
              const opt = document.createElement('option');
              opt.value = String(presetId);
              opt.textContent = `#${presetId} — (depuis l’URL)`;
              select.appendChild(opt);
            }
            select.value = String(presetId);
          }
        }
      })();

      generateTokenBtn.addEventListener('click', async function() {
        const interventionSelect = document.getElementById('intervention-id');
        const interventionId = interventionSelect.value;
        if (!agent || !agent.email) { alert("Email d'agent introuvable. Impossible d'envoyer le jeton."); return; }
        if (!isValidEmail(agent.email)) { alert("L'email de l'agent est invalide. Veuillez corriger l'email de l'agent avant d'envoyer le jeton."); return; }
        if (!interventionId) { alert("Veuillez sélectionner une intervention à attribuer."); return; }
        try {
          const token = localStorage.getItem('token');
          const headers = { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) };
          const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
          const body = { 
            email: agent.email, 
            intervention_id: interventionId || 1, 
            expires_at: expiresAt,
            intervention_label: interventionSelect.options[interventionSelect.selectedIndex]?.text || ''
          };
          const r = await fetch('/api/invite-agent', { method:'POST', headers, credentials:'same-origin', body: JSON.stringify(body) });
          const data = await r.json().catch(()=>({}));
          if (!r.ok) throw new Error((data && data.error) || `HTTP ${r.status}`);
          generatedTokenSpan.textContent = (data && data.token) ? data.token : (data && data.newTicketId ? `TICKET-${data.newTicketId}` : 'OK');
          generatedTokenDisplay.classList.remove('d-none');
          alert('Invitation envoyée à ' + (agent.email || "l'agent") + (data && data.newTicketId ? ('. Ticket lié: ' + data.newTicketId) : ''));
        } catch(e) {
          console.error(e);
          alert('Échec de la génération/envoi: ' + (e && e.message ? e.message : e));
        }
      });

      // Règles d'admin côté UI
      const currentUserRole = localStorage.getItem('userRole');
      const currentUserIsAdmin = (currentUserRole === 'admin');
      if (!currentUserIsAdmin) {
        const form = document.getElementById('token-generation-form');
        form.querySelectorAll('input, select, textarea, button[type="button"]').forEach(element => {
          element.setAttribute('disabled', 'true');
        });
        generateTokenBtn.classList.add('d-none');
      }
    });
  </script>
</body>
</html>
