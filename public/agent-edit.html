<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifier Agent</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    body {
      background: linear-gradient(135deg,#eef2ff 0%,#f8fbff 100%);
      font-family: system-ui,sans-serif;
      padding:2rem;
    }
    .main-card {
      border:none;
      border-radius:20px;
      background:#fff;
      box-shadow:0 8px 28px rgba(0,0,0,.08);
      padding:2rem;
      max-width:900px;
      margin-inline:auto;
    }
    .section-title {
      font-weight:600;
      color:#4a4f57;
      margin-bottom:.7rem;
    }
  </style>
</head>
<body>

<div class="main-card">

  <h2 class="fw-bold mb-4"><i class="bi bi-pencil-square me-2"></i></h2>

  <form id="agent-edit-form">

    <!-- Identité -->
    <div class="section-title">Identité</div>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Nom</label>
        <input type="text" id="nom" class="form-control" required>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Prénom</label>
        <input type="text" id="prenom" class="form-control" required>
      </div>
    </div>

    <!-- Contact -->
    <div class="section-title">Contacts</div>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Email</label>
        <input type="email" id="email" class="form-control" required>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Téléphone</label>
        <input type="tel" id="telephone" class="form-control">
      </div>
    </div>

    <!-- Fonction -->
    <div class="section-title">Fonction</div>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Fonction</label>
        <input type="text" id="fonction" class="form-control" placeholder="Ex: Chef de projet">
      </div>
    </div>

    <!-- Agence -->
    <div class="section-title">Agence</div>
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
      <span id="agence_label" class="fw-semibold text-primary">Aucune sélection</span>
      <input type="hidden" id="agence">
      <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#agenceModal">
        <i class="bi bi-building-add me-1"></i>Choisir
      </button>
      <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-agence">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Options -->
    <div class="row mt-3">
      <div class="col-md-6 form-check form-switch">
        <input type="checkbox" class="form-check-input" id="actif">
        <label class="form-check-label" for="actif">Actif</label>
      </div>
      <div class="col-md-6 form-check form-switch">
        <input type="checkbox" class="form-check-input" id="admin">
        <label class="form-check-label" for="admin">Administrateur</label>
      </div>
    </div>

    <!-- Buttons -->
    <div class="d-flex gap-2 mt-4">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle me-2"></i>Enregistrer
      </button>
    </div>

  </form>
</div>

<!-- Modal sélection agence -->
<div class="modal fade" id="agenceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <iframe id="agenceFrame" style="width:100%;height:80vh;border:none;"></iframe>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded",async()=>{
  const p=new URLSearchParams(location.search);
  const matricule=p.get("matricule");
  if(!matricule)return location.href="agents.html";

  const token=localStorage.getItem("token");
  const headers=token?{ "Authorization":"Bearer "+token }:{};

  const aH=document.getElementById("agence");
  const aL=document.getElementById("agence_label");

  // Load Agent
  try{
    const res=await fetch(`/api/agents/${matricule}/relations`,{headers});
    const d=await res.json();
    const a=d.agent;

    document.getElementById("nom").value = a.nom||"";
    document.getElementById("prenom").value = a.prenom||"";
    document.getElementById("email").value = a.email||"";
    document.getElementById("telephone").value = a.tel||"";
    document.getElementById("fonction").value = a.fonction || "";
    document.getElementById("actif").checked = !!a.actif;
    document.getElementById("admin").checked = !!a.admin;
    aH.value = a.agence_id || "";
    aL.textContent = d.agence?.titre || "Aucune sélection";
  } catch(e){ console.error(e); }

  // Submit update
  document.getElementById("agent-edit-form").addEventListener("submit",async(ev)=>{
    ev.preventDefault();
    const agenceId = aH.value ? Number(aH.value) : null;
    const fonctionVal = fonction.value.trim();
    const body={
      nom:nom.value.trim(),
      prenom:prenom.value.trim(),
      email:email.value.trim(),
      tel:telephone.value.trim(),
      fonction:fonctionVal || undefined,
      actif:actif.checked,
      admin:admin.checked,
      agence_id:agenceId ?? undefined
    };
    const res=await fetch(`/api/agents/${matricule}`,{
      method:"PUT",
      headers:{"Content-Type":"application/json",...headers},
      body:JSON.stringify(body)
    });
    if(!res.ok)return alert("Erreur");
    location.href=`agent-view.html?matricule=${matricule}`;
  });

  // Select agence from modal
  window.addEventListener("message",(ev)=>{
    if(ev.data?.type!=="agence-select")return;
    const g=ev.data.agence;
    if(!g?.id)return;
    aH.value=g.id;
    aL.textContent=g.titre || g.designation || `Agence #${g.id}`;
    const modalInst = bootstrap.Modal.getInstance(document.getElementById("agenceModal"));
    if (modalInst) modalInst.hide();
  });
  const cancelBtn = document.getElementById("cancel-btn");
  if (cancelBtn) cancelBtn.addEventListener("click",()=>history.back());
  document.getElementById("clear-agence").addEventListener("click",()=>{
    aH.value="";
    aL.textContent="Aucune sélection";
  });

  document.getElementById("agenceModal").addEventListener("show.bs.modal",()=>{
    document.getElementById("agenceFrame").src="/agences.html";
  });

});
</script>
</body>
</html>
