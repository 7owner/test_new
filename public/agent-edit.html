<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifier un agent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
</head>
<body>
  <header class="header d-flex justify-content-between align-items-center mb-4">
    <h1><img src="/logo_logicielle.png" alt="Logo Système de Maintenance" style="height: 40px; vertical-align: middle; margin-right: 10px;"></h1>
    <div id="user-info-container" class="d-flex align-items-center">
      <span class="me-2">Bienvenue, <span id="logged-in-user-email"></span></span>
      <button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">Menu</button>
    </div>
  </header>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item"><a class="nav-link" href="/dashboard.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/agents.html">Agents</a></li>
        <li class="nav-item"><a class="nav-link" href="/sites.html">Sites</a></li>
        <li class="nav-item"><a class="nav-link" href="/interventions.html">Interventions</a></li>
        <li class="nav-item"><a class="nav-link" href="#" id="logout-link">Déconnexion</a></li>
      </ul>
    </div>
  </div>

  <main class="container mt-5">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="agents.html">Agents</a></li>
        <li class="breadcrumb-item active" aria-current="page">Modifier</li>
      </ol>
    </nav>
    <h1 class="mb-4">Modifier un agent</h1>

    <div class="card">
      <div class="card-body">
        <form id="agent-edit-form">
          <h2 class="card-title mb-4">Informations de l'agent</h2>
          <div class="mb-3">
            <label for="matricule" class="form-label">Matricule</label>
            <input type="text" class="form-control" id="matricule" required readonly>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="nom" class="form-label">Nom</label>
              <input type="text" class="form-control" id="nom" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="prenom" class="form-label">Prénom</label>
              <input type="text" class="form-control" id="prenom" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="telephone" class="form-label">Téléphone</label>
              <input type="tel" class="form-control" id="telephone">
            </div>
          </div>
          <div class="mb-3">
            <label for="agence" class="form-label">Agence</label>
            <select class="form-select" id="agence" required></select>
          </div>
          <div class="mb-3 form-check form-switch">
            <input type="checkbox" class="form-check-input" id="actif">
            <label class="form-check-label" for="actif">Actif</label>
          </div>
          <div class="mb-3 form-check form-switch">
            <input type="checkbox" class="form-check-input" id="admin">
            <label class="form-check-label" for="admin">Administrateur</label>
          </div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary" id="save-agent-btn"><i class="bi bi-save me-2"></i>Enregistrer les modifications</button>
            <a href="agents.html" class="btn btn-secondary">Annuler</a>
          </div>
          
          <hr class="my-4">

          <h3 class="mt-4 mb-3">Informations Passeport (Lecture seule)</h3>
          <div class="mb-3">
            <label for="permis" class="form-label">Permis</label>
            <textarea class="form-control" id="permis" rows="2" readonly></textarea>
          </div>
          <div class="mb-3">
            <label for="habilitations" class="form-label">Habilitations</label>
            <textarea class="form-control" id="habilitations" rows="2" readonly></textarea>
          </div>
          <div class="mb-3">
            <label for="certifications" class="form-label">Certifications</label>
            <textarea class="form-control" id="certifications" rows="2" readonly></textarea>
          </div>
          <div class="mb-3">
            <a href="agent-passport-new.html" class="btn btn-info"><i class="bi bi-journal-plus me-2"></i>Gérer le Passeport</a>
          </div>

          <hr class="my-4">

          <h3 class="mt-4 mb-3">Fichiers Associés</h3>
          <div class="mb-3">
            <label for="files" class="form-label">Télécharger des fichiers</label>
            <input class="form-control" type="file" id="files" multiple>
            <small class="form-text text-muted">La logique d'upload n'est pas implémentée dans cette page.</small>
          </div>

        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const matricule = urlParams.get('matricule');
      if (!matricule) {
        alert("Matricule de l'agent manquant.");
        window.location.href = "agents.html";
        return;
      }

      const form = document.getElementById('agent-edit-form');
      const token = localStorage.getItem('token');
      const headers = { 
        'Content-Type': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      };

      const agenceSelect = document.getElementById('agence');
      try {
        const res = await fetch('/api/agences', { headers, credentials: 'same-origin' });
        const agences = await res.json();
        if (Array.isArray(agences)) {
          agences.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = a.titre || `Agence #${a.id}`;
            agenceSelect.appendChild(opt);
          });
        }
      } catch (e) {
        console.warn('Could not load agences', e);
      }

      try {
        const res = await fetch(`/api/agents/${matricule}/relations`, { headers, credentials: 'same-origin' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const agent = data.agent;
        const passeport = data.passeport;

        if (!agent) throw new Error('Agent data not found in response');

        document.getElementById('matricule').value = agent.matricule;
        document.getElementById('nom').value = agent.nom || '';
        document.getElementById('prenom').value = agent.prenom || '';
        document.getElementById('email').value = agent.email || '';
        document.getElementById('telephone').value = agent.tel || '';
        document.getElementById('agence').value = agent.agence_id;
        document.getElementById('actif').checked = agent.actif;
        document.getElementById('admin').checked = agent.admin;

        if (passeport) {
          document.getElementById('permis').value = passeport.permis || '';
          document.getElementById('habilitations').value = passeport.habilitations || '';
          document.getElementById('certifications').value = passeport.certifications || '';
        }

      } catch (e) {
        console.error('Failed to load agent data', e);
        alert("Agent non trouvé ou erreur de chargement.");
        window.location.href = "agents.html";
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const payload = {
          nom: document.getElementById('nom').value.trim(),
          prenom: document.getElementById('prenom').value.trim(),
          email: document.getElementById('email').value.trim(),
          tel: document.getElementById('telephone').value.trim(),
          agence_id: Number(document.getElementById('agence').value),
          actif: document.getElementById('actif').checked,
          admin: document.getElementById('admin').checked
        };

        if (!payload.nom || !payload.prenom || !payload.email || !payload.agence_id) {
          alert('Veuillez remplir tous les champs obligatoires.');
          return;
        }

        try {
          const res = await fetch(`/api/agents/${matricule}`, {
            method: 'PUT',
            headers,
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.error || `HTTP ${res.status}`);
          }
          alert('Agent mis à jour avec succès !');
          window.location.href = `agent-view.html?matricule=${matricule}`;
        } catch (e) {
          console.error('Failed to update agent', e);
          alert('Erreur lors de la mise à jour: ' + e.message);
        }
      });
    });
  </script>
</body>
</html>
