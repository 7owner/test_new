<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveau Client</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    label { display:block; margin:.4rem 0 .2rem; }
    input, textarea { padding:.5rem; width:100%; max-width:520px; }
    button { padding:.5rem .8rem; margin-top:.6rem; }
    .card { border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="app-bg">
<main class="container mt-5">
  <div class="card mb-4">
    <div class="card-header"><strong>Informations Générales</strong></div>
    <div class="card-body">
      <form id="clientRegistrationForm">
        <div class="mb-3">
          <label for="nom_client" class="form-label">Nom du client *</label>
          <input type="text" class="form-control" id="nom_client" required>
        </div>
        <div class="mb-3">
          <label for="representant_nom" class="form-label">Nom du représentant</label>
          <input type="text" class="form-control" id="representant_nom">
        </div>
        <div class="mb-3">
          <label for="representant_email" class="form-label">Email du représentant</label>
          <input type="email" class="form-control" id="representant_email">
        </div>
        <div class="mb-3">
          <label for="representant_tel" class="form-label">Téléphone</label>
          <input type="tel" class="form-control" id="representant_tel">
        </div>
        <div class="mb-3">
          <label for="commentaire" class="form-label">Commentaire</label>
          <textarea class="form-control" id="commentaire" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i>Créer le client
        </button>
      </form>
      <div id="message" class="mt-3"></div>
    </div>
  </div>

  <div id="representant-section" class="card d-none">
    <div class="card-header"><strong>Ajouter un représentant</strong></div>
    <div class="card-body">
      <p class="text-muted">Créez ensuite le compte utilisateur associé au client.</p>
      <form id="representantForm" class="row g-3">
        <div class="col-md-6">
          <label for="rep_email" class="form-label">Email *</label>
          <input type="email" class="form-control" id="rep_email" required>
        </div>
        <div class="col-md-6">
          <label for="rep_password" class="form-label">Mot de passe *</label>
          <input type="password" class="form-control" id="rep_password" required>
        </div>
        <div class="col-md-6">
          <label for="rep_nom" class="form-label">Nom</label>
          <input type="text" class="form-control" id="rep_nom">
        </div>
        <div class="col-md-6">
          <label for="rep_tel" class="form-label">Téléphone</label>
          <input type="tel" class="form-control" id="rep_tel">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-person-plus me-1"></i>Créer le compte
          </button>
        </div>
      </form>
      <div id="rep-message" class="mt-2"></div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('clientRegistrationForm');
  const messageDiv = document.getElementById('message');
  const repSection = document.getElementById('representant-section');
  const repForm = document.getElementById('representantForm');
  const repMessage = document.getElementById('rep-message');
  let createdClientId = null;

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const token = localStorage.getItem('token');
    const payload = {
      nom_client: document.getElementById('nom_client').value,
      representant_nom: document.getElementById('representant_nom').value,
      representant_email: document.getElementById('representant_email').value,
      representant_tel: document.getElementById('representant_tel').value,
      commentaire: document.getElementById('commentaire').value
    };

    try {
      const response = await fetch('/api/clients', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      if (response.ok) {
        createdClientId = data.id;
        messageDiv.className = 'alert alert-success';
        messageDiv.textContent = 'Client créé avec succès.';
        repSection.classList.remove('d-none');
      } else {
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = data.error || 'Erreur lors de la création du client.';
      }
    } catch (error) {
      console.error('Erreur réseau ou inattendue:', error);
      messageDiv.className = 'alert alert-danger';
      messageDiv.textContent = 'Erreur de connexion au serveur.';
    }
  });

  repForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!createdClientId) {
      repMessage.className = 'alert alert-warning';
      repMessage.textContent = 'Créez d’abord le client.';
      return;
    }
    const token = localStorage.getItem('token');
    const body = {
      email: document.getElementById('rep_email').value,
      password: document.getElementById('rep_password').value,
      nom: document.getElementById('rep_nom').value,
      tel: document.getElementById('rep_tel').value
    };
    try {
      const resp = await fetch(`/api/clients/${createdClientId}/representant`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(body)
      });
      const bodyResp = await resp.json().catch(() => ({}));
      if (resp.ok) {
        repMessage.className = 'alert alert-success';
        repMessage.textContent = 'Représentant créé et lié au client.';
        repForm.reset();
      } else {
        repMessage.className = 'alert alert-danger';
        repMessage.textContent = bodyResp.error || 'Erreur lors de la création du représentant.';
      }
    } catch (err) {
      repMessage.className = 'alert alert-danger';
      repMessage.textContent = 'Erreur réseau lors de la création du représentant.';
    }
  });
});
</script>
</body>
</html>
