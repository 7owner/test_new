<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Cr√©er un Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Custom -->
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>

  <style>
    .card {border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);}
  </style>
</head>

<body class="app-bg">

<main class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0"><i class="bi bi-building-add me-2"></i>Nouveau Client</h1>
    <button class="btn btn-outline-secondary" onclick="history.back()">
      <i class="bi bi-arrow-left"></i> Retour
    </button>
  </div>

  <!-- Formulaire cr√©ation -->
  <div class="card mb-4">
    <div class="card-header fw-bold"><i class="bi bi-info-circle"></i> Informations</div>
    <div class="card-body">
      <form id="clientForm">
        <div class="mb-3">
          <label class="form-label">Nom du Client *</label>
          <input id="nom_client" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Adresse (optionnel)</label>
          <select id="adresse_id" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Commentaire</label>
          <textarea id="commentaire" class="form-control" rows="3"></textarea>
        </div>
        <button class="btn btn-primary w-100"><i class="bi bi-save me-1"></i>Cr√©er</button>
      </form>
      <div id="msg" class="mt-3"></div>
    </div>
  </div>

  <!-- Section repr√©sentant -->
  <div id="repSection" class="card d-none">
    <div class="card-header fw-bold"><i class="bi bi-person-plus"></i> Ajouter un Repr√©sentant</div>
    <div class="card-body">
      <form id="repForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nom</label>
          <input id="rep_nom" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">T√©l√©phone</label>
          <input id="rep_tel" class="form-control">
        </div>
        <div class="col-12">
          <label class="form-label">Email *</label>
          <input id="rep_email" type="email" class="form-control" required>
        </div>
        <button class="btn btn-outline-primary w-100">
          <i class="bi bi-person-check me-1"></i>Cr√©er le compte utilisateur
        </button>
      </form>
      <div id="repMsg" class="mt-2"></div>
    </div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login.html";

  const selAdresse = document.getElementById("adresse_id");
  const msg = document.getElementById("msg");
  const repSection = document.getElementById("repSection");
  let newClientId = null;

  async function api(url, opt={}) {
    const h={headers:{'Content-Type':'application/json',"Authorization":"Bearer "+token}};
    const r=await fetch(url,{...opt,...h});
    const body=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(body.error||"Erreur API");
    return body;
  }

  // Charger les adresses
  try {
    const adrs = await api("/api/adresses");
    selAdresse.innerHTML = '<option value="">(aucune)</option>';
    adrs.forEach(a=>{
      selAdresse.innerHTML+=`<option value="${a.id}">${a.libelle||"Adresse #"+a.id}</option>`;
    });
  } catch {}

  // Submit Client
  document.getElementById("clientForm").onsubmit = async e => {
    e.preventDefault();
    msg.textContent="";

    const body = {
      nom_client: nom_client.value.trim(),
      adresse_id: adresse_id.value || null,
      commentaire: commentaire.value || null
    };

    try {
      const r = await api("/api/clients",{method:"POST",body:JSON.stringify(body)});
      newClientId = r.id;
      msg.className="alert alert-success";
      msg.textContent="Client cr√©√© !" ;
      repSection.classList.remove("d-none");
    } catch(e){
      msg.className="alert alert-danger";
      msg.textContent=e.message;
    }
  };

  // Submit Repr√©sentant
  document.getElementById("repForm").onsubmit = async e => {
    e.preventDefault();
    if(!newClientId){
      repMsg.className="alert alert-warning";
      repMsg.textContent="Cr√©ez d'abord un client.";
      return;
    }
    try {
      await api(`/api/clients/${newClientId}/representants`,{
        method:"POST",
        body:JSON.stringify({
          nom: rep_nom.value.trim(),
          tel: rep_tel.value.trim(),
          email: rep_email.value.trim()
        })
      });
      repMsg.className="alert alert-success";
      repMsg.textContent="Repr√©sentant ajout√© üëç";
      repForm.reset();
      setTimeout(()=>location.href=`/client-view.html?id=${newClientId}`,1200);
    } catch(e){
      repMsg.className="alert alert-danger";
      repMsg.textContent=e.message;
    }
  };

});
</script>

</body>
</html>
