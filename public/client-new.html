<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer un Nouveau Client</title>
    <link rel="stylesheet" href="custom.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Créer un Nouveau Client</h1>
        <form id="clientRegistrationForm">
            <div class="mb-3">
                <label for="nom_client" class="form-label">Nom du Client (Entreprise)</label>
                <input type="text" class="form-control" id="nom_client" required>
            </div>
            <div class="mb-3">
              <label for="adresse_id" class="form-label">Adresse</label>
              <select class="form-select" id="adresse_id"></select>
            </div>
            <div class="mb-3">
                <label for="commentaire" class="form-label">Commentaire (Optionnel)</label>
                <textarea class="form-control" id="commentaire" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Créer et Continuer</button>
        </form>
        <div id="message" class="mt-3"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/nav.js?v=2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('clientRegistrationForm');
            const messageDiv = document.getElementById('message');
            const adresseSelect = document.getElementById('adresse_id');
            const token = localStorage.getItem('token');

            async function fetchJSON(url, opts) {
                const res = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    ...opts
                });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(body.error || res.statusText);
                return body;
            }

            async function loadAdresses() {
                try {
                    const adrs = await fetchJSON('/api/adresses');
                    adresseSelect.innerHTML = '<option value="">(Aucune)</option>';
                    adrs.forEach(a => {
                        const o = document.createElement('option');
                        o.value = a.id;
                        o.textContent = a.libelle || `Adresse #${a.id}: ${a.ligne1}, ${a.code_postal} ${a.ville}`;
                        adresseSelect.appendChild(o);
                    });
                } catch (e) {
                    console.error('Failed to load addresses', e);
                }
            }

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const payload = {
                    nom_client: document.getElementById('nom_client').value,
                    adresse_id: document.getElementById('adresse_id').value || null,
                    commentaire: document.getElementById('commentaire').value
                };

                try {
                    const newClient = await fetchJSON('/api/clients', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    messageDiv.className = 'alert alert-success';
                    messageDiv.textContent = 'Client créé avec succès! Redirection vers la page d\'édition...';
                    
                    // Since this page is in an iframe, redirect the parent or the iframe itself
                    // Redirecting the iframe is simpler here. The user will then be on the edit page inside the modal.
                    setTimeout(() => {
                        window.location.href = `/client-edit.html?id=${newClient.id}`;
                    }, 1500);

                } catch (error) {
                    console.error('Erreur lors de la création du client:', error);
                    messageDiv.className = 'alert alert-danger';
                    messageDiv.textContent = error.message || 'Erreur de connexion au serveur.';
                }
            });

            await loadAdresses();
        });
    </script>
</body>
</html>
