<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouvelle Demande d'intervention (Client)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
</head>
<body>
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item"><a class="nav-link" href="/client-dashboard.html"><i class="bi bi-person-workspace me-2"></i>Tableau de bord client</a></li>
      </ul>
    </div>
  </div>

  <main class="container mt-4">
    <h1 class="mb-3">Faire une nouvelle demande</h1>
    <div id="msg" class="alert d-none" role="alert"></div>

    <form id="demandeForm" class="card shadow-sm p-4" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="demandeSiteId" class="form-label">Site (optionnel)</label>
        <select id="demandeSiteId" class="form-select">
          <option value="">-- Sans site --</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="demandeTitre" class="form-label">Titre</label>
        <input type="text" id="demandeTitre" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="demandeDescription" class="form-label">Description</label>
        <textarea id="demandeDescription" class="form-control" rows="4" required></textarea>
      </div>
      <div class="mb-3">
        <label for="demandeImages" class="form-label">Images (optionnel)</label>
        <input type="file" id="demandeImages" class="form-control" accept="image/*" multiple>
        <div class="form-text">Vous pouvez sÃ©lectionner plusieurs images. L'envoi peut nÃ©cessiter des droits supplÃ©mentaires.</div>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">Envoyer</button>
        <a href="/client-dashboard.html" class="btn btn-secondary">Annuler</a>
      </div>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = '/login.html'; return; }
      const msg = document.getElementById('msg');
      const selectSite = document.getElementById('demandeSiteId');
      const form = document.getElementById('demandeForm');

      // Charger la liste des sites du client
      (async function loadSites(){
        try {
          const r = await fetch('/api/client/sites', { headers: { 'Authorization': `Bearer ${token}` } });
          if (!r.ok) throw new Error(r.status);
          const sites = await r.json();
          selectSite.innerHTML = '<option value="">-- Sans site --</option>' + sites.map(s=>`<option value="${s.id}">${s.nom_site || ('Site '+s.id)}</option>`).join('');
        } catch (e) { /* silencieux */ }
      })();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const titre = (document.getElementById('demandeTitre').value || '').trim();
        const description = (document.getElementById('demandeDescription').value || '').trim();
        const sid = String(selectSite.value || '').trim();
        if (!titre) { showMsg('Veuillez renseigner le titre.', 'danger'); return; }
        if (!description) { showMsg('Veuillez renseigner la description.', 'danger'); return; }
        const payload = { titre, description };
        if (sid) payload.site_id = Number(sid);
        try {
          const r = await fetch('/api/demandes_client', {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(payload)
          });
          if (!r.ok) { const t = await safeJson(r); throw new Error(t && t.error ? t.error : `Erreur ${r.status}`); }
          const created = await r.json();
          const demandeId = created && created.id ? created.id : null;
          // Optional images
          const files = Array.from(document.getElementById('demandeImages').files || []);
          if (demandeId && files.length) {
            let uploaded = 0, failed = 0;
            for (const f of files) {
              try {
                const base64 = await fileToBase64(f);
                const up = await fetch('/api/documents', {
                  method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                  body: JSON.stringify({
                    cible_type: 'DemandeClient',
                    cible_id: demandeId,
                    nature: 'Image',
                    nom_fichier: f.name,
                    type_mime: f.type || 'image/jpeg',
                    base64
                  })
                });
                if (!up.ok) throw new Error('upload');
                uploaded++;
              } catch { failed++; }
            }
            if (failed && !uploaded) {
              showMsg("Demande crÃ©Ã©e. Les images n'ont pas pu Ãªtre envoyÃ©es (droits requis).", 'warning');
            } else if (failed) {
              showMsg(`Demande crÃ©Ã©e. ${uploaded} image(s) envoyÃ©e(s), ${failed} Ã©chouÃ©e(s).`, 'warning');
            } else {
              showMsg('Demande et images crÃ©Ã©es avec succÃ¨s. Redirection...', 'success');
            }
          } else {
            showMsg('Demande envoyÃ©e avec succÃ¨s. Redirection...', 'success');
          }
          setTimeout(()=> location.href = '/client-dashboard.html', 900);
        } catch (err) { showMsg(String(err.message || err), 'danger'); }
      });

      function showMsg(text, type) { msg.className = `alert alert-${type}`; msg.textContent = text; }
      async function safeJson(resp){ try { return await resp.json(); } catch { return null; } }
      function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => { const res = String(reader.result||''); const comma = res.indexOf(','); resolve(comma>0?res.slice(comma+1):res); }; reader.onerror = reject; reader.readAsDataURL(file); }); }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

