<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du ticket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
</head>
<body>
  <header class="header d-flex justify-content-between align-items-center mb-4">
    <h1><a href="/dashboard.html"><img src="/logo_logicielle.png" alt="Logo" style="height: 40px; vertical-align: middle; margin-right: 10px;"></a></h1>
    <div id="user-info-container" class="d-flex align-items-center">
      <span class="me-2">Bienvenue, <span id="logged-in-user-email"></span></span>
      <button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">Menu</button>
    </div>
  </header>

  <main class="container mt-5">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="tickets.html">Gestion des Tickets</a></li>
        <li class="breadcrumb-item active" aria-current="page">Détails</li>
      </ol>
    </nav>
    <h1 class="mb-4">Détails du ticket: <span id="ticket-title"></span></h1>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Informations générales</h2>
        <p><strong>ID:</strong> <span id="view_id"></span></p>
        <p><strong>Titre:</strong> <span id="view_titre"></span></p>
        <p><strong>Description:</strong> <span id="view_description"></span></p>
        <p><strong>État:</strong> <span id="view_etat"></span></p>
        <p><strong>Date de début:</strong> <span id="view_date_debut"></span></p>
        <p><strong>Date de fin:</strong> <span id="view_date_fin"></span></p>
        <p><strong>Durée:</strong> <span id="view_duree"></span></p>
        <p><strong>DOE:</strong> <span id="view_doe"></span></p>
        <p><strong>Affaire ID:</strong> <span id="view_affaire_id"></span></p>
        <p><strong>Site:</strong> <span id="view_site"></span></p>
        <p><strong>Responsable principal:</strong> <span id="view_responsable"></span></p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Interventions associées</h2>
        <div id="ticket-interventions-list"></div>
        <a href="intervention-new.html" class="btn btn-primary mt-3 d-none" id="add-intervention-btn"><i class="bi bi-plus-circle me-2"></i>Ajouter une intervention</a>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-3">Responsables</h2>
        <div id="ticket-responsables" class="mb-2"></div>
        <div class="d-flex gap-2 d-none" id="ticket-resp-actions">
          <input class="form-control form-control-sm" id="resp-matricule" placeholder="Matricule (Chef/Admin)">
          <button class="btn btn-sm btn-outline-primary" id="add-resp-btn"><i class="bi bi-person-plus me-1"></i>Ajouter</button>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-3">Agents assignés</h2>
        <div id="ticket-agents" class="mb-2"></div>
        <div class="d-flex gap-2 d-none" id="ticket-agent-actions">
          <input class="form-control form-control-sm" id="agent-matricule" placeholder="Matricule agent">
          <button class="btn btn-sm btn-outline-primary" id="add-agent-btn"><i class="bi bi-person-plus me-1"></i>Assigner</button>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="tickets.html" class="btn btn-secondary">Retour à la liste des tickets</a>
      <a href="ticket-edit.html" class="btn btn-primary d-none" id="edit-ticket-btn"><i class="bi bi-pencil me-2"></i>Modifier le ticket</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const qp = new URLSearchParams(location.search);
      const ticketId = qp.get('id');
      const token = localStorage.getItem('token');
      const headers = token? { 'Authorization': `Bearer ${token}` } : {};
      const isAdmin = (()=>{ try{ const p = token? JSON.parse(atob(token.split('.')[1])):null; return Array.isArray(p?.roles)&&p.roles.includes('ROLE_ADMIN'); } catch { return false; } })();
      function set(id, val){ const el=document.getElementById(id); if(el) el.textContent = val||''; }
      function fmt(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)? '' : d.toLocaleString(); }
      try {
        const res = await fetch(`/api/tickets/${ticketId}/relations`, { headers, credentials: 'same-origin' });
        if (res.status===401||res.status===403){ location.href='/login.html'; return; }
        const data = await res.json(); if (!res.ok) throw new Error(data && data.error || `HTTP ${res.status}`);
        const t = data.ticket; if (!t) throw new Error('Not found');
        document.getElementById('ticket-title').textContent = t.titre || '(Sans titre)';
        set('view_id', t.id); set('view_titre', t.titre||''); set('view_description', t.description||''); set('view_etat', t.etat||'');
        set('view_date_debut', fmt(t.date_debut)); set('view_date_fin', t.date_fin? fmt(t.date_fin) : 'En cours');
        if (t.date_debut && t.date_fin) { const dd=new Date(t.date_debut), df=new Date(t.date_fin); const dj=Math.floor((df-dd)/(1000*60*60*24)); set('view_duree', `${dj} jours`); }
        const doe = data.doe; const doeEl=document.getElementById('view_doe');
        if (doeEl) doeEl.innerHTML = (doe && doe.id) ? `<a href="doe-view.html?id=${doe.id}">${doe.titre || 'DOE'}</a>` : 'N/A';
        const affaire = data.affaire; set('view_affaire_id', (affaire && affaire.id)? affaire.id : 'N/A');
        const siteEl = document.getElementById('view_site');
        if (siteEl) {
          const s = data.site; if (s && s.id) { const name = s.nom_site? ` — ${s.nom_site}` : ''; siteEl.innerHTML = `<a href="site-view.html?id=${s.id}">Site #${s.id}${name}</a>`; }
          else if (t.site_id) siteEl.innerHTML = `<a href="site-view.html?id=${t.site_id}">Site #${t.site_id}</a>`; else siteEl.textContent='N/A';
        }
        set('view_responsable', t.responsable || 'Non assigné');

        const list = document.getElementById('ticket-interventions-list'); list.innerHTML = '';
        const items = Array.isArray(data.interventions)? data.interventions : [];
        if (!items.length) list.innerHTML = '<p class="text-muted">Aucune intervention associée.</p>';
        items.forEach(inter => {
          const el = document.createElement('div'); el.className='card card-body mb-2';
          el.innerHTML = `<div class=\"d-flex justify-content-between align-items-center\">`
            + `<div><h6 class=\"mb-1\">${inter.description||''}</h6>`
            + `<small class=\"text-muted\">Du ${fmt(inter.date_debut)||''} au ${fmt(inter.date_fin)||'N/A'}</small></div>`
            + `<div><a href=\"intervention-view.html?id=${inter.id}\" class=\"btn btn-sm btn-info me-1\"><i class=\"bi bi-eye\"></i> Voir</a></div>`
            + `</div>`;
          list.appendChild(el);
        });

        // Responsables et agents assignés
        const respWrap = document.getElementById('ticket-responsables');
        const agentsWrap = document.getElementById('ticket-agents');
        if (respWrap) {
          const arr = data.responsables || data.responsables_secondaires || [];
          respWrap.innerHTML = arr.length? '' : '<span class="text-muted">Aucun responsable secondaire.</span>';
          arr.forEach(r=>{ const el=document.createElement('div'); el.className='small'; el.textContent = (r.actor_email||r.actor_name||'') + (r.role? ` (${r.role})`: ''); respWrap.appendChild(el); });
        }
        if (agentsWrap) {
          const arr = data.agents_assignes || [];
          agentsWrap.innerHTML = arr.length? '' : '<span class="text-muted">Aucun agent assigné.</span>';
          arr.forEach(a=>{ const el=document.createElement('div'); el.className='small'; el.textContent = a.agent_matricule; agentsWrap.appendChild(el); });
        }

        if (isAdmin) {
          const addInt = document.getElementById('add-intervention-btn'); if (addInt) addInt.classList.remove('d-none');
          const editBtn = document.getElementById('edit-ticket-btn'); if (editBtn) editBtn.classList.remove('d-none');
          const respAct = document.getElementById('ticket-resp-actions'); if (respAct) respAct.classList.remove('d-none');
          const agAct = document.getElementById('ticket-agent-actions'); if (agAct) agAct.classList.remove('d-none');
          const addResp = document.getElementById('add-resp-btn'); if (addResp) addResp.onclick = async ()=>{
            const m = document.getElementById('resp-matricule').value.trim(); if (!m) return alert('Matricule requis');
            const rr = await fetch(`/api/tickets/${ticketId}/responsables`, { method:'POST', credentials:'same-origin', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body: JSON.stringify({ agent_matricule:m }) });
            const jd = await rr.json().catch(()=>({})); if (!rr.ok) return alert(jd.error||`HTTP ${rr.status}`); location.reload(); };
          const addAgent = document.getElementById('add-agent-btn'); if (addAgent) addAgent.onclick = async ()=>{
            const m = document.getElementById('agent-matricule').value.trim(); if (!m) return alert('Matricule requis');
            const rr = await fetch(`/api/tickets/${ticketId}/agents`, { method:'POST', credentials:'same-origin', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body: JSON.stringify({ agent_matricule:m }) });
            const jd = await rr.json().catch(()=>({})); if (!rr.ok) return alert(jd.error||`HTTP ${rr.status}`); location.reload(); };
        }
      } catch(e) {
        document.getElementById('ticket-title').textContent = 'Ticket introuvable';
      }
    });
  </script>
</body>
</html>

