<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du Ticket</title>

  <!-- Styles externes -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 1.5rem;
    }
    .main-card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      margin-bottom: 1.5rem;
      background: white;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .main-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }
    .card-header-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      border: none;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    .info-item {
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    .info-item label {
      font-size: 0.75rem;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
      margin-bottom: 0.25rem;
    }
    .info-item .value {
      font-size: 1rem;
      font-weight: 600;
      color: #212529;
    }
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }
    .status-en-attente { background: #fff3cd; color: #856404; }
    .status-en-cours { background: #cfe2ff; color: #084298; }
    .status-termine { background: #d1e7dd; color: #0f5132; }
    .intervention-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    .intervention-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
      transform: translateX(4px);
    }
    .member-card {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-left: 4px solid #667eea;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .avatar {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      margin-right: 1rem;
    }
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      color: white;
    }
    .btn-outline-gradient {
      border: 2px solid #667eea;
      color: #667eea;
      background: transparent;
      padding: 0.6rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-outline-gradient:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }
    .admin-section {
      background: linear-gradient(135deg, #f093fb15 0%, #f5576c15 100%);
      border-radius: 16px;
      padding: 1.5rem;
      border: 2px dashed #f093fb;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .timer-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
      font-family: 'Courier New', monospace;
    }
    .link-button {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .link-button:hover {
      color: #764ba2;
      text-decoration: underline;
    }
    /* Cartes représentants client */
    .client-rep-card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e9ecef;
      padding: 0.9rem 1rem;
      margin-bottom: 0.6rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .client-rep-avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .client-rep-main {
      flex: 1;
    }
    .client-rep-main .name {
      font-weight: 600;
    }
    .client-rep-main .meta {
      font-size: 0.85rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
<div class="container-fluid" style="max-width: 1400px;">

  <!-- ✅ HEADER -->
  <div class="main-card">
    <div class="card-header-gradient d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h4 class="mb-0 d-flex align-items-center">
        <i class="bi bi-ticket-detailed me-2"></i>
        <span id="header-title">Ticket</span>
      </h4>
      <!--<div class="small opacity-75" id="header-status-text"></div>-->
    </div>

    <!-- ✅ Ticket Infos -->
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
       <!-- <h3 class="mb-0 fw-semibold d-flex align-items-center"><i class="bi bi-info-circle me-2"></i><span id="view_titre">-</span></h3>-->
        <div class="d-flex gap-2">
          <!--<a href="tickets.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Retour</a>
          <a id="edit-ticket-btn" href="#" class="btn btn-primary btn-sm d-none"><i class="bi bi-pencil-square me-1"></i>Modifier</a>-->
        </div>
      </div>
      <div class="info-grid">
        <div class="info-item"><label>État</label><div class="value" id="view_etat">-</div></div>
        <div class="info-item"><label>Temps écoulé</label><div class="value timer-display" id="view_elapsed">-</div></div>
        <div class="info-item"><label>Début</label><div class="value" id="view_date_debut">-</div></div>
        <div class="info-item"><label>Fin</label><div class="value" id="view_date_fin">-</div></div>
        <div class="info-item"><label>Affaire</label><div class="value" id="view_affaire">-</div></div>
        <div class="info-item"><label>DOE</label><div class="value" id="view_doe">-</div></div>
       <!-- <div class="info-item"><label>Site</label><div class="value" id="view_site">-</div></div>-->
        <div class="info-item"><label>Responsable principal</label><div class="value" id="view_responsable">-</div></div>
      </div>

      <div class="mt-4">
        <label class="text-muted small fw-bold"><i class="bi bi-text-paragraph me-1"></i>Description :</label>
        <div class="p-3 bg-light rounded" id="view_description">-</div>
      </div>
    </div>
  </div>

  <!-- Interventions section -->
  <div class="main-card">
    <div class="card-header-gradient d-flex justify-content-between align-items-center">
      <span><i class="bi bi-wrench-adjustable me-2"></i>Interventions</span>
      <button id="add-intervention-btn" class="btn btn-light btn-sm d-none" data-bs-toggle="modal" data-bs-target="#createInterventionModal">
        <i class="bi bi-plus-circle me-1"></i>Ajouter
      </button>
    </div>
    <div class="card-body p-4">
      <h3 class="mb-3 fw-semibold"><i class="bi bi-list-task me-2"></i>Suivi des interventions</h3>
      <div id="ticket-interventions-list">
        <div class="loading-spinner"><div class="spinner-border text-primary"></div></div>
      </div>
    </div>
  </div>

  <!-- Site associé -->
  <div class="main-card">
    <div class="card-header-gradient d-flex justify-content-between align-items-center">
      <span class="d-flex align-items-center gap-2"><i class="bi bi-building me-1"></i>Site associé</span>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-light text-dark" id="site-statut">-</span>
        <a id="site-view-link" class="btn btn-light btn-sm d-none" href="#"><i class="bi bi-eye"></i> Voir le site</a>
      </div>
    </div>
    <div class="card-body p-4">
      <div class="hero mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="title" id="site-name">—</div>
            <div class="subtitle small">
              Client : <span id="view_client" class="link-button">—</span>
              <span class="ms-3">Contact : <span id="view_contact">—</span></span>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="mb-2">
          <div class="fw-semibold text-secondary">Adresse</div>
          <div id="view_adresse" class="text-body">—</div>
        </div>
        <div class="mb-2">
          <div class="fw-semibold text-secondary">Commentaire</div>
          <div id="view_commentaire" class="text-body">—</div>
        </div>
      </div>
      <div class="card mt-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0">Représentants client</h2>
          </div>
          <div id="representants-list">
            <div class="text-muted">Chargement...</div>
          </div>
          <div class="mt-3 d-flex justify-content-end">
            <button class="btn btn-outline-primary btn-sm d-none" id="view-messages-btn">
              <i class="bi bi-chat-dots me-1"></i> Voir messages
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Matériels / Commandes -->
  <div class="main-card">
    <div class="card-header-gradient d-flex justify-content-between align-items-center">
      <span class="d-flex align-items-center gap-2"><i class="bi bi-box-seam me-1"></i>Matériels & commandes</span>
      <button class="btn btn-light btn-sm d-none" id="add-materiel-btn">
        <i class="bi bi-plus-circle me-1"></i>Ajouter un matériel
      </button>
    </div>
    <div class="card-body p-4">
      <div id="materiels-list">
        <div class="text-muted">Chargement...</div>
      </div>
    </div>
  </div>

  <!-- Responsables / Agents -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="main-card h-100">
        <div class="card-header-gradient d-flex justify-content-between align-items-center">
          <span><i class="bi bi-people me-2"></i>Responsables</span>
          <button id="add-responsable-btn" class="btn btn-light btn-sm d-none" data-bs-toggle="modal" data-bs-target="#addResponsableModal">
            <i class="bi bi-plus-circle me-1"></i>Ajouter
          </button>
        </div>
        <div class="card-body p-4">
          <h3 class="mb-3 fw-semibold"><i class="bi bi-people-fill me-2"></i>Responsables</h3>
          <div id="responsables-list"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="main-card h-100">
        <div class="card-header-gradient d-flex justify-content-between align-items-center">
          <span><i class="bi bi-person-gear me-2"></i>Agents</span>
          <button id="add-agent-btn" class="btn btn-light btn-sm d-none" data-bs-toggle="modal" data-bs-target="#addAgentModal">
            <i class="bi bi-plus-circle me-1"></i>Ajouter
          </button>
        </div>
        <div class="card-body p-4">
          <h3 class="mb-3 fw-semibold"><i class="bi bi-person-badge me-2"></i>Agents assignés</h3>
          <div id="agents-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Admin -->
  <div id="admin-actions-card" class="main-card d-none">
    <div class="card-header-gradient"><i class="bi bi-shield-lock me-2"></i>Actions Admin</div>
    <div class="card-body p-4 admin-section">
      <button class="btn btn-outline-gradient" data-bs-toggle="modal" data-bs-target="#createAffaireModal">
        Créer Affaire
      </button>
      <button class="btn btn-outline-gradient" data-bs-toggle="modal" data-bs-target="#createDoeModal">
        Créer DOE
      </button>
    </div>
  </div>

</div>

<!-- Modale création intervention -->
<div class="modal fade" id="createInterventionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-wrench-adjustable me-2"></i>Nouvelle intervention</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="create-intervention-form">
          <div class="mb-3">
            <label for="intervention-titre" class="form-label fw-bold">Titre</label>
            <input type="text" id="intervention-titre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="intervention-description" class="form-label fw-bold">Description</label>
            <textarea id="intervention-description" class="form-control" rows="3" required></textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="intervention-date-debut" class="form-label fw-bold">Date début</label>
              <input type="date" id="intervention-date-debut" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label for="intervention-date-fin" class="form-label fw-bold">Date fin (optionnel)</label>
              <input type="date" id="intervention-date-fin" class="form-control">
            </div>
          </div>
          <input type="hidden" id="intervention-status" value="En_attente">
          <button type="submit" class="btn btn-gradient w-100">
            <i class="bi bi-check-circle me-2"></i>Créer l'intervention
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modale ajout responsable -->
<div class="modal fade" id="addResponsableModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Ajouter un responsable</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addResponsableForm">
          <div class="mb-3">
            <label for="responsable-select" class="form-label fw-bold">Sélectionner un agent admin</label>
            <select id="responsable-select" class="form-select" required>
              <option value="">-- Sélectionner --</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-gradient" id="save-responsable-btn">
          <i class="bi bi-check-circle me-1"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modale ajout agent -->
<div class="modal fade" id="addAgentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Ajouter un agent</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addAgentForm">
          <div class="mb-3">
            <label for="agent-select" class="form-label fw-bold">Sélectionner un agent</label>
            <select id="agent-select" class="form-select" required>
              <option value="">-- Sélectionner --</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-gradient" id="save-agent-btn">
          <i class="bi bi-check-circle me-1"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modale création affaire -->
<div class="modal fade" id="createAffaireModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-briefcase me-2"></i>Nouvelle affaire</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="create-affaire-form">
          <div class="mb-3">
            <label for="affaire-nom" class="form-label fw-bold">Nom de l'affaire</label>
            <input type="text" id="affaire-nom" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="affaire-numero" class="form-label fw-bold">Numéro (optionnel)</label>
            <input type="text" id="affaire-numero" class="form-control">
          </div>
          <div class="mb-3">
            <label for="affaire-description" class="form-label fw-bold">Description</label>
            <textarea id="affaire-description" class="form-control" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-check-circle me-2"></i>Créer et lier
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

  <!-- Modale création DOE -->
  <div class="modal fade" id="createDoeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Nouveau DOE</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="create-doe-form">
          <div class="mb-3">
            <label for="doe-titre" class="form-label fw-bold">Titre</label>
            <input type="text" id="doe-titre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="doe-description" class="form-label fw-bold">Description</label>
            <textarea id="doe-description" class="form-control" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-info w-100">
            <i class="bi bi-check-circle me-2"></i>Créer et lier
          </button>
        </form>
      </div>
    </div>
  </div>
  </div>

  <!-- Modale client -->
  <div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Client</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" style="height:80vh;">
          <iframe id="clientModalFrame" src="about:blank" style="width:100%;height:100%;border:0;"></iframe>
        </div>
      </div>
    </div>
  </div>

<!-- Modale messages demande -->
  <div class="modal fade" id="messagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-chat-dots me-2"></i>Messages de la demande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="messages-container">
            <div class="text-muted">Chargement...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale ajout / édition matériel -->
  <div class="modal fade" id="materielModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Ajouter un matériel</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="materiel-form">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Référence</label>
                <input type="text" class="form-control" id="mat-ref" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Désignation</label>
                <input type="text" class="form-control" id="mat-designation" required>
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Catégorie / Métier</label>
                <input type="text" class="form-control" id="mat-categorie" placeholder="GTB, vidéo, intrusion...">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Fabricant</label>
                <input type="text" class="form-control" id="mat-fabricant">
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Prix achat (€)</label>
                <input type="number" step="0.01" class="form-control" id="mat-prix" placeholder="0.00">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Statut commande</label>
                <select class="form-select" id="mat-status">
                  <option value="">—</option>
                  <option value="En attente">En attente</option>
                  <option value="Commande en cours">Commande en cours</option>
                  <option value="Reçue">Reçue</option>
                  <option value="Installée">Installée</option>
                  <option value="Annulée">Annulée</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-8">
                <label class="form-label fw-semibold">Intervention liée</label>
                <select class="form-select" id="mat-intervention" required></select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Commentaire</label>
                <input type="text" class="form-control" id="mat-commentaire">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="save-materiel-btn">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modals et JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function() {
      const qp = new URLSearchParams(location.search);
      const ticketId = qp.get('id');
      const token = localStorage.getItem('token');
      const userPayload = (()=>{ try{ return token? JSON.parse(atob(token.split('.')[1])):null; } catch { return null; } })();
      const userId = userPayload ? userPayload.id : null;
      const headers = token? { 'Authorization': `Bearer ${token}` } : {};
      const isAdmin = (()=>{ try{ const p = token? JSON.parse(atob(token.split('.')[1])):null; return Array.isArray(p?.roles)&&p.roles.includes('ROLE_ADMIN'); } catch { return false; } })();
      function set(id, val){ const el=document.getElementById(id); if(el) el.textContent = val||''; }
      function fmt(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)? '' : d.toLocaleString(); }
      let elapsedTimer = null;
      const elapsedEl = document.getElementById('view_elapsed');
      function formatElapsed(ms){
        if (!ms || ms<0) return '';
        const totalMin = Math.floor(ms/60000);
        const days = Math.floor(totalMin/(60*24));
        const hours = Math.floor((totalMin%(60*24))/60);
        const mins = totalMin%60;
        return `${days}j ${String(hours).padStart(2,'0')}h ${String(mins).padStart(2,'0')}m`;
      }
      function startElapsed(startIso, endIso){
        if (!elapsedEl || !startIso) return;
        if (elapsedTimer) clearInterval(elapsedTimer);
        const startMs = new Date(startIso).getTime();
        if (!startMs || isNaN(startMs)) return;
        const endMs = endIso ? new Date(endIso).getTime() : null;
        const update = () => {
          const now = endMs && !isNaN(endMs) ? endMs : Date.now();
          elapsedEl.textContent = formatElapsed(now - startMs);
        };
        update();
        if (!endMs || isNaN(endMs)) {
          elapsedTimer = setInterval(update, 1000);
        }
      }

      async function fetchJSON(url, opts) {
        const init = Object.assign(
          { credentials: 'same-origin', headers: Object.assign({}, headers) },
          opts || {}
        );
        // Merge headers if provided in opts
        if (opts && opts.headers) {
          init.headers = Object.assign({}, headers, opts.headers);
        }
        const r = await fetch(url, init);
        const ct = r.headers.get('content-type') || '';
        const b = ct.includes('application/json') ? await r.json().catch(() => null) : null;
        if (!r.ok) throw new Error((b && b.error) || r.statusText);
        return b;
      }
      const materielsListEl = document.getElementById('materiels-list');
      const addMaterielBtn = document.getElementById('add-materiel-btn');
      const materielModalEl = document.getElementById('materielModal');
      const materielModal = materielModalEl ? new bootstrap.Modal(materielModalEl) : null;
      const matStatusOptions = ['En attente','Commande en cours','Reçue','Installée','Annulée'];
      let interventionsCache = [];
      try {
        const res = await fetch(`/api/tickets/${ticketId}/relations`, { headers, credentials: 'same-origin' });
        if (res.status===401||res.status===403){ location.href='/login.html'; return; }
        const data = await res.json();
        if (!res.ok) throw new Error(data && data.error || `HTTP ${res.status}`);
        const t = data.ticket; if (!t) throw new Error('Not found');
        let demandeId = t.demande_id || null;
        if (!demandeId && Array.isArray(data.demandes) && data.demandes.length) {
          demandeId = data.demandes.reduce((acc, d) => acc && acc > d.id ? acc : d.id, null);
        }
        // Si au moins une intervention, forcer état affiché à En cours
        if (Array.isArray(data.interventions) && data.interventions.length > 0 && t.etat !== 'Termine') {
          t.etat = 'En_cours';
        }
        set('ticket-title', t.titre || '(Sans titre)');
        const title = t.titre || '(Sans titre)';
        const headerTitle = document.getElementById('header-title');
        if (headerTitle) headerTitle.textContent = title;
        set('view_titre', title); set('view_description', t.description||''); set('view_etat', t.etat||'');
        set('view_date_debut', fmt(t.date_debut)); set('view_date_fin', t.date_fin? fmt(t.date_fin) : 'En cours');
        const endIso = (t.etat === 'Termine')
          ? (t.date_fin || new Date().toISOString())
          : t.date_fin;
        startElapsed(t.date_debut, endIso);
        const headerStatusText = document.getElementById('header-status-text');
        if (headerStatusText) headerStatusText.textContent = t.etat || '';
        const doe = data.doe;
        const doeEl=document.getElementById('view_doe');
        if (doeEl) doeEl.innerHTML = (doe && doe.id) ? `<a href="doe-view.html?id=${doe.id}">${doe.titre || 'DOE'}</a>` : 'N/A';
        
        const affaire = data.affaire;
        const affaireEl = document.getElementById('view_affaire');
        if (affaireEl) {
          if (affaire && affaire.id) {
            affaireEl.innerHTML = `<a href="affaire-view.html?id=${affaire.id}">${affaire.nom_affaire || 'Affaire #' + affaire.id} (${affaire.numero_affaire || 'N/A'})</a>`;
          } else {
            affaireEl.textContent = 'N/A';
          }
        }
        
        const siteEl = document.getElementById('view_site');
        if (siteEl) {
          const s = data.site; if (s && s.id) { const name = s.nom_site? ` — ${s.nom_site}` : ''; siteEl.innerHTML = `<a href="site-view.html?id=${s.id}">Site #${s.id}${name}</a>`; }
          else if (t.site_id) siteEl.innerHTML = `<a href="site-view.html?id=${t.site_id}">Site #${t.site_id}</a>`; else siteEl.textContent='N/A';
        }

        // Carte Site associé
        const siteData = data.site || {};
        let clientId = siteData.client_id || data.client?.id || t.client_id;
        const siteNom = siteData.nom_site || `Site #${siteData.id || t.site_id || ''}` || 'N/A';
        let siteClient = siteData.client_nom || data.client?.nom_client || 'N/A';
        let siteStatut = siteData.status || siteData.statut || 'N/A';
        const siteLink = document.getElementById('site-view-link');
        if (siteLink && siteData.id) {
          siteLink.classList.remove('d-none');
          siteLink.href = `site-view.html?id=${siteData.id}`;
        }
        document.getElementById('site-name').textContent = siteNom;
        document.getElementById('view_client').textContent = siteClient;
        document.getElementById('site-statut').textContent = siteStatut;
        const contactStr = `${siteData.representant_nom || ''} ${siteData.representant_tel || ''}`.trim();
        const contactEl = document.getElementById('view_contact');
        if (contactEl) contactEl.textContent = contactStr || 'Non spécifié';

        // Chargement complet des infos du site (adresse + représentants), comme dans site-view
        const fillSiteDetails = (rel) => {
          const adresse = rel?.adresse;
          if (adresse) {
            const adrHtml = [
              adresse.ligne1,
              adresse.ligne2,
              `${adresse.code_postal || ''} ${adresse.ville || ''}`.trim(),
              adresse.pays
            ].filter(Boolean).join('<br>');
            document.getElementById('view_adresse').innerHTML = adrHtml || '—';
          } else {
            document.getElementById('view_adresse').textContent = siteData.adresse_libelle || siteData.adresse || 'N/A';
          }
          if (rel?.site?.nom_client) {
            siteClient = rel.site.nom_client;
            document.getElementById('view_client').textContent = siteClient;
          }
          if (rel?.site?.status || rel?.site?.statut) {
            siteStatut = rel.site.status || rel.site.statut;
            document.getElementById('site-statut').textContent = siteStatut;
          }
          const contactStr2 = `${rel?.site?.representant_nom || rel?.site?.contact_nom || ''} ${rel?.site?.representant_tel || rel?.site?.contact_tel || ''}`.trim();
          if (contactStr2 && contactEl) contactEl.textContent = contactStr2;
          const commEl = document.getElementById('view_commentaire');
          if (commEl) commEl.textContent = rel?.site?.commentaire || siteData.commentaire || 'Aucun commentaire';

          const repsList = document.getElementById('representants-list');
          if (repsList) {
            repsList.innerHTML = '';
            const reps = rel?.representants || data.representants || [];
            if (!reps.length) {
              repsList.innerHTML = '<div class="text-muted">Aucun représentant.</div>';
            } else {
              reps.forEach(rep => {
                const badge = (rep.nom || rep.email || 'N')[0].toUpperCase();
                repsList.innerHTML += `
                  <div class="d-flex align-items-start mb-2">
                    <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                      ${badge}
                    </div>
                    <div class="ms-3">
                      <div class="fw-semibold">${rep.nom || 'Inconnu'}</div>
                      <div class="small text-muted">${rep.fonction || ''}</div>
                      <div class="small text-muted"><i class="bi bi-envelope me-1"></i>${rep.email || 'N/A'} ${rep.tel ? `<span class="ms-2"><i class="bi bi-phone me-1"></i>${rep.tel}</span>` : ''}</div>
                    </div>
                  </div>`;
              });
            }
          }
        };

        if (siteData.id) {
          try {
            const relRes = await fetch(`/api/sites/${siteData.id}/relations`, { headers, credentials: 'same-origin' });
            if (relRes.ok) {
              const rel = await relRes.json();
              if (rel?.site?.client_id) clientId = rel.site.client_id;
              fillSiteDetails(rel);
            } else {
              fillSiteDetails({ site: siteData });
            }
          } catch {
            fillSiteDetails({ site: siteData });
          }
        } else {
          fillSiteDetails({ site: siteData });
        }

        // Modal client (ouvre client-view dans une iframe)
        const clientLink = document.getElementById('view_client');
        if (clientId && clientLink) {
          clientLink.classList.add('link-button');
          clientLink.addEventListener('click', () => {
            const frame = document.getElementById('clientModalFrame');
            if (frame) frame.src = `client-view.html?id=${clientId}`;
            const modalEl = document.getElementById('clientModal');
            if (modalEl) bootstrap.Modal.getOrCreateInstance(modalEl).show();
          });
        }

        const messagesBtn = document.getElementById('view-messages-btn');
        if (messagesBtn && ticketId) {
          messagesBtn.classList.remove('d-none');
          messagesBtn.addEventListener('click', async () => {
            let conversationId = null;
            // priorité : demande liée
            if (demandeId) {
              conversationId = `demande-${demandeId}`;
            } else {
              // tentative de récupérer une demande depuis les relations à la volée
              try {
                const fresh = await fetchJSON(`/api/tickets/${ticketId}/relations`);
                if (Array.isArray(fresh?.demandes) && fresh.demandes.length) {
                  const dId = fresh.demandes.reduce((acc, d) => acc && acc > d.id ? acc : d.id, null);
                  if (dId) conversationId = `demande-${dId}`;
                }
              } catch (e) {
                console.warn('Impossible de récupérer les demandes pour le ticket', e);
              }
              // fallback ticket
              if (!conversationId) conversationId = `ticket-${ticketId}`;
            }
            // redirection messagerie avec double paramètre pour compatibilité
            const qs = new URLSearchParams();
            qs.set('conversation', conversationId);
            qs.set('embed', '1'); // pour masquage éventuel nav
            window.location.href = `/messagerie.html?${qs.toString()}`;
          });
        }
        set('view_responsable', t.responsable || 'Non assigné');

        const list = document.getElementById('ticket-interventions-list'); list.innerHTML = '';
        const items = Array.isArray(data.interventions)? data.interventions : [];
        interventionsCache = items;
        if (!interventionsCache.length && ticketId) {
          try {
            const extraInter = await fetchJSON(`/api/interventions?ticket_id=${ticketId}`);
            if (Array.isArray(extraInter)) interventionsCache = extraInter;
          } catch (err) {
            console.warn('Impossible de récupérer les interventions du ticket', err);
          }
        }
        if (!items.length) list.innerHTML = '<p class="text-muted">Aucune intervention associée.</p>';
        items.forEach(inter => {
          const el = document.createElement('div'); el.className='card card-body mb-2';
          const interElapsed = inter.date_debut ? formatElapsed((inter.date_fin ? new Date(inter.date_fin).getTime() : Date.now()) - new Date(inter.date_debut).getTime()) : '';
          el.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${inter.titre || '(Sans titre)'}</h6>
                <div class="text-muted small">${inter.description || ''}</div>
                <small class="text-muted">Du ${fmt(inter.date_debut)||''} au ${fmt(inter.date_fin)||'N/A'}</small>
              </div>
              <div class="text-end">
                <div class="small text-muted mb-1">Temps écoulé: ${interElapsed || '—'}</div>
                <a href="intervention-view.html?id=${inter.id}" class="btn btn-sm btn-info me-1"><i class="bi bi-eye"></i> Voir</a>
              </div>
            </div>`;
          list.appendChild(el);
        });

        // Responsables et agents assignés
        const responsablesList = document.getElementById('responsables-list');
        const agentsList = document.getElementById('agents-list');

        function renderResponsables(arr) {
          if (!responsablesList) return;
          responsablesList.innerHTML = '';
          if (!arr || !arr.length) {
            responsablesList.innerHTML = '<li class="list-group-item text-muted">Aucun responsable.</li>';
            return;
          }
          arr.forEach(r => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            const label = (r.actor_email || r.actor_name || r.agent_matricule || 'Responsable')
              + (r.role ? ` (${r.role})` : '');
            li.textContent = label;
            responsablesList.appendChild(li);
          });
        }

        function renderAgents(arr) {
          const container = document.getElementById('agents-list');
          if (!container) return;
          container.innerHTML = '';
          
          if (!arr || !arr.length) {
            agentsList.innerHTML = '<li class="list-group-item text-muted">Aucun agent assigné.</li>';
            return;
          }
          arr.forEach(a => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = a.agent_matricule || a.matricule || 'Agent';
            agentsList.appendChild(li);
          });
        }

        const responsables = data.responsables || data.responsables_secondaires || [];
        const agentsAssignes = data.agents_assignes || [];
        renderResponsables(responsables);
        renderAgents(agentsAssignes);
        await loadMaterielsSection(interventionsCache);

        // Admin features
        if (isAdmin) {
          const addInt = document.getElementById('add-intervention-btn');
          if (addInt) addInt.classList.remove('d-none');
          const addResp = document.getElementById('add-responsable-btn');
          if (addResp) addResp.classList.remove('d-none');
          const addAgent = document.getElementById('add-agent-btn');
          if (addAgent) addAgent.classList.remove('d-none');
          if (addMaterielBtn) addMaterielBtn.classList.remove('d-none');
          const editBtn = document.getElementById('edit-ticket-btn');
          if (editBtn) editBtn.classList.remove('d-none');
          const adminActions = document.getElementById('admin-actions-card');
          if (adminActions) adminActions.classList.remove('d-none');

          // Chargement des agents pour les sélecteurs
          let allAgents = [];
          try {
            const agentsRes = await fetch('/api/agents', { headers, credentials: 'same-origin' });
            if (agentsRes.ok) {
              allAgents = await agentsRes.json();
            }
          } catch {}

          const responsableSelect = document.getElementById('responsable-select');
          const agentSelect = document.getElementById('agent-select');

          function populateSelect(selectEl, filterFn) {
            if (!selectEl) return;
            selectEl.innerHTML = '<option value="">-- Sélectionner --</option>';
            (allAgents || [])
              .filter(filterFn || (() => true))
              .forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.matricule;
                opt.textContent = `${a.matricule} - ${a.nom} ${a.prenom}`;
                selectEl.appendChild(opt);
              });
          }

          // Responsable : admin + Chef
          populateSelect(responsableSelect, a =>
            Array.isArray(a.roles) && a.roles.includes('ROLE_ADMIN')
          );
          // Agents : tous
          populateSelect(agentSelect);

          const saveResponsableBtn = document.getElementById('save-responsable-btn');
          if (saveResponsableBtn && responsableSelect) {
            saveResponsableBtn.addEventListener('click', async () => {
              const matricule = responsableSelect.value;
              if (!matricule) return alert('Veuillez sélectionner un responsable.');
              try {
                const resPost = await fetch(`/api/tickets/${ticketId}/responsables`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  credentials: 'same-origin',
                  body:  JSON.stringify({
                          agent_matricule: matricule,
                          matricule        : matricule
                        })
                });
                const body = await resPost.json().catch(() => ({}));
                if (!resPost.ok) throw new Error(body.error || 'Erreur lors de l\'ajout du responsable');
                alert('Responsable ajouté avec succès.');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }

          const saveAgentBtn = document.getElementById('save-agent-btn');
          if (saveAgentBtn && agentSelect) {
            saveAgentBtn.addEventListener('click', async () => {
              const matricule = agentSelect.value;
              if (!matricule) return alert('Veuillez sélectionner un agent.');
              try {
                const resPost = await fetch(`/api/tickets/${ticketId}/agents`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  credentials: 'same-origin',
                  body:  JSON.stringify({
                          agent_matricule: matricule,
                          matricule        : matricule
                        })
                });
                const body = await resPost.json().catch(() => ({}));
                if (!resPost.ok) throw new Error(body.error || 'Erreur lors de l\'assignation de l\'agent');
                alert('Agent assigné avec succès.');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }

          // Logic for creating Affaire
          const affaireForm = document.getElementById('create-affaire-form');
          if (affaireForm) {
            affaireForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const nomAffaire = document.getElementById('affaire-nom').value.trim();
              const numeroAffaire = document.getElementById('affaire-numero').value.trim();
              const descriptionAffaire = document.getElementById('affaire-description').value.trim();
              if (!nomAffaire) return alert('Le nom de l\'affaire est requis.');

              const clientId = data.site?.client_id;
              if (!clientId) return alert('Impossible de trouver le client associé à ce ticket pour créer une affaire.');

              try {
                const affaireRes = await fetch('/api/affaires', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ nom_affaire: nomAffaire, numero_affaire: numeroAffaire, client_id: clientId, description: descriptionAffaire })
                });
                const newAffaire = await affaireRes.json();
                if (!affaireRes.ok) throw new Error(newAffaire.error || 'Erreur lors de la création de l\'affaire');

                const ticketUpdateRes = await fetch(`/api/tickets/${ticketId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ ...t, affaire_id: newAffaire.id })
                });
                if (!ticketUpdateRes.ok) throw new Error('Erreur lors de la liaison de l\'affaire au ticket');

                alert('Affaire créée et liée avec succès!');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }

          // Logic for creating Intervention
          const interventionForm = document.getElementById('create-intervention-form');
          if (interventionForm) {
            interventionForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const payload = {
                titre: document.getElementById('intervention-titre').value,
                description: document.getElementById('intervention-description').value,
                date_debut: document.getElementById('intervention-date-debut').value,
                date_fin: document.getElementById('intervention-date-fin').value || null,
                ticket_id: ticketId,
                status: 'En_attente'
              };

              try {
                const res = await fetch('/api/interventions', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify(payload)
                });
                if (!res.ok) {
                  const errorData = await res.json();
                  throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                alert('Intervention créée avec succès!');
                location.reload();
              } catch (err) {
                alert(`Échec de la création: ${err.message}`);
              }
            });
          }

          // Logic for creating DOE
          const doeForm = document.getElementById('create-doe-form');
          if (doeForm) {
            doeForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const titreDoe = document.getElementById('doe-titre').value.trim();
              const descriptionDoe = document.getElementById('doe-description').value.trim();
              if (!titreDoe) return alert('Le titre du DOE est requis.');

              const siteId = data.ticket?.site_id;
              const affaireId = data.ticket?.affaire_id;
              if (!siteId || !affaireId) return alert('Le site et l\'affaire doivent être liés au ticket pour créer un DOE.');

              try {
                const doeRes = await fetch('/api/does', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ titre: titreDoe, site_id: siteId, affaire_id: affaireId, description: descriptionDoe })
                });
                const newDoe = await doeRes.json();
                if (!doeRes.ok) throw new Error(newDoe.error || 'Erreur lors de la création du DOE');

                const ticketUpdateRes = await fetch(`/api/tickets/${ticketId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ ...t, doe_id: newDoe.id })
                });
                if (!ticketUpdateRes.ok) throw new Error('Erreur lors de la liaison du DOE au ticket');

                alert('DOE créé et lié avec succès!');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }
        }
      } catch(e) {
        set('ticket-title', 'Ticket introuvable');
      }

      async function loadMaterielsSection(interventions = []) {
        if (!materielsListEl) return;
        if (!interventions.length) {
          materielsListEl.innerHTML = '<div class="text-muted">Aucune intervention, aucun matériel.</div>';
          return;
        }
        materielsListEl.innerHTML = '<div class="text-muted">Chargement des matériels...</div>';
        const all = [];
        for (const inter of interventions) {
          if (!inter?.id) continue;
          try {
            const mats = await fetchJSON(`/api/materiels?intervention_id=${inter.id}`);
            (mats || []).forEach(m => all.push({ ...m, _intervention: inter }));
          } catch (err) {
            console.warn('Materiels non chargés pour intervention', inter.id, err);
          }
        }
        if (!all.length) {
          materielsListEl.innerHTML = '<div class="text-muted">Aucun matériel lié aux interventions de ce ticket.</div>';
          return;
        }
        materielsListEl.innerHTML = '';
        all.forEach(m => {
          const card = document.createElement('div');
          card.className = 'card mb-2';
          const status = m.commande_status || m.status_commande || '—';
          const interLabel = m._intervention ? (m._intervention.titre || `Intervention #${m._intervention.id}`) : 'Intervention';
          card.innerHTML = `
            <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
              <div>
                <div class="fw-semibold">${m.designation || 'Matériel'}</div>
                <div class="small text-muted">${m.reference || ''}${m.categorie ? ' • ' + m.categorie : ''}</div>
                <div class="small text-muted">Intervention : <a href="intervention-view.html?id=${m.intervention_id || m._intervention?.id || ''}" class="link-button">${interLabel}</a></div>
                ${m.fabricant ? `<div class="small text-muted">Fabricant : ${m.fabricant}</div>` : ''}
                ${m.prix_achat ? `<div class="small text-muted">Prix achat : ${m.prix_achat} €</div>` : ''}
                ${m.commentaire ? `<div class="small text-muted">Commentaire : ${m.commentaire}</div>` : ''}
              </div>
              <div class="text-end" style="min-width:180px;">
                <label class="small text-muted">Statut commande</label>
                <div class="d-flex gap-2 align-items-center">
                  ${isAdmin ? `
                    <select class="form-select form-select-sm mat-status">
                      ${['', ...matStatusOptions].map(opt => `<option value="${opt}" ${opt===status?'selected':''}>${opt || '—'}</option>`).join('')}
                    </select>
                  ` : `<span class="badge bg-light text-dark">${status}</span>`}
                </div>
              </div>
            </div>
          `;
          materielsListEl.appendChild(card);
          if (isAdmin) {
            const select = card.querySelector('.mat-status');
            if (select) {
              select.addEventListener('change', async () => {
                try {
                  await fetchJSON(`/api/materiels/${m.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commande_status: select.value || null })
                  });
                } catch (err) {
                  alert(err.message || 'Mise à jour impossible');
                  select.value = status;
                }
              });
            }
          }
        });
      }

      function populateInterventionSelect() {
        const select = document.getElementById('mat-intervention');
        if (!select) return;
        select.innerHTML = '';
        interventionsCache.forEach(inter => {
          if (!inter?.id) return;
          const opt = document.createElement('option');
          opt.value = inter.id;
          opt.textContent = inter.titre || `Intervention #${inter.id}`;
          select.appendChild(opt);
        });
      }

      if (addMaterielBtn && materielModal) {
        addMaterielBtn.addEventListener('click', () => {
          populateInterventionSelect();
          const form = document.getElementById('materiel-form');
          if (form) form.reset();
          materielModal.show();
        });
      }

      const saveMatBtn = document.getElementById('save-materiel-btn');
      if (saveMatBtn && materielModal) {
        saveMatBtn.addEventListener('click', async () => {
          const ref = document.getElementById('mat-ref').value.trim();
          const designation = document.getElementById('mat-designation').value.trim();
          const categorie = document.getElementById('mat-categorie').value.trim();
          const fabricant = document.getElementById('mat-fabricant').value.trim();
          const prixStr = document.getElementById('mat-prix').value.trim();
          const comment = document.getElementById('mat-commentaire').value.trim();
          const status = document.getElementById('mat-status').value;
          const interId = document.getElementById('mat-intervention').value;
          if (!ref || !designation || !interId) {
            alert('Référence, désignation et intervention sont obligatoires.');
            return;
          }
          const payload = {
            reference: ref,
            designation,
            categorie,
            fabricant,
            prix_achat: prixStr ? parseFloat(prixStr) : null,
            commentaire: comment || null,
            intervention_id: Number(interId),
            commande_status: status || null
          };
          try {
            await fetchJSON('/api/materiels', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            materielModal.hide();
            await loadMaterielsSection(interventionsCache);
          } catch (err) {
            alert(err.message || 'Création impossible');
          }
        });
      }
    });
  </script>

</body>
</html>
