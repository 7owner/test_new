<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du ticket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
</head>
<body>


  <main class="container mt-5">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="tickets.html">Gestion des Tickets</a></li>
        <li class="breadcrumb-item active" aria-current="page">Détails</li>
      </ol>
    </nav>
    <h1 class="mb-4">Détails du ticket: <span id="ticket-title"></span></h1>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Informations générales</h2>
        <p><strong>ID:</strong> <span id="view_id"></span></p>
        <p><strong>Titre:</strong> <span id="view_titre"></span></p>
        <p><strong>Description:</strong> <span id="view_description"></span></p>
        <p><strong>État:</strong> <span id="view_etat"></span></p>
        <p><strong>Date de début:</strong> <span id="view_date_debut"></span></p>
        <p><strong>Date de fin:</strong> <span id="view_date_fin"></span></p>
        <p><strong>Temps écoulé:</strong> <span id="view_elapsed"></span></p>
        <p><strong>Durée:</strong> <span id="view_duree"></span></p>
        <p><strong>DOE:</strong> <span id="view_doe"></span></p>
        <p><strong>Affaire:</strong> <span id="view_affaire"></span></p>
        <p><strong>Site:</strong> <span id="view_site"></span></p>
        <p><strong>Responsable principal:</strong> <span id="view_responsable"></span></p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Interventions associées</h2>
        <div id="ticket-interventions-list"></div>
        <button class="btn btn-primary mt-3 d-none" id="add-intervention-btn" data-bs-toggle="modal" data-bs-target="#createInterventionModal"><i class="bi bi-plus-circle me-2"></i>Ajouter une intervention</button>
      </div>
    </div>

    <!-- Responsables Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h2 class="card-title mb-4">Responsables</h2>
            <ul id="responsables-list" class="list-group mb-3">
                <!-- Responsables will be loaded here -->
            </ul>
            <button id="add-responsable-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addResponsableModal">Ajouter un responsable</button>
        </div>
    </div>

    <!-- Agents Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h2 class="card-title mb-4">Agents Assignés</h2>
            <ul id="agents-list" class="list-group mb-3">
                <!-- Agents will be loaded here -->
            </ul>
            <button id="add-agent-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAgentModal">Ajouter un agent</button>
        </div>
    </div>

    <div class="card mb-4 d-none" id="admin-actions-card">
      <div class="card-body">
        <h2 class="card-title mb-3">Actions Administrateur</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#createAffaireModal">Créer une Affaire</button>
          <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#createDoeModal">Créer un DOE</button>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="tickets.html" class="btn btn-secondary">Retour à la liste des tickets</a>
      <a href="ticket-edit.html" class="btn btn-primary d-none" id="edit-ticket-btn"><i class="bi bi-pencil me-2"></i>Modifier le ticket</a>
    </div>
  </main>

  <!-- Modal: Create Intervention -->
  <div class="modal fade" id="createInterventionModal" tabindex="-1" aria-labelledby="createInterventionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createInterventionModalLabel">Créer une nouvelle intervention</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="create-intervention-form">
            <div class="mb-3">
              <label for="intervention-titre" class="form-label">Titre</label>
              <input type="text" class="form-control" id="intervention-titre" required>
            </div>
            <div class="mb-3">
              <label for="intervention-description" class="form-label">Description</label>
              <textarea class="form-control" id="intervention-description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="intervention-date-debut" class="form-label">Date Début</label>
              <input type="date" class="form-control" id="intervention-date-debut" required>
            </div>
            <div class="mb-3">
              <label for="intervention-date-fin" class="form-label">Date Fin</label>
              <input type="date" class="form-control" id="intervention-date-fin">
            </div>
            <div class="mb-3">
              <label for="intervention-status" class="form-label">Statut</label>
              <select class="form-select" id="intervention-status" required>
                <option value="Pas_commence">Pas commencé</option>
                <option value="Bloque">Bloqué</option>
                <option value="En_attente">En attente</option>
                <option value="En_cours">En cours</option>
                <option value="Termine">Terminé</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="intervention-precedente-id" class="form-label">Intervention précédente (si applicable)</label>
              <select class="form-select" id="intervention-precedente-id">
                <option value="">Aucune</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Créer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Responsable Modal -->
  <div class="modal fade" id="addResponsableModal" tabindex="-1" aria-labelledby="addResponsableModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addResponsableModalLabel">Ajouter un responsable</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addResponsableForm">
            <div class="mb-3">
              <label for="responsable-select" class="form-label">Sélectionner un agent (doit être admin et "Chef")</label>
              <select class="form-select" id="responsable-select" required>
                <!-- Agent options will be loaded here -->
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="save-responsable-btn">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Agent Modal -->
  <div class="modal fade" id="addAgentModal" tabindex="-1" aria-labelledby="addAgentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAgentModalLabel">Ajouter un agent</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addAgentForm">
            <div class="mb-3">
              <label for="agent-select" class="form-label">Sélectionner un agent</label>
              <select class="form-select" id="agent-select" required>
                <!-- Agent options will be loaded here -->
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="save-agent-btn">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Create Affaire -->
  <div class="modal fade" id="createAffaireModal" tabindex="-1" aria-labelledby="createAffaireModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createAffaireModalLabel">Créer une nouvelle affaire</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="create-affaire-form">
            <div class="mb-3">
              <label for="affaire-nom" class="form-label">Nom de l'affaire</label>
              <input type="text" class="form-control" id="affaire-nom" required>
            </div>
            <div class="mb-3">
              <label for="affaire-numero" class="form-label">Numéro de l'affaire</label>
              <input type="text" class="form-control" id="affaire-numero">
            </div>
            <div class="mb-3">
              <label for="affaire-description" class="form-label">Description</label>
              <textarea class="form-control" id="affaire-description" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Créer et Lier</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Create DOE -->
  <div class="modal fade" id="createDoeModal" tabindex="-1" aria-labelledby="createDoeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createDoeModalLabel">Créer un nouveau DOE</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="create-doe-form">
            <div class="mb-3">
              <label for="doe-titre" class="form-label">Titre du DOE</label>
              <input type="text" class="form-control" id="doe-titre" required>
            </div>
            <div class="mb-3">
              <label for="doe-description" class="form-label">Description</label>
              <textarea class="form-control" id="doe-description" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Créer et Lier</button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const qp = new URLSearchParams(location.search);
      const ticketId = qp.get('id');
      const token = localStorage.getItem('token');
      const headers = token? { 'Authorization': `Bearer ${token}` } : {};
      const isAdmin = (()=>{ try{ const p = token? JSON.parse(atob(token.split('.')[1])):null; return Array.isArray(p?.roles)&&p.roles.includes('ROLE_ADMIN'); } catch { return false; } })();
      function set(id, val){ const el=document.getElementById(id); if(el) el.textContent = val||''; }
      function fmt(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)? '' : d.toLocaleString(); }
      let elapsedTimer = null;
      const elapsedEl = document.getElementById('view_elapsed');
      function formatElapsed(ms){
        if (!ms || ms<0) return '';
        const totalSec = Math.floor(ms/1000);
        const h = Math.floor(totalSec/3600);
        const m = Math.floor((totalSec%3600)/60);
        const s = totalSec%60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }
      function startElapsed(startIso, endIso){
        if (!elapsedEl || !startIso) return;
        if (elapsedTimer) clearInterval(elapsedTimer);
        const startMs = new Date(startIso).getTime();
        if (!startMs || isNaN(startMs)) return;
        const endMs = endIso ? new Date(endIso).getTime() : null;
        const update = () => {
          const now = endMs && !isNaN(endMs) ? endMs : Date.now();
          elapsedEl.textContent = formatElapsed(now - startMs);
        };
        update();
        if (!endMs || isNaN(endMs)) {
          elapsedTimer = setInterval(update, 1000);
        }
      }
      try {
        const res = await fetch(`/api/tickets/${ticketId}/relations`, { headers, credentials: 'same-origin' });
        if (res.status===401||res.status===403){ location.href='/login.html'; return; }
        const data = await res.json();
        if (!res.ok) throw new Error(data && data.error || `HTTP ${res.status}`);
        const t = data.ticket; if (!t) throw new Error('Not found');
        document.getElementById('ticket-title').textContent = t.titre || '(Sans titre)';
        set('view_id', t.id); set('view_titre', t.titre||''); set('view_description', t.description||''); set('view_etat', t.etat||'');
        set('view_date_debut', fmt(t.date_debut)); set('view_date_fin', t.date_fin? fmt(t.date_fin) : 'En cours');
        startElapsed(t.date_debut, t.date_fin);
        if (t.date_debut && t.date_fin) { const dd=new Date(t.date_debut), df=new Date(t.date_fin); const dj=Math.floor((df-dd)/(1000*60*60*24)); set('view_duree', `${dj} jours`); }
        const doe = data.doe;
        const doeEl=document.getElementById('view_doe');
        if (doeEl) doeEl.innerHTML = (doe && doe.id) ? `<a href="doe-view.html?id=${doe.id}">${doe.titre || 'DOE'}</a>` : 'N/A';
        
        const affaire = data.affaire;
        const affaireEl = document.getElementById('view_affaire');
        if (affaireEl) {
          if (affaire && affaire.id) {
            affaireEl.innerHTML = `<a href="affaire-view.html?id=${affaire.id}">${affaire.nom_affaire || 'Affaire #' + affaire.id} (${affaire.numero_affaire || 'N/A'})</a>`;
          } else {
            affaireEl.textContent = 'N/A';
          }
        }
        
        const siteEl = document.getElementById('view_site');
        if (siteEl) {
          const s = data.site; if (s && s.id) { const name = s.nom_site? ` — ${s.nom_site}` : ''; siteEl.innerHTML = `<a href="site-view.html?id=${s.id}">Site #${s.id}${name}</a>`; }
          else if (t.site_id) siteEl.innerHTML = `<a href="site-view.html?id=${t.site_id}">Site #${t.site_id}</a>`; else siteEl.textContent='N/A';
        }
        set('view_responsable', t.responsable || 'Non assigné');

        const list = document.getElementById('ticket-interventions-list'); list.innerHTML = '';
        const items = Array.isArray(data.interventions)? data.interventions : [];
        if (!items.length) list.innerHTML = '<p class="text-muted">Aucune intervention associée.</p>';
        items.forEach(inter => {
          const el = document.createElement('div'); el.className='card card-body mb-2';
          const interElapsed = inter.date_debut ? formatElapsed((inter.date_fin ? new Date(inter.date_fin).getTime() : Date.now()) - new Date(inter.date_debut).getTime()) : '';
          el.innerHTML = `<div class=\"d-flex justify-content-between align-items-center\">`
            + `<div><h6 class=\"mb-1\">${inter.description||''}</h6>`
            + `<small class=\"text-muted\">Du ${fmt(inter.date_debut)||''} au ${fmt(inter.date_fin)||'N/A'}</small></div>`
            + `<div class="text-end"><div class="small text-muted mb-1">Temps écoulé: ${interElapsed || '—'}</div><a href=\"intervention-view.html?id=${inter.id}\" class=\"btn btn-sm btn-info me-1\"><i class=\"bi bi-eye\"></i> Voir</a></div>`
            + `</div>`;
          list.appendChild(el);
        });

// Responsables et agents assignés
        const responsablesList = document.getElementById('responsables-list');
        const agentsList = document.getElementById('agents-list');

        function renderResponsables(arr) {
          if (!responsablesList) return;
          responsablesList.innerHTML = '';
          if (!arr || !arr.length) {
            responsablesList.innerHTML = '<li class="list-group-item text-muted">Aucun responsable.</li>';
            return;
          }
          arr.forEach(r => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            const label = (r.actor_email || r.actor_name || r.agent_matricule || 'Responsable')
              + (r.role ? ` (${r.role})` : '');
            li.textContent = label;
            responsablesList.appendChild(li);
          });
        }

        function renderAgents(arr) {
          if (!agentsList) return;
          agentsList.innerHTML = '';
          if (!arr || !arr.length) {
            agentsList.innerHTML = '<li class="list-group-item text-muted">Aucun agent assigné.</li>';
            return;
          }
          arr.forEach(a => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = a.agent_matricule || a.matricule || 'Agent';
            agentsList.appendChild(li);
          });
        }

        const responsables = data.responsables || data.responsables_secondaires || [];
        const agentsAssignes = data.agents_assignes || [];
        renderResponsables(responsables);
        renderAgents(agentsAssignes);

        if (isAdmin) {
          const addInt = document.getElementById('add-intervention-btn');
          if (addInt) addInt.classList.remove('d-none');
          const editBtn = document.getElementById('edit-ticket-btn');
          if (editBtn) editBtn.classList.remove('d-none');
          const adminActions = document.getElementById('admin-actions-card');
          if (adminActions) adminActions.classList.remove('d-none');

          // Chargement des agents pour les sélecteurs
          let allAgents = [];
          try {
            const agentsRes = await fetch('/api/agents', { headers, credentials: 'same-origin' });
            if (agentsRes.ok) {
              allAgents = await agentsRes.json();
            }
          } catch {}

          const responsableSelect = document.getElementById('responsable-select');
          const agentSelect = document.getElementById('agent-select');

          function populateSelect(selectEl, filterFn) {
            if (!selectEl) return;
            selectEl.innerHTML = '<option value="">-- Sélectionner --</option>';
            (allAgents || [])
              .filter(filterFn || (() => true))
              .forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.matricule;
                opt.textContent = `${a.matricule} - ${a.nom} ${a.prenom}`;
                selectEl.appendChild(opt);
              });
          }

          // Responsable : admin + Chef
          populateSelect(responsableSelect, a =>
            Array.isArray(a.roles) && a.roles.includes('ROLE_ADMIN') //&&
           // (a.fonction === 'Chef' || a.fonction === 'CHEF')
          );
          // Agents : tous
          populateSelect(agentSelect);

          const saveResponsableBtn = document.getElementById('save-responsable-btn');
          if (saveResponsableBtn && responsableSelect) {
            saveResponsableBtn.addEventListener('click', async () => {
              const matricule = responsableSelect.value;
              if (!matricule) return alert('Veuillez sélectionner un responsable.');
              try {
                const resPost = await fetch(`/api/tickets/${ticketId}/responsables`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  credentials: 'same-origin',
                  body:  JSON.stringify({
                          agent_matricule: matricule, // ce que l’API demande
                          matricule        : matricule // optionnel, pour compatibilité
                        })
                });
                const body = await resPost.json().catch(() => ({}));
                if (!resPost.ok) throw new Error(body.error || 'Erreur lors de l\'ajout du responsable');
                alert('Responsable ajouté avec succès.');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }

          const saveAgentBtn = document.getElementById('save-agent-btn');
          if (saveAgentBtn && agentSelect) {
            saveAgentBtn.addEventListener('click', async () => {
              const matricule = agentSelect.value;
              if (!matricule) return alert('Veuillez sélectionner un agent.');
              try {
                const resPost = await fetch(`/api/tickets/${ticketId}/agents`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  credentials: 'same-origin',
                  body:  JSON.stringify({
                          agent_matricule: matricule, // ce que l’API demande
                          matricule        : matricule // optionnel, pour compatibilité
                        })
                });
                const body = await resPost.json().catch(() => ({}));
                if (!resPost.ok) throw new Error(body.error || 'Erreur lors de l\'assignation de l\'agent');
                alert('Agent assigné avec succès.');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }

          // Logic for creating Affaire
          const affaireForm = document.getElementById('create-affaire-form');
          if (affaireForm) {
            affaireForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const nomAffaire = document.getElementById('affaire-nom').value.trim();
              const numeroAffaire = document.getElementById('affaire-numero').value.trim();
              const descriptionAffaire = document.getElementById('affaire-description').value.trim();
              if (!nomAffaire) return alert('Le nom de l\'affaire est requis.');

              const clientId = data.site?.client_id;
              if (!clientId) return alert('Impossible de trouver le client associé à ce ticket pour créer une affaire.');

              try {
                // 1. Create the affaire
                const affaireRes = await fetch('/api/affaires', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ nom_affaire: nomAffaire, numero_affaire: numeroAffaire, client_id: clientId, description: descriptionAffaire })
                });
                const newAffaire = await affaireRes.json();
                if (!affaireRes.ok) throw new Error(newAffaire.error || 'Erreur lors de la création de l\'affaire');

                // 2. Link to the ticket
                const ticketUpdateRes = await fetch(`/api/tickets/${ticketId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ ...t, affaire_id: newAffaire.id })
                });
                if (!ticketUpdateRes.ok) throw new Error('Erreur lors de la liaison de l\'affaire au ticket');

                alert('Affaire créée et liée avec succès!');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }

          // Logic for creating Intervention
          const interventionForm = document.getElementById('create-intervention-form');
          if (interventionForm) {
            const precedenteSelect = document.getElementById('intervention-precedente-id');
            (data.interventions || []).forEach(inter => {
                precedenteSelect.add(new Option(`INT #${inter.id} - ${inter.description.substring(0, 20)}...`, inter.id));
            });

            interventionForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const payload = {
                titre: document.getElementById('intervention-titre').value,
                description: document.getElementById('intervention-description').value,
                date_debut: document.getElementById('intervention-date-debut').value,
                date_fin: document.getElementById('intervention-date-fin').value || null,
                ticket_id: ticketId,
                status: document.getElementById('intervention-status').value,
                intervention_precedente_id: document.getElementById('intervention-precedente-id').value || null
              };

              try {
                const res = await fetch('/api/interventions', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify(payload)
                });
                if (!res.ok) {
                  const errorData = await res.json();
                  throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                alert('Intervention créée avec succès!');
                location.reload();
              } catch (err) {
                alert(`Échec de la création: ${err.message}`);
              }
            });
          }

          // Logic for creating DOE
          const doeForm = document.getElementById('create-doe-form');
          if (doeForm) {
            doeForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const titreDoe = document.getElementById('doe-titre').value.trim();
              const descriptionDoe = document.getElementById('doe-description').value.trim();
              if (!titreDoe) return alert('Le titre du DOE est requis.');

              const siteId = data.ticket?.site_id;
              const affaireId = data.ticket?.affaire_id;
              if (!siteId || !affaireId) return alert('Le site et l\'affaire doivent être liés au ticket pour créer un DOE.');

              try {
                // 1. Create the DOE
                const doeRes = await fetch('/api/does', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ titre: titreDoe, site_id: siteId, affaire_id: affaireId, description: descriptionDoe })
                });
                const newDoe = await doeRes.json();
                if (!doeRes.ok) throw new Error(newDoe.error || 'Erreur lors de la création du DOE');

                // 2. Link to the ticket
                const ticketUpdateRes = await fetch(`/api/tickets/${ticketId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json', ...headers },
                  body: JSON.stringify({ ...t, doe_id: newDoe.id })
                });
                if (!ticketUpdateRes.ok) throw new Error('Erreur lors de la liaison du DOE au ticket');

                alert('DOE créé et lié avec succès!');
                location.reload();
              } catch (err) {
                alert(`Erreur: ${err.message}`);
              }
            });
          }
        }
      } catch(e) {
        document.getElementById('ticket-title').textContent = 'Ticket introuvable';
      }
    });
  </script>
</body>
</html>

