<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveau travail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/custom.css?v=1">
  <script src="/nav.js?v=2"></script>
</head>
<body class="app-bg">
  <div id="navbar-placeholder"></div>
  <main class="container my-4" style="max-width: 960px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h4 mb-0">Créer un nouveau travail</h1>
        <small class="text-muted">Un travail correspond à un ticket, avec agent responsable, état et échéances.</small>
      </div>
      <a href="/travaux.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-1"></i>Retour au tableau</a>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div id="msg" class="alert d-none" role="alert"></div>
        <form id="work-form" class="row g-3">
          <div class="col-12">
            <label class="form-label fw-semibold">Titre *</label>
            <input type="text" class="form-control" id="titre" required placeholder="Ex: Remplacement automate GTB">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Description</label>
            <textarea class="form-control" id="description" rows="3" placeholder="Détail du travail..."></textarea>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Ticket lié (ID)</label>
            <input type="number" class="form-control" id="ticket_id" placeholder="Optionnel">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Agent responsable (matricule)</label>
            <input type="text" class="form-control" id="agent_matricule" placeholder="Ex: AGT001">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Priorité</label>
            <select class="form-select" id="priorite">
              <option value="Haute">Haute</option>
              <option value="Moyenne" selected>Moyenne</option>
              <option value="Basse">Basse</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">État</label>
            <select class="form-select" id="etat">
              <option value="A_faire" selected>À faire</option>
              <option value="En_cours">En cours</option>
              <option value="En_attente">En attente</option>
              <option value="Termine">Terminé</option>
              <option value="Annule">Annulé</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Date de début</label>
            <input type="datetime-local" class="form-control" id="date_debut">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Date d'échéance</label>
            <input type="datetime-local" class="form-control" id="date_echeance">
          </div>
          <div class="col-12 d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Créer</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('work-form');
      const msg = document.getElementById('msg');
      const token = localStorage.getItem('token');
      const headers = {
        'Content-Type': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      };

      function flash(text, type='info') {
        if (!msg) return;
        msg.className = `alert alert-${type}`;
        msg.textContent = text;
        msg.classList.remove('d-none');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          titre: document.getElementById('titre').value.trim(),
          description: document.getElementById('description').value.trim() || null,
          ticket_id: Number(document.getElementById('ticket_id').value) || null,
          agent_matricule: document.getElementById('agent_matricule').value.trim() || null,
          priorite: document.getElementById('priorite').value || null,
          etat: document.getElementById('etat').value || null,
          date_debut: document.getElementById('date_debut').value || null,
          date_echeance: document.getElementById('date_echeance').value || null
        };
        if (!payload.titre) { flash('Le titre est obligatoire.', 'danger'); return; }
        try {
          const res = await fetch('/api/travaux', {
            method: 'POST',
            headers,
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          if (res.status === 401 || res.status === 403) { location.href = '/login.html'; return; }
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || 'Échec de la création');
          flash('Travail créé avec succès.', 'success');
          setTimeout(() => { location.href = `/travaux-view.html?id=${data.id}`; }, 600);
        } catch (err) {
          flash(err.message || 'Erreur serveur', 'danger');
        }
      });
    });
  </script>
</body>
</html>
