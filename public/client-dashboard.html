<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de Bord Client</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      padding: 1.5rem 0;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    .header-card {
      background: white;
      border-radius: 24px;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }
    .header-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    .main-card {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .main-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f0f0f0;
    }
    .section-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
      font-size: 1.35rem;
      color: #2d3748;
      margin: 0;
    }
    .section-icon {
      width: 45px;
      height: 45px;
      border-radius: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }
    .notif-bell {
      position: relative;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid #667eea;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .notif-bell:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transform: scale(1.1);
    }
    .notif-bell:hover i {
      color: white !important;
    }
    .notif-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border-radius: 20px;
      padding: 4px 8px;
      font-size: 0.7rem;
      font-weight: 700;
      line-height: 1;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      color: white;
    }
    .item-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 5px solid #667eea;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .item-card:hover {
      transform: translateX(8px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
      border-left-width: 8px;
    }
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-en-cours { background: #cfe2ff; color: #084298; }
    .status-traite { background: #d1e7dd; color: #0f5132; }
    .status-rejete { background: #f8d7da; color: #842029; }
    .status-annule { background: #fff3cd; color: #856404; }
    .feedback-section {
      background: linear-gradient(135deg, #667eea08 0%, #764ba208 100%);
      border: 2px dashed #667eea;
      border-radius: 16px;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    .star-rating {
      font-size: 1.5rem;
      color: #fbbf24;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    .profile-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 1.25rem;
      border-radius: 14px;
      border-left: 4px solid #667eea;
    }
    .profile-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .profile-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: #2d3748;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.2;
    }
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .btn-action {
      padding: 0.5rem 1rem;
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .welcome-banner {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      border-left: 6px solid #667eea;
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <!-- Header -->
    <div class="header-card">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="/logo_logicielle.png" alt="Logo" style="height: 40px;" onerror="this.style.display='none'">
          <div>
            <h4 class="mb-0 fw-bold">Espace Client</h4>
            <small class="text-muted">Gérez vos interventions et sites</small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-3">
          <button class="notif-bell" id="notif-btn" title="Tickets terminés en attente de feedback">
            <i class="bi bi-bell-fill text-primary"></i>
            <span class="notif-badge" id="notif-badge" style="display: none;">0</span>
          </button>
          <div class="d-flex align-items-center bg-light border rounded-pill px-3 py-2">
            <i class="bi bi-person-circle text-primary fs-4 me-2"></i>
            <div class="fw-medium text-secondary" id="header-client-name">Client</div>
          </div>
          <button id="client-logout-btn" class="btn btn-outline-danger btn-sm rounded-pill">
            <i class="bi bi-box-arrow-right me-1"></i>Déconnexion
          </button>
        </div>
      </div>
    </div>

    <!-- Welcome Banner -->
    <div class="welcome-banner">
      <h2 class="fw-bold mb-2">Bienvenue sur votre Tableau de Bord</h2>
      <p class="mb-0 text-muted">Gérez vos sites, faites des demandes d'intervention et consultez votre historique en toute simplicité.</p>
    </div>

    <!-- Mon Profil -->
    <div class="main-card">
      <div class="section-header">
        <h3 class="section-title">
          <div class="section-icon">
            <i class="bi bi-person-badge"></i>
          </div>
          Mon Profil
        </h3>
      </div>
      <div class="profile-grid" id="clientProfile">
        <div class="profile-card">
          <div class="profile-label"><i class="bi bi-building"></i>Nom du Client</div>
          <div class="profile-value" id="profileNomClient">—</div>
        </div>
        <div class="profile-card">
          <div class="profile-label"><i class="bi bi-envelope"></i>Email</div>
          <div class="profile-value" id="profileRepresentantEmail">—</div>
        </div>
        <div class="profile-card">
          <div class="profile-label"><i class="bi bi-telephone"></i>Téléphone</div>
          <div class="profile-value" id="profileRepresentantTel">—</div>
        </div>
      </div>
      <div class="mt-3" id="profileCommentaireContainer" style="display: none;">
        <div class="profile-label"><i class="bi bi-chat-quote"></i>Commentaire</div>
        <div class="alert alert-info mb-0 mt-2" id="profileCommentaire"></div>
      </div>
    </div>

    <!-- Vos Sites -->
    <div class="main-card">
      <div class="section-header">
        <h3 class="section-title">
          <div class="section-icon">
            <i class="bi bi-building"></i>
          </div>
          Vos Sites
        </h3>
      </div>
      <div id="sitesList">
        <div class="empty-state">
          <i class="bi bi-building"></i>
          <p class="mb-0">Aucun site enregistré</p>
        </div>
      </div>
    </div>

    <!-- Demandes d'Intervention -->
    <div class="main-card">
      <div class="section-header">
        <h3 class="section-title">
          <div class="section-icon">
            <i class="bi bi-clipboard-check"></i>
          </div>
          Vos Demandes d'Intervention
        </h3>
        <button class="btn btn-gradient" data-modal="createDemandeModal">
          <i class="bi bi-plus-circle me-2"></i>Nouvelle Demande
        </button>
      </div>
      <div id="demandesList">
        <div class="empty-state">
          <i class="bi bi-clipboard-check"></i>
          <p class="mb-0">Aucune demande pour le moment</p>
        </div>
      </div>
    </div>

    <!-- Historique des Interventions -->
    <div class="main-card">
      <div class="section-header">
        <h3 class="section-title">
          <div class="section-icon">
            <i class="bi bi-clock-history"></i>
          </div>
          Historique de vos Interventions
        </h3>
      </div>
      <div id="historiqueInterventions">
        <div class="empty-state">
          <i class="bi bi-clock-history"></i>
          <p class="mb-0">Aucun historique disponible</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="viewSiteModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-building me-2"></i>Détails du Site</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="viewSiteFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editSiteModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Modifier Site</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="editSiteFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="createDemandeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Nouvelle Demande</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="createDemandeFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewDemandeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Suivi de Demande</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="viewDemandeFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editDemandeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Modifier Demande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="editDemandeFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="messagesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-chat-dots me-2"></i>Messages</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="messagesFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="filesDemandeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title"><i class="bi bi-paperclip me-2"></i>Pièces Jointes</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="filesDemandeFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) return location.href = "/login.html";

      const api = (url, opts = {}) =>
        fetch(url, {
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          credentials: 'same-origin',
          ...opts
        }).then(async r => {
          const body = r.headers.get("content-type")?.includes("json") ? await r.json() : null;
          if (r.status === 401 || r.status === 403) {
            localStorage.removeItem("token");
            location.href = "/login.html";
            throw new Error("Unauthorized");
          }
          if (!r.ok) throw new Error(body?.error || r.status);
          return body;
        });

      document.getElementById("client-logout-btn").addEventListener("click", () => {
        if (confirm("Êtes-vous sûr de vouloir vous déconnecter ?")) {
          localStorage.removeItem("token");
          location.href = "/login.html";
        }
      });

      const notifBtn = document.getElementById("notif-btn");
      const notifBadge = document.getElementById("notif-badge");

      function getStatusClass(status) {
        const s = (status || "En cours de traitement").toLowerCase();
        return {
          "en cours de traitement": "status-en-cours",
          "traité": "status-traite",
          "rejeté": "status-rejete",
          "annulé": "status-annule"
        }[s] || "status-en-cours";
      }

      function setLoading(el, msg = "Chargement...") {
        el.innerHTML = `
          <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">${msg}</span>
            </div>
            <p class="text-muted">${msg}</p>
          </div>
        `;
      }

      async function loadProfile() {
        try {
          const p = await api("/api/client/profile");
          document.getElementById("profileNomClient").textContent = p.nom_client || "Non renseigné";
          document.getElementById("profileRepresentantEmail").textContent = p.representant_email || "Non renseigné";
          document.getElementById("profileRepresentantTel").textContent = p.representant_tel || "Non renseigné";
          document.getElementById("header-client-name").textContent = p.nom_client || "Client";
          
          if (p.commentaire) {
            document.getElementById("profileCommentaire").textContent = p.commentaire;
            document.getElementById("profileCommentaireContainer").style.display = "block";
          }
        } catch (e) {
          console.error("profile error:", e);
        }
      }

      async function loadSites() {
        const el = document.getElementById("sitesList");
        setLoading(el, "Chargement des sites...");

        try {
          const sites = await api("/api/client/sites");
          
          if (!sites.length) {
            el.innerHTML = `
              <div class="empty-state">
                <i class="bi bi-building"></i>
                <p class="mb-0">Aucun site enregistré</p>
              </div>
            `;
            return;
          }

          el.innerHTML = sites.map(site => `
            <div class="item-card">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="fw-bold mb-0">${site.nom_site || "Site sans nom"}</h5>
                <span class="badge bg-primary">ID: ${site.id}</span>
              </div>
              <p class="text-muted mb-0">${site.commentaire || "Pas de commentaire"}</p>
              <div class="action-buttons">
                <button class="btn btn-sm btn-primary btn-action" data-modal="viewSiteModal" data-id="${site.id}">
                  <i class="bi bi-eye me-1"></i>Voir
                </button>
                <button class="btn btn-sm btn-warning btn-action" data-modal="editSiteModal" data-id="${site.id}">
                  <i class="bi bi-pencil me-1"></i>Modifier
                </button>
                <a class="btn btn-sm btn-secondary btn-action" href="/client-site-files.html?site_id=${site.id}">
                  <i class="bi bi-paperclip me-1"></i>Fichiers
                </a>
              </div>
            </div>
          `).join("");
        } catch (e) {
          el.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Erreur de chargement des sites
            </div>
          `;
          console.error("sites error:", e);
        }
      }

      async function loadDemands() {
        const el = document.getElementById("demandesList");
        setLoading(el, "Chargement des demandes...");

        try {
          const demands = await api("/api/demandes_client/mine");

          if (!demands.length) {
            el.innerHTML = `
              <div class="empty-state">
                <i class="bi bi-clipboard-check"></i>
                <p class="mb-0">Aucune demande pour le moment</p>
              </div>
            `;
            return;
          }

          el.innerHTML = demands.map(d => {
            const editButton = !d.ticket_id 
              ? `<button class="btn btn-sm btn-warning btn-action" data-modal="editDemandeModal" data-id="${d.id}">
                  <i class="bi bi-pencil me-1"></i>Modifier
                </button>`
              : `<button class="btn btn-sm btn-warning btn-action" disabled title="Convertie en ticket">
                  <i class="bi bi-lock me-1"></i>Verrouillée
                </button>`;

            return `
            <div class="item-card">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1">
                  <h5 class="fw-bold mb-1">Demande #${d.id} — ${d.titre || d.nom_site || "Sans titre"}</h5>
                  <p class="text-muted small mb-2">${d.description || "Pas de description"}</p>
                  <small class="text-muted">
                    <i class="bi bi-calendar me-1"></i>
                    Créée le ${new Date(d.created_at).toLocaleDateString('fr-FR')}
                  </small>
                </div>
                <span class="status-badge ${getStatusClass(d.status)}">${d.status || "En cours"}</span>
              </div>
              <div class="action-buttons">
                <button class="btn btn-sm btn-primary btn-action" data-modal="viewDemandeModal" data-id="${d.id}">
                  <i class="bi bi-eye me-1"></i>Suivre
                </button>
                ${editButton}
                <button class="btn btn-sm btn-secondary btn-action" data-modal="filesDemandeModal" data-id="${d.id}">
                  <i class="bi bi-paperclip me-1"></i>Fichiers
                </button>
                <button class="btn btn-sm btn-outline-primary btn-action" data-modal="messagesModal" data-id="${d.id}">
                  <i class="bi bi-chat-dots me-1"></i>Messages / Suivi
                </button>
              </div>
            </div>`;
          }).join("");
        } catch (e) {
          el.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Erreur de chargement des demandes
            </div>
          `;
          console.error("demands error:", e);
        }
      }

      async function loadHistory() {
        const el = document.getElementById("historiqueInterventions");
        setLoading(el, "Chargement de l'historique...");
        let pendingCount = 0;

        try {
          const sites = await api("/api/client/sites");
          let tickets = [];

          for (const s of sites) {
            try {
              const r = await api(`/api/client/sites/${s.id}/relations`);
              if (r.tickets) {
                tickets.push(...r.tickets.map(t => ({ ...t, site_nom: s.nom_site })));
              }
            } catch {}
          }

          if (!tickets.length) {
            el.innerHTML = `
              <div class="empty-state">
                <i class="bi bi-clock-history"></i>
                <p class="mb-0">Aucun historique disponible</p>
              </div>
            `;
            return;
          }

          tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          const finishedTickets = tickets.filter(t => (t.etat || "").toLowerCase() === "termine");
          pendingCount = finishedTickets.length;

          if (pendingCount > 0) {
            notifBadge.textContent = pendingCount;
            notifBadge.style.display = "inline-block";
          }

          el.innerHTML = tickets.map(t => {
            const isTermine = (t.etat || "").toLowerCase() === "termine";
            const savedNote = t.satisfaction_note ?? t.note_satisfaction ?? (t.satisfaction && t.satisfaction.note);
            const savedComment = t.satisfaction_comment ?? t.commentaire_satisfaction ?? (t.satisfaction && t.satisfaction.commentaire) || "";
            let feedbackSection = '';
            if (isTermine) {
              if (savedNote != null) {
                const stars = "★★★★★".slice(0, Math.min(5, Math.max(1, Number(savedNote))));
                const empty = "☆☆☆☆☆".slice(0, 5 - stars.length);
                feedbackSection = `
                  <div class="feedback-section feedback-block" data-ticket="${t.id}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <strong><i class="bi bi-star-fill text-warning me-2"></i>Votre satisfaction</strong>
                      <span class="badge bg-success">Enregistrée</span>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="text-warning" style="font-size:1.2rem;">${stars}${empty}</span>
                      <span class="small text-muted">${Number(savedNote)}/5</span>
                    </div>
                    <div class="text-muted small mb-0">${savedComment ? savedComment.replace(/\n/g,'<br>') : 'Aucun commentaire.'}</div>
                  </div>
                `;
              } else {
                feedbackSection = `
                <div class="feedback-section" data-ticket="${t.id}">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <strong><i class="bi bi-star me-2"></i>Donnez votre avis</strong>
                    <span class="badge bg-info">Visible par le support</span>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label small fw-bold">Note</label>
                      <select class="form-select feedback-note" data-ticket="${t.id}">
                        <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                        <option value="4">⭐⭐⭐⭐ Très bien</option>
                        <option value="3">⭐⭐⭐ Bien</option>
                        <option value="2">⭐⭐ Moyen</option>
                        <option value="1">⭐ Mauvais</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label small fw-bold">Commentaire</label>
                      <textarea class="form-control feedback-comment" data-ticket="${t.id}" rows="2" placeholder="Partagez votre expérience..."></textarea>
                    </div>
                  </div>

                  <div class="d-flex justify-content-end gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-secondary clear-feedback" data-ticket="${t.id}">
                      <i class="bi bi-x-circle me-1"></i>Effacer
                    </button>
                    <button class="btn btn-sm btn-gradient send-feedback" data-ticket="${t.id}">
                      <i class="bi bi-send me-1"></i>Envoyer
                    </button>
                  </div>
                </div>
              `;
              }
            }

            return `
              <div class="item-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="flex-grow-1">
                    <h5 class="fw-bold mb-1">Ticket #${t.id} — ${t.titre || "Sans titre"}</h5>
                    <p class="text-muted small mb-1">
                      <i class="bi bi-building me-1"></i>Site: ${t.site_nom || "N/A"}
                    </p>
                    <small class="text-muted">
                      <i class="bi bi-calendar me-1"></i>
                      Créé le ${new Date(t.created_at).toLocaleDateString('fr-FR')}
                    </small>
                  </div>
                  <span class="status-badge ${isTermine ? 'status-traite' : 'status-en-cours'}">${t.etat || "En cours"}</span>
                </div>
                ${feedbackSection}
              </div>
            `;
          }).join("");

        } catch (e) {
          el.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Erreur de chargement de l'historique
            </div>
          `;
          console.error("history error:", e);
        }
      }

      // Feedback management
      document.body.addEventListener("click", async (e) => {
        const sendBtn = e.target.closest(".send-feedback");
        const clearBtn = e.target.closest(".clear-feedback");

        if (!sendBtn && !clearBtn) return;
        const ticketId = sendBtn?.dataset.ticket || clearBtn.dataset.ticket;
        const noteEl = document.querySelector(`.feedback-note[data-ticket="${ticketId}"]`);
        const commentEl = document.querySelector(`.feedback-comment[data-ticket="${ticketId}"]`);

        if (clearBtn) {
          noteEl.value = "5";
          commentEl.value = "";
          return;
        }

        const note = noteEl.value;
        const commentaire = commentEl.value.trim();

        try {
          sendBtn.disabled = true;
          sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Envoi...';

          await api(`/api/tickets/${ticketId}/satisfaction`, {
            method: "POST",
            body: JSON.stringify({ note: Number(note), commentaire })
          });

          const block = sendBtn.closest(".feedback-section");
          block.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
              <h5 class="fw-bold mt-3 mb-2">Merci pour votre retour !</h5>
              <div class="star-rating mb-2">${"★".repeat(Number(note))}${"☆".repeat(5 - Number(note))}</div>
              <p class="text-muted">${commentaire || "Aucun commentaire"}</p>
            </div>
          `;

        } catch (err) {
          alert("❌ Erreur lors de l'enregistrement de votre avis.");
          console.error("feedback error:", err);
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<i class="bi bi-send me-1"></i>Envoyer';
        }
      });

      /* ------------ Gestion modales (logique oldclient) ------------ */
      const frameMap = {
        viewSiteModal: "viewSiteFrame",
        editSiteModal: "editSiteFrame",
        createSiteModal: "createSiteFrame",
        createDemandeModal: "createDemandeFrame",
        viewDemandeModal: "viewDemandeFrame",
        editDemandeModal: "editDemandeFrame",
        filesDemandeModal: "filesDemandeFrame",
        messagesModal: "messagesFrame"
      };

      const modalUrlMap = {
        viewSiteModal: (id) => `/client-site-view.html?id=${id}`,
        editSiteModal: (id) => `/client-site-edit.html?id=${id}`,
        createSiteModal: () => `/client-new-site.html`,
        createDemandeModal: () => `/client-new-demand.html`,
        viewDemandeModal: (id) => `/client-demand-view.html?id=${id}`,
        editDemandeModal: (id) => `/client-demand-edit.html?id=${id}`,
        filesDemandeModal: (id) => `/client-demand-files.html?id=${id}`,
        messagesModal: (id) => `/client-demand-view.html?id=${encodeURIComponent(id || '')}&embed=1&modal=1`
      };

      document.body.addEventListener("click", e => {
        const btn = e.target.closest("[data-modal]");
        if (!btn) {
          const msgBtn = e.target.closest(".btn-message");
          if (msgBtn) {
            const did = msgBtn.getAttribute("data-demande-id");
            if (did) {
              const qs = new URLSearchParams();
              qs.set("conversation", `demande-${did}`);
              qs.set("embed", "1");
              window.location.href = `/messagerie.html?${qs.toString()}`;
            }
          }
          return;
        }

        const modalId = btn.dataset.modal;
        const itemId = btn.dataset.id;
        const conversation = btn.dataset.conversation;
        const urlBuilder = modalUrlMap[modalId];

        if (!urlBuilder) {
          console.error("No URL builder found for modal:", modalId);
          return;
        }

        const modalEl = document.getElementById(modalId);
        const frame = document.getElementById(frameMap[modalId]);

        if (modalEl && frame) {
          const url = urlBuilder(itemId || '');
          if (frame.getAttribute('src') !== url) {
            frame.src = url;
          }
          new bootstrap.Modal(modalEl).show();
        } else {
          console.error("Modal or frame not found for:", modalId);
        }
      });

      // Initial load
      loadProfile();
      loadSites();
      loadDemands();
      loadHistory();

    });
  </script>
</body>
</html>
