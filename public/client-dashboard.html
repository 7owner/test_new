<!DOCTYPE html><html lang="fr"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Tableau de Bord Client</title>    <link rel="stylesheet" href="custom.css">    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"></head><body>    <div id="navbar-placeholder"></div>    <div class="container mt-5">        <h1 class="mb-3">Bienvenue sur votre Tableau de Bord Client</h1>        <p class="mb-4">GÃ©rez vos sites, faites des demandes d'intervention et consultez votre historique.</p>        <!-- Section Sites -->        <div class="card mt-4">            <div class="card-header">                Vos Sites            </div>            <div class="card-body">                <button class="btn btn-primary mb-3" id="createSiteBtn">Ajouter un nouveau site</button><form id="siteForm" class="border rounded p-3 mb-3 d-none">
  <div class="mb-3">
    <label for="siteNom" class="form-label">Nom du site</label>
    <input type="text" id="siteNom" class="form-control" required>
  </div>
  <div class="mb-3">
    <label for="siteCommentaire" class="form-label">Commentaire (optionnel)</label>
    <textarea id="siteCommentaire" class="form-control" rows="2"></textarea>
  </div>
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-success">Enregistrer</button>
    <button type="button" id="siteFormCancel" class="btn btn-secondary">Annuler</button>
  </div>
</form>                <div id="sitesList" class="list-group">                    <!-- Les sites du client seront chargÃ©s ici -->                    <p class="text-muted">Aucun site enregistrÃ© pour le moment.</p>                </div>            </div>        </div>        <!-- Section Mon Profil -->        <div class="card mt-4">            <div class="card-header">                Mon Profil            </div>            <div class="card-body" id="clientProfile">                <p><strong>Nom du Client:</strong> <span id="profileNomClient"></span></p>                <p><strong>Email du ReprÃ©sentant:</strong> <span id="profileRepresentantEmail"></span></p>                <p><strong>TÃ©lÃ©phone du ReprÃ©sentant:</strong> <span id="profileRepresentantTel"></span></p>                <p><strong>Commentaire:</strong> <span id="profileCommentaire"></span></p>            </div>        </div>        <!-- Section Demandes d'Intervention -->        <div class="card mt-4">            <div class="card-header">                Vos Demandes d'Intervention            </div>            <div class="card-body">                <button class="btn btn-primary mb-3" id="createDemandeBtn">Faire une nouvelle demande</button><form id="demandeForm" class="border rounded p-3 mb-3 d-none">
  <div class="mb-3">
    <label for="demandeSiteId" class="form-label">Site (optionnel)</label>
    <select id="demandeSiteId" class="form-select"><option value="">-- Sans site --</option></select>
  </div>
  <div class="mb-3">
    <label for="demandeDescription" class="form-label">Description</label>
    <textarea id="demandeDescription" class="form-control" rows="3" required></textarea>
  </div>
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-success">Envoyer</button>
    <button type="button" id="demandeFormCancel" class="btn btn-secondary">Annuler</button>
  </div>
</form>                <div id="demandesList" class="list-group">                    <!-- Les demandes du client seront chargÃ©es ici -->                    <p class="text-muted">Aucune demande d'intervention pour le moment.</p>                </div>            </div>        </div>        <!-- Section Historique des Interventions -->        <div class="card mt-4">            <div class="card-header">                Historique de vos Interventions            </div>            <div class="card-body">                <div id="historiqueInterventions">                    <!-- L'historique des interventions sera chargÃ© ici -->                    <p class="text-muted">Aucun historique d'intervention disponible.</p>                </div>            </div>        </div>    </div>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>    <script src="nav.js"></script>    <script>        document.addEventListener('DOMContentLoaded', () => {            const token = localStorage.getItem('token');            if (!token) {                window.location.href = '/login.html'; // Rediriger si non connectÃ©                return;            }            async function fetchClientProfile() {                try {                    const response = await fetch('/api/client/profile', {                        headers: {                            'Authorization': `Bearer ${token}`                        }                    });                    if (!response.ok) {                        throw new Error(`HTTP error! status: ${response.status}`);                    }                    const profile = await response.json();                    document.getElementById('profileNomClient').textContent = profile.nom_client || 'N/A';                    document.getElementById('profileRepresentantEmail').textContent = profile.representant_email || 'N/A';                    document.getElementById('profileRepresentantTel').textContent = profile.representant_tel || 'N/A';                    document.getElementById('profileCommentaire').textContent = profile.commentaire || 'N/A';                } catch (error) {                    console.error('Erreur lors du chargement du profil client:', error);                    // GÃ©rer l\'affichage d\'une erreur Ã  l\'utilisateur                }            }            async function fetchClientSites() {                try {                    const response = await fetch('/api/client/sites', {                        headers: {                            'Authorization': `Bearer ${token}`                        }                    });                    if (!response.ok) {                        throw new Error(`HTTP error! status: ${response.status}`);                    }                    const sites = await response.json();                    const sitesListDiv = document.getElementById('sitesList');                    sitesListDiv.innerHTML = ''; // Clear existing content                    if (sites.length === 0) {                        sitesListDiv.innerHTML = '<p class="text-muted">Aucun site enregistrÃ© pour le moment.</p>';                    } else {                        sites.forEach(site => {                            const siteEl = document.createElement('div');                            siteEl.className = 'list-group-item list-group-item-action';                            siteEl.innerHTML = `                                <div class="d-flex w-100 justify-content-between">                                    <h5 class="mb-1">${site.nom_site}</h5>                                    <small>ID: ${site.id}</small>                                </div>                                <p class="mb-1">${site.commentaire || 'Pas de commentaire.'}</p>                                <small>Client ID: ${site.client_id}</small>                            `;                            sitesListDiv.appendChild(siteEl);                        });                    }                } catch (error) {                    console.error('Erreur lors du chargement des sites client:', error);                    // GÃ©rer l\'affichage d\'une erreur Ã  l\'utilisateur                }            }            async function fetchClientDemands() {                try {                    const response = await fetch('/api/demandes_client/mine', {                        headers: {                            'Authorization': `Bearer ${token}`                        }                    });                    if (!response.ok) {                        throw new Error(`HTTP error! status: ${response.status}`);                    }                    const demands = await response.json();                    const demandesListDiv = document.getElementById('demandesList');                    demandesListDiv.innerHTML = ''; // Clear existing content                    if (demands.length === 0) {                        demandesListDiv.innerHTML = '<p class="text-muted">Aucune demande d\'intervention pour le moment.</p>';                    } else {                        demands.forEach(demand => {                            const demandEl = document.createElement('div');                            demandEl.className = 'list-group-item list-group-item-action';                            demandEl.innerHTML = `                                <div class="d-flex w-100 justify-content-between">                                    <h5 class="mb-1">Demande #${demand.id} - Site: ${demand.nom_site || 'N/A'}</h5>                                    <small>${demand.status}</small>                                </div>                                <p class="mb-1">${demand.description}</p>                                <small>CrÃ©Ã©e le: ${new Date(demand.created_at).toLocaleDateString()}</small>                            `;                            demandesListDiv.appendChild(demandEl);                        });                    }                } catch (error) {                    console.error('Erreur lors du chargement des demandes client:', error);                    // GÃ©rer l\'affichage d\'une erreur Ã  l\'utilisateur                }            }            async function fetchInterventionHistory() {                try {                    const sitesResponse = await fetch('/api/client/sites', {                        headers: {                            'Authorization': `Bearer ${token}`                        }                    });                    if (!sitesResponse.ok) {                        throw new Error(`HTTP error! status: ${sitesResponse.status}`);                    }                    const sites = await sitesResponse.json();                    const historiqueInterventionsDiv = document.getElementById('historiqueInterventions');                    historiqueInterventionsDiv.innerHTML = '';                    if (sites.length === 0) {                        historiqueInterventionsDiv.innerHTML = '<p class="text-muted">Aucun historique d\'intervention disponible car aucun site enregistrÃ©.</p>';                        return;                    }                    let allTickets = [];                    for (const site of sites) {                        const ticketsResponse = await fetch(`/api/sites/${site.id}/relations`, {                            headers: {                                'Authorization': `Bearer ${token}`                            }                        });                        if (!ticketsResponse.ok) {                            console.warn(`Could not fetch tickets for site ${site.id}: ${ticketsResponse.status}`);                            continue;                        }                        const siteRelations = await ticketsResponse.json();                        if (siteRelations.tickets) {                            allTickets = allTickets.concat(siteRelations.tickets.map(ticket => ({ ...ticket, site_nom: site.nom_site })));                        }                    }                    if (allTickets.length === 0) {                        historiqueInterventionsDiv.innerHTML = '<p class="text-muted">Aucun historique d\'intervention disponible pour vos sites.</p>';                    } else {                        allTickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Sort by most recent                        allTickets.forEach(ticket => {                            const ticketEl = document.createElement('div');                            ticketEl.className = 'list-group-item list-group-item-action';                            ticketEl.innerHTML = `                                <div class="d-flex w-100 justify-content-between">                                    <h5 class="mb-1">Ticket #${ticket.id} - ${ticket.titre}</h5>                                    <small>${ticket.etat}</small>                                </div>                                <p class="mb-1">Site: ${ticket.site_nom || 'N/A'}</p>                                <small>CrÃ©Ã©e le: ${new Date(ticket.created_at).toLocaleDateString()}</small>                            `;                            historiqueInterventionsDiv.appendChild(ticketEl);                        });                    }                } catch (error) {                    console.error('Erreur lors du chargement de l\'historique des interventions:', error);                    // GÃ©rer l\'affichage d\'une erreur Ã  l\'utilisateur                }            }            fetchClientProfile();            fetchClientSites();            fetchClientDemands();            fetchInterventionHistory();            document.getElementById('createSiteBtn').addEventListener('click', () => {                window.location.href = '/site-new.html'; // Assuming a generic site creation page            });            document.getElementById('createDemandeBtn').addEventListener('click', () => {                window.location.href = '/ticket-new.html'; // Assuming a generic ticket creation page for demands            });        });    </script><script>\(function\(\)\{\n\ \ function\ qs\(id\)\{\ return\ document\.getElementById\(id\);\ }\n\ \ document\.addEventListener\('DOMContentLoaded',\ function\(\)\{\n\ \ \ \ const\ token\ =\ localStorage\.getItem\('token'\);\n\ \ \ \ const\ btnSite\ =\ qs\('createSiteBtn'\);\n\ \ \ \ const\ formSite\ =\ qs\('siteForm'\);\n\ \ \ \ const\ btnSiteCancel\ =\ qs\('siteFormCancel'\);\n\ \ \ \ const\ siteNom\ =\ qs\('siteNom'\);\n\ \ \ \ const\ siteCommentaire\ =\ qs\('siteCommentaire'\);\n\n\ \ \ \ const\ btnDemande\ =\ qs\('createDemandeBtn'\);\n\ \ \ \ const\ formDemande\ =\ qs\('demandeForm'\);\n\ \ \ \ const\ btnDemandeCancel\ =\ qs\('demandeFormCancel'\);\n\ \ \ \ const\ demandeSiteId\ =\ qs\('demandeSiteId'\);\n\ \ \ \ const\ demandeDescription\ =\ qs\('demandeDescription'\);\n\n\ \ \ \ if\ \(btnSite\ &&\ formSite\)\{\n\ \ \ \ \ \ btnSite\.onclick\ =\ function\(\)\{\ formSite\.classList\.toggle\('d-none'\);\ };\n\ \ \ \ }\n\ \ \ \ if\ \(btnSiteCancel\)\{\ btnSiteCancel\.onclick\ =\ function\(\)\{\ formSite\.classList\.add\('d-none'\);\ };\ }\n\ \ \ \ if\ \(formSite\)\{\n\ \ \ \ \ \ formSite\.addEventListener\('submit',\ async\ function\(e\)\{\n\ \ \ \ \ \ \ \ e\.preventDefault\(\);\n\ \ \ \ \ \ \ \ const\ payload\ =\ \{\ nom_site:\ siteNom\.value\.trim\(\),\ commentaire:\ siteCommentaire\.value\.trim\(\)\ \|\|\ null\ };\n\ \ \ \ \ \ \ \ if\ \(!payload\.nom_site\)\ return;\n\ \ \ \ \ \ \ \ const\ r\ =\ await\ fetch\('/api/client/sites',\ \{\ method:'POST',\ headers:\ \{\ 'Content-Type':'application/json','Authorization':`Bearer\ \$\{token}`\ },\ body:\ JSON\.stringify\(payload\)\ }\);\n\ \ \ \ \ \ \ \ if\ \(r\.ok\)\{\ formSite\.classList\.add\('d-none'\);\ siteNom\.value='';\ siteCommentaire\.value='';\ try\ \{\ await\ fetchClientSites\(\);\ await\ fetchInterventionHistory\(\);\ }\ catch\(_\)\{}\ }\n\ \ \ \ \ \ }\);\n\ \ \ \ }\n\n\ \ \ \ if\ \(btnDemande\ &&\ formDemande\)\{\ btnDemande\.onclick\ =\ function\(\)\{\ formDemande\.classList\.toggle\('d-none'\);\ };\ }\n\ \ \ \ if\ \(btnDemandeCancel\)\{\ btnDemandeCancel\.onclick\ =\ function\(\)\{\ formDemande\.classList\.add\('d-none'\);\ };\ }\n\ \ \ \ if\ \(formDemande\)\{\n\ \ \ \ \ \ formDemande\.addEventListener\('submit',\ async\ function\(e\)\{\n\ \ \ \ \ \ \ \ e\.preventDefault\(\);\n\ \ \ \ \ \ \ \ const\ payload\ =\ \{\ description:\ demandeDescription\.value\.trim\(\)\ };\n\ \ \ \ \ \ \ \ const\ sid\ =\ String\(demandeSiteId\.value\|\|''\)\.trim\(\);\ if\ \(sid\)\ payload\.site_id\ =\ Number\(sid\);\n\ \ \ \ \ \ \ \ if\ \(!payload\.description\)\ return;\n\ \ \ \ \ \ \ \ const\ r\ =\ await\ fetch\('/api/demandes_client',\ \{\ method:'POST',\ headers:\ \{\ 'Content-Type':'application/json','Authorization':`Bearer\ \$\{token}`\ },\ body:\ JSON\.stringify\(payload\)\ }\);\n\ \ \ \ \ \ \ \ if\ \(r\.ok\)\{\ formDemande\.classList\.add\('d-none'\);\ demandeDescription\.value='';\ try\ \{\ await\ fetchClientDemands\(\);\ }\ catch\(_\)\{}\ }\n\ \ \ \ \ \ }\);\n\ \ \ \ }\n\n\ \ \ \ //\ populate\ demande\ site\ select\ on\ sites\ fetch\n\ \ \ \ try\ \{\ if\ \(typeof\ fetchClientSites\ ===\ 'function'\)\ \{\ fetchClientSites\(\);\ }\ }\ catch\ \{}\n\ \ }\);\n}\)\(\);</script></body></html>




