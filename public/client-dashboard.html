<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de Bord Client</title>
  <link rel="stylesheet" href="/custom.css?v=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="/nav.js?v=1"></script>
  <style>
    .dashboard-bg { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); min-height: 100vh; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
  </style>
</head>
<body class="dashboard-bg">
    <header class="header d-flex justify-content-between align-items-center mb-4 p-3 bg-white shadow-sm rounded">
      <h1 class="m-0">
        <a href="/dashboard.html" class="text-decoration-none text-dark">
          <img src="/logo_logicielle.png" alt="Logo" style="height: 30px; vertical-align: middle; margin-right: 10px;">
          <span class="fw-bold">Espace Client</span>
        </a>
      </h1>
      <div class="d-flex align-items-center gap-3">
      <div class="d-flex align-items-center bg-light border rounded-pill px-3 py-1 shadow-sm">
        <i class="bi bi-person-circle text-primary fs-4 me-2"></i>
        <div class="text-nowrap fw-medium text-secondary">Bienvenue</div>
      </div>
        <button id="client-logout-btn" class="btn btn-outline-danger btn-sm rounded-pill">Déconnexion</button>
        </button>
      </div>
    </header>
  <div id="navbar-placeholder"></div>

  <div class="container mt-5">
    <h1 class="mb-3">Bienvenue sur votre Tableau de Bord Client</h1>
    <p class="mb-4">Gérez vos sites, faites des demandes d'intervention et consultez votre historique.</p>

    <!-- Section Sites -->
    <div class="card mt-4">
      <div class="card-header">Vos Sites</div>
      <div class="card-body">
       <!--<a class="btn btn-primary mb-3" id="createSiteBtn" href="/client-new-site.html">Ajouter un nouveau site</a>-->
        <div id="sitesList" class="list-group">
          <p class="text-muted">Aucun site enregistré pour le moment.</p>
        </div>
      </div>
    </div>

    <!-- Section Mon Profil -->
    <div class="card mt-4">
      <div class="card-header">Mon Profil</div>
      <div class="card-body" id="clientProfile">
        <p><strong>Nom du Client:</strong> <span id="profileNomClient"></span></p>
        <p><strong>Email du Représentant:</strong> <span id="profileRepresentantEmail"></span></p>
        <p><strong>Téléphone du Représentant:</strong> <span id="profileRepresentantTel"></span></p>
        <p><strong>Commentaire:</strong> <span id="profileCommentaire"></span></p>
      </div>
    </div>

    <!-- Section Demandes d'Intervention -->
    <div class="card mt-4">
      <div class="card-header">Vos Demandes d'Intervention</div>
      <div class="card-body">
        <button class="btn btn-primary mb-3" data-modal="createDemandeModal">Faire une nouvelle demande</button>
        <div id="demandesList" class="list-group">
          <p class="text-muted">Aucune demande d'intervention pour le moment.</p>
        </div>
      </div>
    </div>

    <!-- Section Historique des Interventions -->
    <div class="card mt-4">
      <div class="card-header">Historique de vos Interventions</div>
      <div class="card-body">
        <div id="historiqueInterventions">
          <p class="text-muted">Aucun historique d'intervention disponible.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="createSiteModal" tabindex="-1" aria-labelledby="createSiteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createSiteModalLabel">Créer un nouveau site</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="createSiteFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewSiteModal" tabindex="-1" aria-labelledby="viewSiteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewSiteModalLabel">Voir Site</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="viewSiteFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editSiteModal" tabindex="-1" aria-labelledby="editSiteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editSiteModalLabel">Modifier Site</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="editSiteFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="createDemandeModal" tabindex="-1" aria-labelledby="createDemandeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createDemandeModalLabel">Nouvelle demande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="createDemandeFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewDemandeModal" tabindex="-1" aria-labelledby="viewDemandeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewDemandeModalLabel">Suivi de demande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="viewDemandeFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editDemandeModal" tabindex="-1" aria-labelledby="editDemandeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editDemandeModalLabel">Modifier Demande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="editDemandeFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="filesDemandeModal" tabindex="-1" aria-labelledby="filesDemandeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filesDemandeModalLabel">Pièces jointes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="filesDemandeFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ----------------------------
     AUTHENTIFICATION
  ----------------------------- */
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login.html";

  const api = (url, opts = {}) =>
    fetch(url, {
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      ...opts
    }).then(async r => {
      const body = r.headers.get("content-type")?.includes("json") ? await r.json() : null;
      if (!r.ok) throw new Error(body?.error || r.status);
      return body;
    });

  const logoutBtn = document.getElementById("client-logout-btn");
  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("token");
    location.href = "/login.html";
  });

  /* ----------------------------
     HELPERS
  ----------------------------- */
  function badge(status) {
    const s = (status || "En cours de traitement").toLowerCase();
    return {
      "en cours de traitement": "bg-info",
      "traité": "bg-success",
      "rejeté": "bg-danger",
      "annulé": "bg-warning text-dark"
    }[s] || "bg-light text-dark";
  }

  const setText = (id, val) => document.getElementById(id).textContent = val || "N/A";

  function setLoading(el, txt = "Chargement…") {
    el.innerHTML = `<p class='text-muted'>${txt}</p>`;
  }

  /* ----------------------------
     FETCH PROFIL
  ----------------------------- */
  async function loadProfile() {
    try {
      const p = await api("/api/client/profile");
      setText("profileNomClient", p.nom_client);
      setText("profileRepresentantEmail", p.representant_email);
      setText("profileRepresentantTel", p.representant_tel);
      setText("profileCommentaire", p.commentaire);
    } catch (e) {
      console.error("profile", e);
    }
  }

  /* ----------------------------
     FETCH SITES
  ----------------------------- */
  async function loadSites() {
    const el = document.getElementById("sitesList");
    setLoading(el);

    try {
      const sites = await api("/api/client/sites");
      if (!sites.length)
        return setLoading(el, "Aucun site enregistré.");

      el.innerHTML = sites.map(site => `
        <div class="list-group-item list-group-item-action">
          <div class="d-flex w-100 justify-content-between">
            <h5>${site.nom_site}</h5>
            <small>ID: ${site.id}</small>
          </div>
          <p>${site.commentaire || "Pas de commentaire."}</p>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-info" 
                data-modal="viewSiteModal" data-id="${site.id}"><i class="bi bi-eye"></i> Voir</button>
            <button class="btn btn-sm btn-outline-warning"
                data-modal="editSiteModal" data-id="${site.id}"><i class="bi bi-pencil"></i> Modifier</button>
            <a class="btn btn-sm btn-outline-secondary" href="/client-site-files.html?site_id=${site.id}">
              Fichiers
            </a>
          </div>
        </div>
      `).join("");

    } catch (e) {
      setLoading(el, "Erreur de chargement.");
      console.error("sites:", e);
    }
  }

  /* ----------------------------
     FETCH DEMANDES CLIENT
  ----------------------------- */
  async function loadDemands() {
    const el = document.getElementById("demandesList");
    setLoading(el);

    try {
      const demands = await api("/api/demandes_client/mine");

      if (!demands.length)
        return setLoading(el, "Aucune demande pour le moment.");

      el.innerHTML = demands.map(d => `
        <div class="list-group-item list-group-item-action">
          <div class="d-flex justify-content-between">
            <h5>Demande #${d.id} – ${d.titre || d.nom_site || "Sans titre"}</h5>
            <span class="badge ${badge(d.status)}">${d.status}</span>
          </div>
          <p>${d.description || ""}</p>
          <small>Créée le : ${new Date(d.created_at).toLocaleDateString()}</small>

          <div class="mt-2">
            <button class="btn btn-sm btn-primary"
                data-modal="viewDemandeModal" data-id="${d.id}">Suivre</button>
            ${!d.ticket_id
              ? `<button class="btn btn-sm btn-outline-warning"
                    data-modal="editDemandeModal" data-id="${d.id}"><i class="bi bi-pencil"></i> Modifier</button>`
              : `<button class="btn btn-sm btn-outline-warning" disabled title="Cette demande a été convertie en ticket et ne peut plus être modifiée.">
                    <i class="bi bi-pencil"></i> Modifier
                 </button>`
            }
            <button class="btn btn-sm btn-outline-secondary"
                data-modal="filesDemandeModal" data-id="${d.id}">Fichiers</button>
          </div>
        </div>
      `).join("");

    } catch (e) {
      setLoading(el, "Erreur de chargement.");
      console.error("demandes:", e);
    }
  }

  /* ----------------------------
     HISTORIQUE DES INTERVENTIONS
  ----------------------------- */
  async function loadHistory() {
    const el = document.getElementById("historiqueInterventions");
    setLoading(el);

    try {
      const sites = await api("/api/client/sites");
      let tickets = [];

      for (const s of sites) {
        const r = await api(`/api/sites/${s.id}/relations`);
        if (r.tickets)
          tickets.push(...r.tickets.map(t => ({ ...t, site_nom: s.nom_site })));
      }

      if (!tickets.length)
        return setLoading(el, "Aucun historique disponible.");

      tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      el.innerHTML = tickets.map(t => {
        const isTermine = (t.etat || "").toLowerCase() === "termine";
        return `
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">Ticket #${t.id} – ${t.titre}</h5>
              <p class="mb-0">Site : ${t.site_nom}</p>
              <small class="text-muted">Créé le : ${new Date(t.created_at).toLocaleDateString()}</small>
            </div>
            <span class="badge ${isTermine ? "bg-success" : "bg-secondary"}">${t.etat}</span>
          </div>
          ${isTermine ? `
          <div class="mt-3 p-3 border rounded bg-light">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Votre satisfaction</strong>
              <span class="text-muted small">Visible uniquement par l'équipe support</span>
            </div>
            <div class="row g-2 align-items-center">
              <div class="col-sm-4">
                <label class="form-label mb-1 small">Note (1 à 5)</label>
                <select class="form-select form-select-sm feedback-note" data-ticket="${t.id}">
                  <option value="5">5 - Excellent</option>
                  <option value="4">4 - Très bien</option>
                  <option value="3">3 - Bien</option>
                  <option value="2">2 - Moyen</option>
                  <option value="1">1 - Mauvais</option>
                </select>
              </div>
              <div class="col-sm-8">
                <label class="form-label mb-1 small">Commentaire</label>
                <textarea class="form-control form-control-sm feedback-comment" data-ticket="${t.id}" rows="2" placeholder="Partagez votre ressenti..."></textarea>
              </div>
            </div>
            <div class="mt-2 d-flex justify-content-end gap-2">
              <button class="btn btn-sm btn-outline-secondary clear-feedback" data-ticket="${t.id}">Effacer</button>
              <button class="btn btn-sm btn-primary send-feedback" data-ticket="${t.id}">
                <i class="bi bi-send"></i> Envoyer
              </button>
            </div>
            <div class="feedback-status text-success small mt-2 d-none" data-ticket="${t.id}"></div>
          </div>` : ""}
        </div>
      `;
      }).join("");

    } catch (e) {
      console.error("history:", e);
      setLoading(el, "Erreur de chargement.");
    }
  }

  // Envoi de satisfaction
  document.body.addEventListener("click", async (e) => {
    const sendBtn = e.target.closest(".send-feedback");
    const clearBtn = e.target.closest(".clear-feedback");
    if (!sendBtn && !clearBtn) return;

    const ticketId = sendBtn?.dataset.ticket || clearBtn?.dataset.ticket;
    if (!ticketId) return;

    const noteEl = document.querySelector(`.feedback-note[data-ticket="${ticketId}"]`);
    const commentEl = document.querySelector(`.feedback-comment[data-ticket="${ticketId}"]`);
    const statusEl = document.querySelector(`.feedback-status[data-ticket="${ticketId}"]`);

    if (clearBtn) {
      if (noteEl) noteEl.value = "5";
      if (commentEl) commentEl.value = "";
      if (statusEl) { statusEl.classList.add("d-none"); statusEl.textContent = ""; }
      return;
    }

    const note = noteEl?.value || "5";
    const commentaire = commentEl?.value?.trim() || "";

    try {
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      await api(`/api/tickets/${ticketId}/satisfaction`, {
        method: "POST",
        body: JSON.stringify({ note: Number(note), commentaire })
      });
      if (statusEl) {
        statusEl.textContent = "Merci, votre avis a été enregistré.";
        statusEl.classList.remove("d-none");
      }
    } catch (err) {
      alert("Impossible d'enregistrer votre satisfaction. Réessayez plus tard.");
      console.error("feedback:", err);
    } finally {
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="bi bi-send"></i> Envoyer';
    }
  });

  /* ----------------------------
     GESTION AUTOMATISÉE DES MODALES
  ----------------------------- */
  const frameMap = {
    viewSiteModal: "viewSiteFrame",
    editSiteModal: "editSiteFrame",
    createSiteModal: "createSiteFrame",
    createDemandeModal: "createDemandeFrame",
    viewDemandeModal: "viewDemandeFrame",
    editDemandeModal: "editDemandeFrame",
    filesDemandeModal: "filesDemandeFrame"
  };

  const modalUrlMap = {
    viewSiteModal: (id) => `/client-site-view.html?id=${id}`,
    editSiteModal: (id) => `/client-site-edit.html?id=${id}`,
    createSiteModal: () => `/client-new-site.html`,
    createDemandeModal: () => `/client-new-demand.html`,
    viewDemandeModal: (id) => `/client-demand-view.html?id=${id}`,
    editDemandeModal: (id) => `/client-demand-edit.html?id=${id}`,
    filesDemandeModal: (id) => `/client-demand-files.html?id=${id}`
  };

  document.body.addEventListener("click", e => {
    const btn = e.target.closest("[data-modal]");
    if (!btn) return;

    e.preventDefault();

    const modalId = btn.dataset.modal;
    const itemId = btn.dataset.id;
    const urlBuilder = modalUrlMap[modalId];
    
    if (!urlBuilder) {
      console.error("No URL builder found for modal:", modalId);
      return;
    }

    const modalEl = document.getElementById(modalId);
    const frame = document.getElementById(frameMap[modalId]);

    if (modalEl && frame) {
      const url = urlBuilder(itemId || '');
      // Only set src if it's different to avoid reloading the iframe unnecessarily
      if (frame.getAttribute('src') !== url) {
        frame.src = url;
      }
      new bootstrap.Modal(modalEl).show();
    } else {
      console.error("Modal or frame not found for:", modalId);
    }
  });

  /* ----------------------------
     LANCEMENT INITIAL
  ----------------------------- */

  loadProfile();
  loadSites();
  loadDemands();
  loadHistory();

});
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
