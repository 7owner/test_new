<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Contrats</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    .dashboard-bg { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); min-height: 100vh; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .filters-card { background: #fff; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>

  <main class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="m-0">Contrats</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" id="toggle-filters-btn"><i class="bi bi-funnel-fill me-1"></i>Masquer les filtres</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createContratModal"><i class="bi bi-plus-circle me-2"></i>Créer un contrat</button>
      </div>
    </div>

    <div class="filters-card p-3 mb-4" id="filters-row">
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
        <h5 class="mb-0">Filtres</h5>
      </div>
      <div class="row g-2">
        <div class="col-lg-6 col-md-8 col-12">
          <input type="text" id="contrat-search" class="form-control" placeholder="Rechercher par titre...">
        </div>
        <div class="col-lg-3 col-md-4 col-12">
          <input type="date" id="contrat-date-start" class="form-control" title="Date de début min">
        </div>
        <div class="col-lg-3 col-md-4 col-12">
          <input type="date" id="contrat-date-end" class="form-control" title="Date de début max">
        </div>
        <div class="col-lg-3 col-md-4 col-12">
          <select id="association-filter" class="form-select">
            <option value="">Toutes les associations</option>
          </select>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Début</th>
            <th>Fin</th>
            <th>Sites liés</th>
            <th>Associations</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="contrats-table-body"></tbody>
      </table>
    </div>
  </main>

  <!-- Modals (iframes) -->
  <div class="modal fade" id="createContratModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau contrat</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <iframe src="/contrat-new.html" style="width:100%;height:80vh;border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewContratModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Voir contrat</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <iframe id="viewContratFrame" style="width:100%;height:80vh;border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editContratModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Modifier contrat</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <iframe id="editContratFrame" style="width:100%;height:80vh;border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const headers = token ? { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } : { 'Content-Type': 'application/json' };

      const tableBody = document.getElementById('contrats-table-body');
      const searchInput = document.getElementById('contrat-search');
      const dateStart = document.getElementById('contrat-date-start');
      const dateEnd = document.getElementById('contrat-date-end');
      const associationFilter = document.getElementById('association-filter'); // Select
      const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
      const filtersRow = document.getElementById('filters-row');
      const params = new URLSearchParams(window.location.search);
      const preselectAssociationId = params.get('association_id');

      const createModal = new bootstrap.Modal(document.getElementById('createContratModal'));
      const editModal = new bootstrap.Modal(document.getElementById('editContratModal'));
      const viewModal = new bootstrap.Modal(document.getElementById('viewContratModal'));
      const viewContratFrame = document.getElementById('viewContratFrame');
      const editContratFrame = document.getElementById('editContratFrame');

      let contrats = [];

      async function api(url, opts={}) {
        const res = await fetch(url, { headers, ...opts });
        const body = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(body.error || res.statusText);
        return body;
      }

      function formatDate(d) {
        if (!d) return '';
        const dt = new Date(d);
        return isNaN(dt.getTime()) ? '' : dt.toLocaleDateString();
      }

      async function loadContrats() {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-muted">Chargement...</td></tr>';
        try {
          const [contratsList, associationsList] = await Promise.all([
            api('/api/contrats'),
            api('/api/associations').catch(() => [])
          ]);
          contrats = contratsList;
          // Populate association select
          associationFilter.innerHTML = '<option value="">Toutes les associations</option>';
          (associationsList || []).forEach(asso => {
            const opt = document.createElement('option');
            opt.value = asso.id;
            opt.textContent = asso.titre;
            associationFilter.appendChild(opt);
          });
          if (preselectAssociationId) associationFilter.value = preselectAssociationId;
          applyFilters();
        } catch (e) {
          tableBody.innerHTML = '<tr><td colspan="6" class="text-danger">Erreur de chargement.</td></tr>';
        }
      }

      function applyFilters() {
        const term = (searchInput.value || '').toLowerCase();
        const start = dateStart.value ? new Date(dateStart.value) : null;
        const end = dateEnd.value ? new Date(dateEnd.value) : null;
        const selectedAssociationId = associationFilter.value;
        if (start) start.setHours(0,0,0,0);
        if (end) end.setHours(23,59,59,999);

        const rows = (contrats || []).filter(c => {
          const matchTerm = c.titre && c.titre.toLowerCase().includes(term);
          const deb = c.date_debut ? new Date(c.date_debut) : null;
          if (start && deb && deb < start) return false;
          if (end && deb && deb > end) return false;

          // Filter by association id
          const matchesAssociation = !selectedAssociationId || (c.associations && c.associations.some(asso => String(asso.id) === selectedAssociationId));
          
          return matchTerm && matchesAssociation;
        });
        render(rows);
      }

      function render(rows) {
        tableBody.innerHTML = '';
        if (!rows.length) {
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Aucun contrat trouvé.</td></tr>';
          return;
        }
        rows.forEach(c => {
          const tr = document.createElement('tr');
          const siteNames = (c.sites_linked && c.sites_linked.length)
            ? c.sites_linked.map(s => `<span class="badge bg-light text-dark me-1 mb-1">${s.nom_site}</span>`).join(' ')
            : '<span class="text-muted small">Aucun site associé</span>';
          
          const associatedAssociations = (c.associations || []).map(asso => 
            `<span class="badge bg-secondary me-1 mb-1">${asso.titre}</span>`
          ).join(' ');

          tr.innerHTML = `
            <td>${c.titre || ''}</td>
            <td>${formatDate(c.date_debut)}</td>
            <td>${formatDate(c.date_fin) || '—'}</td>
            <td>${siteNames}</td>
            <td>${associatedAssociations || '<span class="text-muted">—</span>'}</td>
            <td>
              <button class="btn btn-sm btn-info me-1 btn-view" data-id="${c.id}"><i class="bi bi-eye"></i> Voir</button>
              <button class="btn btn-sm btn-warning me-1 btn-edit" data-id="${c.id}"><i class="bi bi-pencil"></i> Modifier</button>
              <button class="btn btn-sm btn-outline-danger btn-del" data-id="${c.id}"><i class="bi bi-trash"></i></button>
            </td>
          `;
          tableBody.appendChild(tr);
        });
      }

      tableBody.addEventListener('click', async (e) => {
        const viewBtn = e.target.closest('.btn-view');
        const editBtn = e.target.closest('.btn-edit');
        const delBtn = e.target.closest('.btn-del');
        if (viewBtn) {
          const id = viewBtn.getAttribute('data-id');
          if (viewContratFrame) viewContratFrame.src = `/contrat-view.html?id=${id}`;
          viewModal.show();
        } else if (editBtn) {
          const id = editBtn.getAttribute('data-id');
          if (editContratFrame) editContratFrame.src = `/contrat-edit.html?id=${id}`;
          editModal.show();
        } else if (delBtn) {
          const id = delBtn.getAttribute('data-id');
          if (!confirm('Supprimer ce contrat ?')) return;
          try {
            await api(`/api/contrats/${id}`, { method: 'DELETE' });
            await loadContrats();
          } catch (err) {
            alert(err.message || 'Suppression impossible');
          }
        }
      });

      searchInput.addEventListener('input', applyFilters);
      dateStart.addEventListener('change', applyFilters);
      dateEnd.addEventListener('change', applyFilters);
      associationFilter.addEventListener('change', applyFilters);

      if (toggleFiltersBtn && filtersRow) {
        toggleFiltersBtn.addEventListener('click', () => {
          const hidden = filtersRow.classList.toggle('d-none');
          toggleFiltersBtn.innerHTML = hidden ? '<i class="bi bi-funnel me-1"></i>Afficher les filtres' : '<i class="bi bi-funnel-fill me-1"></i>Masquer les filtres';
        });
      }

      loadContrats();
    });
  </script>
</body>
</html>
