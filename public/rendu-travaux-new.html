<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveau rendu de travail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=3"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .embed header, .embed #navbar-placeholder { display:none !important; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card { border: 2px solid #e5e7eb; border-radius: 12px; background: #fff; overflow: hidden; }
    .attachment-preview { width:100%; height:180px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; }
    .attachment-preview img { width:100%; height:100%; object-fit:cover; }
    .attachment-body { padding: 12px 14px; }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <div>
        <h1 class="h4 mb-1"><i class="bi bi-file-text me-2"></i>Nouveau rendu de travail</h1>
        <div class="text-muted small">Travail <span id="travaux-id">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <form id="rendu-form" novalidate>
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label fw-semibold">Résumé détaillé (Markdown)</label>
              <textarea id="resume" class="form-control" rows="10" placeholder="Rédigez un résumé détaillé en Markdown..."></textarea>
              <div class="form-text">Utilisez Markdown pour un résumé détaillé (optionnel).</div>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-semibold">Aperçu</label>
              <div id="resume-preview" class="border rounded p-3 bg-light" style="min-height: 220px;">
                <em class="text-muted">Le résumé apparaîtra ici...</em>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes (images)</h5>
            <span class="badge bg-primary" id="files-count">0 fichier(s)</span>
          </div>
          <p class="text-muted small mb-3">Ajoutez des images avec un titre et un commentaire.</p>

          <div class="mb-3">
            <input class="form-control" type="file" id="files-input" accept="image/*" multiple>
          </div>

          <div class="row g-3" id="files-grid"></div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary" id="save-btn"><i class="bi bi-save me-1"></i>Créer</button>
            <button type="button" class="btn btn-secondary" id="cancel-btn">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const qp = new URLSearchParams(location.search);
      const travauxId = qp.get('id') || qp.get('travaux_id');
      const isEmbed = window.self !== window.top || qp.get('embed') === '1' || qp.get('modal') === '1';
      if (isEmbed) document.body.classList.add('embed');

      const token = localStorage.getItem('token');
      if (!token) return (location.href = '/login.html');
      const headersAuthOnly = { 'Authorization': `Bearer ${token}` };

      const travauxIdEl = document.getElementById('travaux-id');
      if (travauxIdEl) travauxIdEl.textContent = travauxId || '-';
      if (!travauxId) { alert('Travail inconnu'); return (location.href = '/travaux.html'); }

      const filesInput = document.getElementById('files-input');
      const filesGrid = document.getElementById('files-grid');
      const filesCount = document.getElementById('files-count');
      const saveBtn = document.getElementById('save-btn');

      const editor = new EasyMDE({
        element: document.getElementById('resume'),
        spellChecker: false,
        status: false,
        forceSync: true,
        toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'preview']
      });

      const resumePreview = document.getElementById('resume-preview');
      const updatePreview = () => {
        const txt = editor.value().trim();
        resumePreview.innerHTML = txt ? marked.parse(txt) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
      };
      editor.codemirror.on('change', updatePreview);
      updatePreview();

      const selected = [];
      const renderFiles = () => {
        filesGrid.innerHTML = '';
        filesCount.textContent = `${selected.length} fichier(s)`;
        selected.forEach((it, idx) => {
          const col = document.createElement('div');
          col.className = 'col-12 col-md-6 col-lg-4';
          const url = it.previewUrl;
          col.innerHTML = `
            <div class="attachment-card h-100">
              <div class="attachment-preview">${url ? `<img src="${url}" alt="">` : '<i class="bi bi-image" style="font-size:3rem;color:#94a3b8;"></i>'}</div>
              <div class="attachment-body">
                <div class="mb-2">
                  <label class="form-label fw-semibold small">Titre</label>
                  <input class="form-control form-control-sm file-title" data-idx="${idx}" value="${(it.titre || '').replaceAll('"','&quot;')}">
                </div>
                <div class="mb-2">
                  <label class="form-label fw-semibold small">Commentaire</label>
                  <textarea class="form-control form-control-sm file-comment" rows="2" data-idx="${idx}">${it.commentaire || ''}</textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="small text-muted text-truncate" title="${it.file.name}"><i class="bi bi-paperclip me-1"></i>${it.file.name}</div>
                  <button type="button" class="btn btn-sm btn-outline-danger remove-file" data-idx="${idx}" title="Retirer">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </div>
            </div>`;
          filesGrid.appendChild(col);
        });
      };

      filesInput?.addEventListener('change', () => {
        const files = Array.from(filesInput.files || []);
        for (const file of files) {
          const previewUrl = file.type.startsWith('image/') ? URL.createObjectURL(file) : '';
          selected.push({ file, previewUrl, titre: file.name, commentaire: '' });
        }
        filesInput.value = '';
        renderFiles();
      });

      filesGrid?.addEventListener('input', (e) => {
        const t = e.target;
        if (t.classList.contains('file-title')) {
          const idx = Number(t.dataset.idx);
          if (selected[idx]) selected[idx].titre = t.value;
        }
        if (t.classList.contains('file-comment')) {
          const idx = Number(t.dataset.idx);
          if (selected[idx]) selected[idx].commentaire = t.value;
        }
      });

      filesGrid?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-file');
        if (!btn) return;
        const idx = Number(btn.dataset.idx);
        const it = selected[idx];
        if (it?.previewUrl) URL.revokeObjectURL(it.previewUrl);
        selected.splice(idx, 1);
        renderFiles();
      });

      const back = () => {
        if (document.referrer) return history.back();
        location.href = `/travaux-view.html?id=${travauxId}`;
      };
      document.getElementById('back-btn')?.addEventListener('click', back);
      document.getElementById('cancel-btn')?.addEventListener('click', back);

      document.getElementById('rendu-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Création...';
          const fd = new FormData();
          fd.append('resume', editor.value().trim());
          fd.append('valeur', '');
          selected.forEach((it) => {
            fd.append('image_files[]', it.file);
            fd.append('image_titles', it.titre || it.file.name);
            fd.append('image_commentaires', it.commentaire || '');
            fd.append('image_notes', '');
          });

          const r = await fetch(`/api/travaux/${travauxId}/rendus`, {
            method: 'POST',
            headers: headersAuthOnly,
            credentials: 'same-origin',
            body: fd
          });
          const d = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(d.error || `HTTP ${r.status}`);
          const renduId = d.renduId;
          location.href = `/rendu-travaux-view.html?id=${renduId}&travaux_id=${travauxId}`;
        } catch (err) {
          alert(err.message || "Erreur lors de l'enregistrement");
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Créer';
        }
      });
    });
  </script>
</body>
</html>

