<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travaux</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/custom.css?v=1">
  <script src="/nav.js?v=2"></script>
  <style>
    :root {
      --bg:        #f8f9fc;
      --card:      #ffffff;
      --text:      #1e293b;
      --muted:     #64748b;
      --border:    #e2e8f0;
      --todo:      #94a3b8;
      --doing:     #f59e0b;
      --waiting:   #6b7280;
      --done:      #10b981;
      --prio-high:   #ef4444;
      --prio-med:    #f97316;
      --prio-low:    #6b7280;
    }
    body {
      background: linear-gradient(145deg, #f8fafc, #f1f5f9);
      color: var(--text);
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
      padding: 2rem 1rem;
    }
    .board-col {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 25px -5px rgba(15,23,42,0.08);
      padding: 1.25rem;
      min-height: 65vh;
      transition: all 0.22s ease;
    }
    .board-col:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 35px -10px rgba(15,23,42,0.12);
    }
    .col-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; padding-bottom:.9rem; border-bottom:1px solid var(--border); }
    .col-header h5 { margin:0; font-weight:600; font-size:1.1rem; }
    .badge-count { font-weight:500; padding:0.4em 0.85em; border-radius:1.5rem; font-size:0.9rem; }
    [data-etat="A_faire"]    { --state-color: var(--todo); }
    [data-etat="En_cours"]   { --state-color: var(--doing); }
    [data-etat="En_attente"] { --state-color: var(--waiting); }
    [data-etat="Termine"]    { --state-color: var(--done); }
    [data-etat] .col-header h5 { color: var(--state-color); }
    [data-etat="A_faire"]    .badge-count { background: #e2e8f0; color: #475569; }
    [data-etat="En_cours"]   .badge-count { background: #fef3c7; color: #92400e; }
    [data-etat="En_attente"] .badge-count { background: #f3f4f6; color: #4b5563; }
    [data-etat="Termine"]    .badge-count { background: #d1fae5; color: #065f46; }
    .work-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
      transition: all 0.2s ease;
      overflow: hidden;
    }
    .work-card:hover { transform: translateY(-4px); box-shadow: 0 14px 28px -8px rgba(0,0,0,0.14); }
    .work-card .card-body { padding: 1.1rem; }
    .tag { font-size: 0.8rem; padding: 0.25rem 0.65rem; border-radius: 2rem; font-weight: 500; }
    .tag-haute   { background: #fee2e2; color: #991b1b; }
    .tag-moyenne { background: #ffedd5; color: #9a3412; }
    .tag-basse   { background: #e5e7eb; color: #4b5563; }
    .progress { height: 8px; border-radius: 999px; background: #e2e8f0; margin: 0.5rem 0; }
    .progress-bar { background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 999px; }
    .drop-hover { background: #f1f5f9 !important; outline: 2px dashed #6366f1; outline-offset: -3px; }
    .dragging { opacity: 0.6; }
    .empty-placeholder { color: #8b93aa; font-style: italic; }
    @media (max-width: 992px) { .board-col { min-height: 50vh; margin-bottom: 1.5rem; } }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 fw-bold">Tableau des travaux</h1>
        <div class="text-muted">Vue Kanban – état des chantiers</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-primary px-4" id="btn-new-travail">
          <i class="bi bi-plus-lg me-2"></i>Nouveau travail
        </button>
      </div>
    </div>

    <div class="row g-3" id="board">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="board-col" data-etat="A_faire">
          <div class="col-header">
            <div class="fw-semibold"><i class="bi bi-list-task me-1"></i> À faire</div>
            <span class="badge bg-light text-dark" id="count-A_faire">0</span>
          </div>
          <div class="col-body d-flex flex-column gap-2" id="col-A_faire">
            <div class="empty-placeholder">Chargement...</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="board-col" data-etat="En_cours">
          <div class="col-header">
            <div class="fw-semibold"><i class="bi bi-play-fill me-1"></i> En cours</div>
            <span class="badge bg-warning text-dark" id="count-En_cours">0</span>
          </div>
          <div class="col-body d-flex flex-column gap-2" id="col-En_cours">
            <div class="empty-placeholder">Chargement...</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="board-col" data-etat="En_attente">
          <div class="col-header">
            <div class="fw-semibold"><i class="bi bi-pause-fill me-1"></i> En attente</div>
            <span class="badge bg-secondary" id="count-En_attente">0</span>
          </div>
          <div class="col-body d-flex flex-column gap-2" id="col-En_attente">
            <div class="empty-placeholder">Chargement...</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="board-col" data-etat="Termine">
          <div class="col-header">
            <div class="fw-semibold"><i class="bi bi-check2-circle me-1"></i> Terminé</div>
            <span class="badge bg-success" id="count-Termine">0</span>
          </div>
          <div class="col-body d-flex flex-column gap-2" id="col-Termine">
            <div class="empty-placeholder">Chargement...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      let isAdmin = false;
      try {
        const payload = token ? JSON.parse(atob(token.split('.')[1])) : null;
        isAdmin = Array.isArray(payload?.roles) && payload.roles.includes('ROLE_ADMIN');
      } catch(_) {}
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const colIds = ['A_faire','En_cours','En_attente','Termine'];
      const container = document.querySelector('main .container');
      const filterRow = document.createElement('div');
      filterRow.className = 'row g-2 mb-3';
      filterRow.innerHTML = `
        <div class="col-md-3">
          <input id="filter-title" class="form-control form-control-sm" placeholder="Filtrer par titre de travail...">
        </div>
        <div class="col-md-3 position-relative">
          <input id="filter-affaire" class="form-control form-control-sm" placeholder="Filtrer par affaire...">
          <div id="sug-affaire" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
        </div>
        <div class="col-md-3 position-relative">
          <input id="filter-site" class="form-control form-control-sm" placeholder="Filtrer par site...">
          <div id="sug-site" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
        </div>
        <div class="col-md-3">
          <input id="filter-global" class="form-control form-control-sm" placeholder="Recherche globale (DOE, affaire, site, demande)...">
        </div>`;
      container?.insertBefore(filterRow, document.getElementById('board'));
      const titleFilter = document.getElementById('filter-title');
      const searchInput = document.getElementById('filter-global');
      const filterAffaire = document.getElementById('filter-affaire');
      const filterSite = document.getElementById('filter-site');
      const sugAffaire = document.getElementById('sug-affaire');
      const sugSite = document.getElementById('sug-site');
      let travauxCache = [];
      let affairesCache = [];
      let sitesCache = [];
      const progressCache = new Map(); // travailId -> { pct, remaining }
      const toTravauxArray = (raw) => {
        if (Array.isArray(raw)) return raw;
        if (Array.isArray(raw?.data)) return raw.data;
        if (Array.isArray(raw?.items)) return raw.items;
        return [];
      };

      function renderSuggestions(listEl, data, filterValue, labelFn) {
        if (!listEl) return;
        const term = (filterValue || '').trim().toLowerCase();
        if (!term) { listEl.innerHTML = ''; return; }
        const matches = (data || []).filter(item => labelFn(item).toLowerCase().includes(term)).slice(0, 8);
        if (!matches.length) { listEl.innerHTML = ''; return; }
        listEl.innerHTML = '';
        matches.forEach(m => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'list-group-item list-group-item-action';
          btn.textContent = labelFn(m);
          btn.addEventListener('click', () => {
            const targetInput = listEl.id === 'sug-affaire' ? filterAffaire : filterSite;
            if (targetInput) {
              targetInput.value = labelFn(m);
              renderTravaux(travauxCache);
            }
            listEl.innerHTML = '';
          });
          listEl.appendChild(btn);
        });
      }

      function formatProgressLine(pct, remaining) {
        if (pct === null && remaining === null) return 'Avancement: —';
        const pctStr = pct !== null ? `${pct}%` : '—';
        const restStr = remaining !== null ? ` · Reste: ${remaining}` : '';
        return `Avancement: <strong>${pctStr}</strong>${restStr}`;
      }

      async function hydrateProgressFromTasks(travailId, progressEl) {
        if (!progressEl || !travailId) return;
        if (progressCache.has(travailId)) {
          const cached = progressCache.get(travailId);
          progressEl.innerHTML = formatProgressLine(cached.pct, cached.remaining);
          return;
        }
        try {
          const res = await fetch(`/api/travaux/${travailId}/taches`, { headers, credentials:'same-origin' });
          if (res.status === 401 || res.status === 403) { location.href = '/login.html'; return; }
          if (!res.ok) throw new Error('Erreur chargement tâches');
          const tasks = await res.json();
          const total = Array.isArray(tasks) ? tasks.length : 0;
          const done = Array.isArray(tasks) ? tasks.filter(tk => (tk.etat || '').toLowerCase() === 'termine').length : 0;
          const pct = total > 0 ? Math.round((done / total) * 100) : null;
          const remaining = total > 0 ? Math.max(total - done, 0) : null;
          progressCache.set(travailId, { pct, remaining });
          progressEl.innerHTML = formatProgressLine(pct, remaining);
        } catch (err) {
          console.warn('Progress calcul impossible pour travail', travailId, err);
        }
      }

      function setCount(etat, n) {
        const el = document.getElementById('count-' + etat);
        if (el) el.textContent = n;
      }

      function renderTravaux(travaux = []) {
        // Reset colonnes
        colIds.forEach(etat => {
          const col = document.getElementById('col-' + etat);
          if (col) col.innerHTML = '<div class="empty-placeholder">Aucun travail.</div>';
          setCount(etat, 0);
        });

        const termTitle = (titleFilter?.value || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
        const term = (searchInput?.value || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
        const termAff = (filterAffaire?.value || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
        const termSite = (filterSite?.value || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');

        const filtered = travaux.filter(t => {
          const hayTitle = (t.titre || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
          const matchTitle = !termTitle || hayTitle.includes(termTitle);
          const hayAff = (t.affaire_nom || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
          const haySite = (t.site_nom || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
          const matchAff = !termAff || hayAff.includes(termAff);
          const matchSite = !termSite || haySite.includes(termSite);
          if (!term) return matchTitle && matchAff && matchSite;
          const hay = [
            t.titre, t.description, t.doe_titre, t.affaire_nom, t.site_nom, t.demande_titre
          ].join(' ').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
          return matchTitle && matchAff && matchSite && hay.includes(term);
        });

        const groupByEtat = {};
        filtered.forEach(t => {
          const e = t.etat || 'A_faire';
          groupByEtat[e] = groupByEtat[e] || [];
          groupByEtat[e].push(t);
        });

        colIds.forEach(etat => {
          const col = document.getElementById('col-' + etat);
          const items = groupByEtat[etat] || [];
          setCount(etat, items.length);
          if (!col) return;
          if (!items.length) {
            col.innerHTML = '<div class="empty-placeholder">Aucun travail.</div>';
            return;
          }
          col.innerHTML = '';
          items.forEach(t => {
            const card = document.createElement('div');
            card.className = 'card work-card';
            card.dataset.travailId = t.id;
            card.dataset.etat = etat;
            card.draggable = true;
            const priorite = t.priorite || 'Moyenne';
            const responsable = t.agent_nom
              ? `${t.agent_nom || ''} ${t.agent_prenom || ''}`.trim() || t.agent_matricule || '—'
              : (t.agent_matricule || t.responsable || '—');
            const done = Number(t.taches_terminees ?? t.tachesTerminees ?? t.tasks_done ?? t.tasksDone ?? t.taches_faites ?? t.tasksDoneCount);
            const total = Number(t.taches_total ?? t.tachesTotal ?? t.tasks_total ?? t.tasksTotal ?? t.taches ?? t.tachesCount);
            const explicitPct = Number.isFinite(t.progress_percent) ? t.progress_percent
              : (Number.isFinite(t.avancement) ? t.avancement
              : (Number.isFinite(t.progression) ? t.progression : null));
            const pct = Number.isFinite(explicitPct) ? Math.round(explicitPct)
              : (Number.isFinite(done) && Number.isFinite(total) && total > 0 ? Math.round((done / total) * 100) : null);
            const remaining = Number.isFinite(t.taches_restantes ?? t.tachesRestantes) ? Number(t.taches_restantes ?? t.tachesRestantes)
              : (Number.isFinite(done) && Number.isFinite(total) && total > 0 ? Math.max(total - done, 0) : null);
            const progressLine = pct !== null || remaining !== null
              ? `Avancement: <strong>${pct !== null ? pct + '%' : '—'}</strong>${remaining !== null ? ` · Reste: ${remaining}` : ''}`
              : 'Avancement: —';
            const badgeLinks = [];
            if (t.site_id) badgeLinks.push(`<a class="badge bg-light text-dark text-decoration-none" href="site-view.html?id=${t.site_id}" target="_blank"><i class="bi bi-geo"></i> ${t.site_nom || 'Site'}</a>`);
            if (t.affaire_id) badgeLinks.push(`<a class="badge bg-light text-dark text-decoration-none" href="affaire-view.html?id=${t.affaire_id}" target="_blank"><i class="bi bi-briefcase"></i> ${t.affaire_nom || 'Affaire'}</a>`);
            if (t.doe_id) badgeLinks.push(`<a class="badge bg-light text-dark text-decoration-none" href="doe-view.html?id=${t.doe_id}" target="_blank"><i class="bi bi-journal"></i> ${t.doe_titre || 'DOE'}</a>`);
            if (t.demande_id) badgeLinks.push(`<a class="badge bg-light text-dark text-decoration-none" href="demande-client-admin.html?embed=1&id=${t.demande_id}" target="_blank"><i class="bi bi-chat"></i> Demande #${t.demande_id}</a>`);
            card.innerHTML = `
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="fw-semibold">${t.titre || '(Sans titre)'}</div>
                  <span class="tag ${priorite.toLowerCase() === 'haute' ? 'tag-haute' : priorite.toLowerCase() === 'basse' ? 'tag-basse' : 'tag-moyenne'}">${priorite}</span>
                </div>
                <div class="text-muted small mb-2">${t.description || ''}</div>
                <div class="small text-muted mb-2"><i class="bi bi-person me-1"></i>Resp. ${responsable}</div>
                <div class="progress"><div class="progress-bar" style="width:${pct !== null ? pct : 0}%"></div></div>
                <div class="small text-end fw-medium progress-line">${progressLine}</div>
                ${badgeLinks.length ? `<div class="d-flex flex-wrap gap-1 mt-2">${badgeLinks.join(' ')}</div>` : ''}
                <div class="d-flex justify-content-end align-items-center gap-1 mt-2">
                  <button class="btn btn-sm btn-outline-primary btn-open-travail" data-id="${t.id}"><i class="bi bi-eye"></i> Voir</button>
                  ${isAdmin ? `
                  <button class="btn btn-sm btn-outline-warning btn-edit-travail" data-id="${t.id}" title="Modifier"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-outline-danger btn-del-travail" data-id="${t.id}" title="Supprimer"><i class="bi bi-trash"></i></button>
                  ` : ''}
                </div>
              </div>
            `;
            // Si avancement absent, tenter de calculer via les tâches
            if (progressLine === 'Avancement: —') {
              const progressEl = card.querySelector('.progress-line');
              hydrateProgressFromTasks(t.id, progressEl);
            }
            col.appendChild(card);
          });
        });
      }

      async function loadTravaux() {
        colIds.forEach(etat => {
          const col = document.getElementById('col-' + etat);
          if (col) col.innerHTML = '<div class="empty-placeholder">Chargement...</div>';
        });
        try {
          const travRes = await fetch('/api/travaux', { headers, credentials: 'same-origin' });
          if (travRes.status === 401 || travRes.status === 403) { location.href = '/login.html'; return; }
          const data = travRes.ok ? await travRes.json() : [];
          travauxCache = toTravauxArray(data);
          renderTravaux(travauxCache);
          // Chargements non bloquants des référentiels
          fetch('/api/affaires', { headers, credentials: 'same-origin' }).then(r => r.ok ? r.json() : []).then(d => {
            affairesCache = toTravauxArray(d);
            renderSuggestions(sugAffaire, affairesCache, filterAffaire?.value, a => a.nom_affaire || `Affaire #${a.id}`);
          }).catch(()=>{});
          fetch('/api/sites', { headers, credentials: 'same-origin' }).then(r => r.ok ? r.json() : []).then(d => {
            sitesCache = toTravauxArray(d);
            renderSuggestions(sugSite, sitesCache, filterSite?.value, s => s.nom_site || `Site #${s.id}`);
          }).catch(()=>{});
        } catch (err) {
          console.error('Erreur chargement travaux', err);
          colIds.forEach(etat => {
            const col = document.getElementById('col-' + etat);
            if (col) col.innerHTML = '<div class="text-danger">Erreur de chargement.</div>';
          });
        }
      }

      // Modale générique
      const modalEl = document.getElementById('travailModal');
      const modalFrame = document.getElementById('travailModalFrame');
      const travailModal = modalEl ? new bootstrap.Modal(modalEl) : null;

      function openInModal(url) {
        if (!travailModal || !modalFrame) { window.location.href = url; return; }
        modalFrame.src = url;
        travailModal.show();
      }

      document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-open-travail');
        if (btn) {
          e.preventDefault();
          const id = btn.getAttribute('data-id');
          if (id) openInModal(`/travaux-view.html?id=${id}`);
        }
        const btnEdit = e.target.closest('.btn-edit-travail');
        if (btnEdit) {
          e.preventDefault();
          const id = btnEdit.getAttribute('data-id');
          if (id) openInModal(`/travaux-edit.html?id=${id}`);
        }
        const btnDel = e.target.closest('.btn-del-travail');
        if (btnDel) {
          e.preventDefault();
          const id = btnDel.getAttribute('data-id');
          if (!id) return;
          if (!confirm('Supprimer ce travail ?')) return;
          fetch(`/api/travaux/${id}`, { method:'DELETE', headers, credentials:'same-origin' })
            .then(r => {
              if (r.status===401||r.status===403) { location.href='/login.html'; return; }
              if (!r.ok) throw new Error('Suppression impossible');
              loadTravaux();
            }).catch(err => alert(err.message || 'Erreur suppression'));
        }
      });

      // Filtres dynamiques
      [titleFilter, searchInput, filterAffaire, filterSite].forEach(el => {
        if (!el) return;
        el.addEventListener('input', () => {
          if (el === filterAffaire) renderSuggestions(sugAffaire, affairesCache, filterAffaire.value, a => a.nom_affaire || `Affaire #${a.id}`);
          if (el === filterSite) renderSuggestions(sugSite, sitesCache, filterSite.value, s => s.nom_site || `Site #${s.id}`);
          renderTravaux(travauxCache);
        });
      });
      filterAffaire?.addEventListener('blur', () => setTimeout(() => { if (sugAffaire) sugAffaire.innerHTML=''; }, 150));
      filterSite?.addEventListener('blur', () => setTimeout(() => { if (sugSite) sugSite.innerHTML=''; }, 150));

      const btnNew = document.getElementById('btn-new-travail');
      if (btnNew) {
        btnNew.addEventListener('click', (e) => {
          e.preventDefault();
          openInModal('/travaux-new.html');
        });
      }

      loadTravaux();
      searchInput?.addEventListener('input', () => renderTravaux(travauxCache));
      titleFilter?.addEventListener('input', () => renderTravaux(travauxCache));
      filterAffaire?.addEventListener('input', () => renderTravaux(travauxCache));
      filterSite?.addEventListener('input', () => renderTravaux(travauxCache));

      function bindAutocomplete(inputEl, sugEl, source = [], labelKey = 'nom') {
        if (!inputEl || !sugEl) return;
        inputEl.addEventListener('input', () => {
          const term = inputEl.value.toLowerCase();
          if (!term) { sugEl.innerHTML = ''; return; }
          const matches = source.filter(item => (item[labelKey] || '').toLowerCase().includes(term)).slice(0, 5);
          sugEl.innerHTML = matches.length
            ? matches.map(m => `<button type="button" class="list-group-item list-group-item-action">${m[labelKey] || ''}</button>`).join('')
            : '<div class="list-group-item text-muted">Aucun résultat</div>';
        });
        sugEl.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          inputEl.value = btn.textContent.trim();
          sugEl.innerHTML = '';
          renderTravaux(travauxCache);
        });
        inputEl.addEventListener('blur', () => setTimeout(() => { sugEl.innerHTML = ''; }, 150));
      }
      bindAutocomplete(filterAffaire, sugAffaire, affairesCache, 'nom_affaire');
      bindAutocomplete(filterSite, sugSite, sitesCache, 'nom_site');

      // --- Drag & Drop pour changement d'état ---
      let dragId = null;
      let dragCard = null;

      function clearDropStates() {
        document.querySelectorAll('.col-body').forEach(c => c.classList.remove('drop-hover'));
        if (dragCard) dragCard.classList.remove('dragging');
      }

      document.body.addEventListener('dragstart', (e) => {
        const card = e.target.closest('.work-card');
        if (!card || !card.dataset.travailId) return;
        dragId = card.dataset.travailId;
        dragCard = card;
        card.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });

      document.body.addEventListener('dragend', () => {
        dragId = null;
        clearDropStates();
      });

      document.querySelectorAll('.col-body').forEach(col => {
        col.addEventListener('dragover', (e) => {
          if (!dragId) return;
          e.preventDefault();
          col.classList.add('drop-hover');
        });
        col.addEventListener('dragleave', () => col.classList.remove('drop-hover'));
        col.addEventListener('drop', async (e) => {
          e.preventDefault();
          const newEtat = col.parentElement?.querySelector('.board-col')?.dataset.etat || col.closest('.board-col')?.dataset.etat || col.id?.replace('col-','');
          clearDropStates();
          if (!dragId || !newEtat) return;
          const currentEtat = dragCard?.dataset.etat;
          if (currentEtat === newEtat) return;
          try {
            const res = await fetch(`/api/travaux/${dragId}`, {
              method:'PUT',
              headers: { 'Content-Type':'application/json', ...(headers||{}) },
              credentials:'same-origin',
              body: JSON.stringify({ etat:newEtat })
            });
            if (res.status===401||res.status===403){ location.href='/login.html'; return; }
            if (!res.ok) throw new Error('Mise à jour impossible');
            await loadTravaux();
          } catch (err) {
            console.error('Drag update failed', err);
            alert(err.message || 'Erreur changement d’état');
          } finally {
            dragId = null;
            dragCard = null;
          }
        });
      });
    });
  </script>
  <!-- Modale de visualisation / création -->
  <div class="modal fade" id="travailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Travail</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="travailModalFrame" src="about:blank" style="width:100%;height:80vh;border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
