<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalogue Matériel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .table-hover tbody tr:hover { background-color: rgba(0,0,0,0.03); }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>

  <main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="h4 mb-0">Catalogue Matériel</h1>
      <button class="btn btn-primary btn-sm" id="open-create-btn"><i class="bi bi-plus-circle me-1"></i>Nouveau dans le catalogue</button>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-8">
             <input type="text" id="search-input" class="form-control" placeholder="Rechercher par titre, référence, fabricant...">
          </div>
          <div class="col-md-4">
            <select id="filter-actif" class="form-select">
              <option value="">Tous les statuts</option>
              <option value="true" selected>Actif</option>
              <option value="false">Inactif</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Référence</th>
                <th>Désignation</th>
                <th>Fabricant</th>
                <th>Fournisseur</th>
                <th>Agence</th>
                <th>Prix achat</th>
                <th>Remise %</th>
                <th>Classe</th>
                <th class="text-center">Métier</th>
                <th class="text-center">Utilisé en intervention</th>
                <th class="text-center">Actif</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="catalogue-tbody">
              <tr><td colspan="11" class="text-muted text-center py-4">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal create/edit -->
  <div class="modal fade" id="catalogueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="catalogueModalLabel">Édition d'article du catalogue</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="catalogue-form">
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label">Titre*</label>
                    <input type="text" id="cat-titre" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Référence*</label>
                    <input type="text" id="cat-reference" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Désignation</label>
                    <input type="text" id="cat-designation" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Fabricant</label>
                    <input type="text" id="cat-fabricant" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Fournisseur (par défaut)</label>
                    <input type="text" id="cat-fournisseur" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Prix d'achat (par défaut)</label>
                    <input type="number" id="cat-prix_achat" class="form-control" step="0.01">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Remise (par défaut %)</label>
                    <input type="number" id="cat-remise_fournisseur" class="form-control" step="0.01">
                </div>
                 <div class="col-md-4">
                    <label class="form-label">Classe Matériel</label>
                    <input type="text" id="cat-classe_materiel" class="form-control">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Métier</label>
                    <select id="cat-metier" class="form-select">
                        <option value="">Non spécifié</option>
                        <option value="GTB">GTB</option>
                        <option value="Video">Video</option>
                        <option value="Intrusion">Intrusion</option>
                        <option value="Control_Acces">Contrôle d'Accès</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="cat-actif" checked>
                      <label class="form-check-label" for="cat-actif">Article Actif</label>
                    </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Commentaire</label>
                  <textarea id="cat-commentaire" class="form-control" rows="2"></textarea>
                </div>
            </div>
          </form>
          <hr>
          <h6>Pièces Jointes</h6>
          <div id="cat-documents-list" class="list-group mb-3"></div>
          <div class="input-group">
              <input type="file" class="form-control" id="cat-document-upload">
              <button class="btn btn-outline-secondary" type="button" id="btn-upload-document">Téléverser</button>
          </div>
          <div class="alert d-none mt-3" id="cat-feedback"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="cat-save-btn"><i class="bi bi-save me-1"></i>Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal documents (consultation rapide) -->
  <div class="modal fade" id="docsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="docsModalLabel">Pièces jointes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div id="docs-list" class="list-group"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal agence -->
  <div class="modal fade" id="agenceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="agenceModalLabel">Agence</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="agenceFrame" src="about:blank" style="width:100%;height:80vh;border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) { window.location.href='/login.html'; return; }
      const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' };
      
      const tbody = document.getElementById('catalogue-tbody');
      const searchInput = document.getElementById('search-input');
      const actifFilter = document.getElementById('filter-actif');

      const catModalEl = document.getElementById('catalogueModal');
      const catModal = new bootstrap.Modal(catModalEl);
      const catModalLabel = document.getElementById('catalogueModalLabel');
      const catFeedback = document.getElementById('cat-feedback');
      const catSaveBtn = document.getElementById('cat-save-btn');
      const docsModalEl = document.getElementById('docsModal');
      const docsModal = new bootstrap.Modal(docsModalEl);
      const docsList = document.getElementById('docs-list');
      const docsModalLabel = document.getElementById('docsModalLabel');
      const agenceModalEl = document.getElementById('agenceModal');
      const agenceModal = agenceModalEl ? new bootstrap.Modal(agenceModalEl) : null;
      const agenceFrame = document.getElementById('agenceFrame');
      const agenceModalLabel = document.getElementById('agenceModalLabel');
      
      let catalogueItems = [];
      let editingCatalogueId = null;

      const fields = {
          titre: document.getElementById('cat-titre'),
          reference: document.getElementById('cat-reference'),
          designation: document.getElementById('cat-designation'),
          fabricant: document.getElementById('cat-fabricant'),
          fournisseur: document.getElementById('cat-fournisseur'),
          prix_achat: document.getElementById('cat-prix_achat'),
          remise_fournisseur: document.getElementById('cat-remise_fournisseur'),
          classe_materiel: document.getElementById('cat-classe_materiel'),
          metier: document.getElementById('cat-metier'),
          actif: document.getElementById('cat-actif'),
          commentaire: document.getElementById('cat-commentaire'),
          docList: document.getElementById('cat-documents-list'),
          docUploadInput: document.getElementById('cat-document-upload'),
          docUploadBtn: document.getElementById('btn-upload-document')
      };

      const formatPrice = (value) => {
        if (value === null || value === undefined || value === '') return '—';
        const num = Number(value);
        if (Number.isNaN(num)) return '—';
        return `${num.toFixed(2)} €`;
      };
      const formatPercent = (value) => {
        if (value === null || value === undefined || value === '') return '—';
        const num = Number(value);
        if (Number.isNaN(num)) return '—';
        return `${num.toFixed(2)} %`;
      };

      const api = async (url, opts = {}) => {
          const res = await fetch(url, { headers, credentials: 'same-origin', ...opts });
          if (res.status === 401) window.location.href = '/login.html';
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || `HTTP Error ${res.status}`);
          return data;
      };

      function render() {
        const term = searchInput.value.toLowerCase();
        const actif = actifFilter.value;
        const filtered = catalogueItems.filter(item => {
            const matchesTerm = !term || [item.titre, item.reference, item.fabricant, item.designation].some(f => f?.toLowerCase().includes(term));
            const matchesActif = actif === '' || String(item.actif) === actif;
            return matchesTerm && matchesActif;
        });

        tbody.innerHTML = '';
        if (!filtered.length) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-muted text-center py-4">Aucun article dans le catalogue.</td></tr>';
            return;
        }

        filtered.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="fw-semibold">${item.reference || '-'}</td>
              <td>${item.designation || item.titre || ''}</td>
              <td>${item.fabricant || '-'}</td>
              <td>${item.fournisseur || '-'}</td>
              <td>
                ${item.agence_id ? `<button class="btn btn-sm btn-outline-secondary open-agence" data-id="${item.agence_id}" data-label="${item.agence_nom || 'Agence'}" title="Voir l'agence"><i class="bi bi-box-arrow-up-right me-1"></i>${item.agence_nom || 'Agence'}</button>` : '<span class="text-muted">—</span>'}
              </td>
              <td>${formatPrice(item.prix_achat)}</td>
              <td>${formatPercent(item.remise_fournisseur)}</td>
              <td>${item.classe_materiel || '-'}</td>
              <td>${item.metier || '-'}</td>
              <td class="text-center">${item.total_quantite_used_in_interventions}</td>
              <td class="text-center">${item.actif ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>'}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary docs-btn" data-id="${item.id}" title="Pièces jointes"><i class="bi bi-paperclip"></i></button>
                <button class="btn btn-sm btn-success create-order-btn" data-id="${item.id}" title="Créer une commande à partir de cet article"><i class="bi bi-cart-plus"></i></button>
                <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${item.id}" title="Modifier l'article"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger del-btn" data-id="${item.id}" title="Supprimer l'article"><i class="bi bi-trash"></i></button>
              </td>`;
            tbody.appendChild(tr);
        });
      }

      async function loadCatalogue() {
        tbody.innerHTML = '<tr><td colspan="11" class="text-muted text-center py-4">Chargement...</td></tr>';
        try {
          catalogueItems = await api('/api/catalogue');
          render();
        } catch(e) {
          tbody.innerHTML = `<tr><td colspan="11" class="text-danger text-center py-4">Erreur de chargement: ${e.message}</td></tr>`;
        }
      }

      function showFeedback(msg, isError = true) {
          catFeedback.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
          catFeedback.textContent = msg;
          catFeedback.classList.remove('d-none');
      }

      function openModal(item = null) {
          document.getElementById('catalogue-form').reset();
          catFeedback.classList.add('d-none');
          editingCatalogueId = item?.id || null;
          catModalLabel.textContent = item ? `Modifier: ${item.titre}` : 'Nouvel article de catalogue';
          
          fields.titre.value = item?.titre || '';
          fields.reference.value = item?.reference || '';
          fields.designation.value = item?.designation || '';
          fields.fabricant.value = item?.fabricant || '';
          fields.fournisseur.value = item?.fournisseur || '';
          fields.prix_achat.value = item?.prix_achat || '';
          fields.remise_fournisseur.value = item?.remise_fournisseur || '';
          fields.classe_materiel.value = item?.classe_materiel || '';
          fields.metier.value = item?.metier || '';
          fields.actif.checked = item ? item.actif : true;
          fields.commentaire.value = item?.commentaire || '';

          if (item?.id) {
              fields.docUploadBtn.disabled = false;
              renderDocuments(item.id);
          } else {
              fields.docList.innerHTML = '<div class="text-muted small">Enregistrez l\'article pour pouvoir ajouter des documents.</div>';
              fields.docUploadBtn.disabled = true;
          }
          catModal.show();
      }

      catSaveBtn.addEventListener('click', async () => {
          const payload = {
              titre: fields.titre.value,
              reference: fields.reference.value,
              designation: fields.designation.value,
              fabricant: fields.fabricant.value,
              fournisseur: fields.fournisseur.value,
              prix_achat: fields.prix_achat.value ? Number(fields.prix_achat.value) : null,
              remise_fournisseur: fields.remise_fournisseur.value ? Number(fields.remise_fournisseur.value) : null,
              classe_materiel: fields.classe_materiel.value,
              metier: fields.metier.value || null,
              actif: fields.actif.checked,
              commentaire: fields.commentaire.value
          };

          if (!payload.titre || !payload.reference) {
              return showFeedback('Titre et Référence sont obligatoires.');
          }

          const url = editingCatalogueId ? `/api/catalogue/${editingCatalogueId}` : '/api/catalogue';
          const method = editingCatalogueId ? 'PUT' : 'POST';

          try {
              catSaveBtn.disabled = true;
              await api(url, { method, body: JSON.stringify(payload) });
              showFeedback('Enregistré avec succès.', false);
              await loadCatalogue();
              setTimeout(() => catModal.hide(), 800);
          } catch (e) {
              showFeedback(e.message);
          } finally {
              catSaveBtn.disabled = false;
          }
      });
      
      tbody.addEventListener('click', async (e) => {
          const target = e.target.closest('button');
          if (!target) return;

          const id = target.dataset.id;
          if (target.classList.contains('edit-btn')) {
              const item = catalogueItems.find(i => i.id == id);
              openModal(item);
          } else if (target.classList.contains('del-btn')) {
              if (!confirm('Supprimer cet article du catalogue? Cette action est irréversible.')) return;
              try {
                  await api(`/api/catalogue/${id}`, { method: 'DELETE' });
                  loadCatalogue();
              } catch(e) { alert(e.message); }
          } else if (target.classList.contains('create-order-btn')) {
              if (!confirm('Créer une nouvelle commande pour cet article?')) return;
              try {
                  await api('/api/materiels', { method: 'POST', body: JSON.stringify({ catalogue_id: id }) });
                  alert('Commande créée avec succès! Vous pouvez la voir dans la page "Gestion des Commandes".');
              } catch(e) { alert(`Erreur: ${e.message}`); }
          } else if (target.classList.contains('docs-btn')) {
              openDocsModal(id);
          } else if (target.classList.contains('open-agence')) {
              if (!agenceModal || !agenceFrame) return;
              const label = target.getAttribute('data-label') || 'Agence';
              agenceModalLabel.textContent = label;
              agenceFrame.src = `/agence-view.html?id=${id}`;
              agenceModal.show();
          }
      });

      // --- Document Logic ---
      async function renderDocuments(catalogueId) {
          fields.docList.innerHTML = '<div class="text-muted small">Chargement...</div>';
          try {
              const item = await api(`/api/catalogue/${catalogueId}/relations`);
              const documents = item.documents || [];
              fields.docList.innerHTML = !documents.length ? '<div class="text-muted small">Aucun document.</div>' : '';
              documents.forEach(doc => {
                  const li = document.createElement('div');
                  li.className = 'list-group-item d-flex justify-content-between align-items-center';
                  li.innerHTML = `<a href="/api/documents/${doc.id}/download" target="_blank">${doc.nom_fichier}</a>
                                  <button class="btn btn-sm btn-outline-danger" data-doc-id="${doc.id}"><i class="bi bi-trash"></i></button>`;
                  li.querySelector('button').addEventListener('click', () => deleteDocument(doc.id, catalogueId));
                  fields.docList.appendChild(li);
              });
          } catch (e) {
              fields.docList.innerHTML = `<div class="text-danger small">Erreur: ${e.message}</div>`;
          }
      }
      async function deleteDocument(docId, catId) {
          if (!confirm('Supprimer ce document?')) return;
          try {
              await api(`/api/documents/${docId}`, { method: 'DELETE' });
              await renderDocuments(catId);
          } catch(e) { alert(`Erreur: ${e.message}`); }
      }
      function fileToBase64(file) {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.onerror = reject;
          });
      }
      fields.docUploadBtn.addEventListener('click', async () => {
          if (!editingCatalogueId) return;
          const file = fields.docUploadInput.files[0];
          if (!file) return alert('Sélectionnez un fichier.');
          
          fields.docUploadBtn.disabled = true;
          try {
              const base64 = await fileToBase64(file);
              const payload = {
                  cible_type: 'MaterielCatalogue',
                  cible_id: editingCatalogueId,
                  nom_fichier: file.name,
                  type_mime: file.type,
                  base64
              };
              await api('/api/documents', { method: 'POST', body: JSON.stringify(payload) });
              await renderDocuments(editingCatalogueId);
              fields.docUploadInput.value = '';
          } catch (e) {
              alert(`Erreur: ${e.message}`);
          } finally {
              fields.docUploadBtn.disabled = false;
          }
      });
      // --- End Document Logic ---

      async function openDocsModal(itemId) {
        docsModalLabel.textContent = 'Pièces jointes';
        docsList.innerHTML = '<div class="text-muted small">Chargement...</div>';
        docsModal.show();
        try {
          const item = await api(`/api/catalogue/${itemId}/relations`);
          const documents = item.documents || [];
          docsModalLabel.textContent = `Pièces jointes — ${item.reference || item.titre || 'Article'}`;
          if (!documents.length) {
            docsList.innerHTML = '<div class="text-muted small">Aucune pièce jointe.</div>';
            return;
          }
          docsList.innerHTML = '';
          documents.forEach(doc => {
            const row = document.createElement('div');
            row.className = 'list-group-item d-flex justify-content-between align-items-center';
            row.innerHTML = `<a href="/api/documents/${doc.id}/download" target="_blank" rel="noopener">${doc.nom_fichier || 'Document'}</a>
                             <span class="text-muted small">${doc.type_mime || ''}</span>`;
            docsList.appendChild(row);
          });
        } catch (e) {
          docsList.innerHTML = `<div class="text-danger small">Erreur: ${e.message}</div>`;
        }
      }

      document.getElementById('open-create-btn').addEventListener('click', () => openModal(null));
      searchInput.addEventListener('input', render);
      actifFilter.addEventListener('change', render);

      loadCatalogue();
    });
  </script>
</body>
</html>
