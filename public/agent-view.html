<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails de l'agent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>


  <main class="container mt-5">
    
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h1 class="mb-4">Détails de l'agent: <span id="agent-name"></span></h1>
      <button type="button" class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Informations générales</h2>
        <p><strong>Matricule:</strong> <span id="view_matricule"></span></p>
        <p><strong>Nom:</strong> <span id="view_nom"></span></p>
        <p><strong>Prénom:</strong> <span id="view_prenom"></span></p>
        <p><strong>Email:</strong> <span id="view_email"></span></p>
        <p><strong>Téléphone:</strong> <span id="view_tel"></span></p>
        <p><strong>Titre:</strong> <span id="view_titre"></span></p>
        <p><strong>Agence:</strong> <span id="view_agence"></span></p>
        <p><strong>Fonction:</strong> <span id="view_fonction"></span></p>
        <p><strong>Actif:</strong> <span id="view_actif"></span></p>
        <p><strong>Administrateur:</strong> <span id="view_admin"></span></p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Passeport</h2>
        <p>Voir les détails du passeport de l'agent.</p>
        <a href="agent-passport-view.html" class="btn btn-info"><i class="bi bi-journal-text me-2"></i>Voir Passeport</a>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Formations</h2>
        <p>Voir la liste des formations de l'agent.</p>
        <a href="agent-formation-view.html" class="btn btn-info"><i class="bi bi-mortarboard me-2"></i>Voir Formations</a>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-3">Sites liés</h2>
        <div id="sites-list" class="row g-2"></div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-3">Interventions liées</h2>
        <div id="interventions-list" class="row g-2"></div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-3">Heures par jour et intervention</h2>
        <canvas id="hoursChart" height="120"></canvas>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="agents.html" class="btn btn-secondary">Retour à la liste</a>
      <a href="agent-edit.html" class="btn btn-primary" id="edit-agent-btn"><i class="bi bi-pencil me-2"></i>Modifier l'agent</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const params = new URLSearchParams(location.search);
      const matricule = params.get('matricule');
      const nameEl = document.getElementById('agent-name');
      const sitesEl = document.getElementById('sites-list');
      const interEl = document.getElementById('interventions-list');

      try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const res = await fetch(`/api/agents/${encodeURIComponent(matricule)}/relations`, { headers, credentials: 'same-origin' });
        const rel = await res.json();
        if (!res.ok) throw new Error((rel && rel.error) || `HTTP ${res.status}`);
        const agent = rel.agent || {};
        nameEl.textContent = (agent.nom || '') + ' ' + (agent.prenom || '');
        document.getElementById('view_matricule').textContent = agent.matricule || '';
        document.getElementById('view_nom').textContent = agent.nom || '';
        document.getElementById('view_prenom').textContent = agent.prenom || '';
        document.getElementById('view_email').textContent = agent.email || '';
        document.getElementById('view_tel').textContent = agent.tel || '';
        document.getElementById('view_titre').textContent = agent.titre || '';
        document.getElementById('view_agence').textContent = (rel.sites && rel.sites[0] && (rel.sites[0].nom_site || '')) || '';
        document.getElementById('view_fonction').textContent = agent.fonction || '';
        document.getElementById('view_actif').textContent = agent.actif ? 'Oui' : 'Non';
        document.getElementById('view_admin').textContent = agent.admin ? 'Oui' : 'Non';

        // Sites
        sitesEl.innerHTML = '';
        (rel.sites || []).forEach(s => {
          const col = document.createElement('div');
          col.className = 'col-12 col-sm-6 col-lg-4';
          col.innerHTML = `<div class="border rounded p-2 h-100"><a href="site-view.html?id=${s.id}"><strong>#${s.id}</strong> — ${s.nom_site || 'Site'}</a></div>`;
          sitesEl.appendChild(col);
        });
        

        // Interventions
        interEl.innerHTML = '';
        (rel.interventions || []).forEach(i => {
          const col = document.createElement('div');
          col.className = 'col-12';
          const dd = i.date_debut ? new Date(i.date_debut) : null;
          const df = i.date_fin ? new Date(i.date_fin) : null;
          const period = dd ? dd.toLocaleString() + (df ? ' → ' + df.toLocaleString() : '') : '';
          col.innerHTML = `<div class=\"border rounded p-2\"><div class=\"d-flex justify-content-between\"><div><strong>Intervention #${i.id}</strong> — ${i.description || ''}</div><div class=\"text-muted\">${period}</div></div><div class=\"small\">Ticket: <a href=\"ticket-view.html?id=${i.ticket_id}\">${i.ticket_titre || i.ticket_id}</a> • Site: ${i.site_id ? `<a href=\"site-view.html?id=${i.site_id}\">#${i.site_id} ${i.site_nom || ''}</a>` : '-'}</div></div>`;
          interEl.appendChild(col);
        });

        // Chart hours per day per intervention
        const perDay = new Map(); // day -> { interId: hours }
        (rel.interventions || []).forEach(i => {
          if (!i.date_debut || !i.date_fin) return;
          const start = new Date(i.date_debut);
          const end = new Date(i.date_fin);
          let cur = new Date(start);
          while (cur <= end) {
            const dayKey = cur.toISOString().slice(0,10);
            const dayStart = new Date(dayKey + 'T00:00:00');
            const dayEnd = new Date(dayKey + 'T23:59:59');
            const from = cur < dayStart ? dayStart : cur;
            const to = end < dayEnd ? end : dayEnd;
            const ms = Math.max(0, to - from);
            const hours = ms/3600000;
            if (hours > 0) {
              if (!perDay.has(dayKey)) perDay.set(dayKey, {});
              const obj = perDay.get(dayKey);
              obj[i.id] = (obj[i.id] || 0) + hours;
            }
            cur = new Date(new Date(dayKey).getTime() + 24*3600*1000);
          }
        });
        const labels = Array.from(perDay.keys()).sort();
        const interIds = Array.from(new Set([].concat(...Array.from(perDay.values()).map(o => Object.keys(o))))).sort((a,b)=>Number(a)-Number(b));
        const colors = ['#0d6efd','#198754','#6f42c1','#dc3545','#fd7e14','#20c997','#0dcaf0','#6c757d'];
        const datasets = interIds.map((id, idx)=>({ label: 'Interv #' + id, data: labels.map(d => (perDay.get(d)||{})[id] || 0), backgroundColor: colors[idx % colors.length] }));
        const ctx = document.getElementById('hoursChart');
        if (ctx && labels.length) {
          new Chart(ctx, { type:'bar', data:{ labels, datasets }, options:{ responsive:true, scales:{ y:{ title:{ display:true, text:'Heures' }, beginAtZero:true } }, plugins:{ legend:{ position:'bottom' } } } });
        }
      } catch(e) {
        console.error('Erreur chargement relations agent:', e);
        document.getElementById('agent-name').textContent = 'Agent introuvable';
      }
    });
  </script>
</body>
</html>
