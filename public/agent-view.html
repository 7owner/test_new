<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Agent</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%);
      font-family: system-ui, sans-serif;
      padding: 1.5rem;
    }
    .main-card {
      border: none;
      border-radius: 20px;
      background: #fff;
      box-shadow: 0 8px 28px rgba(0,0,0,.08);
      padding: 1.8rem;
      margin-bottom: 1.5rem;
    }
    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      background: linear-gradient(135deg,#667eea,#764ba2);
      color:#fff;
      font-size: 26px;
      font-weight: 700;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .section-title {
      font-weight:600;
      color:#4a4f57;
      margin-bottom:.5rem;
    }
    .info-line {
      font-size:.95rem;
      margin-bottom:.35rem;
    }
    .link-mini {cursor:pointer;color:#635bff;text-decoration:none;font-weight:600;font-size:.85rem;}
    .link-mini:hover{text-decoration:underline;}
    .small-title {color:#6b7280;font-size:.8rem;}
  </style>
</head>
<body>

<div class="container" style="max-width:1200px;">

  <div class="main-card">

    <!-- HEAD -->
    <div class="d-flex align-items-center gap-3 mb-4">
      <div id="avatar-initials" class="avatar">AG</div>
      <div>
        <div class="small-title">Agent</div>
        <h3 id="agent-fullname" class="fw-bold mb-1">‚Äî</h3>
        <div id="agent-role" class="text-muted small">‚Äî</div>
      </div>
    </div>

    <!-- CONTACTS -->
    <div class="mb-4">
      <div class="section-title">üìû Contacts</div>
      <div class="info-line"><i class="bi bi-envelope me-2"></i><span id="view_email">‚Äî</span></div>
      <div class="info-line"><i class="bi bi-phone me-2"></i><span id="view_tel">‚Äî</span></div>
    </div>

    <!-- INTERVENTIONS -->
    <div class="mb-4">
      <div class="section-title">üõ†Ô∏è Derni√®res interventions</div>
      <div id="interventions-list" class="small"></div>
    </div>

    <!-- LINKS -->
    <div class="d-flex flex-wrap gap-2 mt-3">
      <a id="formation-link" class="btn btn-outline-primary btn-sm" href="#">Formations</a>
      <a id="heures-link" class="btn btn-outline-secondary btn-sm" href="#">Heures</a>
    </div>

    <!-- Retour -->
    <div class="mt-4">
      <!--<button type="button" class="btn btn-light" id="back-btn">
        <i class="bi bi-arrow-left"></i> Retour
      </button>-->
    </div>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {

  const params = new URLSearchParams(location.search);
  const matricule = params.get("matricule");
  if (!matricule) return alert("Matricule manquant");

  const token = localStorage.getItem("token");
  const headers = token ? { "Authorization": "Bearer "+ token } : {};

  const setInitials = (n,p) => {
    const i1=(p||'')[0]||''; const i2=(n||'')[0]||'';
    document.getElementById("avatar-initials").textContent =
      (i1+i2).toUpperCase()||"AG";
  };

  const renderInterventions = (arr=[]) => {
    const el = document.getElementById("interventions-list");
    if (!arr.length) return el.innerHTML = "<small class='text-muted'>Aucune intervention r√©cente.</small>";
    el.innerHTML = arr.slice(0,4).map(i=>`
      <div class="border-bottom py-2 small">
        <strong>${i.site_nom || "Site inconnu"}</strong><br>
        <span class="text-muted">${i.description || ""}</span>
      </div>
    `).join("");
  };

  try {
    const r = await fetch(`/api/agents/${encodeURIComponent(matricule)}/relations`,{headers});
    const data = await r.json();
    if (!r.ok) throw new Error(data.error);

    const a = data.agent || {};
    document.getElementById("agent-fullname").textContent =
      `${a.nom||''} ${a.prenom||''}`.trim() || "‚Äî";
    document.getElementById("agent-role").textContent =
      a.fonction || "‚Äî";
    document.getElementById("view_email").textContent = a.email || "‚Äî";
    document.getElementById("view_tel").textContent = a.tel || "‚Äî";

    setInitials(a.nom, a.prenom);
    renderInterventions(data.interventions || []);

    document.getElementById("formation-link").href =
      `agent-formation-view.html?matricule=${encodeURIComponent(matricule)}`;
    document.getElementById("heures-link").href =
      `agent-heures.html?matricule=${encodeURIComponent(matricule)}`;

  } catch(e){
    console.error(e);
  }

  document.getElementById("back-btn")
    .addEventListener("click",()=>history.back());
});
</script>

</body>
</html>
