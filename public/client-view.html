<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Client - Détails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { 
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8f0f7 100%);
      padding: 1.5rem;
    }
    .main-card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      margin-bottom: 1.5rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .main-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }
    .card-header-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.25rem 1.5rem;
      font-weight: 600;
      border: none;
    }
    .info-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      border-left: 4px solid #667eea;
    }
    .info-badge i {
      color: #667eea;
      font-size: 1.2rem;
    }
    .section-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: #667eea;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
    }
    .list-item-custom {
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      background: white;
      border: 1px solid #e9ecef;
      transition: all 0.2s ease;
    }
    .list-item-custom:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
      transform: translateX(4px);
    }
    .status-badge {
      padding: 0.35rem 0.85rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-progress { background: #cfe2ff; color: #084298; }
    .status-completed { background: #d1e7dd; color: #0f5132; }
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
    }
    .image-thumbnail {
      position: relative;
      width: 100%;
      padding-bottom: 100%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .image-thumbnail:hover {
      transform: scale(1.05);
    }
    .image-thumbnail img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .rep-card {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-left: 4px solid #667eea;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .admin-section {
      background: linear-gradient(135deg, #f093fb15 0%, #f5576c15 100%);
      border-radius: 16px;
      padding: 1.5rem;
    }
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.6rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      color: white;
    }
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    .doc-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      border: 1px solid #e9ecef;
      transition: all 0.2s ease;
    }
    .doc-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    .doc-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 1rem;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid" style="max-width: 1400px;">
    <!-- Header Section -->
    <div class="main-card">
      <div class="card-header-custom d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0"><i class="bi bi-person-badge me-2"></i>Détails du Client</h4>
        </div>
      </div>
      <div class="card-body p-4">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="info-badge w-100">
              <i class="bi bi-building"></i>
              <div>
                <small class="text-muted d-block">Nom du client</small>
                <strong id="client-nom">-</strong>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-badge w-100">
              <i class="bi bi-geo-alt"></i>
              <div>
                <small class="text-muted d-block">Adresse</small>
                <strong id="client-adresse-id">-</strong>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="info-badge w-100">
              <i class="bi bi-chat-left-text"></i>
              <div>
                <small class="text-muted d-block">Commentaire</small>
                <strong id="client-commentaire">-</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Representatives Section -->
    <div class="main-card">
      <div class="card-header-custom">
        <i class="bi bi-people me-2"></i>Représentants
      </div>
      <div class="card-body p-4">
        <div id="representants-list">
          <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Edition Représentant -->
    <div class="modal fade" id="editRepModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modifier représentant</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editRepForm">
              <input type="hidden" id="edit-rep-id">
              <div class="mb-3">
                <label class="form-label">Nom</label>
                <input class="form-control" id="edit-rep-nom">
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input class="form-control" id="edit-rep-email" type="email">
              </div>
              <div class="mb-3">
                <label class="form-label">Téléphone</label>
                <input class="form-control" id="edit-rep-tel" type="tel">
              </div>
              <div class="mb-3">
                <label class="form-label">Fonction</label>
                <input class="form-control" id="edit-rep-fonction">
              </div>
            </form>
            <div id="edit-rep-feedback" class="small mt-2"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button class="btn btn-primary" id="save-rep-btn">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sites and Demands Row -->
    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="main-card h-100">
          <div class="card-header-custom">
            <i class="bi bi-building me-2"></i>Sites Associés
          </div>
          <div class="card-body p-4">
            <div id="sites-container">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="main-card h-100">
          <div class="card-header-custom">
            <i class="bi bi-clipboard-check me-2"></i>Demandes d'Intervention
          </div>
          <div class="card-body p-4">
            <div id="demandes-container">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Repository -->
    <div class="main-card">
      <div class="card-header-custom">
        <i class="bi bi-folder2-open me-2"></i>Répertoire Documents
      </div>
      <div class="card-body p-4">
        <p class="text-muted mb-4">
          <i class="bi bi-info-circle me-2"></i>
          Rassemble toutes les pièces jointes (documents, images, PJ messages) liées aux sites/tickets/demandes de ce client.
        </p>
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="section-title"><i class="bi bi-file-earmark-text me-2"></i>Documents</div>
            <div id="repo-docs">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="section-title"><i class="bi bi-image me-2"></i>Images</div>
            <div id="repo-imgs">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
              </div>
            </div>
            <small class="text-muted d-block mt-2" id="repo-msgs-info"></small>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Actions -->
    <div id="adminActions" class="main-card" style="display:none;">
      <div class="card-header-custom">
        <i class="bi bi-shield-lock me-2"></i>Actions Administrateur
      </div>
      <div class="card-body p-4">
        <div class="admin-section">
          <div class="row g-4">
            <div class="col-md-6">
              <h5 class="mb-3"><i class="bi bi-building-add me-2"></i>Créer un Site</h5>
              <div class="mb-3">
                <label for="new_site_nom" class="form-label fw-semibold">Nom du site</label>
                <input id="new_site_nom" class="form-control" placeholder="Ex: Site principal">
              </div>
              <div class="mb-3">
                <label for="new_site_comment" class="form-label fw-semibold">Commentaire (optionnel)</label>
                <textarea id="new_site_comment" class="form-control" rows="2" placeholder="Ajoutez des notes..."></textarea>
              </div>
              <button id="btnCreateSite" class="btn btn-gradient w-100">
                <i class="bi bi-plus-circle me-2"></i>Créer le Site
              </button>
            </div>
            <div class="col-md-6">
              <h5 class="mb-3"><i class="bi bi-clipboard-plus me-2"></i>Créer une Demande</h5>
              <div class="mb-3">
                <label for="new_demande_site" class="form-label fw-semibold">Site ID (optionnel)</label>
                <input id="new_demande_site" class="form-control" placeholder="Ex: 12" type="number">
              </div>
              <div class="mb-3">
                <label for="new_demande_desc" class="form-label fw-semibold">Description</label>
                <textarea id="new_demande_desc" class="form-control" rows="2" placeholder="Décrivez la demande..."></textarea>
              </div>
              <button id="btnCreateDemande" class="btn btn-gradient w-100">
                <i class="bi bi-plus-circle me-2"></i>Créer la Demande
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      const params = new URLSearchParams(location.search);
      const id = params.get('id');

      if (!id) {
        document.body.innerHTML = `
          <div class="container mt-5">
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Client ID manquant dans l'URL
            </div>
          </div>`;
        return;
      }

      async function fetchJSON(url, opts) {
        const base = { headers: { 'Content-Type': 'application/json' } };
        if (token) base.headers['Authorization'] = 'Bearer ' + token;
        const r = await fetch(url, Object.assign(base, opts || {}));
        const ct = r.headers.get('content-type') || '';
        const b = ct.includes('application/json') ? await r.json() : null;
        if (!r.ok) throw new Error((b && b.error) || r.statusText);
        return b;
      }

      async function fetchBinaryURL(url) {
        const r = await fetch(url, {
          headers: token ? { 'Authorization': 'Bearer ' + token } : {},
          credentials: 'same-origin'
        });
        if (!r.ok) return null;
        const blob = await r.blob();
        return URL.createObjectURL(blob);
      }

      function getStatusBadge(status) {
        const map = {
          'En cours de traitement': 'status-progress',
          'Terminé': 'status-completed',
          'Complété': 'status-completed',
          'En attente': 'status-pending'
        };
        return `<span class="status-badge ${map[status] || 'status-pending'}">${status || 'En cours'}</span>`;
      }

      const docList = document.getElementById('repo-docs');
      const imgList = document.getElementById('repo-imgs');
      const msgsInfo = document.getElementById('repo-msgs-info');
      const editRepModalEl = document.getElementById('editRepModal');
      const editRepModal = editRepModalEl ? new bootstrap.Modal(editRepModalEl) : null;
      const editRepFeedback = document.getElementById('edit-rep-feedback');
      let currentRepEditing = null;

      try {
        const data = await fetchJSON('/api/clients/' + id + '/relations');
        const { client: c, sites, demandes, representants } = data;

        // Affichage des informations du client
        document.getElementById('client-nom').textContent = c.nom_client || 'Non spécifié';
        const adresse = c.adresse_libelle || c.adresse_id;
        document.getElementById('client-adresse-id').textContent = adresse || 'Non spécifié';
        document.getElementById('client-commentaire').textContent = c.commentaire || 'Aucun commentaire';

        const editLink = document.getElementById('editLink');
        if (editLink) {
          editLink.href = `/client-edit.html?id=${encodeURIComponent(id)}`;
          editLink.style.display = 'inline-block';
        }

        // Représentants
        const representantsList = document.getElementById('representants-list');
        representantsList.innerHTML = '';
        if (representants?.length) {
          representants.forEach(rep => {
            representantsList.innerHTML += `
              <div class="rep-card">
                <div class="d-flex align-items-start">
                  <div style="width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:bold;">
                    ${(rep.nom || 'N')[0].toUpperCase()}
                  </div>
                  <div class="ms-3">
                    <h6 class="fw-bold mb-1">${rep.nom || 'Inconnu'}</h6>
                    <small class="text-muted">${rep.fonction || ''}</small><br>
                    <small><i class="bi bi-envelope me-1"></i>${rep.email || 'N/A'}</small>
                    <small class="ms-2"><i class="bi bi-phone me-1"></i>${rep.tel || 'N/A'}</small>
                  </div>
                </div>
              </div>`;
          });
        } else {
          representantsList.innerHTML = `<div class="empty-state"><i class="bi bi-people"></i><p>Aucun représentant</p></div>`;
        }

        // Sites
        const sitesContainer = document.getElementById('sites-container');
        sitesContainer.innerHTML = sites?.length ? '' : `
          <div class="empty-state">
            <i class="bi bi-building"></i><p>Aucun site</p>
          </div>`;
        sites?.forEach(s =>
          sitesContainer.innerHTML += `
            <div class="list-item-custom">
              <strong>${s.nom_site || 'Site #' + s.id}</strong><br>
              <a href="/site-view.html?id=${s.id}" class="btn btn-sm btn-outline-primary mt-2">
                <i class="bi bi-eye"></i> Voir
              </a>
            </div>`);

        // Demandes
        const demandesContainer = document.getElementById('demandes-container');
        demandesContainer.innerHTML = demandes?.length ? '' : `
          <div class="empty-state">
            <i class="bi bi-clipboard-check"></i><p>Aucune demande</p>
          </div>`;
        demandes?.forEach(d =>
          demandesContainer.innerHTML += `
            <div class="list-item-custom">
              <strong>#${d.id}</strong> ${getStatusBadge(d.status)}
              <div class="text-muted small">
                <i class="bi bi-building me-1"></i>${d.nom_site || 'Aucun site'}
              </div>
              <small>${d.description || '(sans description)'}</small>
            </div>`);

        // ROLE ADMIN
        let isAdmin = false;
        try {
          const payload = token ? JSON.parse(atob(token.split('.')[1])) : {};
          isAdmin = payload?.roles?.includes('ROLE_ADMIN');
        } catch {}
        if (isAdmin) document.getElementById('adminActions').style.display = '';

        /* 🔽 RÉPERTOIRE DOCUMENTS + IMAGES 🔽 */
        const allDocs = [];
        const allImages = [];
        const allMsgAttachments = [];

        const loadDocs = async (type, cibleId) => {
          if (!cibleId) return;
          try {
            const docs = await fetchJSON(`/api/documents?cible_type=${type}&cible_id=${cibleId}`);
            const imgs = await fetchJSON(`/api/images?cible_type=${type}&cible_id=${cibleId}`);
            if (docs) allDocs.push(...docs);
            if (imgs) allImages.push(...imgs);
          } catch {}
        };

        const loadMessages = async demandeId => {
          if (!demandeId) return;
          try {
            const msgs = await fetchJSON(`/api/conversations/demande-${demandeId}`);
            msgs?.forEach(m => allMsgAttachments.push(...m.attachments || []));
          } catch {}
        };

        for (const s of sites || []) {
          await loadDocs('Site', s.id);
          try {
            const rel = await fetchJSON(`/api/sites/${s.id}/relations`);
            rel.tickets?.forEach(async t => {
              await loadDocs('Ticket', t.id);
              if (t.demande_id) await loadMessages(t.demande_id);
            });
          } catch {}
        }

        for (const d of demandes || []) {
          await loadDocs('DemandeClient', d.id);
          await loadMessages(d.id);
        }

        /* 🔹 Affichage des documents */
        docList.innerHTML = '';
        if (!allDocs.length && !allMsgAttachments.length) {
          docList.innerHTML = `<div class="empty-state"><i class="bi bi-file-earmark-text"></i><p>Aucun document</p></div>`;
        } else {
          allDocs.forEach(doc => {
            docList.innerHTML += `
              <div class="doc-item">
                <div class="d-flex align-items-center">
                  <div class="doc-icon"><i class="bi bi-file-earmark-text"></i></div>
                  <div><strong>${doc.nom_fichier}</strong><br><small class="text-muted">Document</small></div>
                </div>
                <a href="/api/documents/${doc.id}/download" class="btn btn-sm btn-outline-primary">
                  Télécharger
                </a>
              </div>`;
          });

          allMsgAttachments.forEach(att => {
            docList.innerHTML += `
              <div class="doc-item">
                <div class="d-flex align-items-center">
                  <div class="doc-icon"><i class="bi bi-paperclip"></i></div>
                  <div><strong>${att.file_name}</strong><br><small class="text-muted">Depuis message</small></div>
                </div>
                <a href="/api/attachments/${att.id}/view" class="btn btn-sm btn-outline-primary">
                  Télécharger
                </a>
              </div>`;
          });
        }

        /* 🔹 Affichage images */
        imgList.innerHTML = '';
        imgList.classList.add('image-gallery');
        if (!allImages.length) {
          imgList.innerHTML = `<div class="empty-state"><i class="bi bi-image"></i><p>Aucune image</p></div>`;
        } else {
          for (const img of allImages) {
            const url = await fetchBinaryURL(`/api/images/${img.id}/view`);
            if (!url) continue;
            imgList.innerHTML += `
              <a href="${url}" class="image-thumbnail" target="_blank">
                <img src="${url}" alt="">
              </a>`;
          }
        }

        if (msgsInfo && allMsgAttachments.length) {
          msgsInfo.innerHTML = `<i class="bi bi-info-circle me-1"></i>${allMsgAttachments.length} pièce(s) jointe(s) issue(s) des messages`;
        }

      } catch (err) {
        console.error(err);
        alert('Erreur de chargement: ' + err.message);
      }
    });
  </script>
</body>
</html>
