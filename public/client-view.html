<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Client - Détails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; }
  </style>
</head>
<body class="app-bg">
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item"><a class="nav-link" href="/dashboard.html"><i class="bi bi-house-door-fill me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/agents.html"><i class="bi bi-people-fill me-2"></i>Agents</a></li>
        <li class="nav-item"><a class="nav-link" href="/sites.html"><i class="bi bi-building-fill me-2"></i>Sites</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/tickets.html"><i class="bi bi-tools me-2"></i>Tickets</a></li>
        <li class="nav-item"><a class="nav-link" href="/interventions.html"><i class="bi bi-tools me-2"></i>Interventions</a></li>
        <li class="nav-item"><a class="nav-link" href="/rendezvous.html"><i class="bi bi-calendar-event-fill me-2"></i>Rendez-vous</a></li>
        <li class="nav-item"><a class="nav-link" href="/achats.html"><i class="bi bi-cart-fill me-2"></i>Achats</a></li>
        <li class="nav-item"><a class="nav-link" href="/factures.html"><i class="bi bi-receipt-cutoff me-2"></i>Factures</a></li>
        <li class="nav-item"><a class="nav-link" href="" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
      </ul>
    </div>
  </div>

 <!-- <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Détails Client</h1>
      <a id="editLink" href="#" class="btn btn-outline-secondary"><i class="bi bi-pencil"></i> Modifier ce client</a>
    </div>-->

    <div class="card mb-3">
      <div class="card-header"><strong>Détails Client</strong></div>
      <div class="card-body">
        <p><strong>Nom du client:</strong> <span id="client-nom"></span></p>
        <p><strong>Adresse ID:</strong> <span id="client-adresse-id"></span></p>
        <p><strong>Commentaire:</strong> <span id="client-commentaire"></span></p>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header"><strong>Représentants</strong></div>
      <div id="representants-list" class="list-group list-group-flush">
        <div class="list-group-item text-muted">Chargement...</div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header"><strong>Sites</strong></div>
          <div class="card-body">
            <ul id="sites" class="mb-0"></ul>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header"><strong>Demandes d'intervention</strong></div>
          <div class="card-body">
            <ul id="demandes" class="mb-0"></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header"><strong>Répertoire documents</strong></div>
      <div class="card-body">
        <p class="text-muted small">Rassemble toutes les pièces jointes (documents, images, PJ messages) liées aux sites/tickets/demandes de ce client.</p>
        <div class="row g-3">
          <div class="col-lg-6">
            <h6>Documents</h6>
            <ul id="repo-docs" class="list-group list-group-flush small"></ul>
          </div>
          <div class="col-lg-6">
            <h6>Images</h6>
            <div id="repo-imgs" class="d-flex flex-wrap gap-2"></div>
            <div class="text-muted small" id="repo-msgs-info"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="adminActions" class="card mt-3" style="display:none;">
      <div class="card-header"><strong>Actions administrateur</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <h5>Créer un site</h5>
            <div class="mb-2">
              <label for="new_site_nom" class="form-label">Nom site</label>
              <input id="new_site_nom" class="form-control">
            </div>
            <div class="mb-2">
              <label for="new_site_comment" class="form-label">Commentaire (optionnel)</label>
              <input id="new_site_comment" class="form-control">
            </div>
            <button id="btnCreateSite" class="btn btn-primary">Créer</button>
          </div>
          <div class="col-md-6">
            <h5>Créer une demande</h5>
            <div class="mb-2">
              <label for="new_demande_site" class="form-label">Site ID (optionnel)</label>
              <input id="new_demande_site" class="form-control" placeholder="ex: 12">
            </div>
            <div class="mb-2">
              <label for="new_demande_desc" class="form-label">Description</label>
              <textarea id="new_demande_desc" class="form-control" rows="3"></textarea>
            </div>
            <button id="btnCreateDemande" class="btn btn-primary">Créer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) { document.querySelector('main').innerHTML = '<div class="alert alert-danger">Client ID manquant</div>'; return; }

      async function fetchJSON(url, opts){
        const base = { headers: { 'Content-Type': 'application/json' } };
        if (token) base.headers['Authorization'] = 'Bearer ' + token;
        const r = await fetch(url, Object.assign(base, opts||{}));
        const ct = r.headers.get('content-type')||''; const b = ct.includes('application/json') ? await r.json() : null; if(!r.ok) throw new Error((b&&b.error)||r.statusText); return b;
      }
      async function fetchBinaryURL(url){
        const r = await fetch(url, { headers: token ? { 'Authorization': 'Bearer '+token } : {}, credentials:'same-origin' });
        if(!r.ok) return null;
        const blob = await r.blob();
        return URL.createObjectURL(blob);
      }
      const docList = document.getElementById('repo-docs');
      const imgList = document.getElementById('repo-imgs');
      const msgsInfo = document.getElementById('repo-msgs-info');
      const setRepoLoading = () => {
        if (docList) docList.innerHTML = '<li class="list-group-item text-muted">Chargement...</li>';
        if (imgList) imgList.innerHTML = '<div class="text-muted">Chargement...</div>';
        if (msgsInfo) msgsInfo.textContent = '';
      };

      try {
        const data = await fetchJSON('/api/clients/'+id+'/relations');
        const { client: c, sites, demandes, representants } = data; // Destructure new data

        // Populate main client details
        document.getElementById('client-nom').textContent = c.nom_client || '-';
        document.getElementById('client-adresse-id').textContent = c.adresse_id || '-';
        document.getElementById('client-commentaire').textContent = c.commentaire || 'Aucun';

        try { const el=document.getElementById('editLink'); if (el) el.href = '/client-edit.html?id='+encodeURIComponent(id); } catch {}

        const sitesList = document.getElementById('sites');
        sitesList.innerHTML = '';
        sites.forEach(s=>{ const li=document.createElement('li'); li.innerHTML = '#' + s.id + ' <a href="/site-view.html?id=' + s.id + '">' + (s.nom_site||('Site '+s.id)) + '</a>'; sitesList.appendChild(li); });
        const demandesList = document.getElementById('demandes');
        demandesList.innerHTML = '';
        demandes.forEach(d=>{ const li=document.createElement('li'); const sitePart = d.site_id ? (' <a href="/site-view.html?id=' + d.site_id + '">' + (d.nom_site||('Site '+d.site_id)) + '</a>') : ' (site: -)'; li.innerHTML = '#' + d.id + ' [' + (d.status||'En cours de traitement') + ']' + sitePart + ' - ' + (d.description||''); demandesList.appendChild(li); });

        // Populate representatives list
        const representantsList = document.getElementById('representants-list');
        representantsList.innerHTML = '';
        if (representants && representants.length > 0) {
            representants.forEach(rep => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="fw-bold">${rep.nom}</div>
                    <div class="small text-muted">${rep.fonction || 'N/A'}</div>
                    <div class="small"><i class="bi bi-envelope-fill"></i> ${rep.email || 'N/A'} | <i class="bi bi-telephone-fill"></i> ${rep.tel || 'N/A'}</div>
                `;
                representantsList.appendChild(item);
            });
        } else {
            representantsList.innerHTML = '<div class="list-group-item text-muted">Aucun représentant trouvé.</div>';
        }

        let isAdmin = false;
        try { const p = token ? JSON.parse(atob(token.split('.')[1])) : null; isAdmin = Array.isArray(p?.roles)&&p.roles.includes('ROLE_ADMIN'); } catch{}
        if (isAdmin) { const box = document.getElementById('adminActions'); if (box) box.style.display = ''; }

        const btnSite = document.getElementById('btnCreateSite');
        if (btnSite) btnSite.addEventListener('click', async () => {
          if (!isAdmin) return alert('Admin requis');
          const nom_site = document.getElementById('new_site_nom').value.trim();
          const commentaire = document.getElementById('new_site_comment').value.trim();
          if (!nom_site) return alert('Nom requis');
          try { await fetchJSON('/api/sites', { method:'POST', body: JSON.stringify({ nom_site, client_id: Number(id), commentaire }) }); alert('Site créé'); location.reload(); }
          catch(e){ alert(e.message); }
        });
        const btnDem = document.getElementById('btnCreateDemande');
        if (btnDem) btnDem.addEventListener('click', async () => {
          if (!isAdmin) return alert('Admin requis');
          const site_id_raw = document.getElementById('new_demande_site').value.trim();
          const description = document.getElementById('new_demande_desc').value.trim();
          const site_id = site_id_raw ? Number(site_id_raw) : null;
          if (!description) return alert('Description requise');
          try { await fetchJSON('/api/clients/'+id+'/demandes', { method:'POST', body: JSON.stringify({ site_id, description }) }); alert('Demande créée'); location.reload(); }
          catch(e){ alert(e.message); }
        });

        // Charger le répertoire documents
        setRepoLoading();
        try {
          const allDocs = [];
          const allImages = [];
          const allMsgAttachments = [];

          const loadDocs = async (type, cibleId) => {
            if (!cibleId) return;
            const docs = await fetchJSON(`/api/documents?cible_type=${encodeURIComponent(type)}&cible_id=${cibleId}`);
            if (Array.isArray(docs)) allDocs.push(...docs);
            const imgs = await fetchJSON(`/api/images?cible_type=${encodeURIComponent(type)}&cible_id=${cibleId}`);
            if (Array.isArray(imgs)) allImages.push(...imgs);
          };

          const loadMessages = async (demandeId) => {
            if (!demandeId) return;
            const msgs = await fetchJSON(`/api/conversations/demande-${demandeId}`).catch(()=>null);
            if (Array.isArray(msgs)) {
              msgs.forEach(m => { if (Array.isArray(m.attachments)) allMsgAttachments.push(...m.attachments); });
            }
          };

          // Par site
          for (const s of sites||[]) {
            await loadDocs('Site', s.id);
            // tickets du site
            const siteRel = await fetchJSON(`/api/sites/${s.id}/relations`).catch(()=>null);
            if (siteRel?.tickets) {
              for (const t of siteRel.tickets) {
                await loadDocs('Ticket', t.id);
                if (t.demande_id) await loadMessages(t.demande_id);
              }
            }
          }
          // Par demande directe
          for (const d of demandes||[]) {
            await loadDocs('DemandeClient', d.id);
            await loadMessages(d.id);
          }

          // Rendu documents
          if (docList) {
            docList.innerHTML = '';
            if (!allDocs.length && !allMsgAttachments.length) {
              docList.innerHTML = '<li class="list-group-item text-muted">Aucun document</li>';
            } else {
              allDocs.forEach(doc => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<span>${doc.nom_fichier || 'Document #'+doc.id}</span>`;
                const btn = document.createElement('a');
                btn.className = 'btn btn-sm btn-outline-primary';
                btn.textContent = 'Télécharger';
                btn.href = `/api/documents/${doc.id}/download`;
                btn.target = '_blank';
                li.appendChild(btn);
                docList.appendChild(li);
              });
              allMsgAttachments.forEach(att => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                const name = att.file_name || 'Pièce jointe';
                li.innerHTML = `<span>${name} <span class="badge bg-secondary ms-2">Message</span></span>`;
                const href = `/api/attachments/${att.id}/view`;
                const btn = document.createElement('a');
                btn.className = 'btn btn-sm btn-outline-primary';
                btn.textContent = 'Télécharger';
                btn.href = href;
                btn.target = '_blank';
                li.appendChild(btn);
                docList.appendChild(li);
              });
            }
          }

          // Rendu images
          if (imgList) {
            imgList.innerHTML = '';
            if (!allImages.length) {
              imgList.innerHTML = '<div class="text-muted">Aucune image</div>';
            } else {
              for (const img of allImages) {
                const url = await fetchBinaryURL(`/api/images/${img.id}/view`);
                if (!url) continue;
                const link = document.createElement('a');
                link.href = url; link.target = '_blank';
                const tag = document.createElement('img');
                tag.src = url; tag.alt = img.nom_fichier; tag.style = 'width:110px;height:110px;object-fit:cover;border-radius:8px;';
                link.appendChild(tag);
                imgList.appendChild(link);
              }
            }
          }

          if (msgsInfo) msgsInfo.textContent = allMsgAttachments.length ? `${allMsgAttachments.length} PJ issues des messages` : '';
        } catch(e) {
          if (docList) docList.innerHTML = '<li class="list-group-item text-danger">Erreur de chargement du répertoire</li>';
          if (imgList) imgList.innerHTML = '<div class="text-danger">Erreur</div>';
        }
      } catch(e) {
        const cc = document.getElementById('clientCard'); if (cc) cc.innerHTML = '<div class="card-body">Erreur: '+(e.message||e)+'</div>';
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
