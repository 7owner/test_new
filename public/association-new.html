<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouvelle Association</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
  <div class="container p-4">
    <form id="new-association-form">
      <div class="mb-3">
        <label for="titre" class="form-label">Titre de l'association</label>
        <input type="text" class="form-control" id="titre" required>
      </div>
      <div class="mb-3">
        <label for="email_comptabilite" class="form-label">Email de comptabilité</label>
        <input type="email" class="form-control" id="email_comptabilite">
      </div>
      
      <hr class="my-4">

      <h5>Adresse</h5>
      <div class="mb-3">
        <label for="adresse-ligne1" class="form-label">Ligne 1</label>
        <input type="text" class="form-control" id="adresse-ligne1">
      </div>
      <div class="mb-3">
        <label for="adresse-ligne2" class="form-label">Ligne 2 (optionnel)</label>
        <input type="text" class="form-control" id="adresse-ligne2">
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="adresse-codepostal" class="form-label">Code Postal</label>
          <input type="text" class="form-control" id="adresse-codepostal">
        </div>
        <div class="col-md-6 mb-3">
          <label for="adresse-ville" class="form-label">Ville</label>
          <input type="text" class="form-control" id="adresse-ville">
        </div>
      </div>
      
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
    <div id="feedback" class="mt-3"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('new-association-form');
      const feedback = document.getElementById('feedback');
      const token = localStorage.getItem('token');
      const headers = { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        feedback.innerHTML = '';
        feedback.classList.remove('alert', 'alert-danger', 'alert-success');

        let adresseId = null;

        // Check if address fields are filled
        const ligne1 = document.getElementById('adresse-ligne1').value.trim();
        const codePostal = document.getElementById('adresse-codepostal').value.trim();
        const ville = document.getElementById('adresse-ville').value.trim();

        if (ligne1 && codePostal && ville) {
          try {
            const adressePayload = {
              ligne1: ligne1,
              ligne2: document.getElementById('adresse-ligne2').value.trim(),
              code_postal: codePostal,
              ville: ville
            };
            const addrRes = await fetch('/api/adresses', {
              method: 'POST',
              headers: headers,
              body: JSON.stringify(adressePayload)
            });
            if (!addrRes.ok) throw new Error('Erreur lors de la création de l\'adresse.');
            const newAdresse = await addrRes.json();
            adresseId = newAdresse.id;
          } catch (error) {
            feedback.className = 'alert alert-danger';
            feedback.textContent = error.message;
            return;
          }
        }

        // Create the association
        try {
          const assocPayload = {
            titre: document.getElementById('titre').value,
            email_comptabilite: document.getElementById('email_comptabilite').value,
            adresse_id: adresseId
          };
          const assocRes = await fetch('/api/associations', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(assocPayload)
          });
          if (!assocRes.ok) throw new Error('Erreur lors de la création de l\'association.');
          
          feedback.className = 'alert alert-success';
          feedback.textContent = 'Association créée avec succès ! Cette fenêtre va se fermer.';
          
          // Close the modal after a short delay
          setTimeout(() => {
            // This is running inside an iframe, so we ask the parent window to close the modal
            if (window.parent) {
                const modal = window.parent.document.getElementById('createAssociationModal');
                if (modal) {
                    const bsModal = window.parent.bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                }
            }
          }, 2000);

        } catch (error) {
          feedback.className = 'alert alert-danger';
          feedback.textContent = error.message;
        }
      });
    });
  </script>
</body>
</html>
