<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du rendu d'intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <script src="/js/rapport-intervention.js"></script>
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card {
      border: 2px solid #e5e7eb; border-radius: 12px; background: #fff;
      transition: all 0.2s ease; height: 100%;
    }
    .attachment-card:hover { border-color:#3b82f6; box-shadow:0 8px 24px rgba(59,130,246,0.12); }
    .attachment-preview {
      width:100%; height:180px; background:#f3f4f6; display:flex; align-items:center; justify-content:center;
      border-radius: 10px 10px 0 0; overflow:hidden;
    }
    .attachment-preview img { width:100%; height:100%; object-fit:cover; }
    .attachment-info { padding:12px 14px; }
    .attachment-comment { font-size:0.9rem; color:#374151; min-height:48px; }
    .badge-source { font-size:0.7rem; }
  </style>
</head>
<body>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1"><i class="bi bi-file-text me-2"></i>Rendu d'intervention</h1>
        <div class="text-muted small">Intervention <span id="intervention-id">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-success btn-sm" id="download-html-btn"><i class="bi bi-download"></i> Télécharger (HTML)</button>
        <button class="btn btn-outline-primary btn-sm" id="edit-meta-btn"><i class="bi bi-pencil"></i> Modifier</button>
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h6 class="text-uppercase text-muted small mb-2">Résumé</h6>
        <div id="view_resume" class="small">—</div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes liées</h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-primary" id="attachments-count">0 pièce(s)</span>
            <a class="btn btn-outline-primary btn-sm" id="manage-attachments-btn"><i class="bi bi-pencil-square me-1"></i>Modifier</a>
          </div>
        </div>
        <p class="text-muted small mb-3">Images / documents provenant du ticket, du site, de la demande client ou des messages associés.</p>
        <div class="row g-3" id="attachments-grid"></div>
      </div>
    </div>

    <div class="card mb-4 d-none" id="messages-card">
      <div class="card-body">
        <h5 class="mb-2"><i class="bi bi-chat-dots me-2"></i>Messages liés</h5>
        <p class="text-muted small mb-3">Extraits des messages accompagnant les pièces jointes.</p>
        <div class="row g-3" id="messages-grid"></div>
      </div>
    </div>

    <div class="d-flex gap-2 no-print">
      <button class="btn btn-secondary" id="back-to-intervention-btn">Retour à l'intervention</button>
      <a class="btn btn-outline-primary" id="open-rendu-new-btn"><i class="bi bi-plus-circle me-1"></i>Nouveau rendu</a>
    </div>
  </main>

  <!-- Modal édition valeur / résumé -->
  <div class="modal fade" id="editMetaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Modifier le résumé</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
              <div class="col-lg-6">
                <label class="form-label fw-semibold" for="edit-resume-input">Résumé (Markdown)</label>
              <textarea class="form-control" id="edit-resume-input" rows="8" placeholder="Saisissez le résumé en Markdown..."></textarea>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-semibold">Aperçu</label>
              <div id="edit-resume-preview" class="border rounded p-3 bg-light" style="min-height: 200px;">
                <em class="text-muted">Le résumé apparaîtra ici...</em>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="save-meta-btn"><i class="bi bi-check-lg"></i> Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Session expirée. Veuillez vous reconnecter.');
        return location.href = '/login.html';
      }
      const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

      const params = new URLSearchParams(location.search);
      const renduId = params.get('id');

      if (!renduId) {
        alert('ID du rendu manquant.');
        return location.href = '/interventions.html';
      }

      const grid = document.getElementById('attachments-grid');
      const countBadge = document.getElementById('attachments-count');
      const resumeEl = document.getElementById('view_resume');
      const interEl = document.getElementById('intervention-id');
      const backInterBtn = document.getElementById('back-to-intervention-btn');
      const newRenduBtn = document.getElementById('open-rendu-new-btn');
      const backBtn = document.getElementById('back-btn');
      const editBtn = document.getElementById('edit-meta-btn');
      const manageAttachmentsBtn = document.getElementById('manage-attachments-btn');
      const messagesCard = document.getElementById('messages-card');
      const messagesGrid = document.getElementById('messages-grid');
      const editModalEl = document.getElementById('editMetaModal');
      const editModal = new bootstrap.Modal(editModalEl);
      const editResumeInput = document.getElementById('edit-resume-input');
      const editResumePreview = document.getElementById('edit-resume-preview');
      const downloadBtn = document.getElementById('download-html-btn');
      let editResumeEditor = null;
      let currentRendu = null;
      let saving = false;
      let attachments = [];
      let messages = [];
      let printTemplate = null;
      let ticketIdRef = null;
      let siteIdRef = null;
      const detectKind = (mime = '', name = '') => {
        const lowerName = (name || '').toLowerCase();
        if ((mime && mime.startsWith('image/')) || /\.(png|jpe?g|gif|webp|bmp)$/i.test(lowerName)) return 'image';
        return 'doc';
      };
      // Nettoyer les pièces jointes orphelines (documents 404)
      const validateAttachments = async (list) => {
        const checks = await Promise.all(list.map(async (att) => {
          if (att.url && att.kind === 'doc') {
            try {
              const res = await fetch(att.url, { method: 'HEAD', headers });
              return res.ok;
            } catch (_) { return false; }
          }
          return true;
        }));
        return list.filter((_, idx) => checks[idx]);
      };
      const ensureReportHelpers = async () => {
        if (window.fetchInterventionMeta && window.buildInterventionReportHTML) return;
        // Inline fallback definitions if the external script n'est pas exécuté (ex: rendu injecté en modal)
        (function () {
          if (window.fetchInterventionMeta && window.buildInterventionReportHTML) return;
          const placeholderPixel = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAn8B9W/2zXMAAAAASUVORK5CYII=';
          async function fetchAsDataUrl(path, token) {
            if (!path) return placeholderPixel;
            try {
              const headers = token ? { Authorization: `Bearer ${token}` } : {};
              const res = await fetch(path, { credentials: 'same-origin', headers });
              if (!res.ok) throw new Error('fetch failed');
              const ct = (res.headers.get('Content-Type') || '').toLowerCase();
              if (!ct.startsWith('image/')) return path;
              const blob = await res.blob();
              return await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
              });
            } catch (_) {
              return path || placeholderPixel;
            }
          }
          async function buildInterventionReportHTML({ meta = {}, images = [], resumeHtml = '', token = null, logoUrl = '/logo_logicielle.png' } = {}) {
            const safeMeta = {
              client: meta.client || 'Non renseigné',
              site: meta.site || 'Non renseigné',
              contrat: meta.contrat || 'Non renseigné',
              intervention: meta.intervention || 'Rendu intervention',
              dateStr: meta.dateStr || new Date().toLocaleDateString('fr-FR'),
            };
            const logoSrc = await fetchAsDataUrl(logoUrl, token);
            let imagesHtml = '';
            for (const img of images) {
              const imgSrc = await fetchAsDataUrl(img.url || img.previewUrl || '', token);
              imagesHtml += `
                <div class="bloc">
                  <img src="${imgSrc || ''}" alt="${img.nom_fichier || 'Image'}">
                  <p><b>${img.nom_fichier || 'Image'}</b></p>
                  <p>${img.commentaire_image || ''}</p>
                </div>`;
            }
            return `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Rapport d'intervention</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #f9f9f9; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .header h1 { font-size: 16px; color: #2A61B3; margin-top: 5px; }
    .date { text-align: center; font-size: 13px; margin-top: 10px; color: #555; }
    .infos { text-align: center; margin: 30px 0; line-height: 1.8; font-size: 15px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .bloc { background-color: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 5px; text-align: center; }
    .bloc img { width: 80%; height: auto; border-radius: 4px; margin-bottom: 8px; cursor: pointer; transition: transform 0.5s ease; }
    .bloc img:hover { transform: scale(1.3); }
    p { margin: 4px 0; font-size: 14px; color: #333; }
    .comment-section { background-color: #f0f8ff; padding: 15px; margin: 20px 0; border-left: 4px solid #2A61B3; border-radius: 4px; }
    .comment-section p { text-align: left; line-height: 1.6; }
  </style>
</head>
<body>
  <div class="header">
    <img src="${logoSrc}" alt="Logo" style="width:160px;height:auto;">
    <h1>Client : ${safeMeta.client}</h1>
  </div>
  <div class="date"><p><b>Date :</b> ${safeMeta.dateStr}</p></div>
  <div class="infos">
    <p><b>Intervention :</b> ${safeMeta.intervention}</p>
    <p><b>Site :</b> ${safeMeta.site}</p>
    <p><b>Contrat :</b> ${safeMeta.contrat}</p>
  </div>
  <div class="comment-section">
    <p><b>Commentaire / Résumé :</b></p>
    <div style="padding:8px;border-radius:4px;border:1px solid #ccc;background:#fff;">${resumeHtml || '<em>Aucun résumé</em>'}</div>
  </div>
  <div class="grid">
    ${imagesHtml || '<p class="text-muted">Aucune image.</p>'}
  </div>
</body>
</html>`;
          }
          async function fetchInterventionMeta({ interventionId, ticketId, siteId, associationId, token }) {
            const safeMeta = { client:'Non renseigné', site:'Non renseigné', contrat:'Non renseigné', intervention: interventionId || 'Rendu intervention' };
            const fetchJSON = async (url) => {
              const headers = token ? { Authorization: `Bearer ${token}` } : {};
              const res = await fetch(url, { headers, credentials:'same-origin' });
              if (!res.ok) return null;
              return res.json();
            };
            try {
              if (interventionId) {
                const interData = await fetchJSON(`/api/interventions/${interventionId}`);
                if (interData) {
                  if (interData.titre) safeMeta.intervention = interData.titre;
                  if (interData.ticket_id) ticketId = ticketId || interData.ticket_id;
                  if (interData.site_id) siteId = siteId || interData.site_id;
                  if (interData.association_id) associationId = associationId || interData.association_id;
                }
                const rel = await fetchJSON(`/api/interventions/${interventionId}/relations`);
                if (rel?.ticket) {
                  ticketId = ticketId || rel.ticket.id || rel.ticket.ticket_id;
                  siteId = siteId || rel.ticket.site_id;
                  associationId = associationId || rel.ticket.association_id;
                  safeMeta.client = rel.ticket.nom_client || safeMeta.client;
                  safeMeta.site = rel.ticket.nom_site || safeMeta.site;
                  safeMeta.intervention = rel.ticket.titre || safeMeta.intervention;
                  safeMeta.contrat = rel.ticket.contrat_titre || safeMeta.contrat;
                }
                if (rel?.site?.nom_site) safeMeta.site = rel.site.nom_site;
                if (rel?.intervention?.titre) safeMeta.intervention = rel.intervention.titre;
                if (rel?.contrat?.titre) safeMeta.contrat = rel.contrat.titre;
                if (rel?.association) {
                  associationId = associationId || rel.association.id;
                  safeMeta.client = rel.association.client_nom || safeMeta.client;
                  safeMeta.contrat = rel.association.contrat_titre || safeMeta.contrat;
                }
              }
              if (ticketId) {
                const rel = await fetchJSON(`/api/tickets/${ticketId}/relations`);
                if (rel?.ticket) {
                  safeMeta.client = rel.ticket.nom_client || safeMeta.client;
                  safeMeta.site = rel.ticket.nom_site || safeMeta.site;
                  safeMeta.intervention = rel.ticket.titre || safeMeta.intervention;
                  safeMeta.contrat = rel.ticket.contrat_titre || safeMeta.contrat;
                  if (!siteId && rel.ticket.site_id) siteId = rel.ticket.site_id;
                  if (!associationId && rel.ticket.association_id) associationId = rel.ticket.association_id;
                }
                if (rel?.association) {
                  associationId = associationId || rel.association.id;
                  safeMeta.client = rel.association.client_nom || safeMeta.client;
                  safeMeta.contrat = rel.association.contrat_titre || safeMeta.contrat;
                }
              }
              if (siteId && (safeMeta.site === 'Non renseigné' || safeMeta.client === 'Non renseigné')) {
                const site = await fetchJSON(`/api/sites/${siteId}`);
                if (site) {
                  if (site.nom_site) safeMeta.site = site.nom_site;
                  if (site.nom_client) safeMeta.client = site.nom_client;
                }
              }
              if (associationId && (safeMeta.client === 'Non renseigné' || safeMeta.contrat === 'Non renseigné')) {
                const asso = await fetchJSON(`/api/associations/${associationId}`);
                if (asso) {
                  if (asso.nom) safeMeta.client = asso.nom;
                  if (asso.client_nom) safeMeta.client = asso.client_nom;
                  if (asso.contrat_titre) safeMeta.contrat = asso.contrat_titre;
                }
              }
            } catch (_) {}
            return safeMeta;
          }
          window.fetchInterventionMeta = fetchInterventionMeta;
          window.buildInterventionReportHTML = buildInterventionReportHTML;
        })();
      };
      const loadHelperScript = () => new Promise((resolve, reject) => {
        if (window.fetchInterventionMeta) return resolve();
        const s = document.createElement('script');
        s.src = '/js/rapport-intervention.js';
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Impossible de charger rapport-intervention.js'));
        document.head.appendChild(s);
      });

      const fetchJSON = async (url) => {
        const response = await fetch(url, { headers });
        if (!response.ok) {
          const error = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
          throw new Error(error.message || 'Erreur de chargement');
        }
        return response.json();
      };

      const escapeHtml = (str = '') => String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');

      const buildAndDownloadHtml = async () => {
        if (!currentRendu) return alert('Rendu non chargé.');
        try {
          await ensureReportHelpers();
          if (!window.fetchInterventionMeta || !window.buildInterventionReportHTML) {
            throw new Error('Helper rapport indisponible');
          }
          const resumeHtml = currentRendu.resume ? marked.parse(currentRendu.resume) : '';
          // Préparer les pièces jointes (images converties en data URL)
          const imgs = attachments
            .filter(att => att.kind === 'image')
            .map(att => ({ ...att, url: att.url || att.previewUrl || '' }));

          const metaReport = await window.fetchInterventionMeta({
            interventionId: currentRendu.intervention_id || renduId,
            ticketId: ticketIdRef,
            siteId: siteIdRef,
            token
          });
          metaReport.dateStr = new Date().toLocaleDateString('fr-FR');
          const htmlString = await window.buildInterventionReportHTML({
            meta: metaReport,
            images: imgs,
            resumeHtml,
            token
          });

          const blob = new Blob([htmlString], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `rendu-${currentRendu.id || renduId}.html`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          alert(`Impossible de préparer le téléchargement : ${err.message}`);
        }
      };

      try {
        const { rendu, images, documents, message_attachments } = await fetchJSON(`/api/rendus/${renduId}`);
        currentRendu = rendu;
        attachments = [];
        messages = [];

        // Populate header and nav buttons
        interEl.textContent = rendu.intervention_id;
        backInterBtn.onclick = () => location.href = `intervention-view.html?id=${rendu.intervention_id}`;
        newRenduBtn.href = `rendu-intervention-new.html?id=${rendu.intervention_id}`;
        backBtn.onclick = () => location.href = `intervention-view.html?id=${rendu.intervention_id}`;
        if (manageAttachmentsBtn) manageAttachmentsBtn.href = `rendu-intervention-edit.html?id=${renduId}#attachments`;


        // Populate summary cards
        const updateDisplay = (resume) => {
          resumeEl.innerHTML = resume ? marked.parse(resume) : '<span class="text-muted">Aucun résumé.</span>';
        };
        updateDisplay(rendu.resume);

        const updatePreview = () => {
          const text = editResumeEditor ? editResumeEditor.value() : (editResumeInput.value || '');
          editResumePreview.innerHTML = text ? marked.parse(text) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        };

        editBtn.addEventListener('click', () => {
          if (!currentRendu) return;
          try {
            // Init éditeur Markdown si dispo, sinon fallback textarea
            if (!editResumeEditor && typeof EasyMDE !== 'undefined') {
              editResumeEditor = new EasyMDE({
                element: editResumeInput,
                spellChecker: false,
                forceSync: true,
                status: false,
                minHeight: "220px",
                toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|","link","table","code","preview"]
              });
              editResumeEditor.codemirror.on('change', updatePreview);
            }
            if (editResumeEditor) {
              editResumeEditor.value(currentRendu.resume || '');
            } else {
              editResumeInput.value = currentRendu.resume || '';
            }
            updatePreview();
            editModal.show();
          } catch (err) {
            alert('Impossible d’ouvrir le formulaire de modification : ' + err.message);
          }
        });

        document.getElementById('save-meta-btn').addEventListener('click', async () => {
          if (saving) return;
          saving = true;
          const payload = {
            resume: editResumeEditor ? editResumeEditor.value() : (editResumeInput.value || '')
          };
          try {
            const resp = await fetch(`/api/rendus/${renduId}`, {
              method: 'PATCH',
              headers,
              body: JSON.stringify(payload)
            });
            if (!resp.ok) {
              const body = await resp.json().catch(() => null);
              throw new Error(body?.error || body?.message || `HTTP ${resp.status}`);
            }
            const data = await resp.json().catch(() => payload);
            currentRendu = data.rendu || { ...currentRendu, ...payload };
            updateDisplay(currentRendu.resume);
            editModal.hide();
          } catch (err) {
            alert(`Erreur lors de la mise à jour : ${err.message}`);
          } finally {
            saving = false;
          }
        });

        // IDs for meta enrichment
        ticketIdRef = rendu.ticket_id || null;
        siteIdRef = rendu.site_id || null;

        // Process and render attachments
        (images || []).forEach(img => {
            attachments.push({
                kind: 'image',
                url: `/api/images/${img.id}/view`,
                nom_fichier: img.nom_fichier,
                titre: img.titre || img.nom_fichier,
                commentaire_image: img.commentaire_image,
                type: 'Image'
            });
        });

        (documents || []).forEach(doc => {
            attachments.push({
                kind: detectKind(doc.type_mime, doc.nom_fichier),
                url: `/api/documents/${doc.id}/view`,
                nom_fichier: doc.nom_fichier,
                titre: doc.titre || doc.nom_fichier,
                commentaire_image: doc.nature || 'Document',
                type: 'Document'
            });
        });

        (message_attachments || []).forEach(msgAtt => {
            const kind = detectKind(msgAtt.file_type, msgAtt.file_name);
            attachments.push({
                kind: kind,
                url: `/api/attachments/${msgAtt.id}/view`,
                nom_fichier: msgAtt.file_name,
                titre: msgAtt.titre || msgAtt.file_name,
                commentaire_image: `Pièce jointe du message: "${(msgAtt.message || '').substring(0, 50)}..."`,
                type: 'Message'
            });
            if (msgAtt.message) {
              messages.push({
                message: msgAtt.message,
                created_at: msgAtt.created_at || msgAtt.date || null,
                fichier: msgAtt.file_name
              });
            }
        });
        attachments = await validateAttachments(attachments);

        countBadge.textContent = `${attachments.length} pièce(s)`;
        grid.innerHTML = '';
        if (!attachments.length) {
          grid.innerHTML = '<div class="col-12 text-muted small">Aucune pièce jointe pour ce rendu.</div>';
          document.querySelector('.small.mb-3').textContent = 'Ce rendu ne contient aucune pièce jointe.';
        } else {
            document.querySelector('.small.mb-3').textContent = 'Pièces jointes enregistrées avec ce rendu et son contexte.';
            attachments.forEach(att => {
                const col = document.createElement('div');
                col.className = 'col-12 col-sm-6 col-lg-4';
                const card = document.createElement('div');
                card.className = 'attachment-card';

                const prev = document.createElement('div');
                prev.className = 'attachment-preview';
                const displayTitle = att.titre || att.commentaire_image || att.nom_fichier || 'Fichier';
                if (att.kind === 'image') {
                  prev.innerHTML = `<a href="${att.url}" target="_blank"><img src="${att.url}" alt="${displayTitle}"></a>`;
                } else {
                  prev.innerHTML = `<a href="${att.url}" target="_blank" class="text-white d-flex align-items-center justify-content-center h-100"><i class="bi bi-file-earmark-text fs-1"></i></a>`;
                  prev.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                }

                const info = document.createElement('div');
                info.className = 'attachment-info';
                info.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="badge bg-primary badge-source">${att.type || (att.kind === 'image' ? 'Image' : 'Document')}</div>
                    </div>
                    <div class="fw-semibold">${displayTitle}</div>
                    <div class="attachment-comment">${marked.parse(att.commentaire_image || 'Aucun commentaire')}</div>
                `;
                card.append(prev, info);
                col.append(card);
                grid.append(col);
            });
        }

      } catch (error) {
        console.error('Failed to load rendu details:', error);
        document.querySelector('main').innerHTML = `<div class="alert alert-danger">Impossible de charger le rendu. ${error.message}</div>`;
      }

      // Afficher les messages liés (si présents)
      if (messages.length && messagesCard && messagesGrid) {
        messagesCard.classList.remove('d-none');
        messagesGrid.innerHTML = messages.map(m => {
          const dateTxt = m.created_at ? new Date(m.created_at).toLocaleString() : '';
          return `
            <div class="col-12 col-md-6 col-lg-4">
              <div class="border rounded p-3 h-100 bg-light">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge bg-secondary">Message</span>
                  ${dateTxt ? `<small class="text-muted">${dateTxt}</small>` : ''}
                </div>
                <div class="fw-semibold mb-1">${m.fichier || 'Pièce jointe'}</div>
                <div class="small text-muted">${m.message.replace(/\n/g,'<br>')}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      if (downloadBtn) downloadBtn.addEventListener('click', buildAndDownloadHtml);
    });
  </script>
</body>
</html>
