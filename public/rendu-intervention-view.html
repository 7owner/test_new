<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du rendu d'intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card {
      border: 2px solid #e5e7eb; border-radius: 12px; background: #fff;
      transition: all 0.2s ease; height: 100%;
    }
    .attachment-card:hover { border-color:#3b82f6; box-shadow:0 8px 24px rgba(59,130,246,0.12); }
    .attachment-preview {
      width:100%; height:180px; background:#f3f4f6; display:flex; align-items:center; justify-content:center;
      border-radius: 10px 10px 0 0; overflow:hidden;
    }
    .attachment-preview img { width:100%; height:100%; object-fit:cover; }
    .attachment-info { padding:12px 14px; }
    .attachment-comment { font-size:0.9rem; color:#374151; min-height:48px; }
    .badge-source { font-size:0.7rem; }
  </style>
</head>
<body>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1"><i class="bi bi-file-text me-2"></i>Rendu d'intervention</h1>
        <div class="text-muted small">Intervention <span id="intervention-id">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Imprimer</button>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h6 class="text-uppercase text-muted small mb-2">Valeur</h6>
            <div id="view_valeur" class="fs-5 fw-semibold">—</div>
            <div class="text-muted small">Montant estimé</div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="text-uppercase text-muted small mb-2">Résumé</h6>
            <div id="view_resume" class="small">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes liées</h5>
          <span class="badge bg-primary" id="attachments-count">0 pièce(s)</span>
        </div>
        <p class="text-muted small mb-3">Images / documents provenant du ticket, du site, de la demande client ou des messages associés.</p>
        <div class="row g-3" id="attachments-grid"></div>
      </div>
    </div>

    <div class="d-flex gap-2 no-print">
      <button class="btn btn-secondary" id="back-to-intervention-btn">Retour à l'intervention</button>
      <a class="btn btn-outline-primary" id="open-rendu-new-btn"><i class="bi bi-plus-circle me-1"></i>Nouveau rendu</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Session expirée. Veuillez vous reconnecter.');
        return location.href = '/login.html';
      }
      const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

      const params = new URLSearchParams(location.search);
      const renduId = params.get('id');

      if (!renduId) {
        alert('ID du rendu manquant.');
        return location.href = '/interventions.html';
      }

      const grid = document.getElementById('attachments-grid');
      const countBadge = document.getElementById('attachments-count');
      const resumeEl = document.getElementById('view_resume');
      const valeurEl = document.getElementById('view_valeur');
      const interEl = document.getElementById('intervention-id');
      const backInterBtn = document.getElementById('back-to-intervention-btn');
      const newRenduBtn = document.getElementById('open-rendu-new-btn');
      const backBtn = document.getElementById('back-btn');

      const fetchJSON = async (url) => {
        const response = await fetch(url, { headers });
        if (!response.ok) {
          const error = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
          throw new Error(error.message || 'Erreur de chargement');
        }
        return response.json();
      };

      try {
        const { rendu, images, documents, message_attachments } = await fetchJSON(`/api/rendus/${renduId}`);

        // Populate header and nav buttons
        interEl.textContent = rendu.intervention_id;
        backInterBtn.onclick = () => location.href = `intervention-view.html?id=${rendu.intervention_id}`;
        newRenduBtn.href = `rendu-intervention-new.html?id=${rendu.intervention_id}`;
        backBtn.onclick = () => location.href = `intervention-view.html?id=${rendu.intervention_id}`;


        // Populate summary cards
        valeurEl.textContent = rendu.valeur || 'Non spécifiée';
        resumeEl.innerHTML = rendu.resume ? marked.parse(rendu.resume) : '<span class="text-muted">Aucun résumé.</span>';

        // Process and render attachments
        const attachments = [];
        (images || []).forEach(img => {
            attachments.push({
                kind: 'image',
                url: `/api/images/${img.id}/view`,
                nom_fichier: img.nom_fichier,
                commentaire_image: img.commentaire_image,
                type: 'Image'
            });
        });

        (documents || []).forEach(doc => {
            attachments.push({
                kind: 'doc',
                url: `/api/documents/${doc.id}/view`,
                nom_fichier: doc.nom_fichier,
                commentaire_image: doc.nature || 'Document',
                type: 'Document'
            });
        });

        (message_attachments || []).forEach(msgAtt => {
            const kind = (msgAtt.file_type && msgAtt.file_type.startsWith('image/')) ? 'image' : 'doc';
            attachments.push({
                kind: kind,
                url: `/api/attachments/${msgAtt.id}/view`,
                nom_fichier: msgAtt.file_name,
                commentaire_image: `Pièce jointe du message: "${(msgAtt.message || '').substring(0, 50)}..."`,
                type: 'Message'
            });
        });
        
        countBadge.textContent = `${attachments.length} pièce(s)`;
        grid.innerHTML = '';
        if (!attachments.length) {
          grid.innerHTML = '<div class="col-12 text-muted small">Aucune pièce jointe pour ce rendu.</div>';
          document.querySelector('.small.mb-3').textContent = 'Ce rendu ne contient aucune pièce jointe.';
        } else {
            document.querySelector('.small.mb-3').textContent = 'Pièces jointes enregistrées avec ce rendu et son contexte.';
            attachments.forEach(att => {
                const col = document.createElement('div');
                col.className = 'col-12 col-sm-6 col-lg-4';
                const card = document.createElement('div');
                card.className = 'attachment-card';

                const prev = document.createElement('div');
                prev.className = 'attachment-preview';
                if (att.kind === 'image') {
                prev.innerHTML = `<a href="${att.url}" target="_blank"><img src="${att.url}" alt="${att.nom_fichier}"></a>`;
                } else {
                prev.innerHTML = `<a href="${att.url}" target="_blank" class="text-white d-flex align-items-center justify-content-center h-100"><i class="bi bi-file-earmark-text fs-1"></i></a>`;
                prev.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                }

                const info = document.createElement('div');
                info.className = 'attachment-info';
                info.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="badge bg-primary badge-source">${att.type}</div>
                    </div>
                    <div class="fw-semibold">${att.nom_fichier || 'Fichier'}</div>
                    <div class="attachment-comment">${marked.parse(att.commentaire_image || 'Aucun commentaire')}</div>
                `;
                card.append(prev, info);
                col.append(card);
                grid.append(col);
            });
        }

      } catch (error) {
        console.error('Failed to load rendu details:', error);
        document.querySelector('main').innerHTML = `<div class="alert alert-danger">Impossible de charger le rendu. ${error.message}</div>`;
      }
    });
  </script>
</body>
</html>
