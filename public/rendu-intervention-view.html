<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du rendu d'intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card {
      border: 2px solid #e5e7eb; border-radius: 12px; background: #fff;
      transition: all 0.2s ease; height: 100%;
    }
    .attachment-card:hover { border-color:#3b82f6; box-shadow:0 8px 24px rgba(59,130,246,0.12); }
    .attachment-preview {
      width:100%; height:180px; background:#f3f4f6; display:flex; align-items:center; justify-content:center;
      border-radius: 10px 10px 0 0; overflow:hidden;
    }
    .attachment-preview img { width:100%; height:100%; object-fit:cover; }
    .attachment-info { padding:12px 14px; }
    .attachment-comment { font-size:0.9rem; color:#374151; min-height:48px; }
    .badge-source { font-size:0.7rem; }
  </style>
</head>
<body>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1"><i class="bi bi-file-text me-2"></i>Rendu d'intervention</h1>
        <div class="text-muted small">Intervention <span id="intervention-id">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-success btn-sm" id="download-html-btn"><i class="bi bi-download"></i> Télécharger (HTML)</button>
        <button class="btn btn-outline-primary btn-sm" id="edit-meta-btn"><i class="bi bi-pencil"></i> Modifier</button>
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Imprimer</button>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h6 class="text-uppercase text-muted small mb-2">Valeur</h6>
            <div id="view_valeur" class="fs-5 fw-semibold">—</div>
            <div class="text-muted small">Montant estimé</div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="text-uppercase text-muted small mb-2">Résumé</h6>
            <div id="view_resume" class="small">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes liées</h5>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-primary" id="attachments-count">0 pièce(s)</span>
            <a class="btn btn-outline-primary btn-sm" id="manage-attachments-btn"><i class="bi bi-pencil-square me-1"></i>Modifier</a>
          </div>
        </div>
        <p class="text-muted small mb-3">Images / documents provenant du ticket, du site, de la demande client ou des messages associés.</p>
        <div class="row g-3" id="attachments-grid"></div>
      </div>
    </div>

    <div class="card mb-4 d-none" id="messages-card">
      <div class="card-body">
        <h5 class="mb-2"><i class="bi bi-chat-dots me-2"></i>Messages liés</h5>
        <p class="text-muted small mb-3">Extraits des messages accompagnant les pièces jointes.</p>
        <div class="row g-3" id="messages-grid"></div>
      </div>
    </div>

    <div class="d-flex gap-2 no-print">
      <button class="btn btn-secondary" id="back-to-intervention-btn">Retour à l'intervention</button>
      <a class="btn btn-outline-primary" id="open-rendu-new-btn"><i class="bi bi-plus-circle me-1"></i>Nouveau rendu</a>
    </div>
  </main>

  <!-- Modal édition valeur / résumé -->
  <div class="modal fade" id="editMetaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Modifier la valeur et le résumé</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold" for="edit-valeur-input">Valeur</label>
            <input type="text" class="form-control" id="edit-valeur-input" placeholder="Ex: 1500€">
          </div>
          <div class="row g-3">
              <div class="col-lg-6">
                <label class="form-label fw-semibold" for="edit-resume-input">Résumé (Markdown)</label>
              <textarea class="form-control" id="edit-resume-input" rows="8" placeholder="Saisissez le résumé en Markdown..."></textarea>
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-semibold">Aperçu</label>
              <div id="edit-resume-preview" class="border rounded p-3 bg-light" style="min-height: 200px;">
                <em class="text-muted">Le résumé apparaîtra ici...</em>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="save-meta-btn"><i class="bi bi-check-lg"></i> Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Session expirée. Veuillez vous reconnecter.');
        return location.href = '/login.html';
      }
      const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

      const params = new URLSearchParams(location.search);
      const renduId = params.get('id');

      if (!renduId) {
        alert('ID du rendu manquant.');
        return location.href = '/interventions.html';
      }

      const grid = document.getElementById('attachments-grid');
      const countBadge = document.getElementById('attachments-count');
      const resumeEl = document.getElementById('view_resume');
      const valeurEl = document.getElementById('view_valeur');
      const interEl = document.getElementById('intervention-id');
      const backInterBtn = document.getElementById('back-to-intervention-btn');
      const newRenduBtn = document.getElementById('open-rendu-new-btn');
      const backBtn = document.getElementById('back-btn');
      const editBtn = document.getElementById('edit-meta-btn');
      const manageAttachmentsBtn = document.getElementById('manage-attachments-btn');
      const messagesCard = document.getElementById('messages-card');
      const messagesGrid = document.getElementById('messages-grid');
      const editModalEl = document.getElementById('editMetaModal');
      const editModal = new bootstrap.Modal(editModalEl);
      const editValeurInput = document.getElementById('edit-valeur-input');
      const editResumeInput = document.getElementById('edit-resume-input');
      const editResumePreview = document.getElementById('edit-resume-preview');
      const downloadBtn = document.getElementById('download-html-btn');
      let editResumeEditor = null;
      let currentRendu = null;
      let saving = false;
      let attachments = [];
      let messages = [];
      let printTemplate = null;

      const fetchJSON = async (url) => {
        const response = await fetch(url, { headers });
        if (!response.ok) {
          const error = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
          throw new Error(error.message || 'Erreur de chargement');
        }
        return response.json();
      };

      const escapeHtml = (str = '') => String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');

      const buildAndDownloadHtml = async () => {
        if (!currentRendu) return alert('Rendu non chargé.');
        try {
          if (!printTemplate) {
            const resp = await fetch('/partials/rendu-print.html');
            if (!resp.ok) throw new Error('Impossible de charger le modèle HTML.');
            printTemplate = await resp.text();
          }

          const parser = new DOMParser();
          const doc = parser.parseFromString(printTemplate, 'text/html');
          const titre = currentRendu.titre || `Rendu intervention #${currentRendu.intervention_id || renduId}`;
          doc.getElementById('p-title')?.textContent = titre;
          doc.getElementById('p-meta')?.textContent = `Intervention #${currentRendu.intervention_id || '-'} • Rendu #${currentRendu.id || renduId}`;
          doc.getElementById('p-valeur')?.textContent = `Valeur : ${currentRendu.valeur || 'Non spécifiée'}`;
          const resumeHtml = currentRendu.resume ? marked.parse(currentRendu.resume) : '<em>Aucun résumé.</em>';
          const resumeBody = doc.getElementById('p-resume-body');
          if (resumeBody) resumeBody.innerHTML = resumeHtml;

          const attContainer = doc.getElementById('p-attachments');
          if (attContainer) {
            if (!attachments.length) {
              attContainer.innerHTML = '<div class="meta">Aucune pièce jointe.</div>';
            } else {
              attContainer.innerHTML = attachments.map(att => {
                const comment = escapeHtml(att.commentaire_image || 'Aucun commentaire');
                const noteHtml = att.note ? marked.parse(att.note) : '';
                const preview = att.kind === 'image'
                  ? `<div style="margin:6px 0;"><img src="${att.url}" alt="${escapeHtml(att.nom_fichier || '')}" style="width:100%;border-radius:6px;"></div>`
                  : '';
                return `
                  <div class="attachment">
                    <h4>${escapeHtml(att.nom_fichier || 'Fichier')}</h4>
                    <div class="meta">${escapeHtml(att.type || 'Pièce jointe')}</div>
                    ${preview}
                    <div class="comment">${comment}</div>
                    ${noteHtml ? `<div class="comment">${noteHtml}</div>` : ''}
                    <div class="meta"><a href="${att.url}" target="_blank" rel="noopener">Ouvrir</a></div>
                  </div>
                `;
              }).join('');
            }
          }

          const blob = new Blob([doc.documentElement.outerHTML], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `rendu-${currentRendu.id || renduId}.html`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          alert(`Impossible de préparer le téléchargement : ${err.message}`);
        }
      };

      try {
        const { rendu, images, documents, message_attachments } = await fetchJSON(`/api/rendus/${renduId}`);
        currentRendu = rendu;
        attachments = [];
        messages = [];

        // Populate header and nav buttons
        interEl.textContent = rendu.intervention_id;
        backInterBtn.onclick = () => location.href = `intervention-view.html?id=${rendu.intervention_id}`;
        newRenduBtn.href = `rendu-intervention-new.html?id=${rendu.intervention_id}`;
        backBtn.onclick = () => location.href = `intervention-view.html?id=${rendu.intervention_id}`;
        if (manageAttachmentsBtn) manageAttachmentsBtn.href = `rendu-intervention-edit.html?id=${renduId}#attachments`;


        // Populate summary cards
        const updateDisplay = (valeur, resume) => {
          valeurEl.textContent = valeur || 'Non spécifiée';
          resumeEl.innerHTML = resume ? marked.parse(resume) : '<span class="text-muted">Aucun résumé.</span>';
        };
        updateDisplay(rendu.valeur, rendu.resume);

        const updatePreview = () => {
          const text = editResumeEditor ? editResumeEditor.value() : (editResumeInput.value || '');
          editResumePreview.innerHTML = text ? marked.parse(text) : '<em class="text-muted">Le résumé apparaîtra ici...</em>';
        };

        editBtn.addEventListener('click', () => {
          if (!currentRendu) return;
          if (!editResumeEditor) {
            editResumeEditor = new EasyMDE({
              element: editResumeInput,
              spellChecker: false,
              forceSync: true,
              status: false,
              minHeight: "220px",
              toolbar: ["bold","italic","heading","|","quote","unordered-list","ordered-list","|","link","table","code","preview"]
            });
            editResumeEditor.codemirror.on('change', updatePreview);
          }
          editValeurInput.value = currentRendu.valeur || '';
          editResumeEditor.value(currentRendu.resume || '');
          updatePreview();
          editModal.show();
        });

        document.getElementById('save-meta-btn').addEventListener('click', async () => {
          if (saving) return;
          saving = true;
          const payload = {
            valeur: editValeurInput.value.trim(),
            resume: editResumeEditor ? editResumeEditor.value() : (editResumeInput.value || '')
          };
          try {
            const resp = await fetch(`/api/rendus/${renduId}`, {
              method: 'PATCH',
              headers,
              body: JSON.stringify(payload)
            });
            if (!resp.ok) {
              const body = await resp.json().catch(() => null);
              throw new Error(body?.error || body?.message || `HTTP ${resp.status}`);
            }
            const data = await resp.json().catch(() => payload);
            currentRendu = data.rendu || { ...currentRendu, ...payload };
            updateDisplay(currentRendu.valeur, currentRendu.resume);
            editModal.hide();
          } catch (err) {
            alert(`Erreur lors de la mise à jour : ${err.message}`);
          } finally {
            saving = false;
          }
        });

        // Process and render attachments
        (images || []).forEach(img => {
            attachments.push({
                kind: 'image',
                url: `/api/images/${img.id}/view`,
                nom_fichier: img.nom_fichier,
                commentaire_image: img.commentaire_image,
                type: 'Image',
                note: img.note || ''
            });
        });

        (documents || []).forEach(doc => {
            attachments.push({
                kind: 'doc',
                url: `/api/documents/${doc.id}/view`,
                nom_fichier: doc.nom_fichier,
                commentaire_image: doc.nature || 'Document',
                type: 'Document',
                note: doc.note || ''
            });
        });

        (message_attachments || []).forEach(msgAtt => {
            const kind = (msgAtt.file_type && msgAtt.file_type.startsWith('image/')) ? 'image' : 'doc';
            attachments.push({
                kind: kind,
                url: `/api/attachments/${msgAtt.id}/view`,
                nom_fichier: msgAtt.file_name,
                commentaire_image: `Pièce jointe du message: "${(msgAtt.message || '').substring(0, 50)}..."`,
                type: 'Message',
                note: msgAtt.note || msgAtt.message || ''
            });
            if (msgAtt.message) {
              messages.push({
                message: msgAtt.message,
                created_at: msgAtt.created_at || msgAtt.date || null,
                fichier: msgAtt.file_name
              });
            }
        });
        
        countBadge.textContent = `${attachments.length} pièce(s)`;
        grid.innerHTML = '';
        if (!attachments.length) {
          grid.innerHTML = '<div class="col-12 text-muted small">Aucune pièce jointe pour ce rendu.</div>';
          document.querySelector('.small.mb-3').textContent = 'Ce rendu ne contient aucune pièce jointe.';
        } else {
            document.querySelector('.small.mb-3').textContent = 'Pièces jointes enregistrées avec ce rendu et son contexte.';
            attachments.forEach(att => {
                const col = document.createElement('div');
                col.className = 'col-12 col-sm-6 col-lg-4';
                const card = document.createElement('div');
                card.className = 'attachment-card';

                const prev = document.createElement('div');
                prev.className = 'attachment-preview';
                if (att.kind === 'image') {
                prev.innerHTML = `<a href="${att.url}" target="_blank"><img src="${att.url}" alt="${att.nom_fichier}"></a>`;
                } else {
                prev.innerHTML = `<a href="${att.url}" target="_blank" class="text-white d-flex align-items-center justify-content-center h-100"><i class="bi bi-file-earmark-text fs-1"></i></a>`;
                prev.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
                }

                const info = document.createElement('div');
                info.className = 'attachment-info';
                info.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="badge bg-primary badge-source">${att.type}</div>
                    </div>
                    <div class="fw-semibold">${att.nom_fichier || 'Fichier'}</div>
                    <div class="attachment-comment">${marked.parse(att.commentaire_image || 'Aucun commentaire')}</div>
                    ${att.note ? `<div class="mt-2 small text-muted">Résumé : ${marked.parse(att.note)}</div>` : ''}
                `;
                card.append(prev, info);
                col.append(card);
                grid.append(col);
            });
        }

      } catch (error) {
        console.error('Failed to load rendu details:', error);
        document.querySelector('main').innerHTML = `<div class="alert alert-danger">Impossible de charger le rendu. ${error.message}</div>`;
      }

      // Afficher les messages liés (si présents)
      if (messages.length && messagesCard && messagesGrid) {
        messagesCard.classList.remove('d-none');
        messagesGrid.innerHTML = messages.map(m => {
          const dateTxt = m.created_at ? new Date(m.created_at).toLocaleString() : '';
          return `
            <div class="col-12 col-md-6 col-lg-4">
              <div class="border rounded p-3 h-100 bg-light">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge bg-secondary">Message</span>
                  ${dateTxt ? `<small class="text-muted">${dateTxt}</small>` : ''}
                </div>
                <div class="fw-semibold mb-1">${m.fichier || 'Pièce jointe'}</div>
                <div class="small text-muted">${m.message.replace(/\n/g,'<br>')}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      if (downloadBtn) downloadBtn.addEventListener('click', buildAndDownloadHtml);
    });
  </script>
</body>
</html>
