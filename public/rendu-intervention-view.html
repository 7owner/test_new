<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du rendu d'intervention</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .attachment-card {
      border: 2px solid #e5e7eb; border-radius: 12px; background: #fff;
      transition: all 0.2s ease; height: 100%;
    }
    .attachment-card:hover { border-color:#3b82f6; box-shadow:0 8px 24px rgba(59,130,246,0.12); }
    .attachment-preview {
      width:100%; height:180px; background:#f3f4f6; display:flex; align-items:center; justify-content:center;
      border-radius: 10px 10px 0 0; overflow:hidden;
    }
    .attachment-preview img { width:100%; height:100%; object-fit:cover; }
    .attachment-info { padding:12px 14px; }
    .attachment-comment { font-size:0.9rem; color:#374151; min-height:48px; }
    .badge-source { font-size:0.7rem; }
  </style>
</head>
<body>
  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1"><i class="bi bi-file-text me-2"></i>Rendu d'intervention</h1>
        <div class="text-muted small">Intervention <span id="intervention-id">-</span></div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Imprimer</button>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h6 class="text-uppercase text-muted small mb-2">Valeur</h6>
            <div id="view_valeur" class="fs-5 fw-semibold">—</div>
            <div class="text-muted small">Montant estimé</div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="text-uppercase text-muted small mb-2">Résumé</h6>
            <div id="view_resume" class="small">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Pièces jointes liées</h5>
          <span class="badge bg-primary" id="attachments-count">0 pièce(s)</span>
        </div>
        <p class="text-muted small mb-3">Images / documents provenant du ticket, du site, de la demande client ou des messages associés.</p>
        <div class="row g-3" id="attachments-grid"></div>
      </div>
    </div>

    <div class="d-flex gap-2 no-print">
      <button class="btn btn-secondary" id="back-to-intervention-btn">Retour à l'intervention</button>
      <a class="btn btn-outline-primary" id="open-rendu-new-btn"><i class="bi bi-plus-circle me-1"></i>Nouveau rendu</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      if (!token) { alert('Session expirée'); return location.href='/login.html'; }

      const params = new URLSearchParams(location.search);
      const interventionId = params.get('intervention_id') || params.get('id');
      if (!interventionId) { alert('Intervention manquante'); return; }

      const grid = document.getElementById('attachments-grid');
      const countBadge = document.getElementById('attachments-count');
      const resumeEl = document.getElementById('view_resume');
      const valeurEl = document.getElementById('view_valeur');
      const interEl = document.getElementById('intervention-id');
      const backInterBtn = document.getElementById('back-to-intervention-btn');
      const newRenduBtn = document.getElementById('open-rendu-new-btn');

      interEl.textContent = interventionId;
      backInterBtn.onclick = () => location.href = `intervention-view.html?id=${interventionId}`;
      newRenduBtn.href = `rendu-intervention-new.html?id=${interventionId}`;

      const fetchJSON = async (url) => {
        const r = await fetch(url, { headers:{ 'Authorization': 'Bearer '+token }, credentials:'same-origin' });
        if (!r.ok) return null;
        return r.json();
      };
      const fetchBlobURL = async (url) => {
        try {
          const r = await fetch(url, { headers:{ 'Authorization':'Bearer '+token }, credentials:'same-origin' });
          if (!r.ok) return null;
          const b = await r.blob();
          return URL.createObjectURL(b);
        } catch { return null; }
      };

      let attachments = [];

      const renderGrid = () => {
        grid.innerHTML = '';
        if (!attachments.length) {
          grid.innerHTML = '<div class="col-12 text-muted small">Aucune pièce jointe trouvée.</div>';
        } else {
          attachments.forEach(att => {
            const col = document.createElement('div');
            col.className = 'col-12 col-sm-6 col-lg-4';
            const card = document.createElement('div');
            card.className = 'attachment-card';

            const prev = document.createElement('div');
            prev.className = 'attachment-preview';
            if (att.kind === 'image') {
              prev.innerHTML = `<img src="${att.url||att.previewUrl||''}" alt="${att.nom_fichier}">`;
            } else {
              prev.innerHTML = '<i class="bi bi-file-earmark-text fs-1 text-primary"></i>';
              prev.style.background = 'linear-gradient(135deg,#667eea,#764ba2)';
              prev.style.color = '#fff';
            }

            const info = document.createElement('div');
            info.className = 'attachment-info';
            info.innerHTML = `
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="badge bg-secondary badge-source">${att.type||'—'}</div>
                ${att.cible_id ? `<span class="badge bg-light text-dark">#${att.cible_id}</span>`:''}
              </div>
              <div class="fw-semibold">${att.nom_fichier||'Fichier'}</div>
              <div class="attachment-comment">${att.commentaire_image||'Aucun commentaire'}</div>
            `;
            card.append(prev, info); col.append(card); grid.append(col);
          });
        }
        countBadge.textContent = `${attachments.length} pièce(s)`;
      };

      const loadItems = async (type, id, endpoint) => {
        if (!id) return;
        const data = await fetchJSON(`/api/${endpoint}?cible_type=${encodeURIComponent(type)}&cible_id=${id}`);
        if (Array.isArray(data)) {
          for (const item of data) {
            let url = `/api/${endpoint}/${item.id}/view`;
            if (endpoint === 'images') {
              url = await fetchBlobURL(url) || url;
            }
            attachments.push({
              id: item.id,
              type,
              cible_id: id,
              nom_fichier: item.nom_fichier,
              commentaire_image: item.commentaire_image || item.commentaire || '',
              note: item.note || '',
              url,
              kind: endpoint === 'images' ? 'image' : 'doc'
            });
          }
        }
      };

      const loadConversationAttachments = async (demandeId) => {
        if (!demandeId) return;
        const msgs = await fetchJSON(`/api/conversations/demande-${demandeId}`);
        if (!Array.isArray(msgs)) return;
        msgs.forEach(m => {
          if (!Array.isArray(m.attachments)) return;
          m.attachments.forEach(att => {
            const path = String(att.file_path||'');
            const url = path ? '/' + path.replace(/^public\//,'') : '';
            const name = att.file_name || path.split('/').pop() || 'Pièce jointe';
            const mime = att.type_mime || '';
            const lower = name.toLowerCase();
            const kind = (mime && mime.startsWith('image/')) || /\.(png|jpe?g|gif|webp)$/i.test(lower) ? 'image' : 'doc';
            attachments.push({
              id: att.id || `conv-${demandeId}-${name}`,
              type: 'Message',
              cible_id: demandeId,
              nom_fichier: name,
              commentaire_image: att.commentaire || m.message || '',
              note: '',
              url,
              kind,
            });
          });
        });
      };

      try {
        // Essayer de récupérer les infos de l'intervention (valeur/resume si dispo)
        const inter = await fetchJSON(`/api/interventions/${interventionId}`).catch(()=>null);
        if (inter) {
          valeurEl.textContent = inter.valeur || inter.budget || '—';
          resumeEl.innerHTML = inter.resume ? marked.parse(inter.resume) : '<span class="text-muted">Aucun résumé</span>';
        }

        // Relations
        const rel = await fetchJSON(`/api/interventions/${interventionId}/relations`);
        let ticketId = rel?.ticket?.id || rel?.ticket?.ticket_id || null;
        let siteId = rel?.ticket?.site_id || rel?.site?.id || rel?.site?.site_id || null;
        let demandeId = rel?.ticket?.demande_id || rel?.demande?.id || rel?.demande?.demande_id || params.get('demande_id');

        if ((!demandeId || !siteId) && ticketId) {
          const ticketData = await fetchJSON(`/api/tickets/${ticketId}`).catch(()=>null);
          if (ticketData?.demande_id && !demandeId) demandeId = ticketData.demande_id;
          if (ticketData?.site_id && !siteId) siteId = ticketData.site_id;
        }

        await loadItems('Ticket', ticketId, 'images');
        await loadItems('Ticket', ticketId, 'documents');
        await loadItems('Site', siteId, 'images');
        await loadItems('Site', siteId, 'documents');
        await loadItems('DemandeClient', demandeId, 'images');
        await loadItems('DemandeClient', demandeId, 'documents');
        await loadItems('Intervention', interventionId, 'images');
        await loadItems('Intervention', interventionId, 'documents');
        await loadConversationAttachments(demandeId);
      } catch (e) {
        console.error(e);
        resumeEl.innerHTML = '<span class="text-danger">Erreur de chargement</span>';
      }

      if (!attachments.length) {
        attachments.push({
          id: 'ex1', type:'Exemple', nom_fichier:'Aucune pièce jointe',
          commentaire_image:'Ajoutez des pièces pour les voir ici.', kind:'doc', url:''
        });
      }
      renderGrid();
    });
  </script>
</body>
</html>
