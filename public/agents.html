<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Agents</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script type="module" src="/nav.js"></script>
  <style>
    .dashboard-bg { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); min-height: 100vh; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>

  <!-- ====================== CONTENU PRINCIPAL ====================== -->
  <main class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="mb-0">Agents</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" id="toggle-filters-btn"><i class="bi bi-funnel-fill me-1"></i> Masquer les filtres</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal"><i class="bi bi-person-plus me-2"></i>Créer un nouvel agent</button>
      </div>
    </div>

    <div class="card p-3 mb-4" id="filters-row">
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
          <h5 class="mb-0">Filtres</h5>
        </div>
        <div class="row g-2">
            <div class="col-lg-6 col-md-12">
                <input type="text" class="form-control" id="agent-search" placeholder="Rechercher par nom, matricule ou email...">
            </div>
            <div class="col-lg-3 col-md-6">
                <select class="form-select" id="agent-status-filter">
                    <option value="">Tous les statuts</option>
                    <option value="actif">Actif</option>
                    <option value="inactif">Inactif</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6">
                <select class="form-select" id="agent-admin-filter">
                    <option value="">Tous les rôles</option>
                    <option value="admin">Admin</option>
                    <option value="non-admin">Non-Admin</option>
                </select>
            </div>
        </div>
    </div>

    <div id="agents-cards" class="row g-3"></div>
  </main>

  <div class="modal fade" id="createAgentModal" tabindex="-1" aria-labelledby="createAgentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createAgentModalLabel">Créer un nouvel agent</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/agent-new.html" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewAgentModal" tabindex="-1" aria-labelledby="viewAgentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewAgentModalLabel">Voir Agent</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="viewAgentFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editAgentModal" tabindex="-1" aria-labelledby="editAgentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editAgentModalLabel">Modifier Agent</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="editAgentFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="tokenAgentModal" tabindex="-1" aria-labelledby="tokenAgentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tokenAgentModalLabel">Générer un jeton</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="tokenAgentFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- ====================== SCRIPTS ====================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const cardsContainer = document.getElementById('agents-cards');
    const searchInput = document.getElementById('agent-search');
    const statusFilter = document.getElementById('agent-status-filter');
    const adminFilter = document.getElementById('agent-admin-filter');
    const filtersRow = document.getElementById('filters-row');
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');

    let allAgents = [];
    let currentUserIsAdmin = false;
    try {
        const token = localStorage.getItem('token');
        const payload = token ? JSON.parse(atob(token.split('.')[1])) : {};
        currentUserIsAdmin = Array.isArray(payload.roles) && payload.roles.includes('ROLE_ADMIN');
    } catch(e) {
        console.error("Failed to parse token:", e);
    }


    async function fetchAgents() {
      try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const res = await fetch('/api/agents', { headers, credentials: 'same-origin' });
        const data = res.ok ? await res.json() : [];
        allAgents = (Array.isArray(data) ? data : []).map(a => ({
          matricule: a.matricule,
          nom: a.nom,
          prenom: a.prenom,
          email: a.email,
          tel: a.tel || '',
          actif: a.actif !== false,
          admin: a.admin === true
        }));
        renderAgents(allAgents);
      } catch (e) {
        console.error('Erreur chargement /api/agents:', e);
      }
    }

    function renderAgents(list) {
      cardsContainer.innerHTML = '';
      if (!list.length) {
        cardsContainer.innerHTML = '<div class="col-12 text-center text-muted">Aucun agent trouvé.</div>';
        return;
      }
      list.forEach(agent => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-lg-4';
        col.innerHTML = `
          <div class="card h-100 agent-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <h5 class="card-title mb-1">${agent.nom || ''} ${agent.prenom || ''}</h5>
                <span class="badge ${agent.actif ? 'bg-success' : 'bg-danger'}">${agent.actif ? 'Actif' : 'Inactif'}</span>
              </div>
              <h6 class="card-subtitle text-muted mb-2">Matricule: ${agent.matricule}</h6>
              <div class="small text-break"><i class="bi bi-envelope me-1"></i>${agent.email || '-'}</div>
              <div class="small mb-2"><i class="bi bi-telephone me-1"></i>${agent.tel || '-'}</div>
              <div class="mb-2">
                <span class="badge ${agent.admin ? 'bg-primary' : 'bg-secondary'}">${agent.admin ? 'Admin' : 'Utilisateur'}</span>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewAgentModal" data-id="${agent.matricule}"><i class="bi bi-eye me-1"></i>Voir</button>
                ${currentUserIsAdmin ? `
                  <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editAgentModal" data-id="${agent.matricule}"><i class="bi bi-pencil me-1"></i>Modifier</button>
                <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${agent.matricule}">
                    <i class="bi bi-trash me-1"></i>Supprimer
                  </button>
                  <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#tokenAgentModal" data-id="${agent.matricule}">
                    <i class="bi bi-key me-1"></i>Générer Jeton
                  </button>
                ` : ''}
              </div>
            </div>
          </div>`;
        cardsContainer.appendChild(col);
      });
    }

    function applyFilters() {
      const term = searchInput.value.toLowerCase();
      const status = statusFilter.value;
      const adminRole = adminFilter.value;

      const filtered = allAgents.filter(a => {
        const matchesTerm = (a.nom || '').toLowerCase().includes(term) ||
                            (a.matricule || '').toLowerCase().includes(term) ||
                            (a.email || '').toLowerCase().includes(term);
        const matchesStatus = !status || (status === 'actif' ? a.actif : !a.actif);
        const matchesAdmin = !adminRole || (adminRole === 'admin' ? a.admin : !a.admin);
        return matchesTerm && matchesStatus && matchesAdmin;
      });
      renderAgents(filtered);
    }

    if (toggleFiltersBtn && filtersRow) {
        toggleFiltersBtn.innerHTML = '<i class="bi bi-funnel-fill me-1"></i> Masquer les filtres';
        toggleFiltersBtn.addEventListener('click', () => {
            const hidden = filtersRow.classList.toggle('d-none');
            toggleFiltersBtn.innerHTML = hidden
            ? '<i class="bi bi-eye me-1"></i> Afficher les filtres'
            : '<i class="bi bi-funnel-fill me-1"></i> Masquer les filtres';
        });
    }

    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    adminFilter.addEventListener('change', applyFilters);

    await fetchAgents();

    const createAgentModal = document.getElementById('createAgentModal');
    const viewAgentModal = document.getElementById('viewAgentModal');
    const editAgentModal = document.getElementById('editAgentModal');
    const viewAgentFrame = document.getElementById('viewAgentFrame');
    const editAgentFrame = document.getElementById('editAgentFrame');
    const tokenAgentModal = document.getElementById('tokenAgentModal');
    const tokenAgentFrame = document.getElementById('tokenAgentFrame');

    if (createAgentModal) {
      createAgentModal.addEventListener('show.bs.modal', function () {
        const frame = createAgentModal.querySelector('iframe');
        if (frame) frame.src = '/agent-new.html';
      });
      createAgentModal.addEventListener('hidden.bs.modal', function() {
        fetchAgents(); // Re-fetch agents when create modal is closed
      });
    }

    if (viewAgentModal) {
      viewAgentModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const agentMatricule = button.getAttribute('data-id');
        viewAgentFrame.src = `/agent-view.html?matricule=${agentMatricule}`;
      });
    }

    if (editAgentModal) {
      editAgentModal.addEventListener('hidden.bs.modal', function() {
        fetchAgents(); // Re-fetch agents when edit modal is closed
      });
      editAgentModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const agentMatricule = button.getAttribute('data-id');
        editAgentFrame.src = `/agent-edit.html?matricule=${agentMatricule}`;
      });
    }

    if (tokenAgentModal) {
      tokenAgentModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const agentMatricule = button.getAttribute('data-id');
        tokenAgentFrame.src = `/agent-token-new.html?matricule=${agentMatricule}`;
      });
      tokenAgentModal.addEventListener('hidden.bs.modal', fetchAgents);
    }
  });
  </script>

  <script>
  // ======== Suppression agent ========
  document.addEventListener('DOMContentLoaded', () => {
    document.body.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action="delete"]');
      if (!btn) return;

      const matricule = btn.getAttribute('data-id');
      if (!matricule) return alert('Matricule non trouvé.');

      const confirmDelete = confirm(`Voulez-vous vraiment supprimer l'agent ${matricule} ?`);
      if (!confirmDelete) return;

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/agents/${matricule}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
          credentials: 'same-origin'
        });

        const result = await response.json();

        if (response.ok) {
          alert(`✅ ${result.message}`);
          btn.closest('.agent-card')?.remove();
        } else {
          alert(`❌ ${result.error || 'Erreur lors de la suppression'}`);
        }
      } catch (err) {
        console.error('Erreur de communication avec le serveur:', err);
        alert('❌ Impossible de contacter le serveur.');
      }
    });
  });
  </script>

</body>
</html>
