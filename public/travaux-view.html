<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/custom.css?v=1">
  <script src="/nav.js?v=3"></script>
  <style>
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 1.5rem;
    }
    .embed #navbar-placeholder { display:none !important; }
    .main-card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      margin-bottom: 1.5rem;
      background: white;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .main-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }
    .card-header-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      border: none;
    }
    .info-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:1rem; }
    .info-box {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius:12px;
      padding:1rem;
      border:none;
      min-height:76px;
      border-left:4px solid #667eea;
    }
    .info-box label { font-size:.8rem; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:.4px; }
    .info-box .value { font-weight:700; color:#111827; margin-top:.2rem; }
    .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .75rem; border-radius:999px; background:#eef2ff; color:#312e81; font-weight:600; margin-right:.35rem; margin-bottom:.35rem; border:1px solid #c7d2fe; }
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      color: white;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <main class="container-fluid" style="max-width: 1400px;">
    <div class="card main-card mb-3">
      <div class="card-header card-header-gradient d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <h4 class="mb-0 d-flex align-items-center">
            <i class="bi bi-tools me-2"></i>
            <span id="work-title">Travail</span>
          </h4>
          <div class="small opacity-75" id="work-sub">—</div>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <div class="d-flex flex-wrap gap-2" id="header-actions-bar">
            <button class="btn btn-light btn-sm" id="header-add-resp"><i class="bi bi-person-plus me-1"></i>Responsable</button>
            <button class="btn btn-light btn-sm" id="header-add-agent"><i class="bi bi-people me-1"></i>Agent</button>
            <button class="btn btn-light btn-sm" id="header-create-affaire"><i class="bi bi-briefcase me-1"></i>Affaire</button>
            <button class="btn btn-light btn-sm" id="header-create-doe"><i class="bi bi-diagram-3 me-1"></i>DOE</button>
          </div>
          <div class="d-flex align-items-center gap-1">
            <select id="work-etat-select" class="form-select form-select-sm" style="min-width:140px;">
              <option value="A_faire">À faire</option>
              <option value="En_cours">En cours</option>
              <option value="En_attente">En attente</option>
              <option value="Termine">Terminé</option>
              <option value="Annule">Annulé</option>
            </select>
            <button class="btn btn-light btn-sm" id="work-etat-save" title="Enregistrer le statut"><i class="bi bi-save"></i></button>
          </div>
          <span class="badge bg-light text-dark" id="work-prio">-</span>
        </div>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
          <div class="d-flex gap-2">
           <!-- <a href="travaux.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Retour</a>-->
            <a id="edit-travail-btn" href="#" class="btn btn-primary btn-sm"><i class="bi bi-pencil-square me-1"></i>Modifier</a>
          </div>
          <div id="team-inline" class="d-flex flex-wrap"></div>
        </div>

        <div class="info-grid mb-3">
          <div class="info-box">
            <label>État</label>
            <div class="value" id="info-etat">-</div>
          </div>
          <div class="info-box">
            <label>Temps écoulé</label>
            <div class="value" id="info-elapsed">-</div>
          </div>
          <div class="info-box">
            <label>Début</label>
            <div class="value" id="info-debut">-</div>
          </div>
          <div class="info-box">
            <label>Fin</label>
            <div class="value" id="info-fin">-</div>
          </div>
          <div class="info-box">
            <label>Site</label>
            <div class="value" id="info-site">-</div>
          </div>
          <div class="info-box">
            <label>Affaire</label>
            <div class="value" id="info-affaire">-</div>
          </div>
          <div class="info-box">
            <label>DOE</label>
            <div class="value" id="info-doe">-</div>
          </div>
          <div class="info-box">
            <label>Avancement</label>
            <div class="value" id="info-progress">0%</div>
          </div>
          <div class="info-box">
            <label>Reste à faire</label>
            <div class="value" id="info-remaining">—</div>
          </div>
        </div>

        <div class="mb-3">
          <div class="fw-bold text-muted"><i class="bi bi-text-paragraph me-1"></i>Description :</div>
          <div class="p-3 bg-light rounded border" id="work-desc-block">—</div>
        </div>

        <div class="row g-3 mb-2">
          <div class="col-lg-6">
            <div class="info-box h-100">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="mb-0">Responsables</label>
              </div>
              <div id="responsables-inline" class="d-flex flex-wrap gap-2 text-muted small">Aucun responsable</div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="info-box h-100">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="mb-0">Agents assignés</label>
              </div>
              <div id="agents-inline" class="d-flex flex-wrap gap-2 text-muted small">Aucun agent</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-check me-1"></i>Tâches / Checklists</span>
            <button class="btn btn-sm btn-primary" id="add-task-btn"><i class="bi bi-plus-lg"></i> Ajouter</button>
          </div>
          <div class="card-body" id="tasks-list">
            <div class="text-muted">Chargement...</div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-journal-text me-1"></i>Rendus</span>
            <button class="btn btn-sm btn-outline-primary" id="add-rendu-btn">Nouveau rendu</button>
          </div>
          <div class="card-body" id="rendu-list">
            <div class="text-muted">Chargement...</div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Modale ajout responsable -->
  <div class="modal fade" id="addResponsableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Ajouter un responsable</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addResponsableForm">
            <div class="mb-3">
              <label for="responsable-search-input" class="form-label fw-bold">Rechercher un responsable (matricule)</label>
              <input type="text" id="responsable-search-input" class="form-control" placeholder="Ex: AGT001" autocomplete="off">
              <input type="hidden" id="responsable-mat">
              <div id="responsable-suggestions" class="list-group mt-1" style="max-height:200px;overflow:auto;"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-gradient" id="save-responsable-btn">
            <i class="bi bi-check-circle me-1"></i>Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale ajout agent -->
  <div class="modal fade" id="addAgentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Ajouter un agent</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addAgentForm">
            <div class="mb-3">
              <label for="agent-search-input" class="form-label fw-bold">Rechercher un agent</label>
              <input type="text" id="agent-search-input" class="form-control" placeholder="Nom, matricule..." autocomplete="off">
              <input type="hidden" id="agent-mat">
              <div id="agent-suggestions" class="list-group mt-1" style="max-height:200px;overflow:auto;"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-gradient" id="save-agent-btn">
            <i class="bi bi-check-circle me-1"></i>Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale création affaire -->
  <div class="modal fade" id="createAffaireModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-briefcase me-2"></i>Nouvelle affaire</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="create-affaire-form">
            <div class="mb-3">
              <label for="affaire-nom" class="form-label fw-bold">Nom de l'affaire</label>
              <input type="text" id="affaire-nom" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="affaire-numero" class="form-label fw-bold">Numéro (optionnel)</label>
              <input type="text" id="affaire-numero" class="form-control">
            </div>
            <div class="mb-3">
              <label for="affaire-description" class="form-label fw-bold">Description</label>
              <textarea id="affaire-description" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-check-circle me-2"></i>Créer et lier
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale création DOE -->
  <div class="modal fade" id="createDoeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title"><i class="bi bi-diagram-3 me-2"></i>Nouveau DOE</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="create-doe-form">
            <div class="mb-3">
              <label for="doe-titre" class="form-label fw-bold">Titre</label>
              <input type="text" id="doe-titre" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="doe-description" class="form-label fw-bold">Description</label>
              <textarea id="doe-description" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-info w-100">
              <i class="bi bi-check-circle me-2"></i>Créer et lier
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ajout tâche -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nouvelle tâche</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="task-form" class="row g-2">
            <div class="col-12">
              <label class="form-label">Titre *</label>
              <input type="text" class="form-control" id="task-titre" required>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="task-desc" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">État</label>
              <select class="form-select" id="task-etat">
                <option value="A_faire">À faire</option>
                <option value="En_cours">En cours</option>
                <option value="En_attente">En attente</option>
                <option value="Termine">Terminé</option>
                <option value="Annule">Annulé</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Priorité</label>
              <select class="form-select" id="task-priorite">
                <option value="Haute">Haute</option>
                <option value="Moyenne" selected>Moyenne</option>
                <option value="Basse">Basse</option>
              </select>
            </div>
            <div class="col-md-12">
              <label class="form-label">Échéance</label>
              <input type="datetime-local" class="form-control" id="task-ech">
            </div>
          </form>
          <div id="task-feedback" class="small mt-2 text-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="task-save-btn"><i class="bi bi-save me-1"></i>Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal lien (affaire/site/DOE/demande) -->
  <div class="modal fade" id="linkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Détails</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="linkFrame" src="about:blank" style="width:100%;height:80vh;border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const qp = new URLSearchParams(location.search);
      const isEmbed = window.self !== window.top || qp.get('embed') === '1';
      if (isEmbed) document.body.classList.add('embed');

      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) { alert('Travail introuvable'); return; }
      const token = localStorage.getItem('token');
      if (!token) { location.href = '/login.html'; return; }
      const headers = { 'Authorization': `Bearer ${token}` };
      let isAdmin = false;
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        isAdmin = Array.isArray(payload?.roles) && payload.roles.includes('ROLE_ADMIN');
      } catch (_) {}
      const fmt = (d) => d ? new Date(d).toLocaleString('fr-FR') : '—';

      const set = (id,val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      const setHTML = (id,val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };
      const renduList = document.getElementById('rendu-list');
      const factList = document.getElementById('fact-list');
      const matList = document.getElementById('mat-list');
      const taskList = document.getElementById('tasks-list');
      const taskModalEl = document.getElementById('taskModal');
      const taskModal = taskModalEl ? new bootstrap.Modal(taskModalEl) : null;
      const teamInline = document.getElementById('team-inline');
      const headerActionsBar = document.getElementById('header-actions-bar');
      const btnResp = document.getElementById('header-add-resp');
      const btnAgent = document.getElementById('header-add-agent');
      const btnAffaire = document.getElementById('header-create-affaire');
      const btnDoe = document.getElementById('header-create-doe');
      const etatSelect = document.getElementById('work-etat-select');
      const etatSave = document.getElementById('work-etat-save');
      let currentTravail = null;
      const editBtn = document.getElementById('edit-travail-btn');
      const addRespModal = document.getElementById('addResponsableModal') ? new bootstrap.Modal(document.getElementById('addResponsableModal')) : null;
      const addAgentModal = document.getElementById('addAgentModal') ? new bootstrap.Modal(document.getElementById('addAgentModal')) : null;
      const createAffaireModal = document.getElementById('createAffaireModal') ? new bootstrap.Modal(document.getElementById('createAffaireModal')) : null;
      const createDoeModal = document.getElementById('createDoeModal') ? new bootstrap.Modal(document.getElementById('createDoeModal')) : null;
      const respSearch = document.getElementById('responsable-search-input');
      const respHidden = document.getElementById('responsable-mat');
      const respSug = document.getElementById('responsable-suggestions');
      const agentSearch = document.getElementById('agent-search-input');
      const agentHidden = document.getElementById('agent-mat');
      const agentSug = document.getElementById('agent-suggestions');

      const pickArray = (...candidates) => candidates.find(a => Array.isArray(a) && a.length >= 0) || [];

      async function fetchJSON(url, opts) {
        const r = await fetch(url, { headers, credentials:'same-origin', ...(opts||{}) });
        if (r.status===401||r.status===403){ location.href='/login.html'; return null; }
        const data = await r.json().catch(()=>null);
        if (!r.ok) throw new Error((data && data.error) || r.statusText);
        return data;
      }

      function formatMember(label, email) {
        if (label && email) return `${label} (${email})`;
        return label || email || 'Utilisateur';
      }

      function renderTeamInline(respMatricule, agents = [], responsables = []) {
        if (!teamInline) return;
        const chips = [];
        if (respMatricule) {
          chips.push(`<span class="chip"><i class="bi bi-person-badge"></i>${respMatricule}</span>`);
        }
        (agents || []).forEach(a => {
          const label = formatMember(a.agent_matricule || a.matricule || a.actor_name, a.actor_email);
          if (label) chips.push(`<span class="chip"><i class="bi bi-people"></i>${label}</span>`);
        });
        teamInline.innerHTML = chips.length ? chips.join('') : '<span class="text-white-50">Aucun responsable ou agent assigné</span>';
        const respInline = document.getElementById('responsables-inline');
        if (respInline) {
          if ((responsables || []).length) {
            respInline.innerHTML = responsables.map(r => {
              const label = formatMember(
                (r.nom || '' ? `${r.prenom || ''} ${r.nom || ''}`.trim() : '') || r.agent_matricule || r.matricule,
                r.email || r.actor_email
              );
              const matricule = r.agent_matricule || r.matricule || '';
              const remove = isAdmin && matricule ? `<button class="btn btn-sm btn-outline-danger ms-1 p-0 del-resp" data-m="${matricule}" title="Retirer"><i class="bi bi-x-lg"></i></button>` : '';
              return `<span class="chip d-inline-flex align-items-center gap-1">${label || 'Responsable'}${remove}</span>`;
            }).join('');
          } else if (respMatricule) {
            const remove = isAdmin ? `<button class="btn btn-sm btn-outline-danger ms-1 p-0 del-resp" data-m="${respMatricule}" title="Retirer"><i class="bi bi-x-lg"></i></button>` : '';
            respInline.innerHTML = `<span class="chip d-inline-flex align-items-center gap-1">${respMatricule}${remove}</span>`;
          } else {
            respInline.innerHTML = 'Aucun responsable';
          }
        }
        const agentsInline = document.getElementById('agents-inline');
        if (agentsInline) {
          if ((agents || []).length) {
            agentsInline.innerHTML = agents.map(a => {
              const label = formatMember(a.agent_matricule || a.matricule || a.actor_name, a.actor_email);
              const matricule = a.agent_matricule || a.matricule || '';
              const remove = isAdmin && matricule ? `<button class="btn btn-sm btn-outline-danger ms-1 p-0 del-agent" data-m="${matricule}" title="Retirer"><i class="bi bi-x-lg"></i></button>` : '';
              return `<span class="chip d-inline-flex align-items-center gap-1">${label}${remove}</span>`;
            }).join('');
          } else {
            agentsInline.innerHTML = 'Aucun agent';
          }
        }
      }

      // Autocomplete agents
      function setupAgentAutocomplete(inputEl, hiddenEl, sugEl) {
        if (!inputEl || !hiddenEl || !sugEl) return;
        let timer;
        inputEl.addEventListener('input', () => {
          clearTimeout(timer);
          const q = inputEl.value.trim();
          hiddenEl.value = '';
          if (q.length < 1) { sugEl.innerHTML=''; return; }
          timer = setTimeout(async () => {
            try {
              const r = await fetch(`/api/agents?query=${encodeURIComponent(q)}`, { headers, credentials:'same-origin' });
              const agents = r.ok ? await r.json() : [];
              sugEl.innerHTML = '';
              (agents || []).forEach(a => {
                const btn = document.createElement('button');
                btn.type='button';
                btn.className='list-group-item list-group-item-action';
                const full = `${a.prenom || ''} ${a.nom || ''}`.trim() || a.matricule || 'Agent';
                btn.textContent = `${full}${a.matricule ? ' ('+a.matricule+')' : ''}`;
                btn.addEventListener('click', () => {
                  inputEl.value = full;
                  hiddenEl.value = a.matricule || '';
                  sugEl.innerHTML='';
                });
                sugEl.appendChild(btn);
              });
              if (!sugEl.innerHTML) sugEl.innerHTML = '<div class="list-group-item text-muted">Aucun résultat</div>';
            } catch(err){ sugEl.innerHTML='<div class="list-group-item text-danger">Erreur</div>'; }
          }, 200);
        });
        inputEl.addEventListener('blur', () => setTimeout(() => { sugEl.innerHTML=''; }, 200));
      }
      setupAgentAutocomplete(respSearch, respHidden, respSug);
      setupAgentAutocomplete(agentSearch, agentHidden, agentSug);

      try {
        const res = await fetch(`/api/travaux/${id}`, { headers, credentials:'same-origin' });
        if (res.status===401||res.status===403){ location.href='/login.html'; return; }
        const t = res.ok ? await res.json() : null;
        currentTravail = t;
        if (!t) throw new Error('Travail introuvable');
        set('work-title', t.titre || '(Sans titre)');
        set('work-sub', t.description || '');
        set('work-etat', t.etat || 'A_faire');
        set('work-prio', t.priorite || 'Moyenne');
        if (etatSelect && t.etat) etatSelect.value = t.etat;
        set('work-ech', fmt(t.date_echeance));
        set('work-debut', fmt(t.date_debut));
        set('work-fin', fmt(t.date_fin));
        setHTML('work-desc', t.description ? t.description.replace(/\n/g,'<br>') : '—');
        setHTML('work-desc-block', t.description ? t.description.replace(/\n/g,'<br>') : '—');
        setHTML('info-etat', t.etat || '—');

        // elapsed
        if (t.date_debut) {
          const start = new Date(t.date_debut).getTime();
          const end = t.date_fin ? new Date(t.date_fin).getTime() : Date.now();
          const diff = end - start;
          const days = Math.floor(diff / (1000*60*60*24));
          const hours = Math.floor((diff / (1000*60*60)) % 24);
          const mins = Math.floor((diff / (1000*60)) % 60);
          set('info-elapsed', `${days}j ${hours}h ${mins}m`);
        } else {
          set('info-elapsed', '—');
        }

        set('info-debut', fmt(t.date_debut));
        set('info-fin', t.date_fin ? fmt(t.date_fin) : 'En cours');

        setHTML('work-ticket', t.ticket_id ? `<a href="ticket-view.html?id=${t.ticket_id}" target="_blank">Ticket #${t.ticket_id}</a>` : '—');
        setHTML('work-client', t.client_nom ? t.client_nom : '—');
        const modalLink = (url, label) => {
          if (!url) return label || '—';
          const href = url.includes('?') ? `${url}&embed=1` : `${url}?embed=1`;
          return `<a href="${href}" class="link-button open-link-modal" data-href="${href}">${label || url}</a>`;
        };
        // Récupérer les libellés si l'API ne les a pas inclus
        let siteLabel = t.site_nom || '';
        let affaireLabel = t.affaire_nom || '';
        let doeLabel = t.doe_titre || '';
        try {
          if (t.site_id && !siteLabel) {
            const rs = await fetch(`/api/sites/${t.site_id}?_=${Date.now()}`, {
              headers: { ...headers, 'Cache-Control':'no-cache' },
              credentials:'same-origin',
              cache:'no-store'
            });
            if (rs.ok) { const s = await rs.json(); siteLabel = s.nom_site || siteLabel; }
          }
          if (t.affaire_id && !affaireLabel) {
            const ra = await fetch(`/api/affaires/${t.affaire_id}?_=${Date.now()}`, {
              headers: { ...headers, 'Cache-Control':'no-cache' },
              credentials:'same-origin',
              cache:'no-store'
            });
            if (ra.ok) { const a = await ra.json(); affaireLabel = a.nom_affaire || affaireLabel; }
          }
          if (t.doe_id && !doeLabel) {
            const rd = await fetch(`/api/does/${t.doe_id}?_=${Date.now()}`, {
              headers: { ...headers, 'Cache-Control':'no-cache' },
              credentials:'same-origin',
              cache:'no-store'
            });
            if (rd.ok) { const d = await rd.json(); doeLabel = d.titre || doeLabel; }
          }
        } catch(_) {}

        siteLabel = siteLabel || (t.site_id ? `Site #${t.site_id}` : '—');
        affaireLabel = affaireLabel || (t.affaire_id ? `Affaire #${t.affaire_id}` : '—');
        doeLabel = doeLabel || (t.doe_id ? `DOE #${t.doe_id}` : '—');

        setHTML('work-affaire', t.affaire_id ? modalLink(`affaire-view.html?id=${t.affaire_id}`, affaireLabel) : affaireLabel);
        setHTML('work-site', t.site_id ? modalLink(`site-view.html?id=${t.site_id}`, siteLabel) : siteLabel);
        setHTML('work-doe', t.doe_id ? modalLink(`doe-view.html?id=${t.doe_id}`, doeLabel) : doeLabel);
        setHTML('work-demande', t.demande_id ? modalLink(`demande-client-admin.html?id=${t.demande_id}`, `Demande #${t.demande_id}`) : (t.demande_titre || '—'));
        setHTML('info-affaire', t.affaire_id ? modalLink(`affaire-view.html?id=${t.affaire_id}`, affaireLabel) : affaireLabel);
        setHTML('info-doe', t.doe_id ? modalLink(`doe-view.html?id=${t.doe_id}`, doeLabel) : doeLabel);
        setHTML('info-site', t.site_id ? modalLink(`site-view.html?id=${t.site_id}`, siteLabel) : siteLabel);

        // Agents / Responsables
        const agentsList = document.getElementById('agents-list');
        let agentsData = pickArray(
          t.agents_assignes,
          t.agents,
          t.travaux_agents
        );
        let responsablesData = pickArray(
          t.responsables,
          t.travaux_responsables,
          t.responsables_assignes
        );
        // Relations étendues si dispos
        let relations = null;
        try {
          relations = await fetchJSON(`/api/travaux/${id}/relations`);
        } catch (err) {
          console.warn('Relations travaux non chargées', err);
        }
        try {
          const [agentsApi, respApi] = await Promise.all([
            fetchJSON(`/api/travaux/${id}/agents`).catch(()=>null),
            fetchJSON(`/api/travaux/${id}/responsables`).catch(()=>null)
          ]);
          const relAgents = pickArray(
            relations?.agents,
            relations?.travaux_agents,
            relations?.agents_assignes,
            relations?.agents_lies
          );
          const relResp = pickArray(
            relations?.responsables,
            relations?.travaux_responsables,
            relations?.responsables_assignes,
            relations?.travaux_responsable
          );
          if (Array.isArray(agentsApi)) agentsData = agentsApi;
          else if (relAgents.length) agentsData = relAgents;
          if (Array.isArray(respApi)) responsablesData = respApi;
          else if (relResp.length) responsablesData = relResp;
        } catch(err) {
          console.warn('Impossible de charger agents/responsables travaux', err);
        }
        if (agentsList) {
          agentsList.innerHTML = agentsData.length ? '' : '<li class="list-group-item text-muted">Aucun agent.</li>';
          agentsData.forEach(a => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = a.agent_matricule || a.matricule || 'Agent';
            agentsList.appendChild(li);
          });
        }
        const principalResp = (responsablesData.find(r => (r.role || '').toLowerCase().includes('principal')) || responsablesData[0] || {});
        const responsableMatricule = principalResp.agent_matricule || principalResp.matricule || t.agent_matricule || null;
        set('resp-principal', responsableMatricule || '—');
        const infoRespEl = document.getElementById('info-resp');
        if (infoRespEl) infoRespEl.textContent = responsableMatricule || '—';
        renderTeamInline(responsableMatricule, agentsData, responsablesData);

        // Actions alignées sur ticket-view
        if (!isAdmin) {
          editBtn?.classList.add('d-none');
          headerActionsBar?.classList.add('d-none');
        } else {
          if (headerActionsBar) { headerActionsBar.classList.remove('d-none'); headerActionsBar.style.display = 'flex'; }
          if (editBtn) { editBtn.classList.remove('d-none'); editBtn.href = `travaux-edit.html?id=${id}`; }
          if (btnResp) btnResp.onclick = () => { if (respSearch) respSearch.value=''; if (respHidden) respHidden.value=''; addRespModal?.show(); };
          if (btnAgent) btnAgent.onclick = () => { if (agentSearch) agentSearch.value=''; if (agentHidden) agentHidden.value=''; addAgentModal?.show(); };
          if (btnAffaire) btnAffaire.onclick = () => { createAffaireModal?.show(); };
          if (btnDoe) btnDoe.onclick = () => { createDoeModal?.show(); };

          // Suppression responsable / agent (inline chips)
          const respInline = document.getElementById('responsables-inline');
          if (respInline) {
            respInline.addEventListener('click', async (ev) => {
              const btn = ev.target.closest('.del-resp');
              if (!btn) return;
              const mat = btn.getAttribute('data-m');
              if (!mat || !confirm('Retirer ce responsable ?')) return;
              try {
                const del = await fetch(`/api/travaux/${id}/responsables/${mat}`, { method:'DELETE', headers, credentials:'same-origin' });
                if (!del.ok) throw new Error('Suppression impossible');
                location.reload();
              } catch (err) {
                try {
                  // fallback : effacer le responsable principal
                  await updateTravail({ agent_matricule: null });
                  location.reload();
                } catch(_) {
                  alert(err.message || 'Erreur suppression responsable');
                }
              }
            });
          }

          const agentsInline = document.getElementById('agents-inline');
          if (agentsInline) {
            agentsInline.addEventListener('click', async (ev) => {
              const btn = ev.target.closest('.del-agent');
              if (!btn) return;
              const mat = btn.getAttribute('data-m');
              if (!mat || !confirm('Retirer cet agent ?')) return;
              try {
                const del = await fetch(`/api/travaux/${id}/agents/${mat}`, { method:'DELETE', headers, credentials:'same-origin' });
                if (!del.ok) throw new Error('Suppression impossible');
                location.reload();
              } catch (err) {
                alert(err.message || 'Erreur suppression agent');
              }
            });
          }
        }

        // Helpers pour mises à jour
        async function updateTravail(payload) {
          // L'API attend au minimum un titre : on le repasse toujours
          const base = currentTravail && currentTravail.titre ? { titre: currentTravail.titre } : {};
          const body = { ...base, ...payload };
          if (!body.titre) throw new Error('Titre requis pour la mise à jour du travail');
          const r = await fetch(`/api/travaux/${id}`, {
            method:'PUT',
            headers:{ ...headers, 'Content-Type':'application/json' },
            credentials:'same-origin',
            body: JSON.stringify(body)
          });
          const d = await r.json().catch(()=>({}));
          if (!r.ok) throw new Error(d.error || `HTTP ${r.status}`);
        }

        document.getElementById('save-responsable-btn')?.addEventListener('click', async (e) => {
          e.preventDefault();
          const btn = e.currentTarget;
          const val = respHidden?.value?.trim();
          if (!val) { alert('Sélectionnez un responsable.'); return; }
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            // Tentative via endpoint dédié (si exposé)
            const r = await fetch(`/api/travaux/${id}/responsables`, {
              method:'POST',
              headers:{ ...headers, 'Content-Type':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify({ agent_matricule: val, matricule: val })
            });
            if (!r.ok) {
              const d = await r.json().catch(()=>({}));
              throw new Error(d.error || `HTTP ${r.status}`);
            }
            addRespModal?.hide();
            location.reload();
          } catch(err){
            // Fallback: mise à jour du champ agent_matricule directement
            try {
              await updateTravail({ agent_matricule: val });
              addRespModal?.hide();
              location.reload();
              return;
            } catch(_) {}
            alert(err.message || 'Erreur enregistrement responsable');
          } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Enregistrer';
          }
        });

        if (etatSave && etatSelect) {
          etatSave.addEventListener('click', async () => {
            const newEtat = etatSelect.value;
            if (!newEtat || !currentTravail) return;
            etatSave.disabled = true;
            const prev = etatSave.innerHTML;
            etatSave.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            try {
              await updateTravail({ etat: newEtat });
              set('work-etat', newEtat);
              set('info-etat', newEtat);
              currentTravail.etat = newEtat;
            } catch (err) {
              alert(err.message || 'Erreur lors de la mise à jour du statut');
            } finally {
              etatSave.disabled = false;
              etatSave.innerHTML = prev;
            }
          });
        }

        document.getElementById('save-agent-btn')?.addEventListener('click', async (e) => {
          e.preventDefault();
          const btn = e.currentTarget;
          const val = agentHidden?.value?.trim();
          if (!val) { alert('Sélectionnez un agent.'); return; }
          try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            const r = await fetch(`/api/travaux/${id}/agents`, {
              method:'POST',
              headers:{ ...headers, 'Content-Type':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify({ agent_matricule: val })
            });
            const d = await r.json().catch(()=>({}));
            if (!r.ok) throw new Error(d.error || `HTTP ${r.status}`);
            addAgentModal?.hide();
            location.reload();
          } catch(err){
            alert(err.message || 'Erreur ajout agent');
          } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Enregistrer';
          }
        });

        document.getElementById('create-affaire-form')?.addEventListener('submit', async (e) => {
          e.preventDefault();
          const nom = document.getElementById('affaire-nom').value.trim();
          const numero = document.getElementById('affaire-numero').value.trim() || null;
          const desc = document.getElementById('affaire-description').value.trim() || null;
          if (!nom) { alert('Nom requis'); return; }
          try {
            const r = await fetch('/api/affaires', {
              method:'POST',
              headers:{ ...headers, 'Content-Type':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify({ nom_affaire: nom, numero_affaire: numero, description: desc })
            });
            const d = await r.json().catch(()=>({}));
            if (!r.ok) throw new Error(d.error || `HTTP ${r.status}`);
            if (d.id) await updateTravail({ affaire_id: d.id });
            createAffaireModal?.hide();
            location.reload();
          } catch(err){ alert(err.message || 'Erreur création affaire'); }
        });

        document.getElementById('create-doe-form')?.addEventListener('submit', async (e) => {
          e.preventDefault();
          const titre = document.getElementById('doe-titre').value.trim();
          const desc = document.getElementById('doe-description').value.trim() || null;
          if (!titre) { alert('Titre requis'); return; }
          try {
            const r = await fetch('/api/does', {
              method:'POST',
              headers:{ ...headers, 'Content-Type':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify({ titre, description: desc })
            });
            const d = await r.json().catch(()=>({}));
            if (!r.ok) throw new Error(d.error || `HTTP ${r.status}`);
            if (d.id) await updateTravail({ doe_id: d.id });
            createDoeModal?.hide();
            location.reload();
          } catch(err){ alert(err.message || 'Erreur création DOE'); }
        });

        // Rendus
        const rRendus = await fetch(`/api/travaux/${id}/rendus`, { headers, credentials:'same-origin' });
        if (rRendus.status===401||rRendus.status===403){ location.href='/login.html'; return; }
        const rendus = rRendus.ok ? await rRendus.json() : [];
        renduList.innerHTML = '';
        if (!rendus.length) {
          renduList.innerHTML = '<div class="text-muted">Aucun rendu.</div>';
        } else {
          rendus.forEach(r => {
            const div = document.createElement('div');
            div.className = 'border rounded p-2 mb-2';
            div.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">Rendu #${r.id}</div>
                <span class="badge bg-light text-dark">${r.attachments_count || 0} pièce(s)</span>
              </div>
              <div class="small text-muted mb-1">${r.resume || '—'}</div>
              <div class="d-flex gap-2">
                <a href="/rendu-intervention-view.html?id=${r.id}" class="btn btn-sm btn-outline-primary">Voir</a>
              </div>
            `;
            renduList.appendChild(div);
          });
        }

        // Factures / matériel restent à raccorder côté API (cible Travaux)
        if (factList) factList.innerHTML = '<div class="text-muted">Pas encore relié aux factures Travaux.</div>';
        if (matList) matList.innerHTML = '<div class="text-muted">Pas encore relié aux demandes matériel Travaux.</div>';

      // --- Tâches ---
        async function loadTasks() {
          try {
            const rt = await fetch(`/api/travaux/${id}/taches`, { headers, credentials:'same-origin' });
            if (rt.status===401||rt.status===403){ location.href='/login.html'; return; }
            const tasks = rt.ok ? await rt.json() : [];
            taskList.innerHTML = '';
            if (!tasks.length) {
              taskList.innerHTML = '<div class="text-muted">Aucune tâche.</div>';
              set('info-progress', '0%');
              set('info-remaining', '0');
              return;
            }
            const doneCount = tasks.filter(tk => (tk.etat || '').toLowerCase() === 'termine').length;
            const total = tasks.length;
            const pct = Math.round((doneCount / total) * 100);
            set('info-progress', `${pct}%`);
            set('info-remaining', `${total - doneCount} tâche(s)`);
            tasks.forEach(tk => {
              const card = document.createElement('div');
              card.className = 'border rounded p-2 mb-2';
              const ech = tk.date_echeance ? new Date(tk.date_echeance).toLocaleString('fr-FR') : '—';
              const isDone = tk.etat === 'Termine';
              const doneAction = isDone
                ? '<span class="badge bg-success align-self-center">Terminé</span>'
                : `<button class="btn btn-sm btn-outline-success btn-task-done" data-id="${tk.id}" data-title="${tk.titre || ''}" title="Terminer"><i class="bi bi-check2"></i></button>`;
              card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">${tk.titre}</div>
                    <div class="small text-muted">${tk.description || ''}</div>
                    <div class="small text-muted">État: ${tk.etat || 'A_faire'} · Priorité: ${tk.priorite || 'Moyenne'} · Échéance: ${ech}</div>
                  </div>
                  <div class="d-flex gap-1 align-items-center">
                    ${doneAction}
                    <button class="btn btn-sm btn-outline-danger btn-task-del" data-id="${tk.id}" title="Supprimer"><i class="bi bi-trash"></i></button>
                  </div>
                </div>
              `;
              taskList.appendChild(card);
            });
          } catch(err) {
            taskList.innerHTML = '<div class="text-danger">Erreur chargement tâches.</div>';
          }
        }
        await loadTasks();

        document.getElementById('add-task-btn')?.addEventListener('click', () => {
          document.getElementById('task-form').reset();
          document.getElementById('task-feedback').classList.add('d-none');
          taskModal?.show();
        });

        document.getElementById('task-save-btn')?.addEventListener('click', async () => {
          const fb = document.getElementById('task-feedback');
          const titre = document.getElementById('task-titre').value.trim();
          const description = document.getElementById('task-desc').value.trim() || null;
          const etat = document.getElementById('task-etat').value;
          const priorite = document.getElementById('task-priorite').value;
          const date_echeance = document.getElementById('task-ech').value || null;
          if (!titre) { fb.textContent='Le titre est requis.'; fb.classList.remove('d-none'); return; }
          try {
            const r = await fetch(`/api/travaux/${id}/taches`, {
              method:'POST',
              headers:{ ...headers, 'Content-Type':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify({ titre, description, etat, priorite, date_echeance })
            });
            if (r.status===401||r.status===403){ location.href='/login.html'; return; }
            if (!r.ok) { const d=await r.json().catch(()=>({})); throw new Error(d.error||'Erreur'); }
            taskModal?.hide();
            await loadTasks();
          } catch(err) {
            fb.textContent = err.message || 'Erreur';
            fb.classList.remove('d-none');
          }
        });

        taskList?.addEventListener('click', async (e) => {
          const btnDone = e.target.closest('.btn-task-done');
          const btnDel = e.target.closest('.btn-task-del');
          if (btnDone) {
            const tid = btnDone.dataset.id;
            const currentTitle = btnDone.dataset.title || 'Tâche';
            await fetch(`/api/travaux_taches/${tid}`, {
              method:'PUT',
              headers:{ ...headers, 'Content-Type':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify({ titre: currentTitle, etat:'Termine' })
            }).catch(()=>{});
            await loadTasks();
          }
          if (btnDel) {
            const tid = btnDel.dataset.id;
            await fetch(`/api/travaux_taches/${tid}`, { method:'DELETE', headers, credentials:'same-origin' }).catch(()=>{});
            await loadTasks();
          }
        });
      } catch (err) {
        alert(err.message || 'Erreur chargement travail');
      }

      // Liens modaux pour affaire/site/DOE/demande
      const linkModalEl = document.getElementById('linkModal');
      const linkFrame = document.getElementById('linkFrame');
      const linkModal = linkModalEl ? new bootstrap.Modal(linkModalEl) : null;
      const toModal = (href) => {
        if (!href) return;
        const finalHref = href.includes('?') ? `${href}&embed=1` : `${href}?embed=1`;
        if (linkFrame) linkFrame.src = finalHref;
        linkModal?.show();
      };
      document.body.addEventListener('click', (e) => {
        const a = e.target.closest('.open-link-modal');
        if (a && a.dataset.href) {
          e.preventDefault();
          toModal(a.dataset.href);
        }
      });
    });
  </script>
</body>
</html>
