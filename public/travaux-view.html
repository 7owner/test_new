<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/custom.css?v=1">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg,#eef2ff 0%,#f8fbff 100%); }
    .card-gradient { background: linear-gradient(135deg,#4da5ff 0%,#7c5bff 100%); color:#fff; border:none; }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <main class="container my-4">
    <div class="card card-gradient mb-3">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-center">
        <div>
          <div class="small text-white-50">Travail</div>
          <h3 class="mb-0" id="work-title">Chargement...</h3>
          <div class="text-white-50 small" id="work-sub">—</div>
        </div>
        <div class="d-flex gap-2">
          <span class="badge bg-light text-dark" id="work-etat">-</span>
          <span class="badge bg-light text-dark" id="work-prio">-</span>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-8">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-info-circle me-1"></i>Détails</span>
          </div>
          <div class="card-body">
            <p class="mb-1 text-muted">Description</p>
            <div id="work-desc" class="border rounded p-2 bg-light">—</div>
            <hr>
            <div class="row g-3 small">
              <div class="col-md-4">
                <div class="text-muted">Échéance</div>
                <div id="work-ech">—</div>
              </div>
              <div class="col-md-4">
                <div class="text-muted">Début</div>
                <div id="work-debut">—</div>
              </div>
              <div class="col-md-4">
                <div class="text-muted">Fin</div>
                <div id="work-fin">—</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-check me-1"></i>Tâches / Checklists</span>
            <button class="btn btn-sm btn-primary" id="add-task-btn"><i class="bi bi-plus-lg"></i> Ajouter</button>
          </div>
          <div class="card-body" id="tasks-list">
            <div class="text-muted">À implémenter (endpoint tâches interne).</div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-archive me-1"></i>Demandes matériel</span>
            <button class="btn btn-sm btn-outline-primary" id="add-mat-btn">Demander</button>
          </div>
          <div class="card-body" id="mat-list">
            <div class="text-muted">Chargement...</div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-journal-text me-1"></i>Rendus</span>
            <button class="btn btn-sm btn-outline-primary" id="add-rendu-btn">Nouveau rendu</button>
          </div>
          <div class="card-body" id="rendu-list">
            <div class="text-muted">Chargement...</div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-receipt me-1"></i>Factures liées</span>
            <button class="btn btn-sm btn-outline-success" id="add-fac-btn">Ajouter facture</button>
          </div>
          <div class="card-body" id="fact-list">
            <div class="text-muted">Chargement...</div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card mb-3">
          <div class="card-header"><i class="bi bi-people-fill me-1"></i>Responsables / Agents</div>
          <div class="card-body">
            <div class="small text-muted mb-1">Responsable</div>
            <div id="resp-principal" class="fw-semibold">—</div>
            <hr>
            <div class="small text-muted mb-1">Agents assignés</div>
            <ul class="list-group list-group-flush" id="agents-list"></ul>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header"><i class="bi bi-diagram-3 me-1"></i>Liens</div>
          <div class="card-body small">
            <div>Ticket lié : <span id="work-ticket">—</span></div>
            <div>Client : <span id="work-client">—</span></div>
            <div>Affaire : <span id="work-affaire">—</span></div>
            <div>Site : <span id="work-site">—</span></div>
            <div>DOE : <span id="work-doe">—</span></div>
            <div>Demande client : <span id="work-demande">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) { alert('Travail introuvable'); return; }
      const token = localStorage.getItem('token');
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const fmt = (d) => d ? new Date(d).toLocaleString('fr-FR') : '—';

      const set = (id,val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      const setHTML = (id,val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };
      const renduList = document.getElementById('rendu-list');
      const factList = document.getElementById('fact-list');
      const matList = document.getElementById('mat-list');

      try {
        const res = await fetch(`/api/travaux/${id}`, { headers, credentials:'same-origin' });
        if (res.status===401||res.status===403){ location.href='/login.html'; return; }
        const t = res.ok ? await res.json() : null;
        if (!t) throw new Error('Travail introuvable');
        set('work-title', t.titre || '(Sans titre)');
        set('work-sub', t.description || '');
        set('work-etat', t.etat || 'A_faire');
        set('work-prio', t.priorite || 'Moyenne');
        set('work-ech', fmt(t.date_echeance));
        set('work-debut', fmt(t.date_debut));
        set('work-fin', fmt(t.date_fin));
        setHTML('work-desc', t.description ? t.description.replace(/\n/g,'<br>') : '—');

        setHTML('work-ticket', t.ticket_id ? `<a href="ticket-view.html?id=${t.ticket_id}" target="_blank">Ticket #${t.ticket_id}</a>` : '—');
        setHTML('work-client', t.client_nom ? t.client_nom : '—');
        setHTML('work-affaire', t.affaire_id ? `<a href="affaire-view.html?id=${t.affaire_id}" target="_blank">${t.affaire_nom || 'Affaire'}</a>` : (t.affaire_nom || '—'));
        setHTML('work-site', t.site_id ? `<a href="site-view.html?id=${t.site_id}" target="_blank">${t.site_nom || 'Site'}</a>` : (t.site_nom || '—'));
        setHTML('work-doe', t.doe_id ? `<a href="doe-view.html?id=${t.doe_id}" target="_blank">${t.doe_titre || 'DOE'}</a>` : (t.doe_titre || '—'));
        setHTML('work-demande', t.demande_id ? `<a href="demande-client-admin.html?embed=1&id=${t.demande_id}" target="_blank">Demande #${t.demande_id}</a>` : (t.demande_titre || '—'));

        // Agents
        const agentsList = document.getElementById('agents-list');
        agentsList.innerHTML = t.agents_assignes?.length ? '' : '<li class="list-group-item text-muted">Aucun agent.</li>';
        (t.agents_assignes || []).forEach(a => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = a.agent_matricule || a.matricule || 'Agent';
          agentsList.appendChild(li);
        });
        set('resp-principal', t.agent_matricule || '—');

        // Rendus
        const rRendus = await fetch(`/api/travaux/${id}/rendus`, { headers, credentials:'same-origin' });
        if (rRendus.status===401||rRendus.status===403){ location.href='/login.html'; return; }
        const rendus = rRendus.ok ? await rRendus.json() : [];
        renduList.innerHTML = '';
        if (!rendus.length) {
          renduList.innerHTML = '<div class="text-muted">Aucun rendu.</div>';
        } else {
          rendus.forEach(r => {
            const div = document.createElement('div');
            div.className = 'border rounded p-2 mb-2';
            div.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">Rendu #${r.id}</div>
                <span class="badge bg-light text-dark">${r.attachments_count || 0} pièce(s)</span>
              </div>
              <div class="small text-muted mb-1">${r.resume || '—'}</div>
              <div class="d-flex gap-2">
                <a href="/rendu-intervention-view.html?id=${r.id}" class="btn btn-sm btn-outline-primary">Voir</a>
              </div>
            `;
            renduList.appendChild(div);
          });
        }

        // Factures / matériel restent à raccorder côté API (cible Travaux)
        factList.innerHTML = '<div class="text-muted">Pas encore relié aux factures Travaux.</div>';
        matList.innerHTML = '<div class="text-muted">Pas encore relié aux demandes matériel Travaux.</div>';
      } catch (err) {
        alert(err.message || 'Erreur chargement travail');
      }
    });
  </script>
</body>
</html>
