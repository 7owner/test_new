<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Commandes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .order-card { transition: transform 0.2s, box-shadow 0.2s; }
    .order-card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>

  <main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="h4 mb-0">Gestion des Commandes</h1>
      <a href="/catalogue-materiel.html" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-1"></i>Nouvelle commande depuis le catalogue</a>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Rechercher</label>
            <input type="text" id="search-input" class="form-control" placeholder="Filtrer par référence, désignation, fournisseur...">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Statut de commande</label>
            <select id="filter-status" class="form-select">
              <option value="">Tous</option>
              <option value="A commander">À commander</option>
              <option value="Commande">Commandé</option>
              <option value="En livraison">En livraison</option>
              <option value="Reçu">Reçu</option>
              <option value="Installé">Installé</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <div id="orders-cards" class="row g-3">
            <div class="col-12 text-center text-muted py-4">Chargement...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal edit -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="orderModalLabel">Détails de la commande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <p><strong>Référence:</strong> <span id="ord-reference"></span></p>
            <p><strong>Désignation:</strong> <span id="ord-designation"></span></p>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Statut de commande</label>
                    <select class="form-select" id="ord-commande_status">
                        <option value="A commander">À commander</option>
                        <option value="Commande">Commandé</option>
                        <option value="En livraison">En livraison</option>
                        <option value="Reçu">Reçu</option>
                        <option value="Installé">Installé</option>
                    </select>
                </div>
                 <div class="col-md-6">
                    <label class="form-label">Fournisseur</label>
                    <input type="text" class="form-control" id="ord-fournisseur">
                </div>
                <div class="col-12">
                    <label class="form-label">Commentaire</label>
                    <textarea class="form-control" id="ord-commentaire" rows="2"></textarea>
                </div>
            </div>
            <hr>
            <h6>Pièces Jointes (Bon de livraison, etc.)</h6>
            <div id="ord-documents-list" class="list-group mb-3"></div>
            <div class="input-group">
                <input type="file" class="form-control" id="ord-document-upload">
                <button class="btn btn-outline-secondary" type="button" id="btn-upload-document">Téléverser</button>
            </div>
             <div class="alert d-none mt-3" id="ord-feedback"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="ord-save-btn"><i class="bi bi-save me-1"></i>Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal réception -->
  <div class="modal fade" id="receiveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Marquer comme reçu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2 text-muted" id="receive-ref">Référence : -</p>
          <div class="mb-3">
            <label class="form-label">Quantité reçue</label>
            <input type="number" min="0" step="1" class="form-control" id="receive-qty" placeholder="Ex: 5">
            <small class="text-muted">Cette quantité sera enregistrée dans le commentaire de la commande.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-success" id="receive-save-btn"><i class="bi bi-check-circle me-1"></i>Valider reçu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal consultation documents -->
  <div class="modal fade" id="docsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="docsModalLabel">Pièces jointes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div id="docs-list" class="list-group"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) { window.location.href='/login.html'; return; }
      const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' };
      
      const cardsContainer = document.getElementById('orders-cards');
      const searchInput = document.getElementById('search-input');
      const statusFilter = document.getElementById('filter-status');
      
      const orderModalEl = document.getElementById('orderModal');
      const orderModal = new bootstrap.Modal(orderModalEl);
      const orderModalLabel = document.getElementById('orderModalLabel');
      const feedback = document.getElementById('ord-feedback');
      const saveBtn = document.getElementById('ord-save-btn');
      const docsModalEl = document.getElementById('docsModal');
      const docsModal = new bootstrap.Modal(docsModalEl);
      const docsList = document.getElementById('docs-list');
      const docsModalLabel = document.getElementById('docsModalLabel');
      const receiveModalEl = document.getElementById('receiveModal');
      const receiveModal = new bootstrap.Modal(receiveModalEl);
      const receiveRef = document.getElementById('receive-ref');
      const receiveQty = document.getElementById('receive-qty');
      const receiveSaveBtn = document.getElementById('receive-save-btn');
      
      let orders = [];
      let editingOrderId = null;
      let receivingOrderId = null;

      const fields = {
          reference: document.getElementById('ord-reference'),
          designation: document.getElementById('ord-designation'),
          commande_status: document.getElementById('ord-commande_status'),
          fournisseur: document.getElementById('ord-fournisseur'),
          commentaire: document.getElementById('ord-commentaire'),
          docList: document.getElementById('ord-documents-list'),
          docUploadInput: document.getElementById('ord-document-upload'),
          docUploadBtn: document.getElementById('btn-upload-document'),
      };

      const statusClass = (status) => {
        switch (status) {
          case 'A commander': return 'bg-secondary';
          case 'Commande': return 'bg-primary';
          case 'En livraison': return 'bg-warning text-dark';
          case 'Reçu': return 'bg-success';
          case 'Installé': return 'bg-info text-dark';
          default: return 'bg-light text-dark';
        }
      };
      const formatPrice = (value) => {
        if (value === null || value === undefined || value === '') return '—';
        const num = Number(value);
        if (Number.isNaN(num)) return '—';
        return `${num.toFixed(2)} €`;
      };
      const formatPercent = (value) => {
        if (value === null || value === undefined || value === '') return '—';
        const num = Number(value);
        if (Number.isNaN(num)) return '—';
        return `${num.toFixed(2)} %`;
      };
      
      const api = async (url, opts = {}) => {
          const res = await fetch(url, { headers, credentials: 'same-origin', ...opts });
          if (res.status === 401) window.location.href = '/login.html';
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || `HTTP Error ${res.status}`);
          return data;
      };

      function render() {
        const term = searchInput.value.toLowerCase();
        const status = statusFilter.value;
        const filtered = orders.filter(item => {
            const matchesTerm = !term || [item.titre, item.reference, item.fournisseur, item.designation, item.fabricant].some(f => f?.toLowerCase().includes(term));
            const matchesStatus = !status || item.commande_status === status;
            return matchesTerm && matchesStatus;
        });

        cardsContainer.innerHTML = '';
        if (!filtered.length) {
            cardsContainer.innerHTML = '<div class="col-12 text-center text-muted py-4">Aucune commande.</div>';
            return;
        }

        filtered.forEach(item => {
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg-4';
            const card = document.createElement('div');
            card.className = 'card h-100 shadow-sm order-card';
            card.innerHTML = `
              <div class="card-body d-flex flex-column gap-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">${item.reference || '-'}</div>
                    <div class="text-muted">${item.designation || '-'}</div>
                    <div class="small text-muted">Fabricant: ${item.fabricant || '—'}</div>
                    <div class="small text-muted">Fournisseur: ${item.fournisseur || '—'}</div>
                    <div class="small text-muted">Quantité (interventions): ${item.total_quantite_used_in_interventions ?? 0}</div>
                    <div class="small text-muted">Prix: ${formatPrice(item.prix_achat)}</div>
                    <div class="small text-muted">Remise: ${formatPercent(item.remise_fournisseur)}</div>
                  </div>
                  <span class="badge ${statusClass(item.commande_status)}">${(item.commande_status || '').replace('_', ' ')}</span>
                </div>
                <div class="d-flex flex-wrap gap-2 justify-content-end">
                  <button class="btn btn-sm btn-outline-success receive-btn" data-id="${item.id}" title="Marquer reçu"><i class="bi bi-box-seam"></i></button>
                  <button class="btn btn-sm btn-outline-primary docs-btn" data-id="${item.id}" title="Pièces jointes"><i class="bi bi-paperclip"></i></button>
                  <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${item.id}" title="Détails"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-outline-danger del-btn" data-id="${item.id}" title="Supprimer"><i class="bi bi-trash"></i></button>
                </div>
              </div>`;
            col.appendChild(card);
            cardsContainer.appendChild(col);
        });
      }

      async function loadOrders() {
        cardsContainer.innerHTML = '<div class="col-12 text-center text-muted py-4">Chargement...</div>';
        try {
          orders = await api('/api/materiels');
          render();
        } catch(e) {
          tbody.innerHTML = `<tr><td colspan="8" class="text-danger text-center py-4">Erreur: ${e.message}</td></tr>`;
        }
      }

      function showFeedback(msg, isError = true) {
          feedback.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
          feedback.textContent = msg;
          feedback.classList.remove('d-none');
      }

      function openModal(order) {
          feedback.classList.add('d-none');
          editingOrderId = order?.id || null;
          orderModalLabel.textContent = `Commande #${order.id} - ${order.reference}`;
          
          fields.reference.textContent = order.reference;
          fields.designation.textContent = order.designation;
          fields.commande_status.value = order.commande_status || 'A commander';
          fields.fournisseur.value = order.fournisseur || '';
          fields.commentaire.value = order.commentaire || '';

          if (order.id) {
              fields.docUploadBtn.disabled = false;
              renderDocuments(order.id);
          }
          orderModal.show();
      }

      saveBtn.addEventListener('click', async () => {
          if (!editingOrderId) return;
          const payload = {
              fournisseur: fields.fournisseur.value,
              commande_status: fields.commande_status.value,
              commentaire: fields.commentaire.value
          };
          try {
              saveBtn.disabled = true;
              await api(`/api/materiels/${editingOrderId}`, { method: 'PUT', body: JSON.stringify(payload) });
              showFeedback('Enregistré.', false);
              await loadOrders();
              setTimeout(() => orderModal.hide(), 800);
          } catch (e) {
              showFeedback(e.message);
          } finally {
              saveBtn.disabled = false;
          }
      });
      
      cardsContainer.addEventListener('click', (e) => {
          const target = e.target.closest('button');
          if (!target) return;
          const id = target.dataset.id;
          if (target.classList.contains('edit-btn')) {
              const order = orders.find(i => i.id == id);
              openModal(order);
          } else if (target.classList.contains('receive-btn')) {
              const order = orders.find(i => i.id == id);
              if (!order) return;
              receivingOrderId = id;
              receiveRef.textContent = `Référence : ${order.reference || '-'}`;
              receiveQty.value = '';
              receiveModal.show();
          } else if (target.classList.contains('del-btn')) {
              if (!confirm('Supprimer cette commande?')) return;
              api(`/api/materiels/${id}`, { method: 'DELETE' }).then(loadOrders).catch(e => alert(e.message));
          } else if (target.classList.contains('docs-btn')) {
              openDocsModal(id);
          }
      });

      receiveSaveBtn.addEventListener('click', async () => {
          if (!receivingOrderId) return;
          const qty = Number(receiveQty.value);
          if (Number.isNaN(qty) || qty < 0) { alert('Veuillez saisir une quantité valide.'); return; }
          try {
              await api(`/api/materiels/${receivingOrderId}`, {
                  method: 'PUT',
                  body: JSON.stringify({
                    commande_status: 'Reçu',
                    commentaire: `Quantité reçue: ${qty}`
                  })
              });
              await loadOrders();
              receiveModal.hide();
          } catch (err) { alert(err.message); }
      });

      // --- Document Logic ---
      async function renderDocuments(orderId) {
          fields.docList.innerHTML = '';
          try {
              const documents = await api(`/api/documents?cible_type=Materiel&cible_id=${orderId}`);
              if (!documents.length) {
                  fields.docList.innerHTML = '<div class="text-muted small">Aucun document.</div>';
                  return;
              }
              documents.forEach(doc => {
                  const li = document.createElement('div');
                  li.className = 'list-group-item d-flex justify-content-between align-items-center';
                  li.innerHTML = `<a href="/api/documents/${doc.id}/download" target="_blank">${doc.nom_fichier}</a><button class="btn btn-sm btn-outline-danger" data-doc-id="${doc.id}"><i class="bi bi-trash"></i></button>`;
                  li.querySelector('button').addEventListener('click', () => deleteDocument(doc.id, orderId));
                  fields.docList.appendChild(li);
              });
          } catch (e) {
              fields.docList.innerHTML = `<div class="text-danger small">Erreur: ${e.message}</div>`;
          }
      }
      async function deleteDocument(docId, orderId) {
          if (!confirm('Supprimer ce document?')) return;
          try {
              await api(`/api/documents/${docId}`, { method: 'DELETE' });
              await renderDocuments(orderId);
          } catch(e) { alert(`Erreur: ${e.message}`); }
      }
      function fileToBase64(file) {
          return new Promise((resolve, reject) => {
              const reader = new FileReader(); reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.onerror = reject;
          });
      }
      fields.docUploadBtn.addEventListener('click', async () => {
          if (!editingOrderId) return;
          const file = fields.docUploadInput.files[0];
          if (!file) return alert('Sélectionnez un fichier.');
          fields.docUploadBtn.disabled = true;
          try {
              const base64 = await fileToBase64(file);
              await api('/api/documents', { method: 'POST', body: JSON.stringify({
                  cible_type: 'Materiel', cible_id: editingOrderId, nom_fichier: file.name, type_mime: file.type, base64
              }) });
              await renderDocuments(editingOrderId);
              fields.docUploadInput.value = '';
          } catch (e) {
              alert(`Erreur: ${e.message}`);
          } finally {
              fields.docUploadBtn.disabled = false;
          }
      });
      // --- End Document Logic ---

      async function openDocsModal(orderId) {
        docsModalLabel.textContent = 'Pièces jointes';
        docsList.innerHTML = '<div class="text-muted small">Chargement...</div>';
        docsModal.show();
        try {
          const documents = await api(`/api/documents?cible_type=Materiel&cible_id=${orderId}`);
          if (!documents.length) {
            docsList.innerHTML = '<div class="text-muted small">Aucune pièce jointe.</div>';
            return;
          }
          docsList.innerHTML = '';
          documents.forEach(doc => {
            const row = document.createElement('div');
            row.className = 'list-group-item d-flex justify-content-between align-items-center';
            row.innerHTML = `<a href="/api/documents/${doc.id}/download" target="_blank" rel="noopener">${doc.nom_fichier || 'Document'}</a>
                             <span class="text-muted small">${doc.type_mime || ''}</span>`;
            docsList.appendChild(row);
          });
        } catch (e) {
          docsList.innerHTML = `<div class="text-danger small">Erreur: ${e.message}</div>`;
        }
      }

      searchInput.addEventListener('input', render);
      statusFilter.addEventListener('change', render);

      loadOrders();
    });
  </script>
</body>
</html>
