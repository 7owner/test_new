<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalogue Matériel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/custom.css?v=1">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); min-height: 100vh; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .filters-card { background: #fff; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .modal-lg { max-width: 900px; }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>

  <main class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="m-0"><i class="bi bi-box-seam me-2 text-primary"></i>Catalogue matériel</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#materielModal" id="btn-add"><i class="bi bi-plus-circle me-1"></i>Ajouter un matériel</button>
    </div>

    <div class="filters-card p-3 mb-4">
      <div class="row g-2">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="search" class="form-control" placeholder="Rechercher par référence, désignation, catégorie...">
          </div>
        </div>
        <div class="col-md-3">
          <select id="filter-categorie" class="form-select">
            <option value="">Toutes catégories</option>
          </select>
        </div>
        <div class="col-md-3 text-end">
          <span class="badge bg-primary" id="count-badge">0 élément(s)</span>
        </div>
      </div>
    </div>

    <div id="list" class="row g-3">
      <div class="col-12 text-center text-muted">Chargement...</div>
    </div>
  </main>

  <!-- Modal add/edit -->
  <div class="modal fade" id="materielModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Nouveau matériel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <form id="materiel-form">
            <input type="hidden" id="mat-id">
            <div class="row g-3">
              <!-- New Row for Titre -->
              <div class="col-md-12">
                <label class="form-label">Titre*</label>
                <input type="text" id="mat-titre" class="form-control" required>
              </div>
              <!-- Row 1 -->
              <div class="col-md-4">
                <label class="form-label">Référence*</label>
                <input type="text" id="mat-reference" class="form-control" required>
              </div>
              <div class="col-md-8">
                <label class="form-label">Désignation*</label>
                <input type="text" id="mat-designation" class="form-control" required>
              </div>

              <!-- Row 2 -->
              <div class="col-md-4">
                <label class="form-label">Catégorie</label>
                <input type="text" id="mat-categorie" class="form-control" placeholder="Ex: Câble, Capteur...">
              </div>
              <div class="col-md-4">
                <label class="form-label">Fabricant</label>
                <input type="text" id="mat-fabricant" class="form-control" placeholder="Ex: Siemens, Schneider...">
              </div>
              <div class="col-md-4">
                <label class="form-label">Fournisseur</label>
                <input type="text" id="mat-fournisseur" class="form-control" placeholder="Ex: Rexel, Sonepar...">
              </div>

              <!-- Row 3 -->
              <div class="col-md-4">
                <label class="form-label">Prix d'achat (€)</label>
                <input type="number" id="mat-prix_achat" class="form-control" min="0" step="0.01" placeholder="0.00">
              </div>
              <div class="col-md-4">
                <label class="form-label">Remise Fournisseur (%)</label>
                <input type="number" id="mat-remise_fournisseur" class="form-control" min="0" max="100" step="0.01" placeholder="0.00">
              </div>
              <div class="col-md-4">
                <label class="form-label">Classe Matériel</label>
                <input type="text" id="mat-classe_materiel" class="form-control" placeholder="Ex: A, B, C...">
              </div>

              <!-- Row 4 -->
              <div class="col-md-6">
                <label class="form-label">Métier</label>
                <select id="mat-metier" class="form-select">
                  <option value="">Non spécifié</option>
                  <option value="GTB">GTB</option>
                  <option value="Video">Video</option>
                  <option value="Intrusion">Intrusion</option>
                  <option value="Control_Acces">Contrôle d'Accès</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Statut Commande</label>
                <select id="mat-commande_status" class="form-select">
                  <option value="A commander">A commander</option>
                  <option value="Commande">Commandé</option>
                  <option value="En livraison">En livraison</option>
                  <option value="Reçu">Reçu</option>
                  <option value="Installé">Installé</option>
                </select>
              </div>

              <!-- Row 5: Document Upload -->
              <div class="col-12">
                <hr>
                <h5>Pièces Jointes</h5>
                <div id="mat-documents-list" class="list-group mb-3"></div>
                <div class="input-group">
                    <input type="file" class="form-control" id="mat-document-upload">
                    <button class="btn btn-outline-secondary" type="button" id="btn-upload-document">Téléverser</button>
                </div>
                <small class="form-text text-muted">Ajouter un document (PDF, image, etc.)</small>
              </div>
              
              <!-- Row 6 -->
              <div class="col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea id="mat-commentaire" class="form-control" rows="2" placeholder="Informations additionnelles..."></textarea>
              </div>
            </div>
          </form>
          <div id="form-feedback" class="text-danger small mt-2"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="save-btn"><i class="bi bi-check-circle me-1"></i>Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const listEl = document.getElementById('list');
      const searchEl = document.getElementById('search');
      const filterCat = document.getElementById('filter-categorie');
      const countBadge = document.getElementById('count-badge');
      const modalEl = document.getElementById('materielModal');
      const modal = modalEl ? new bootstrap.Modal(modalEl) : null;
      const form = document.getElementById('materiel-form');
      const formFeedback = document.getElementById('form-feedback');
      const saveBtn = document.getElementById('save-btn');
      const titleEl = document.getElementById('modalTitle');
      
      const fields = {
        id: document.getElementById('mat-id'),
        titre: document.getElementById('mat-titre'),
        reference: document.getElementById('mat-reference'),
        designation: document.getElementById('mat-designation'),
        categorie: document.getElementById('mat-categorie'),
        fabricant: document.getElementById('mat-fabricant'),
        fournisseur: document.getElementById('mat-fournisseur'),
        remise_fournisseur: document.getElementById('mat-remise_fournisseur'),
        classe_materiel: document.getElementById('mat-classe_materiel'),
        prix_achat: document.getElementById('mat-prix_achat'),
        commentaire: document.getElementById('mat-commentaire'),
        commande_status: document.getElementById('mat-commande_status'),
        metier: document.getElementById('mat-metier'),
        docList: document.getElementById('mat-documents-list'),
        docUploadInput: document.getElementById('mat-document-upload'),
        docUploadBtn: document.getElementById('btn-upload-document')
      };

      let materiels = [];
      const token = localStorage.getItem('token');
      const baseHeaders = token ? { 'Authorization': 'Bearer ' + token } : {};

      const api = async (url, opts = {}) => {
        const defaultHeaders = opts.body instanceof FormData ? {} : { 'Content-Type': 'application/json' };
        const res = await fetch(url, { credentials: 'same-origin', headers: { ...defaultHeaders, ...baseHeaders, ...(opts.headers||{}) }, ...opts });
        if (res.status === 401) { location.href = '/login.html'; return null; }
        const ct = res.headers.get('content-type') || '';
        const body = ct.includes('application/json') ? await res.json() : null;
        if (!res.ok) throw new Error((body && body.error) || res.statusText);
        return body;
      };

      function render() {
        const term = (searchEl.value || '').toLowerCase();
        const cat = filterCat.value;
        const filtered = materiels.filter(m => {
          const blob = `${m.titre||''} ${m.reference||''} ${m.designation||''} ${m.categorie||''} ${m.fabricant||''} ${m.fournisseur||''} ${m.commentaire||''}`.toLowerCase();
          const matchText = !term || blob.includes(term);
          const matchCat = !cat || m.categorie === cat;
          return matchText && matchCat;
        });
        countBadge.textContent = `${filtered.length} élément(s)`;
        listEl.innerHTML = filtered.length ? '' : '<div class="col-12 text-center text-muted">Aucun matériel</div>';
        filtered.forEach(m => {
          const col = document.createElement('div');
          col.className = 'col-12 col-md-6 col-lg-4';
          const prix = m.prix_achat ? `${parseFloat(m.prix_achat).toFixed(2)}€` : '—';
          col.innerHTML = `
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h5 class="fw-bold">${m.titre || '(Sans titre)'}</h5>
                    <div class="text-muted small">Ref: ${m.reference || '—'} | Désignation: ${m.designation || '—'}</div>
                  </div>
                  <span class="badge bg-light text-dark">${m.categorie || '—'}</span>
                </div>
                <div class="text-muted small mb-2">
                    Fabricant: ${m.fabricant || 'N/A'} | Prix: <span class="fw-bold">${prix}</span>
                </div>
                <div class="small">${m.commentaire || ''}</div>
              </div>
              <div class="card-footer bg-transparent d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-outline-secondary" data-action="edit" data-id="${m.id}"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${m.id}"><i class="bi bi-trash"></i></button>
              </div>
            </div>
          `;
          listEl.appendChild(col);
        });
      }

      async function renderDocuments(materielId) {
        fields.docList.innerHTML = '<div class="text-muted small">Chargement des documents...</div>';
        try {
            const materiel = await api(`/api/materiels/${materielId}/relations`);
            const documents = materiel.documents || [];
            if (!documents.length) {
                fields.docList.innerHTML = '<div class="text-muted small">Aucun document.</div>';
                return;
            }
            fields.docList.innerHTML = '';
            documents.forEach(doc => {
                const li = document.createElement('div');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <a href="/api/documents/${doc.id}/download" target="_blank">${doc.nom_fichier}</a>
                    <button class="btn btn-sm btn-outline-danger" data-doc-id="${doc.id}"><i class="bi bi-trash"></i></button>
                `;
                li.querySelector('button').addEventListener('click', () => deleteDocument(doc.id, materielId));
                fields.docList.appendChild(li);
            });
        } catch (e) {
            fields.docList.innerHTML = '<div class="text-danger small">Erreur de chargement des documents.</div>';
        }
      }

      async function deleteDocument(docId, materielId) {
        if (!confirm('Voulez-vous vraiment supprimer ce document ?')) return;
        try {
            await api(`/api/documents/${docId}`, { method: 'DELETE' });
            await renderDocuments(materielId); // Refresh list
        } catch(e) {
            alert(`Erreur: ${e.message}`);
        }
      }

      function populateCategories() {
        const set = new Set();
        materiels.forEach(m => { if (m.categorie) set.add(m.categorie); });
        filterCat.innerHTML = '<option value="">Toutes catégories</option>';
        Array.from(set).sort().forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          filterCat.appendChild(opt);
        });
      }

      async function loadMateriels() {
        try {
          listEl.innerHTML = '<div class="col-12 text-center text-muted">Chargement...</div>';
          materiels = await api('/api/materiels') || [];
          populateCategories();
          render();
        } catch (e) {
          console.error(e);
          listEl.innerHTML = '<div class="col-12 text-danger">Erreur de chargement.</div>';
        }
      }

      function openModal(mat = null) {
        form.reset();
        formFeedback.textContent = '';
        fields.id.value = mat?.id || '';
        fields.titre.value = mat?.titre || '';
        fields.reference.value = mat?.reference || '';
        fields.designation.value = mat?.designation || '';
        fields.categorie.value = mat?.categorie || '';
        fields.fabricant.value = mat?.fabricant || '';
        fields.fournisseur.value = mat?.fournisseur || '';
        fields.remise_fournisseur.value = mat?.remise_fournisseur || '';
        fields.classe_materiel.value = mat?.classe_materiel || '';
        fields.prix_achat.value = mat?.prix_achat || '';
        fields.commentaire.value = mat?.commentaire || '';
        fields.commande_status.value = mat?.commande_status || 'A commander';
        fields.metier.value = mat?.metier || '';
        
        titleEl.textContent = mat ? `Modifier : ${mat.titre || mat.designation}` : 'Nouveau matériel';

        if (mat?.id) {
            renderDocuments(mat.id);
            fields.docUploadBtn.disabled = false;
        } else {
            fields.docList.innerHTML = '<div class="text-muted small">Veuillez d\'abord enregistrer le matériel pour ajouter des documents.</div>';
            fields.docUploadBtn.disabled = true;
        }

        if (modal) modal.show();
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
      }

      async function uploadDocument() {
        const materielId = fields.id.value;
        if (!materielId) {
            alert('Veuillez enregistrer le matériel avant de téléverser un document.');
            return;
        }
        const file = fields.docUploadInput.files[0];
        if (!file) {
            alert('Veuillez sélectionner un fichier.');
            return;
        }

        fields.docUploadBtn.disabled = true;
        fields.docUploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const base64 = await fileToBase64(file);
            const payload = {
                cible_type: 'Materiel',
                cible_id: materielId,
                nom_fichier: file.name,
                type_mime: file.type,
                base64: base64
            };
            await api('/api/documents', { method: 'POST', body: JSON.stringify(payload) });
            await renderDocuments(materielId); // Refresh list
            fields.docUploadInput.value = ''; // Clear input
        } catch (e) {
            alert(`Erreur de téléversement: ${e.message}`);
        } finally {
            fields.docUploadBtn.disabled = false;
            fields.docUploadBtn.innerHTML = 'Téléverser';
        }
      }

      async function saveMateriel() {
        formFeedback.textContent = '';
        const payload = {
          titre: fields.titre.value.trim(),
          reference: fields.reference.value.trim(),
          designation: fields.designation.value.trim(),
          categorie: fields.categorie.value.trim(),
          fabricant: fields.fabricant.value.trim(),
          fournisseur: fields.fournisseur.value.trim(),
          remise_fournisseur: fields.remise_fournisseur.value ? Number(fields.remise_fournisseur.value) : null,
          classe_materiel: fields.classe_materiel.value.trim(),
          prix_achat: fields.prix_achat.value ? Number(fields.prix_achat.value) : null,
          commentaire: fields.commentaire.value.trim(),
          commande_status: fields.commande_status.value,
          metier: fields.metier.value || null
        };

        if (!payload.titre || !payload.reference || !payload.designation) {
          formFeedback.textContent = 'Titre, Référence et désignation sont obligatoires.';
          return;
        }

        const id = fields.id.value;
        const url = id ? `/api/materiels/${id}` : '/api/materiels';
        const method = id ? 'PUT' : 'POST';
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sauvegarde...';
        try {
          const savedMateriel = await api(url, { method, body: JSON.stringify(payload) });
          if (modal) modal.hide();
          await loadMateriels();
        } catch (e) {
          formFeedback.textContent = e.message || 'Erreur lors de l’enregistrement.';
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Enregistrer';
        }
      }

      async function deleteMateriel(id) {
        if (!confirm('Supprimer ce matériel ? Cette action est irréversible.')) return;
        try {
          await api(`/api/materiels/${id}`, { method: 'DELETE' });
          await loadMateriels();
        } catch (e) {
          alert(e.message || 'Suppression impossible. Le matériel est peut-être lié à une intervention.');
        }
      }

      listEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        const mat = materiels.find(m => String(m.id) === String(id));
        if (action === 'edit') openModal(mat);
        if (action === 'delete') deleteMateriel(id);
      });

      document.getElementById('btn-add').addEventListener('click', () => openModal(null));
      fields.docUploadBtn.addEventListener('click', uploadDocument);
      saveBtn.addEventListener('click', saveMateriel);
      searchEl.addEventListener('input', render);
      filterCat.addEventListener('change', render);

      loadMateriels();
    });
  </script>
</body>
</html>
