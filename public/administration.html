<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    .dashboard-bg { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); min-height: 100vh; }
    .metric-card { background: linear-gradient(145deg, #f6f7fc, #eef2ff); border: none; border-radius: 18px; padding: 18px; box-shadow: 0 18px 30px rgba(41,53,108,0.14); display: flex; flex-direction: column; gap: 10px; color: #2c3350; height: 100%; }
    .metric-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.12); }
    .icon-blue { background: linear-gradient(135deg, #4da5ff, #3c68ff); }
    .icon-green { background: linear-gradient(135deg, #32d296, #0fa968); }
    .icon-orange { background: linear-gradient(135deg, #ffb347, #ff784b); }
    .icon-purple { background: linear-gradient(135deg, #9d7bff, #7451ff); }
    .metric-label { text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.08em; color: #6c7693; margin-bottom: 4px; }
    .metric-value { font-size: 2rem; font-weight: 700; line-height: 1; }
    .metric-sub { font-size: 0.95rem; font-weight: 600; color: #1b9b6e; }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>

  <main class="container mt-5">
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <div class="col">
        <div class="metric-card h-100">
          <div class="d-flex align-items-center gap-3">
            <div class="metric-icon icon-blue"><i class="bi bi-person-badge"></i></div>
            <div>
              <div class="metric-label">Clients</div>
              <div class="metric-value" id="adminClientsCount">-</div>
              <div class="metric-sub text-primary">Gestion clients</div>
            </div>
          </div>
          <div class="mt-auto">
            <a href="/clients.html" class="btn btn-outline-primary btn-sm">Ouvrir</a>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="metric-card h-100">
          <div class="d-flex align-items-center gap-3">
            <div class="metric-icon icon-purple"><i class="bi bi-file-earmark-text"></i></div>
            <div>
              <div class="metric-label">Contrats</div>
              <div class="metric-value" id="adminContratsCount">-</div>
              <div class="metric-sub text-primary">Sites liés</div>
            </div>
          </div>
          <div class="mt-auto">
            <a href="/contrats.html" class="btn btn-outline-primary btn-sm">Ouvrir</a>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="metric-card h-100">
          <div class="d-flex align-items-center gap-3">
            <div class="metric-icon icon-purple"><i class="bi bi-building"></i></div>
            <div>
              <div class="metric-label">Sites sous contrat</div>
              <div class="metric-value" id="adminSitesCount">-</div>
              <div class="metric-sub text-primary">Actifs / non actifs</div>
            </div>
          </div>
          <div class="mt-auto">
            <a href="/sites.html" class="btn btn-outline-primary btn-sm">Ouvrir</a>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="metric-card h-100">
          <div class="d-flex align-items-center gap-3">
            <div class="metric-icon icon-orange"><i class="bi bi-people-fill"></i></div>
            <div>
              <div class="metric-label">Agents</div>
              <div class="metric-value" id="adminAgentsCount">-</div>
              <div class="metric-sub text-warning-emphasis">Disponibles</div>
            </div>
          </div>
          <div class="mt-auto">
            <a href="/agents.html" class="btn btn-outline-warning btn-sm text-dark">Ouvrir</a>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="metric-card h-100">
          <div class="d-flex align-items-center gap-3">
            <div class="metric-icon icon-green"><i class="bi bi-receipt"></i></div>
            <div>
              <div class="metric-label">Factures</div>
              <div class="metric-value" id="adminFacturesCount">-</div>
              <div class="metric-sub text-success">Portefeuille</div>
            </div>
          </div>
          <div class="mt-auto">
            <a href="/factures.html" class="btn btn-outline-success btn-sm">Ouvrir</a>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="metric-card h-100">
          <div class="d-flex align-items-center gap-3">
            <div class="metric-icon icon-blue"><i class="bi bi-cash-coin"></i></div>
            <div>
              <div class="metric-label">Règlements</div>
              <div class="metric-value" id="adminReglementsCount">-</div>
              <div class="metric-sub text-primary">Encaissements</div>
            </div>
          </div>
          <div class="mt-auto">
            <a href="/factures.html" class="btn btn-outline-primary btn-sm">Ouvrir</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const setText = (id,val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      async function fetchCount(url) {
        try { const r = await fetch(url, { headers, credentials:'same-origin' }); const rows = r.ok? await r.json(): []; return Array.isArray(rows)? rows.length: 0; }
        catch { return 0; }
      }
      setText('adminClientsCount', await fetchCount('/api/clients'));
      setText('adminContratsCount', await fetchCount('/api/contrats'));
      // Sites sous contrat: actifs/non actifs
      try {
        const rSites = await fetch('/api/sites', { headers, credentials:'same-origin' });
        const rows = rSites.ok ? await rSites.json() : [];
        const sites = Array.isArray(rows) ? rows : [];
        const actifs = sites.filter(s => !s.date_fin || new Date(s.date_fin) >= new Date()).length;
        const inactifs = sites.length - actifs;
        setText('adminSitesCount', `${actifs} / ${sites.length}`);
        const sub = document.querySelector('#adminSitesCount')?.parentElement?.querySelector('.metric-sub');
        if (sub) sub.textContent = `${actifs} actifs · ${inactifs} non actifs`;
      } catch { setText('adminSitesCount', '-'); }

      setText('adminAgentsCount', await fetchCount('/api/agents'));
      setText('adminFacturesCount', await fetchCount('/api/factures'));
      setText('adminReglementsCount', await fetchCount('/api/reglements'));
    });
  </script>
</body>
</html>
