<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rendu Intervention (Impression)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <style>
    body { background: #f6f7fb; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .image-card img { border-radius: 12px; object-fit: cover; width: 100%; max-height: 240px; }
    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
    }
  </style>
</head>
<body>

  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1">Rendu d'intervention</h1>
        <div class="text-muted small">Intervention #<span id="intervention-id">—</span> • Demande #<span id="demande-id">—</span></div>
      </div>
      <div class="d-flex gap-2 no-print">
        <button class="btn btn-outline-secondary btn-sm" id="back-btn"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Imprimer</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Photos (Demande / Ticket / Site)</h2>
        <div class="row g-3" id="photos-list"></div>
        <div id="photos-empty" class="text-muted small">Aucune photo disponible.</div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Documents</h2>
        <ul class="list-group list-group-flush" id="docs-list"></ul>
        <div id="docs-empty" class="text-muted small">Aucun document trouvé.</div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Note en Markdown</h2>
        <div class="row g-3">
          <div class="col-md-6">
            <textarea id="note-md" class="form-control" rows="8" placeholder="Rédigez une note..."></textarea>
          </div>
          <div class="col-md-6">
            <div id="note-preview" class="p-3 border rounded bg-light" style="min-height: 200px;"><em class="text-muted">Prévisualisation...</em></div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(location.search);
      const interventionId = params.get('intervention_id') || params.get('id');
      const demandeId = params.get('demande_id');
      const token = localStorage.getItem('token');
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

      const set = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val || '—'; };
      set('intervention-id', interventionId);
      set('demande-id', demandeId);

      const photosList = document.getElementById('photos-list');
      const photosEmpty = document.getElementById('photos-empty');
      const docsList = document.getElementById('docs-list');
      const docsEmpty = document.getElementById('docs-empty');
      const noteMd = document.getElementById('note-md');
      const notePrev = document.getElementById('note-preview');

      const showPreview = () => {
        if (!notePrev) return;
        const txt = noteMd?.value || '';
        notePrev.innerHTML = txt ? marked.parse(txt) : '<em class="text-muted">Prévisualisation...</em>';
      };
      noteMd?.addEventListener('input', showPreview);
      showPreview();

      const backBtn = document.getElementById('back-btn');
      backBtn?.addEventListener('click', () => {
        if (document.referrer) history.back(); else location.href = 'intervention-view.html' + (interventionId ? `?id=${interventionId}` : '');
      });

      const addPhotoCard = (img) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4';
        col.innerHTML = `
          <div class="image-card p-2 border rounded h-100">
            <img src="/api/images/${img.id}/view" alt="${img.commentaire_image || img.nom_fichier || 'photo'}">
            <div class="mt-2 fw-semibold small">${img.nom_fichier || 'Photo'}</div>
            <div class="text-muted small">${img.commentaire_image || ''}</div>
            <div class="text-muted small">Source: ${img.cible_type || '-'} #${img.cible_id || ''}</div>
          </div>
        `;
        photosList?.appendChild(col);
      };

      const addDocItem = (doc) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${doc.nom_fichier || 'Document'}</div>
            <div class="text-muted small">${doc.nature || ''} • ${doc.cible_type || '-'} #${doc.cible_id || ''}</div>
          </div>
          <a class="btn btn-sm btn-outline-primary" href="/api/documents/${doc.id}/view" target="_blank"><i class="bi bi-eye"></i></a>
        `;
        docsList?.appendChild(li);
      };

      const fetchImages = async (type, id) => {
        if (!id) return [];
        try {
          const r = await fetch(`/api/images?cible_type=${encodeURIComponent(type)}&cible_id=${id}`, { headers });
          if (!r.ok) return [];
          const data = await r.json().catch(() => []);
          return Array.isArray(data) ? data.map(i => ({ ...i, cible_type: type, cible_id: id })) : [];
        } catch { return []; }
      };

      const fetchDocs = async (type, id) => {
        if (!id) return [];
        try {
          const r = await fetch(`/api/documents?cible_type=${encodeURIComponent(type)}&cible_id=${id}`, { headers });
          if (!r.ok) return [];
          const data = await r.json().catch(() => []);
          return Array.isArray(data) ? data.map(i => ({ ...i, cible_type: type, cible_id: id })) : [];
        } catch { return []; }
      };

      let ticketId = null;
      let siteId = null;
      // Charger relations pour trouver ticket/site
      try {
        if (interventionId) {
          const res = await fetch(`/api/interventions/${interventionId}/relations`, { headers });
          if (res.ok) {
            const rel = await res.json().catch(() => ({}));
            if (rel && rel.ticket) {
              ticketId = rel.ticket.id || rel.ticket.ticket_id;
              siteId = rel.ticket.site_id || siteId;
            }
            if (rel && rel.site) siteId = rel.site.id || rel.site.site_id || siteId;
          }
        }
      } catch (e) {
        console.warn('Relations intervention non chargées', e);
      }

      // Chargement des images : demande, ticket, site
      let images = [];
      images = images.concat(await fetchImages('DemandeClient', demandeId));
      images = images.concat(await fetchImages('Ticket', ticketId));
      images = images.concat(await fetchImages('Site', siteId));

      if (images.length) {
        photosEmpty?.classList.add('d-none');
        images.forEach(addPhotoCard);
      } else {
        photosEmpty?.classList.remove('d-none');
      }

      // Chargement documents : demande, site
      let docs = [];
      docs = docs.concat(await fetchDocs('DemandeClient', demandeId));
      docs = docs.concat(await fetchDocs('Site', siteId));
      if (docs.length) {
        docsEmpty?.classList.add('d-none');
        docs.forEach(addDocItem);
      } else {
        docsEmpty?.classList.remove('d-none');
      }
    });
  </script>
</body>
</html>
