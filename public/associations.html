<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Associations</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    .dashboard-bg { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); min-height: 100vh; }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>

  <main class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1>Associations</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAssociationModal"><i class="bi bi-plus-circle me-2"></i>Créer une association</button>
    </div>

    <div id="associations-grid" class="row g-3"></div>
  </main>

  <!-- Modals -->
  <div class="modal fade" id="createAssociationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Créer une nouvelle association</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/association-new.html" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewAssociationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Voir l'association</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="viewAssociationFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editAssociationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modifier l'association</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="editAssociationFrame" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const grid = document.getElementById('associations-grid');
      const token = localStorage.getItem('token');
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

      async function loadAssociations() {
        try {
          const res = await fetch('/api/associations', { headers });
          if (!res.ok) throw new Error('Failed to fetch associations');
          const associations = await res.json();
          renderAssociations(associations);
        } catch (error) {
          grid.innerHTML = '<div class="col-12"><div class="alert alert-danger">Erreur de chargement des associations.</div></div>';
        }
      }

      function renderAssociations(associations) {
        grid.innerHTML = '';
        if (!associations || associations.length === 0) {
          grid.innerHTML = '<div class="col-12"><p class="text-muted">Aucune association trouvée.</p></div>';
          return;
        }
        associations.forEach(assoc => {
          const col = document.createElement('div');
          col.className = 'col-12 col-md-6 col-lg-4';
          const address = [assoc.ligne1, assoc.code_postal, assoc.ville].filter(Boolean).join(', ');
          col.innerHTML = `
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">${assoc.titre}</h5>
                <h6 class="card-subtitle mb-2 text-muted">${assoc.email_comptabilite || 'Pas d\'email de compta'}</h6>
                <p class="card-text small">${address || 'Pas d\'adresse'}</p>
                <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewAssociationModal" data-id="${assoc.id}"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editAssociationModal" data-id="${assoc.id}"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${assoc.id}"><i class="bi bi-trash"></i></button>
              </div>
            </div>
          `;
          grid.appendChild(col);
        });
      }

      // Modal event listeners
      const viewModal = document.getElementById('viewAssociationModal');
      viewModal.addEventListener('show.bs.modal', e => {
        const id = e.relatedTarget.getAttribute('data-id');
        e.currentTarget.querySelector('iframe').src = `/association-view.html?id=${id}`;
      });

      const editModal = document.getElementById('editAssociationModal');
      editModal.addEventListener('show.bs.modal', e => {
        const id = e.relatedTarget.getAttribute('data-id');
        e.currentTarget.querySelector('iframe').src = `/association-edit.html?id=${id}`;
      });

      [document.getElementById('createAssociationModal'), editModal].forEach(modal => {
        modal.addEventListener('hidden.bs.modal', loadAssociations);
      });
      
      // Delete button listener
      grid.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
          const btn = e.target.closest('.delete-btn');
          const id = btn.getAttribute('data-id');
          if (confirm('Voulez-vous vraiment supprimer cette association ?')) {
            try {
              const res = await fetch(`/api/associations/${id}`, { method: 'DELETE', headers });
              if (!res.ok) throw new Error('La suppression a échoué');
              loadAssociations();
            } catch (error) {
              alert(error.message);
            }
          }
        }
      });

      loadAssociations();
    });
  </script>
</body>
</html>
