<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Tickets</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Custom -->
  <link href="/custom.css?v=1" rel="stylesheet">

  <!-- Navigation -->
  <script src="/nav.js?v=1"></script>

  <style>
    .ticket-card { min-height: 100%; }
    .section-title { margin-top: 2rem; margin-bottom: 1rem; }
    .table-card { border-radius: 12px; box-shadow: 0 8px 18px rgba(0,0,0,0.05); }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1><a href="/dashboard.html"><img src="/logo_logicielle.png" alt="" style="height:40px;margin-right:10px;"></a></h1>
    <div class="d-flex align-items-center">
      <span class="me-2">Bienvenue, <span id="logged-in-user-email"></span></span>
      <button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
        Menu
      </button>
    </div>
  </header>

  <!-- OFFCANVAS MENU -->
  <div class="offcanvas offcanvas-end" id="offcanvasNavbar">
    <div class="offcanvas-header">
      <h5>Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>

    <div class="offcanvas-body">
      <ul class="navbar-nav flex-grow-1">
        <li><a class="nav-link" href="/dashboard.html">Dashboard</a></li>
        <li><a class="nav-link" href="/agents.html">Agents</a></li>
        <li><a class="nav-link" href="/sites.html">Sites</a></li>
        <li><a class="nav-link active" href="/tickets.html">Tickets</a></li>
        <li><a class="nav-link" href="/interventions.html">Interventions</a></li>
        <li><a class="nav-link" href="/rendezvous.html">Rendez-vous</a></li>
        <li><a class="nav-link" href="/achats.html">Achats</a></li>
        <li><a class="nav-link" href="/factures.html">Factures</a></li>
        <li><a class="nav-link" id="logout-link" href="#">Déconnexion</a></li>
      </ul>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Tickets</h1>
      <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#demandesClientModal">
        <i class="bi bi-inbox me-2"></i>Demandes clients
      </button>
    </div>

    <!-- FILTRES -->
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <input type="text" id="ticket-search" class="form-control" placeholder="Rechercher par titre ou ID…">
      <select id="ticket-status-filter" class="form-select">
        <option value="">Tous les États</option>
        <option value="Pas_commence">Pas commencé</option>
        <option value="En_cours">En cours</option>
        <option value="Termine">Terminé</option>
      </select>
      <select id="ticket-responsible-filter" class="form-select">
        <option value="">Tous les responsables</option>
      </select>
      <input type="date" id="ticket-date-start" class="form-control">
      <input type="date" id="ticket-date-end" class="form-control">
    </div>

    <!-- TICKETS OUVERTS -->
    <h2 class="section-title">Tickets ouverts</h2>
    <div id="open-tickets-container" class="row g-4"></div>

    <!-- TICKETS FERMÉS -->
    <h2 class="section-title">Tickets terminés</h2>
    <div class="card table-card mb-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th><th>Titre</th><th>Description</th><th>Etat</th><th>Site</th><th>Responsable</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="closed-tickets-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </main>

  <!-- MODALES (inchangées) -->
  <!-- ... (tes modales comme dans ton fichier original) ... -->

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ⭐ NOUVEAU SCRIPT UNIFIÉ ET CORRIGÉ ⭐ -->
  <script>
  document.addEventListener("DOMContentLoaded", async function () {

    /* ----------------------
       VARIABLES / HELPERS
    ------------------------ */
    const norm = s => (s || "").normalize("NFD").replace(/\p{Diacritic}+/gu, "").toLowerCase();

    const state = {
      tickets: [],
      sites: new Map(),
      agents: new Map(),
      isAdmin: false
    };

    const openContainer = document.getElementById("open-tickets-container");
    const closedBody = document.getElementById("closed-tickets-table-body");

    const searchInput = document.getElementById("ticket-search");
    const statusFilter = document.getElementById("ticket-status-filter");
    const responsibleFilter = document.getElementById("ticket-responsible-filter");

    /* ----------------------
       AUTH / ROLES
    ------------------------ */
    try {
      const token = localStorage.getItem("token");
      if (token) {
        const payload = JSON.parse(atob(token.split(".")[1]));
        if (payload.roles?.includes("ROLE_ADMIN")) state.isAdmin = true;
        document.getElementById("logged-in-user-email").textContent = payload.email;
      }
    } catch {}

    /* ----------------------
       FETCH SITES & AGENTS
    ------------------------ */
    async function fetchSites() {
      const res = await fetch("/api/sites");
      const data = res.ok ? await res.json() : [];
      state.sites = new Map(data.map(s => [String(s.id), s.nom_site || `Site #${s.id}`]));
    }

    async function fetchAgents() {
      const res = await fetch("/api/agents");
      const data = res.ok ? await res.json() : [];
      state.agents = new Map(data.map(a => [String(a.matricule), `${a.nom} ${a.prenom}`]));

      // mise à jour du filtre "responsable"
      responsibleFilter.innerHTML = `<option value="">Tous les responsables</option>`;
      state.agents.forEach((label, mat) => {
        responsibleFilter.innerHTML += `<option value="${mat}">${label} (${mat})</option>`;
      });
    }

    /* ----------------------
       FETCH TICKETS
    ------------------------ */
    async function fetchTickets() {
      const res = await fetch("/api/tickets");
      const data = res.ok ? await res.json() : [];
      state.tickets = data.map(t => ({
        id: String(t.id),
        titre: t.titre || "(Sans titre)",
        description: t.description || "",
        etat: t.etat || "En_cours",
        responsable: t.responsable || null,
        site_id: t.site_id || null,
        date_debut: t.date_debut || null,
        date_fin: t.date_fin || null
      }));
    }

    /* ----------------------
       RENDERING
    ------------------------ */
    function render() {
      const term = norm(searchInput.value);
      const status = statusFilter.value;
      const resp = responsibleFilter.value;

      const filtered = state.tickets.filter(t => {
        return (
          (!term || norm(t.titre).includes(term) || norm(t.description).includes(term) || t.id.includes(term)) &&
          (!status || t.etat === status) &&
          (!resp || t.responsable === resp)
        );
      });

      const open = filtered.filter(t => t.etat !== "Termine");
      const closed = filtered.filter(t => t.etat === "Termine");

      /* Tickets ouverts */
      openContainer.innerHTML = open.length ? "" : `<p class="text-muted">Aucun ticket ouvert trouvé.</p>`;

      open.forEach(t => {
        openContainer.innerHTML += `
          <div class="col">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h5>${t.titre}</h5>
                <p>${t.description}</p>
                <small>ID : ${t.id}</small>
              </div>
            </div>
          </div>`;
      });

      /* Tickets terminés */
      closedBody.innerHTML = closed.length ? "" :
        `<tr><td class="text-center text-muted" colspan="7">Aucun ticket terminé trouvé.</td></tr>`;

      closed.forEach(t => {
        closedBody.innerHTML += `
          <tr>
            <td>${t.id}</td>
            <td>${t.titre}</td>
            <td>${t.description}</td>
            <td>${t.etat}</td>
            <td>${state.sites.get(String(t.site_id)) || "N/A"}</td>
            <td>${state.agents.get(String(t.responsable)) || "N/A"}</td>
            <td><button class="btn btn-sm btn-info" data-id="${t.id}" data-bs-toggle="modal" data-bs-target="#viewTicketModal">Voir</button></td>
          </tr>`;
      });
    }

    /* ----------------------
       EVENT LISTENERS
    ------------------------ */
    searchInput.addEventListener("input", render);
    statusFilter.addEventListener("change", render);
    responsibleFilter.addEventListener("change", render);

    /* ----------------------
       SEQUENCE DE CHARGEMENT
    ------------------------ */
    await Promise.all([
      fetchSites(),
      fetchAgents(),
      fetchTickets()
    ]);

    render(); // affichage final avec données

  });
  </script>

</body>
</html>
