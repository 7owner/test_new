<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Demandes Client - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    .sort-arrow {
      display: inline-block;
      width: 0;
      height: 0;
      margin-left: 5px;
      vertical-align: middle;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 4px solid #000; /* Default arrow up */
    }
    .sort-arrow.asc {
      border-bottom: 4px solid #000;
      border-top: none;
    }
    .sort-arrow.desc {
      border-top: 4px solid #000;
      border-bottom: none;
    }
  </style>
</head>
<body>
    <header class="header d-flex justify-content-between align-items-center mb-4">
    <h1>  <a href="/dashboard.html"> <img src="/logo_logicielle.png" alt="" style="height: 40px; vertical-align: middle; margin-right: 10px;"></a></h1>
    <div id="user-info-container" class="d-flex align-items-center">
      <span class="me-2">Bienvenue, <span id="logged-in-user-email"></span></span>
      <button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
        Menu
      </button>
    </div>
  </header>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard.html"><i class="bi bi-house-door-fill me-2"></i>Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/agents.html"><i class="bi bi-people-fill me-2"></i>Agents</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/sites.html"><i class="bi bi-building-fill me-2"></i>Sites</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="/tickets.html"><i class="bi bi-tools me-2"></i>Tickets</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/interventions.html"><i class="bi bi-tools me-2"></i>Interventions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/rendezvous.html"><i class="bi bi-calendar-event-fill me-2"></i>Rendez-vous</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/achats.html"><i class="bi bi-cart-fill me-2"></i>Achats</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/factures.html"><i class="bi bi-receipt-cutoff me-2"></i>Factures</a>
        </li>
        <li class="nav-item">
      <a class="nav-link" href="#" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a>
        </li>
      </ul>
    </div>
  </div>
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h1 class="mb-4">Demandes Client - Administration</h1>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Filtres</span>
        <button id="show-deleted-btn" class="btn btn-outline-danger btn-sm">Voir demandes supprimées</button>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="filterClient" class="form-label">Filtrer par Client:</label>
            <input type="text" id="filterClient" class="form-control" placeholder="Nom du client ou email">
          </div>
          <div class="col-md-6">
            <label for="filterStatus" class="form-label">Filtrer par Statut:</label>
            <select id="filterStatus" class="form-select">
              <option value="">Tous</option>
              <option value="En cours de traitement">En cours de traitement</option>
              <option value="Traité">Traité</option>
              <option value="Rejeté">Rejeté</option>
              <option value="Annulé">Annulé</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="demandsContainer" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <!-- Demandes will be loaded here as cards -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/nav.js?v=2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const token = localStorage.getItem('token');
  if (!token) { location.href = '/login.html'; return; }

  let roles = [];
  try { const p = JSON.parse(atob(token.split('.')[1])); roles = Array.isArray(p.roles)?p.roles:[]; } catch {}
  if (!roles.includes('ROLE_ADMIN')) { alert('Accès admin requis'); location.href = '/dashboard.html'; return; }


  const demandsContainer = document.getElementById('demandsContainer');
  const filterClientInput = document.getElementById('filterClient');
  const filterStatusSelect = document.getElementById('filterStatus');

  let currentFilter = { client: '', status: '' };
  let currentSort = { column: "id", direction: "desc" };

    const statusSel = ['En cours de traitement', 'Traité', 'En attente', 'Annulé'];


  async function fetchJSON(url, opts = {}) {
    const res = await fetch(url, {
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      ...opts
    });

    const ct = res.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await res.json() : null;

    if (!res.ok) throw new Error(body?.error || res.statusText);
    return body;
  }


  function createDemandCard(d) {
    const col = document.createElement("div");
    col.className = "col";

    const badgeClass = (() => {
      switch ((d.status || "").toLowerCase()) {
        case "en cours de traitement": return "bg-info";
        case "traité": return "bg-success";
        case "en attente": return "bg-secondary";
        case "annulé": return "bg-warning text-dark";
        default: return "bg-light text-dark";
      }
    })();

    col.innerHTML = `
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">
            Demande #${d.id} <span class="badge ${badgeClass}">${d.status}</span>
          </h5>
          <h6 class="card-subtitle mb-2 text-muted">${d.nom_client} (${d.representant_email})</h6>
          <p><strong>Site :</strong> ${d.nom_site || "N/A"}</p>
          <p>${d.description || "Pas de description."}</p>
          ${d.commentaire ? `<p class="text-danger"><strong>Commentaire :</strong> ${d.commentaire}</p>` : ""}
          <small class="text-muted">Créée le : ${new Date(d.created_at).toLocaleDateString()}</small>
        </div>

        <div class="card-footer d-flex flex-wrap justify-content-end">
          ${statusSel.map(s => `
            <button class="btn btn-sm btn-outline-primary me-1 mb-1 status-btn" data-id="${d.id}" data-status="${s}">
              ${s}
            </button>`).join("")}

          <button class="btn btn-sm btn-success mb-1 convert-btn" data-id="${d.id}" ${d.status === "Traité" ? "disabled" : ""}>
            Convertir en ticket
          </button>

          <button class="btn btn-sm btn-danger mb-1 delete-btn" data-id="${d.id}">
            Supprimer
          </button>
        </div>
      </div>
    `;

    // --- EVENTS ---
    col.querySelectorAll(".status-btn").forEach(btn => {
      btn.addEventListener("click", () => updateStatus(d, btn.dataset.status));
    });

    col.querySelector(".convert-btn").addEventListener("click", () => convertToTicket(d.id));
    col.querySelector(".delete-btn").addEventListener("click", () => openDeleteModal(d.id));

    return col;
  }


  async function updateStatus(d, status) {
    if (["Rejeté", "Annulé"].includes(status)) {
      currentDemandId = d.id;
      currentDemandStatus = status;
      if (commentTextArea) commentTextArea.value = d.commentaire || "";
      commentModal.show();
      return;
    }

    await fetchJSON(`/api/demandes_client/${d.id}/status`, {
      method: "PUT",
      body: JSON.stringify({ status })
    });

    load();
  }


  async function convertToTicket(id) {
    const r = await fetchJSON(`/api/demandes_client/${id}/convert-to-ticket`, { method: "POST" });
    alert("Ticket créé : #" + r.ticket?.id);
    load();
  }


  let deleteDemandModal = new bootstrap.Modal(document.getElementById("deleteDemandeClientModal"));
  let commentModal = new bootstrap.Modal(document.getElementById("commentModal"));
  let currentDemandId = null;
  let currentDemandStatus = null;
  const commentTextArea = document.getElementById("comment-text");


  document.getElementById("saveCommentBtn").addEventListener("click", async () => {
    const comment = document.getElementById("comment-text").value.trim();
    if (!comment) return alert("Le commentaire est obligatoire.");

    await fetchJSON(`/api/demandes_client/${currentDemandId}/status`, {
      method: "PUT",
      body: JSON.stringify({ status: currentDemandStatus, commentaire: comment })
    });

    commentModal.hide();
    load();
  });


  function openDeleteModal(id) {
    currentDemandId = id;
    deleteDemandModal.show();
  }

  document.getElementById("confirm-delete-demand-btn").addEventListener("click", async () => {
    const justification = document.getElementById("delete-demand-justification").value.trim();
    if (!justification) return alert("La justification est obligatoire.");

    await fetchJSON(`/api/demandes_client/${currentDemandId}`, {
      method: "DELETE",
      body: JSON.stringify({ justification })
    });

    deleteDemandModal.hide();
    load();
  });


  // Deleted demandes (audit log)
  const deletedModal = new bootstrap.Modal(document.getElementById("deletedDemandesModal"));
  const deletedBody = document.getElementById("deleted-demandes-body");
  document.getElementById("show-deleted-btn").addEventListener("click", async () => {
    deletedBody.innerHTML = "<p class='text-muted'>Chargement…</p>";
    try {
      const rows = await fetchJSON("/api/demandes_client/deleted");
      if (!rows || !rows.length) {
        deletedBody.innerHTML = "<p class='text-muted'>Aucune demande supprimée.</p>";
        deletedModal.show();
        return;
      }
      const table = document.createElement("table");
      table.className = "table table-striped";
      table.innerHTML = `
        <thead>
          <tr>
            <th>ID</th><th>Commentaire</th><th>Supprimé par</th><th>Date</th><th>Client</th><th>Site</th><th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td>${r.id || ''}</td>
              <td>${r.justification || ''}</td>
              <td>${r.actor_email || ''}</td>
              <td>${r.updated_at ? new Date(r.updated_at).toLocaleString() : ''}</td>
              <td>${r.nom_client || ''}</td>
              <td>${r.nom_site || ''}</td>
              <td><button class="btn btn-sm btn-success restore-btn" data-id="${r.id}">Restaurer</button></td>
            </tr>
          `).join('')}
        </tbody>
      `;
      deletedBody.innerHTML = "";
      deletedBody.appendChild(table);
      deletedBody.querySelectorAll(".restore-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.currentTarget.dataset.id;
          try {
            await fetchJSON(`/api/demandes_client/${id}/restore`, { method:'POST' });
            alert(`Demande #${id} restaurée`);
            deletedModal.hide();
            load();
          } catch(err) {
            alert(err.message);
          }
        });
      });
      deletedModal.show();
    } catch (e) {
      deletedBody.innerHTML = `<p class="text-danger">Erreur: ${e.message}</p>`;
      deletedModal.show();
    }
  });

  async function load() {
    try {
      demandsContainer.innerHTML = "<p class='text-muted'>Chargement…</p>";

      let url = "/api/demandes_client?";
      if (currentFilter.client) url += `client=${encodeURIComponent(currentFilter.client)}&`;
      if (currentFilter.status) url += `status=${encodeURIComponent(currentFilter.status)}&`;
      url += `sort=${currentSort.column},${currentSort.direction}`;

      let data = await fetchJSON(url);
      // Masquer les demandes déjà converties en ticket
      data = (data || []).filter(d => !d.ticket_id);

      demandsContainer.innerHTML = "";
      data.forEach(d => demandsContainer.appendChild(createDemandCard(d)));

    } catch (err) {
      console.error(err);
      demandsContainer.innerHTML = `<p class="text-danger">Erreur : ${err.message}</p>`;
    }
  }


  filterClientInput.addEventListener("input", () => {
    currentFilter.client = filterClientInput.value;
    load();
  });

  filterStatusSelect.addEventListener("change", () => {
    currentFilter.status = filterStatusSelect.value;
    load();
  });


  load();

});
</script>

  <!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">Ajouter un commentaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="comment-text" class="col-form-label">Commentaire:</label>
            <textarea class="form-control" id="comment-text" rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="saveCommentBtn">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Demand Modal -->
<div class="modal fade" id="deleteDemandeClientModal" tabindex="-1" aria-labelledby="deleteDemandeClientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDemandeClientModalLabel">Justification de la suppression</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="delete-demand-form">
          <div class="mb-3">
            <label for="delete-demand-justification" class="col-form-label">Veuillez fournir une justification pour la suppression de cette demande client :</label>
            <textarea class="form-control" id="delete-demand-justification" rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-demand-btn">Confirmer la suppression</button>
      </div>
    </div>
  </div>
</div>

<!-- Deleted demandes Modal -->
<div class="modal fade" id="deletedDemandesModal" tabindex="-1" aria-labelledby="deletedDemandesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deletedDemandesModalLabel">Demandes supprimées</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="deleted-demandes-body">
      </div>
    </div>
  </div>
</div>
</body>
</html>
