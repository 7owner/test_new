<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Demandes Client - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    .sort-arrow {
      display: inline-block;
      width: 0;
      height: 0;
      margin-left: 5px;
      vertical-align: middle;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 4px solid #000; /* Default arrow up */
    }
    .sort-arrow.asc {
      border-bottom: 4px solid #000;
      border-top: none;
    }
    .sort-arrow.desc {
      border-top: 4px solid #000;
      border-bottom: none;
    }
  </style>
</head>
<body>
    <header class="header d-flex justify-content-between align-items-center mb-4">
    <h1>  <a href="/dashboard.html"> <img src="/logo_logicielle.png" alt="" style="height: 40px; vertical-align: middle; margin-right: 10px;"></a></h1>
    <div id="user-info-container" class="d-flex align-items-center">
      <span class="me-2">Bienvenue, <span id="logged-in-user-email"></span></span>
      <button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
        Menu
      </button>
    </div>
  </header>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard.html"><i class="bi bi-house-door-fill me-2"></i>Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/agents.html"><i class="bi bi-people-fill me-2"></i>Agents</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/sites.html"><i class="bi bi-building-fill me-2"></i>Sites</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="/tickets.html"><i class="bi bi-tools me-2"></i>Tickets</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/interventions.html"><i class="bi bi-tools me-2"></i>Interventions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/rendezvous.html"><i class="bi bi-calendar-event-fill me-2"></i>Rendez-vous</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/achats.html"><i class="bi bi-cart-fill me-2"></i>Achats</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/factures.html"><i class="bi bi-receipt-cutoff me-2"></i>Factures</a>
        </li>
        <li class="nav-item">
      <a class="nav-link" href="#" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a>
        </li>
      </ul>
    </div>
  </div>
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h1 class="mb-4">Demandes Client - Administration</h1>

    <div class="card mb-4">
      <div class="card-header">Filtres</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="filterClient" class="form-label">Filtrer par Client:</label>
            <input type="text" id="filterClient" class="form-control" placeholder="Nom du client ou email">
          </div>
          <div class="col-md-6">
            <label for="filterStatus" class="form-label">Filtrer par Statut:</label>
            <select id="filterStatus" class="form-select">
              <option value="">Tous</option>
              <option value="En cours de traitement">En cours de traitement</option>
              <option value="Traité">Traité</option>
              <option value="Rejeté">Rejeté</option>
              <option value="Annulé">Annulé</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div id="demandsContainer" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <!-- Demandes will be loaded here as cards -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/nav.js?v=2"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token'); // Use jwtToken as per nav.js
    if (!token) { location.href = '/login.html'; return; }
    let roles = [];
    try { const p = JSON.parse(atob(token.split('.')[1])); roles = Array.isArray(p.roles)?p.roles:[]; } catch {}
    if (!roles.includes('ROLE_ADMIN')) { alert('Accès admin requis'); location.href = '/dashboard.html'; return; }

    const demandsContainer = document.getElementById('demandsContainer');
    const filterClientInput = document.getElementById('filterClient');
    const filterStatusSelect = document.getElementById('filterStatus');
    const tableHeaders = document.querySelectorAll('th[data-sort]'); // Keep for sorting logic, even if not visually present

    let currentSort = { column: 'id', direction: 'desc' }; // Default sort
    let currentFilter = { client: '', status: '' };

    const statusSel = ['En cours de traitement', 'Traité', 'Rejeté', 'Annulé'];

    async function fetchJSON(url, opts) {
      const res = await fetch(url, Object.assign({ headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token } }, opts||{}));
      const ct = res.headers.get('content-type')||'';
      const body = ct.includes('application/json') ? await res.json() : null;
      if (!res.ok) throw new Error((body && body.error) || res.statusText);
      return body;
    }

    // Comment Modal elements
    const commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
    const commentTextArea = document.getElementById('comment-text');
    const saveCommentBtn = document.getElementById('saveCommentBtn');
    let currentDemandId = null;
    let currentDemandStatus = null;

    saveCommentBtn.addEventListener('click', async () => {
      const comment = commentTextArea.value.trim();
      if (!comment) {
        alert('Le commentaire est obligatoire pour ce statut.');
        return;
      }
      try {
        await fetchJSON(`/api/demandes_client/${currentDemandId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ status: currentDemandStatus, commentaire: comment })
        });
        commentModal.hide();
        await load();
      } catch(err) {
        alert(err.message);
      }
    });

    function createDemandCard(d) {
      const col = document.createElement('div');
      col.className = 'col';
      const card = document.createElement('div');
      card.className = 'card h-100 shadow-sm';
      
      const badgeClass = (s => {
        switch(String(s || '').toLowerCase()) {
          case 'en cours de traitement': return 'bg-info';
          case 'traité': return 'bg-success';
          case 'rejeté': return 'bg-danger';
          case 'annulé': return 'bg-warning text-dark';
          default: return 'bg-light text-dark';
        }
      })(d.status);

      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">Demande #${d.id} <span class="badge ${badgeClass}">${String(d.status || 'En cours de traitement')}</span></h5>
          <h6 class="card-subtitle mb-2 text-muted">${d.nom_client || 'N/A'} (${d.representant_email || 'N/A'})</h6>
          <p class="card-text mb-1"><strong>Site:</strong> ${d.nom_site || 'N/A'} (ID: ${d.site_id || '-'})</p>
          <p class="card-text">${d.description || 'Pas de description.'}</p>
          ${d.commentaire ? `<p class="card-text text-danger"><strong>Commentaire:</strong> ${d.commentaire}</p>` : ''} <!-- Display comment if exists -->
          <small class="text-muted">Créée le: ${new Date(d.created_at).toLocaleDateString()}</small>
        </div>
        <div class="card-footer bg-transparent border-top-0 d-flex flex-wrap justify-content-end">
          ${statusSel.map(s => `<button class="btn btn-sm btn-outline-primary me-1 mb-1 status-btn" data-id="${d.id}" data-status="${s}">${s}</button>`).join('')}
          <button class="btn btn-sm btn-success mb-1 convert-btn" data-id="${d.id}">Convertir en ticket</button>
        </div>
      `;

      card.querySelectorAll('.status-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          const status = e.target.dataset.status;

          if (status === 'Rejeté' || status === 'Annulé') {
            currentDemandId = id;
            currentDemandStatus = status;
            commentTextArea.value = d.commentaire || ''; // Pre-fill if comment already exists
            commentModal.show();
          } else {
            try {
              await fetchJSON(`/api/demandes_client/${id}/status`, { method:'PUT', body: JSON.stringify({ status: status }) });
              await load();
            } catch(err){ alert(err.message); }
          }
        });
      });
      card.querySelector('.convert-btn').addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        try {
          const r = await fetchJSON(`/api/demandes_client/${id}/convert-to-ticket`, { method:'POST' });
          alert('Ticket créé: #' + (r.ticket && r.ticket.id));
          await load();
        } catch(err) { alert(err.message); }
      });
      col.appendChild(card);
      return col;
    }

    async function load() {
      demandsContainer.innerHTML='';
      let url = '/api/demandes_client?';
      if (currentFilter.client) {
        url += `client=${encodeURIComponent(currentFilter.client)}&`;
      }
      if (currentFilter.status) {
        url += `status=${encodeURIComponent(currentFilter.status)}&`;
      }
      url += `sort=${currentSort.column}&direction=${currentSort.direction}`;

      try {
        let data = await fetchJSON(url);
        if (currentFilter.status === '') { // If filter is 'Tous', hide 'Traité'
            data = data.filter(d => d.status !== 'Traité');
        }

        if (data.length === 0) {
          demandsContainer.innerHTML = '<p class="text-muted">Aucune demande client à afficher.</p>';
        } else {
          data.forEach(d => demandsContainer.appendChild(createDemandCard(d)));
        }
      } catch(e) { console.error(e); alert('Chargement impossible: ' + e.message); }
    }

    filterClientInput.addEventListener('input', () => {
      currentFilter.client = filterClientInput.value;
      load();
    });

    filterStatusSelect.addEventListener('change', () => {
      currentFilter.status = filterStatusSelect.value;
      load();
    });

    // Sorting logic for cards (optional, can be removed if not needed for cards)
    // For now, keeping it but it won't visually update arrows on cards
    tableHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const column = header.dataset.sort;
        if (currentSort.column === column) {
          currentSort.direction = (currentSort.direction === 'asc' ? 'desc' : 'asc');
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }
        // Visual update for sort arrows is not directly applicable to cards
        // If needed, implement a different visual feedback for card sorting
        load();
      });
    });

    load();
  });
  </script>
  <!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">Ajouter un commentaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="comment-text" class="col-form-label">Commentaire:</label>
            <textarea class="form-control" id="comment-text" rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="saveCommentBtn">Enregistrer</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>