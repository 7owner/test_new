<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du site</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
</head>
<body>
  <header class="header d-flex justify-content-between align-items-center mb-4">
    <h1><a href="/dashboard.html"><img src="/logo_logicielle.png" alt="Logo" style="height: 40px; vertical-align: middle; margin-right: 10px;"></a></h1>
    <div id="user-info-container" class="d-flex align-items-center">
      <span class="me-2">Bienvenue, <span id="logged-in-user-email"></span></span>
      <button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">Menu</button>
    </div>
  </header>

  <main class="container mt-5">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="sites.html">Gestion des Sites</a></li>
        <li class="breadcrumb-item active" aria-current="page">Détails</li>
      </ol>
    </nav>
    <h1 class="mb-4">Détails du site: <span id="site-name"></span></h1>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Informations générales</h2>
        <p><strong>ID:</strong> <span id="view_id"></span></p>
        <p><strong>Nom du Site:</strong> <span id="view_nom_site"></span></p>
        <p><strong>Adresse ID:</strong> <span id="view_adresse_id"></span></p>
        <p><strong>Commentaire:</strong> <span id="view_commentaire"></span></p>
        <p><strong>Statut:</strong> <span id="view_statut"></span></p>
        <p><strong>Ticket Ouvert:</strong> <span id="view_ticket"></span></p>
        <p><strong>Date Début:</strong> <span id="view_date_debut"></span></p>
        <p><strong>Date Fin:</strong> <span id="view_date_fin"></span></p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Tickets associés</h2>
        <div id="tickets-list"></div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-3">Responsables</h2>
        <div id="site-responsables" class="mb-2"></div>
        <div class="d-flex gap-2 d-none" id="site-resp-actions">
          <input class="form-control form-control-sm" id="site-resp-matricule" placeholder="Matricule (Chef/Admin)">
          <button class="btn btn-sm btn-outline-primary" id="site-add-resp-btn"><i class="bi bi-person-plus me-1"></i>Ajouter</button>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-3">Agents assignés</h2>
        <div id="site-agents" class="mb-2"></div>
        <div class="d-flex gap-2 d-none" id="site-agent-actions">
          <input class="form-control form-control-sm" id="site-agent-matricule" placeholder="Matricule agent">
          <button class="btn btn-sm btn-outline-primary" id="site-add-agent-btn"><i class="bi bi-person-plus me-1"></i>Assigner</button>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="sites.html" class="btn btn-secondary">Retour à la liste</a>
      <a href="site-edit.html" class="btn btn-primary" id="edit-site-btn"><i class="bi bi-pencil me-2"></i>Modifier le site</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const qp = new URLSearchParams(location.search);
      const siteId = qp.get('id');
      const token = localStorage.getItem('token');
      const headers = token? { 'Authorization': `Bearer ${token}` } : {};
      const isAdmin = (()=>{ try{ const p = token? JSON.parse(atob(token.split('.')[1])):null; return Array.isArray(p?.roles)&&p.roles.includes('ROLE_ADMIN'); } catch { return false; } })();
      try {
        const r = await fetch(`/api/sites/${siteId}/relations`, { headers, credentials:'same-origin' });
        const data = await r.json(); if (!r.ok) throw new Error(data && data.error || `HTTP ${r.status}`);
        const s = data.site || {};
        document.getElementById('site-name').textContent = s.nom_site || '';
        const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v||''; };
        set('view_id', s.id); set('view_nom_site', s.nom_site); set('view_adresse_id', s.adresse_id); set('view_commentaire', s.commentaire); set('view_statut', s.statut); set('view_ticket', (data.tickets && data.tickets.length)? data.tickets.length : 0); set('view_date_debut', s.date_debut); set('view_date_fin', s.date_fin);
        const tl = document.getElementById('tickets-list'); tl.innerHTML=''; (data.tickets||[]).forEach(t=>{ const el=document.createElement('div'); el.className='small'; el.innerHTML=`<a href="ticket-view.html?id=${t.id}">#${t.id} — ${t.titre||''}</a>`; tl.appendChild(el); }); if (!tl.innerHTML) tl.innerHTML='<span class="text-muted">Aucun ticket.</span>';
        const respEl = document.getElementById('site-responsables'); respEl.innerHTML=''; (data.responsables||[]).forEach(x=>{ const el=document.createElement('div'); el.className='small'; el.textContent = `${x.agent_matricule || ''} ${x.role? '('+x.role+')':''}`; respEl.appendChild(el); }); if(!respEl.innerHTML) respEl.innerHTML='<span class="text-muted">Aucun responsable.</span>';
        const agentsEl = document.getElementById('site-agents'); agentsEl.innerHTML=''; (data.agents_assignes||[]).forEach(x=>{ const el=document.createElement('div'); el.className='small'; el.textContent = x.agent_matricule; agentsEl.appendChild(el); }); if (!agentsEl.innerHTML) agentsEl.innerHTML='<span class="text-muted">Aucun agent assigné.</span>';
        if (isAdmin) {
          document.getElementById('site-resp-actions').classList.remove('d-none');
          document.getElementById('site-agent-actions').classList.remove('d-none');
          document.getElementById('site-add-resp-btn').onclick = async ()=>{
            const m = document.getElementById('site-resp-matricule').value.trim(); if (!m) return alert('Matricule requis');
            const rr = await fetch(`/api/sites/${siteId}/responsables`, { method:'POST', credentials:'same-origin', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body: JSON.stringify({ agent_matricule:m }) });
            const jd = await rr.json().catch(()=>({})); if (!rr.ok) return alert(jd.error||`HTTP ${rr.status}`); location.reload(); };
          document.getElementById('site-add-agent-btn').onclick = async ()=>{
            const m = document.getElementById('site-agent-matricule').value.trim(); if (!m) return alert('Matricule requis');
            const rr = await fetch(`/api/sites/${siteId}/agents`, { method:'POST', credentials:'same-origin', headers:{ 'Content-Type':'application/json', ...(token?{ 'Authorization':`Bearer ${token}` }:{}) }, body: JSON.stringify({ agent_matricule:m }) });
            const jd = await rr.json().catch(()=>({})); if (!rr.ok) return alert(jd.error||`HTTP ${rr.status}`); location.reload(); };
        }
      } catch(e) { console.error('site relations load failed:', e); }
    });
  </script>
</body>
</html>

