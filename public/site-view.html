<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du site</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
  <style>
    body { background: linear-gradient(135deg, #e9eeff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 18px; box-shadow: 0 12px 28px rgba(58,87,232,0.08); }
    .pill { background:#e0e7ff; border-radius:12px; padding:6px 12px; font-weight:700; color:#1e293b; letter-spacing: .2px; }
    .tickets-badge { font-size: 0.95rem; }
    .hero {
      background: linear-gradient(120deg, #5c7cfa, #7c3aed);
      color: #fff;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 12px 30px rgba(92,124,250,0.2);
    }
    .hero .title { font-size: 1.25rem; font-weight: 700; margin: 0; }
    .hero .subtitle { opacity: 0.9; }
    .ticket-item {
      border: 1px solid #e9eefb;
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 8px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .ticket-item .status-pill {
      border-radius: 999px;
      padding: 2px 8px;
      font-weight: 700;
      font-size: 0.8rem;
    }
    .status-attente { background:#e5fbe5; color:#15803d; }
    .status-cours   { background:#fff7d6; color:#b45309; }
    .status-termine { background:#ffe0e0; color:#b91c1c; }
  </style>
</head>
<body>


  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div class="d-flex gap-2">
        <a href="site-edit.html" class="btn btn-primary btn-sm" id="edit-site-btn"><i class="bi bi-pencil me-2"></i>Modifier</a>
      </div>
    </div>

    <div class="card mb-4">
      <div class="hero mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="title" id="view_nom_site">—</div>
            <div class="subtitle small">
              Client : <span id="view_client">—</span>
              <span class="ms-3">Contact : <span id="view_contact">—</span></span>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="mb-2">
          <div class="fw-semibold text-secondary">Adresse</div>
          <div id="view_adresse" class="text-body">—</div>
        </div>
        <div class="mb-2">
          <div class="fw-semibold text-secondary">Commentaire</div>
          <div id="view_commentaire" class="text-body">—</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Tickets associés</h2>
          <span class="text-muted small" id="tickets-count"></span>
        </div>
        <div id="tickets-list"></div>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const qp = new URLSearchParams(location.search);
      const siteId = qp.get('id');
      const token = localStorage.getItem('token');
      const headers = token? { 'Authorization': `Bearer ${token}` } : {};
      const isAdmin = (()=>{ try{ const p = token? JSON.parse(atob(token.split('.')[1])):null; return Array.isArray(p?.roles)&&p.roles.includes('ROLE_ADMIN'); } catch { return false; } })();
      try {
        const r = await fetch(`/api/sites/${siteId}/relations`, { headers, credentials:'same-origin' });
        const data = await r.json(); if (!r.ok) throw new Error(data && data.error || `HTTP ${r.status}`);
        const s = data.site || {};
        document.getElementById('site-name').textContent = s.nom_site || '';
        const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v||''; };
        set('view_nom_site', s.nom_site);
        set('view_client', s.client_nom || s.client_name || '—');
        set('view_commentaire', s.commentaire);
        // Adresse lisible
        const adr = s.adresse_nom || s.adresse_complete || s.adresse || '';
        set('view_adresse', adr || '—');
        // Contact info dans la sous-titre
        const contactInfo = s.contact_nom || s.contact_tel || '';
        set('view_contact', contactInfo ? `${s.contact_nom || ''} ${s.contact_tel || ''}`.trim() : '—');
        // Contact : site.contact_* ou premier responsable
        const contact = s.contact_nom ? `${s.contact_nom} ${s.contact_tel||''}` : (data.responsables && data.responsables[0] ? `${data.responsables[0].agent_matricule || ''}` : '—');
        set('view_contact', contact);

        const tickets = Array.isArray(data.tickets) ? data.tickets : [];
        const tl = document.getElementById('tickets-list');
        const statusClass = (etat) => {
          const e = (etat||'').toLowerCase();
          if (e.includes('attente')) return 'text-success';
          if (e.includes('cours')) return 'text-warning';
          if (e.includes('term')) return 'text-danger';
          return 'text-muted';
        };
        tl.innerHTML='';
        tickets.forEach(t=>{
          const el=document.createElement('div');
          const dateStr = t.date_debut ? new Date(t.date_debut).toLocaleDateString() : (t.date_fin ? new Date(t.date_fin).toLocaleDateString() : '');
          const etat = (t.etat||t.statut||'').toLowerCase();
          const badgeClass = etat.includes('attente') ? 'status-attente' : etat.includes('cours') ? 'status-cours' : etat.includes('term') ? 'status-termine' : '';
          el.className='ticket-item';
          el.innerHTML=`<div class="d-flex justify-content-between align-items-start">
            <div>
              <a class="fw-semibold" href="ticket-view.html?id=${t.id}">#${t.id} — ${t.titre||''}</a>
              <div class="small text-muted">${t.description||''}</div>
            </div>
            <div class="text-end">
              <div class="status-pill ${badgeClass}">${(t.etat||t.statut||'').replace('_',' ')||'—'}</div>
              <div class="small text-muted mt-1">${dateStr||''}</div>
            </div>
          </div>`;
          tl.appendChild(el);
        });
        if (!tl.innerHTML) tl.innerHTML='<span class="text-muted">Aucun ticket.</span>';

      } catch(e) { console.error('site relations load failed:', e); }

      const backBtn = document.getElementById('back-btn');
      if (backBtn) backBtn.addEventListener('click', () => window.history.back());
    });
  </script>
</body>
</html>
