<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Créer un nouvel agent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>
</head>
<body>
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard.html"><i class="bi bi-house-door-fill me-2"></i>Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="/agents.html"><i class="bi bi-people-fill me-2"></i>Agents</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/sites.html"><i class="bi bi-building-fill me-2"></i>Sites</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/interventions.html"><i class="bi bi-tools me-2"></i>Interventions</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/rendezvous.html"><i class="bi bi-calendar-event-fill me-2"></i>Rendez-vous</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/achats.html"><i class="bi bi-cart-fill me-2"></i>Achats</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/factures.html"><i class="bi bi-receipt-cutoff me-2"></i>Factures</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a>
        </li>
      </ul>
    </div>
  </div>

  <main class="container mt-5">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="agents.html">Agents</a></li>
        <li class="breadcrumb-item active" aria-current="page">Créer</li>
      </ol>
    </nav>
    <h1 class="mb-4">Créer un nouvel agent</h1>

    <div class="card">
      <div class="card-body">
        <h2 class="card-title mb-4">Informations de l'agent</h2>
        <form id="agent-form">
          <div class="mb-3">
            <label for="matricule" class="form-label">Matricule</label>
            <input type="text" class="form-control" id="matricule" placeholder="Ex: AGT005" required>
          </div>
          <div class="mb-3">
            <label for="nom" class="form-label">Nom</label>
            <input type="text" class="form-control" id="nom" placeholder="Ex: Dupont" required>
          </div>
          <div class="mb-3">
            <label for="prenom" class="form-label">Prénom</label>
            <input type="text" class="form-control" id="prenom" placeholder="Ex: Jean" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" placeholder="Ex: jean.dupont@example.com" required>
          </div>
          <div class="mb-3">
            <label for="telephone" class="form-label">Téléphone</label>
            <input type="tel" class="form-control" id="telephone" placeholder="Ex: 0612345678">
          </div>
          <div class="mb-3">
            <label for="agence" class="form-label">Agence</label>
            <div class="input-group">
              <select class="form-select" id="agence" required>
                <option value="">Sélectionner une agence</option>
              </select>
              <button class="btn btn-outline-secondary" type="button" id="refresh-agences" title="Rafraîchir la liste">
                <i class="bi bi-arrow-repeat"></i>
              </button>
              <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#agenceModal" title="Créer/Gérer les agences">
                <i class="bi bi-building-add"></i>
              </button>
            </div>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="actif" checked>
            <label class="form-check-label" for="actif">Actif</label>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="admin">
            <label class="form-check-label" for="admin">Administrateur</label>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary"><i class="bi bi-person-plus me-2"></i>Enregistrer</button>
            <a href="agents.html" class="btn btn-secondary">Annuler</a>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Modal gestion agences -->
  <div class="modal fade" id="agenceModal" tabindex="-1" aria-labelledby="agenceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="agenceModalLabel">Gérer les agences</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="agenceFrame" src="about:blank" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('agent-form');
      const agenceSelect = document.getElementById('agence');
      const token = localStorage.getItem('token');
      const isAdmin = (() => { try { const p = token? JSON.parse(atob(token.split('.')[1])):null; return Array.isArray(p?.roles) && p.roles.includes('ROLE_ADMIN'); } catch { return false; } })();

      async function buildHeaders(json = false) {
        const h = json ? { 'Content-Type': 'application/json' } : {};
        if (token) { h['Authorization'] = `Bearer ${token}`; return h; }
        try {
          const rTok = await fetch('/api/csrf-token', { credentials: 'same-origin' });
          const dTok = await rTok.json().catch(() => ({}));
          if (dTok && dTok.csrfToken) h['CSRF-Token'] = dTok.csrfToken;
        } catch {}
        return h;
      }

      if (!isAdmin) {
        try { alert('Action réservée aux administrateurs.'); } catch {}
        form.querySelectorAll('input, select, textarea, button[type=submit]').forEach(el => el.setAttribute('disabled','true'));
      }

      async function loadAgences() {
        try {
          const res = await fetch('/api/agences', { headers: await buildHeaders(false), credentials: 'same-origin' });
          if (!res.ok) return;
          const agences = await res.json();
          agenceSelect.innerHTML = '<option value="">Sélectionner une agence</option>';
          if (Array.isArray(agences)) {
            agences.forEach(a => {
              const opt = document.createElement('option');
              opt.value = a.id;
              opt.textContent = a.titre || `Agence #${a.id}`;
              agenceSelect.appendChild(opt);
            });
          }
        } catch(e) { console.warn('Erreur chargement /api/agences:', e); }
      }

      loadAgences();

      const isValidEmail = (em) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(em||'').trim());

      if (form) form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        
        const payload = {
          matricule: document.getElementById('matricule').value.trim(),
          nom: document.getElementById('nom').value.trim(),
          prenom: document.getElementById('prenom').value.trim(),
          email: document.getElementById('email').value.trim(),
          tel: document.getElementById('telephone').value.trim(),
          agence_id: Number(agenceSelect.value),
          actif: document.getElementById('actif').checked,
          admin: document.getElementById('admin').checked
        };

        if (!payload.matricule || !payload.nom || !payload.prenom || !payload.email || !payload.agence_id) {
          alert('Veuillez remplir tous les champs obligatoires: Matricule, Nom, Prénom, Email et Agence.');
          return;
        }
        if (!isValidEmail(payload.email)) {
          alert('Email invalide.');
          return;
        }

        try {
          if (!isAdmin) { alert('Action réservée aux administrateurs.'); return; }
          const headers = await buildHeaders(true);
          const r = await fetch('/api/agents', { method: 'POST', headers, credentials: 'same-origin', body: JSON.stringify(payload) });
          const data = await r.json().catch(()=>({}));

          if (!r.ok) {
            let errorMessage = data.error || `HTTP ${r.status}`;
            if (r.status === 409) errorMessage = 'Un agent avec ce matricule ou cet email existe déjà.';
            throw new Error(errorMessage);
          }

          alert('Agent créé avec succès !');
          location.href = `agent-view.html?matricule=${encodeURIComponent(payload.matricule)}`;
        } catch(e) {
          console.error(e);
          alert('Échec de la création: ' + (e.message || e));
        }
      });

      const refreshBtn = document.getElementById('refresh-agences');
      if (refreshBtn) refreshBtn.addEventListener('click', loadAgences);

      const agenceModal = document.getElementById('agenceModal');
      if (agenceModal) {
        agenceModal.addEventListener('show.bs.modal', () => {
          const frame = document.getElementById('agenceFrame');
          if (frame) frame.src = '/agences.html';
        });
        agenceModal.addEventListener('hidden.bs.modal', loadAgences);
      }

      // Réception sélection d'agence depuis la modale
      window.addEventListener('message', (event) => {
        if (!event?.data || event.data.type !== 'agence-select' || !event.data.agence) return;
        const a = event.data.agence;
        if (!a.id) return;
        // Injecter l'option si elle n'existe pas
        let opt = Array.from(agenceSelect.options).find(o => String(o.value) === String(a.id));
        if (!opt) {
          opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.titre || `Agence #${a.id}`;
          agenceSelect.appendChild(opt);
        }
        agenceSelect.value = a.id;
        // Fermer le modal si ouvert
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('agenceModal'));
        if (modalInstance) modalInstance.hide();
      });
    });
  </script>
</body>
</html>
