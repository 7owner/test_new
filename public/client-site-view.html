<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Détails du site</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    .embed #navbar-placeholder { display:none !important; }
  </style>
</head>
<body class="app-bg">
  <main class="container my-4">
    <div id="navbar-placeholder"></div>
    <div class="card mb-3">
      <div class="card-body d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">Détails du site: <span id="site-name"></span></h1>
        <div class="d-flex gap-2">
          <a href="#" class="btn btn-outline-primary btn-sm" id="edit-site-btn"><i class="bi bi-pencil me-2"></i>Modifier</a>
          <button onclick="window.parent.location.reload();" class="btn btn-secondary btn-sm">Fermer</button>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Informations générales</h2>
        <p><strong>Nom du Site:</strong> <span id="view_nom_site"></span></p>
        <p><strong>Commentaire:</strong> <span id="view_commentaire"></span></p>
        <p><strong>Statut:</strong> <span id="view_statut"></span></p>
        <p><strong>Date Début:</strong> <span id="view_date_debut"></span></p>
        <p><strong>Date Fin:</strong> <span id="view_date_fin"></span></p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="card-title mb-4">Tickets associés</h2>
        <p><strong>Nombre de tickets:</strong> <span id="view_ticket_count"></span></p>
        <div id="tickets-list"></div>
      </div>
    </div>

  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const qp = new URLSearchParams(location.search);
      const siteId = qp.get('id');
      const isEmbed = window.self !== window.top || qp.get('embed') === '1' || qp.get('modal') === '1';
      if (isEmbed) document.body.classList.add('embed');
      const token = localStorage.getItem('token');
      if (!token || !siteId) {
          document.body.innerHTML = '<p class="text-danger">Erreur: Paramètres manquants ou session invalide.</p>';
          return;
      }

      const headers = { 'Authorization': `Bearer ${token}` };

      try {
        const r = await fetch(`/api/client/sites/${siteId}/relations`, { headers });
        const data = await r.json(); 
        if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);
        
        const s = data.site || {};
        document.getElementById('site-name').textContent = s.nom_site || '';
        
        const set = (id, v) => { 
            const el = document.getElementById(id); 
            if (el) el.textContent = v ?? 'N/A'; 
        };
        
        set('view_nom_site', s.nom_site);
        set('view_commentaire', s.commentaire);
        set('view_statut', s.statut);
        set('view_date_debut', s.date_debut ? new Date(s.date_debut).toLocaleDateString() : 'N/A');
        set('view_date_fin', s.date_fin ? new Date(s.date_fin).toLocaleDateString() : 'N/A');
        
        const tickets = data.tickets || [];
        set('view_ticket_count', tickets.length);

        const ticketsListEl = document.getElementById('tickets-list');
        if (tickets.length > 0) {
            ticketsListEl.innerHTML = tickets.map(t => `
                <div class="small border-bottom pb-1 mb-1">
                    Ticket #${t.id} — ${t.titre || 'Sans titre'} 
                    <span class="badge bg-secondary">${t.etat}</span>
                </div>
            `).join('');
        } else {
            ticketsListEl.innerHTML = '<span class="text-muted">Aucun ticket.</span>';
        }

        // Setup edit button link
        document.getElementById('edit-site-btn').href = `client-site-edit.html?id=${siteId}`;

      } catch(e) { 
        console.error('Erreur lors du chargement des détails du site:', e);
        document.body.innerHTML = `<p class="text-danger">Impossible de charger les informations du site. ${e.message}</p>`;
      }
    });
  </script>
</body>
</html>
