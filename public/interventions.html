<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Interventions</title>
  <link href="/style.css" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    .embed header, .embed #navbar-placeholder { display:none !important; }
  </style>
</head>
<body class="min-h-screen app-bg">
  <div id="navbar-placeholder"></div>
  <header></header>
  <main class="container mx-auto px-6 py-8 max-w-7xl">
    <div class="card">
      <div class="card-header primary">
        <h3 style="margin:0; display:flex; align-items:center; gap:.5rem">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14.7 6.3a5 5 0 0 1-6.4 6.4L3 18l3 3 5.3-5.3a5 5 0 0 0 6.4-6.4l-3-3Z"/></svg>
          Liste des Interventions
        </h3>
        <a href="/intervention-new.html" class="btn btn-light btn-sm" title="Nouvelle intervention">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
        </a>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table class="table" id="interTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Maintenance</th>
                <th>Description</th>
                <th>Début</th>
                <th>Fin</th>
                <th>Temps écoulé</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="interTbody"></tbody>
          </table>
        </div>
        <div id="interEmpty" class="hidden">Aucune intervention trouvée.</div>
      </div>
    </div>
  </main>
  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const isEmbed = window.self !== window.top || params.get('embed') === '1' || params.get('modal') === '1';
      if (isEmbed) document.body.classList.add('embed');

      async function loadList(){
        const token = localStorage.getItem('token');
        const tbody = document.getElementById('interTbody');
        const empty = document.getElementById('interEmpty');
        if (!tbody) return;
        tbody.innerHTML = '';
        try {
          const r = await fetch('/api/interventions', { headers: { 'Authorization': `Bearer ${token}` }});
          const arr = r.ok ? await r.json() : [];
          if (!arr.length) { if (empty) empty.classList.remove('hidden'); return; }
          if (empty) empty.classList.add('hidden');
          const fmtElapsed = (startStr, endStr, status) => {
            if (!startStr) return '—';
            const start = new Date(startStr).getTime();
            if (Number.isNaN(start)) return '—';
            const isClosed = status === 'Termine' || status === 'Terminé' || status === 'Fermé';
            const end = endStr ? new Date(endStr).getTime() : Date.now();
            const diff = Math.max(0, end - start);
            const totalMin = Math.floor(diff / 60000);
            const days = Math.floor(totalMin / (60 * 24));
            const hours = Math.floor((totalMin % (60 * 24)) / 60);
            const mins = totalMin % 60;
            const parts = [];
            if (days) parts.push(`${days} j`);
            parts.push(`${String(hours).padStart(2,'0')} h ${String(mins).padStart(2,'0')} min`);
            return parts.join(' ');
          };

          arr.forEach(it => {
            const dDeb = it.date_debut ? new Date(it.date_debut).toLocaleString() : '';
            const dFin = it.date_fin ? new Date(it.date_fin).toLocaleString() : '';
            const elapsed = fmtElapsed(it.date_debut, it.date_fin, it.status || it.statut);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="fw-bold text-primary">#${it.id||''}</td>
              <td><span class="fw-semibold">${it.maintenance_titre||''}</span><br><small class="text-slate-500">ID: ${it.maintenance_id||''}</small></td>
              <td>${it.description||''}</td>
              <td>${dDeb||'-'}</td>
              <td>${dFin||'-'}</td>
              <td>${elapsed||'-'}</td>
              <td class="text-center">
                <a href="/intervention.html#${it.id}" class="btn btn-outline-info btn-sm" title="Voir">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                </a>
                <a href="/intervention-edit.html#${it.id}" class="btn btn-outline-warning btn-sm" title="Modifier">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5Z"/></svg>
                </a>
                <button data-id="${it.id}" class="btn btn-outline-danger btn-sm inter-del-btn" title="Supprimer">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                </button>
              </td>`;
            tbody.appendChild(tr);
          });
        } catch(_) {}
      }
      document.addEventListener('DOMContentLoaded', () => {
        loadList();
        const tbody = document.getElementById('interTbody');
        if (tbody) tbody.addEventListener('click', async (e) => {
          const btn = e.target.closest('.inter-del-btn');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          if (!id) return;
          if (!confirm('Êtes-vous sûr de vouloir supprimer cette intervention ?')) return;
          const token = localStorage.getItem('token');
          try { await fetch(`/api/interventions/${id}`, { method:'DELETE', headers:{ 'Authorization': `Bearer ${token}` }}); loadList(); } catch(_){ }
        });
      });
    })();
  </script>
  <script src="/script.js"></script>
</body>
</html>
