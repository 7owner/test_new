<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interventions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=2"></script>
  <style>
    body { background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%); }
    .card { border: none; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
    .embed #navbar-placeholder { display:none !important; }
    .table thead th { background: #f7f8ff; }
  </style>
</head>
<body class="dashboard-bg">
  <div id="navbar-placeholder"></div>
  <main class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1>Interventions</h1>
      <a href="/intervention-new.html" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-2"></i>Nouvelle intervention</a>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Ticket</th>
                <th>Description</th>
                <th>Début</th>
                <th>Fin</th>
                <th>Temps écoulé</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="interTbody">
              <tr><td colspan="7" class="text-muted text-center py-4">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
        <div id="interEmpty" class="text-muted text-center py-3 d-none">Aucune intervention trouvée.</div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      const isEmbed = window.self !== window.top || params.get('embed') === '1' || params.get('modal') === '1';
      if (isEmbed) document.body.classList.add('embed');

      const token = localStorage.getItem('token');
      if (!token) { window.location.href='/login.html'; return; }
      const headers = { 'Authorization': `Bearer ${token}` };
      const tbody = document.getElementById('interTbody');
      const empty = document.getElementById('interEmpty');

      const fmtElapsed = (startStr, endStr, status) => {
        if (!startStr) return '—';
        const start = new Date(startStr).getTime();
        if (Number.isNaN(start)) return '—';
        const isClosed = ['Termine','Terminé','Fermé'].includes(status);
        const end = endStr ? new Date(endStr).getTime() : Date.now();
        const diff = Math.max(0, end - start);
        const totalMin = Math.floor(diff / 60000);
        const days = Math.floor(totalMin / (60 * 24));
        const hours = Math.floor((totalMin % (60 * 24)) / 60);
        const mins = totalMin % 60;
        const parts = [];
        if (days) parts.push(`${days} j`);
        parts.push(`${String(hours).padStart(2,'0')} h ${String(mins).padStart(2,'0')} min`);
        return parts.join(' ');
      };

      async function loadList() {
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="7" class="text-muted text-center py-4">Chargement...</td></tr>';
        try {
          const ticketId = params.get('ticket_id');
          const url = ticketId ? `/api/interventions?ticket_id=${encodeURIComponent(ticketId)}` : '/api/interventions';
          const r = await fetch(url, { headers, credentials:'same-origin' });
          const arr = r.ok ? await r.json() : [];
          const search = (params.get('q') || '').trim().toLowerCase();
          tbody.innerHTML = '';
          let list = Array.isArray(arr) ? arr : [];

          const matchBasic = (it) => {
            if (!search) return true;
            const fields = [
              it.id,
              it.ticket_id,
              it.titre,
              it.description,
              it.status || it.statut
            ].map(x => (x || '').toString().toLowerCase());
            return fields.some(f => f.includes(search));
          };

          if (search) {
            const basicMatches = [];
            const remaining = [];
            list.forEach(it => (matchBasic(it) ? basicMatches : remaining).push(it));
            // Cherche dans les matériels liés si pas trouvé par basic
            const withMateriels = [];
            for (const it of remaining) {
              try {
                const mats = await (await fetch(`/api/interventions/${it.id}/materiels`, { headers, credentials:'same-origin' })).json();
                const hasMatch = Array.isArray(mats) && mats.some(m => {
                  return [m.reference, m.designation, m.categorie].some(v => (v || '').toString().toLowerCase().includes(search));
                });
                if (hasMatch) withMateriels.push(it);
              } catch {}
            }
            list = [...basicMatches, ...withMateriels];
          }

          if (!list.length) { if (empty) empty.classList.remove('d-none'); return; }
          if (empty) empty.classList.add('d-none');

          list.forEach(it => {
            const dDeb = it.date_debut ? new Date(it.date_debut).toLocaleString() : '';
            const dFin = it.date_fin ? new Date(it.date_fin).toLocaleString() : '';
            const elapsed = fmtElapsed(it.date_debut, it.date_fin, it.status || it.statut);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div class="fw-semibold">${it.titre || '(Sans titre)'}</div>
                <div class="small text-muted">#${it.id||''}</div>
              </td>
              <td>
                ${it.ticket_id ? `<span class="fw-semibold">#${it.ticket_id}</span> — <span class="text-muted">${it.ticket_titre || ''}</span>` : '—'}
              </td>
              <td>${it.titre ? `<div class="fw-semibold">${it.titre}</div><div class="small text-muted">${it.description||''}</div>` : (it.description||'')}</td>
              <td>${dDeb||'-'}</td>
              <td>${dFin||'-'}</td>
              <td>${elapsed||'-'}</td>
              <td class="text-center">
                <a href="/intervention-view.html?id=${it.id}" class="btn btn-outline-info btn-sm open-modal-link" data-url="/intervention-view.html?id=${it.id}"><i class="bi bi-eye"></i></a>
                <a href="/intervention-edit.html?id=${it.id}" class="btn btn-outline-warning btn-sm open-modal-link" data-url="/intervention-edit.html?id=${it.id}"><i class="bi bi-pencil"></i></a>
                <button data-id="${it.id}" class="btn btn-outline-danger btn-sm inter-del-btn"><i class="bi bi-trash"></i></button>
              </td>`;
            tbody.appendChild(tr);
          });
        } catch(err) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-danger text-center py-4">Erreur de chargement.</td></tr>';
        }
      }

      loadList();

      // suppression
      if (tbody) tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('.inter-del-btn');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Supprimer cette intervention ?')) return;
        try { await fetch(`/api/interventions/${id}`, { method:'DELETE', headers, credentials:'same-origin' }); loadList(); } catch(_){ }
      });

      // ouverture en modal si besoin
      const viewerModalEl = document.getElementById('viewerModal');
      const viewerFrame = document.getElementById('viewerFrame');
      const openInternalModal = (url) => {
        if (viewerFrame) viewerFrame.src = url + (url.includes('?') ? '&' : '?') + 'embed=1&modal=1';
        if (viewerModalEl) bootstrap.Modal.getOrCreateInstance(viewerModalEl).show();
      };
      document.body.addEventListener('click', (e) => {
        const link = e.target.closest('.open-modal-link');
        if (link && link.dataset.url) {
          e.preventDefault();
          openInternalModal(link.dataset.url);
        }
      });
    });
  </script>

  <!-- Modal viewer -->
  <div class="modal fade" id="viewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Aperçu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" style="height:80vh;">
          <iframe id="viewerFrame" src="about:blank" style="width:100%;height:100%;border:0;"></iframe>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
