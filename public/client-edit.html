<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Modifier Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Custom -->
  <link href="/custom.css?v=1" rel="stylesheet">
  <script src="/nav.js?v=1"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    label { display:block; margin:.4rem 0 .2rem; }
    input, textarea, select { padding:.5rem; width:100%; max-width:520px; }
    button { padding:.5rem .8rem; margin-top:.6rem; }
    .card { border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08);}
  </style>
</head>

<body class="app-bg">

<main class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 id="title">Modifier le client</h1>
    <button class="btn btn-outline-secondary" onclick="window.history.back()">
      <i class="bi bi-arrow-left"></i> Retour
    </button>
  </div>

  <!-- FORM CLIENT -->
  <div class="card mb-4">
    <div class="card-header"><strong>Informations Générales</strong></div>

    <div class="card-body">
      <form id="form">
        <input type="hidden" id="clientId">

        <div class="mb-3">
          <label>Nom client *</label>
          <input type="text" class="form-control" id="nom_client" required>
        </div>

        <div class="mb-3">
          <label>Adresse</label>
          <select class="form-select" id="adresse_id"></select>
        </div>

        <div class="mb-3">
          <label>Commentaire</label>
          <textarea class="form-control" id="commentaire" rows="3"></textarea>
        </div>

        <button class="btn btn-primary" type="submit">
          <i class="bi bi-save me-1"></i> Enregistrer
        </button>
      </form>
    </div>
  </div>

  <!-- REPRESENTANTS -->
  <div class="card mb-4" id="representants-section">
    <div class="card-header d-flex justify-content-between">
      <strong>Représentants</strong>
      <button class="btn btn-sm btn-success" id="add-representant-btn">
        <i class="bi bi-person-plus me-1"></i> Ajouter
      </button>
    </div>

    <ul id="representants-list" class="list-group list-group-flush">
      <li class="list-group-item text-muted">Chargement...</li>
    </ul>
  </div>

</main>


<!-- MODAL Représentant -->
<div class="modal fade" id="representantModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="representantModalLabel" class="modal-title">Ajouter un représentant</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="representantForm">
          <input type="hidden" id="representantId">

          <label>Nom *</label>
          <input id="representantNom" class="form-control" required>

          <label class="mt-2">Email</label>
          <input id="representantEmail" class="form-control">

          <label class="mt-2">Téléphone</label>
          <input id="representantTel" class="form-control">

          <label class="mt-2">Fonction</label>
          <input id="representantFonction" class="form-control">
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button class="btn btn-primary" id="saveRepresentantBtn">Enregistrer</button>
      </div>
    </div>
  </div>
</div>


<!-- Bootstrap JS + Script Logic -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login.html";

  const params = new URLSearchParams(location.search);
  const clientId = params.get("id");
  const isNew = !clientId;

  const modal = new bootstrap.Modal("#representantModal");

  // API helper
  async function api(url, opt = {}) {
    const h = { headers: { "Content-Type": "application/json" }};
    if(token) h.headers.Authorization = "Bearer "+token;
    const r = await fetch(url, { ...opt, ...h });
    if(!r.ok) throw new Error((await r.json()).error || "Erreur API");
    return r.json();
  }

  document.getElementById("title").textContent =
    isNew ? "Créer un client" : `Modifier client #${clientId}`;

  async function loadAdresses(){
    const list = await api("/api/adresses");
    const sel = document.getElementById("adresse_id");
    sel.innerHTML = '<option value="">Aucune</option>';
    list.forEach(a => {
      sel.innerHTML += `<option value="${a.id}">${a.libelle || "Adresse #"+a.id}</option>`;
    });
  }

  async function loadClient(){
    if(isNew){
      document.getElementById("representants-section").style.display="none";
      return;
    }
    const data = await api(`/api/clients/${clientId}/relations`);
    const c = data.client;
    document.getElementById("nom_client").value = c.nom_client;
    document.getElementById("adresse_id").value = c.adresse_id || "";
    document.getElementById("commentaire").value = c.commentaire || "";
    renderRepresentants(data.representants || []);
  }

  async function saveClient(ev){
    ev.preventDefault();
    const c = {
      nom_client: nom_client.value.trim(),
      adresse_id: adresse_id.value || null,
      commentaire: commentaire.value.trim() || null
    };

    if(isNew){
      const res = await api("/api/clients", { method:"POST", body:JSON.stringify(c) });
      alert("Client créé !");
      location.href = `/client-edit.html?id=${res.id}`;
    } else {
      await api(`/api/clients/${clientId}`, { method:"PUT", body:JSON.stringify(c) });
      alert("Modifications enregistrées !");
      location.href = "/clients.html";
    }
  }

  function renderRepresentants(list){
    const ul = document.getElementById("representants-list");
    ul.innerHTML="";
    if(!list.length){
      ul.innerHTML='<li class="list-group-item text-muted">Aucun</li>';
      return;
    }
    list.forEach(rep=>{
      ul.innerHTML+=`
      <li class="list-group-item d-flex justify-content-between">
        <div>
          <strong>${rep.nom}</strong><br>
          <small>${rep.fonction || ""}</small><br>
          <small class="text-muted">${rep.email || ""} | ${rep.tel || ""}</small>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="editRep(${rep.id})">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="delRep(${rep.id})">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </li>`;
    });
  }

  window.editRep = async (id)=>{
    const r = await api(`/api/representants/${id}`);
    representantId.value = r.id;
    representantNom.value = r.nom;
    representantEmail.value = r.email || "";
    representantTel.value = r.tel || "";
    representantFonction.value = r.fonction || "";
    representantModalLabel.textContent = "Modifier représentant";
    modal.show();
  };

  window.delRep = async (id) => {
    if(!confirm("Supprimer ?")) return;
    await api(`/api/representants/${id}`, { method:"DELETE" });
    await loadClient();
  };

  document.getElementById("add-representant-btn").onclick = ()=>{
    representantId.value="";
    representantForm.reset();
    representantModalLabel.textContent="Ajouter représentant";
    modal.show();
  };

  document.getElementById("saveRepresentantBtn").onclick = async () => {
    const body = {
      nom: representantNom.value.trim(),
      email: representantEmail.value.trim(),
      tel: representantTel.value.trim(),
      fonction: representantFonction.value.trim()
    };
    const id = representantId.value;
    if(id)
      await api(`/api/representants/${id}`, { method:"PUT", body:JSON.stringify(body) });
    else
      await api(`/api/clients/${clientId}/representants`, { method:"POST", body:JSON.stringify(body) });

    modal.hide();
    await loadClient();
  };

  document.getElementById("form").onsubmit = saveClient;
  await loadAdresses();
  await loadClient();
});
</script>

</body>
</html>
