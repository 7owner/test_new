<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Modifier Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="/nav.js?v=2"></script>
</head>
<body class="app-bg">
  <main class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1 class="mb-0" id="title">Chargement...</h1>
      <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()"><i class="bi bi-arrow-left me-1"></i> Retour</button>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Informations Générales</h5>
      </div>
      <div class="card-body">
        <form id="form">
          <input type="hidden" id="clientId">
          <div class="mb-3">
            <label for="nom_client" class="form-label">Nom client</label>
            <input type="text" class="form-control" id="nom_client" required>
          </div>
          <div class="mb-3">
            <label for="adresse_id" class="form-label">Adresse</label>
            <select class="form-select" id="adresse_id"></select>
          </div>
          <div class="mb-3">
            <label for="commentaire" class="form-label">Commentaire</label>
            <textarea class="form-control" id="commentaire" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Enregistrer</button>
        </form>
      </div>
    </div>

    <!-- Représentants Management Section -->
    <div class="card mb-4" id="representants-section">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Représentants (Utilisateurs)</h5>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#representantModal"><i class="bi bi-person-plus me-1"></i> Gérer les représentants</button>
        </div>
        <ul id="representants-list" class="list-group list-group-flush"></ul>
    </div>
  </main>

  <!-- Representant Modal -->
  <div class="modal fade" id="representantModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gérer les représentants</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-tab-pane" type="button">Lier un utilisateur existant</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane" type="button">Créer un nouvel utilisateur</button>
            </li>
          </ul>
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active p-3" id="search-tab-pane" role="tabpanel">
              <div class="mb-3">
                <label for="user-search" class="form-label">Rechercher par email</label>
                <input type="email" class="form-control" id="user-search" placeholder="tape-ici@email.com">
              </div>
              <ul id="user-search-results" class="list-group"></ul>
            </div>
            <div class="tab-pane fade p-3" id="create-tab-pane" role="tabpanel">
              <form id="createUserForm">
                <div class="mb-3">
                  <label for="user-email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="user-email" required>
                </div>
                <div class="mb-3">
                  <label for="user-password" class="form-label">Mot de passe temporaire</label>
                  <input type="password" class="form-control" id="user-password" required>
                </div>
                <div class="mb-3">
                  <label for="user-nom" class="form-label">Nom</label>
                  <input type="text" class="form-control" id="user-nom">
                </div>
                <div class="mb-3">
                  <label for="user-tel" class="form-label">Téléphone</label>
                  <input type="tel" class="form-control" id="user-tel">
                </div>
                <div class="mb-3">
                  <label for="user-fonction" class="form-label">Fonction</label>
                  <input type="text" class="form-control" id="user-fonction">
                </div>
                <button type="submit" class="btn btn-primary">Créer et lier</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      if (!token) return location.href = '/login.html';
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };

      const params = new URLSearchParams(location.search);
      const clientId = params.get('id');
      const isNew = !clientId;

      const h1Title = document.getElementById('title');
      const clientNomInput = document.getElementById('nom_client');
      const commentaireTextarea = document.getElementById('commentaire');
      const mainForm = document.getElementById('form');
      const representantsSection = document.getElementById('representants-section');
      const representantsList = document.getElementById('representants-list');
      const userSearchInput = document.getElementById('user-search');
      const userSearchResults = document.getElementById('user-search-results');
      const createUserForm = document.getElementById('createUserForm');
      const editRepModalEl = document.getElementById('editRepModal');
      const editRepModal = editRepModalEl ? new bootstrap.Modal(editRepModalEl) : null;
      const editRepFeedback = document.getElementById('edit-rep-feedback');
      const saveRepBtn = document.getElementById('save-rep-btn');
      let allRepresentants = [];

      h1Title.textContent = isNew ? 'Créer un client' : `Modifier Client #${clientId}`;
      if(isNew) {
          representantsSection.style.display = 'none';
      } else {
          representantsSection.style.display = '';
      }

      async function api(url, opts = {}) {
        const r = await fetch(url, { headers, ...opts });
        const body = await r.json().catch(() => ({}));
        if (!r.ok) {
          if (r.status === 401 || r.status === 403) window.location.href = '/login.html';
          throw new Error(body.error || `HTTP ${r.status}`);
        }
        return body;
      }

      async function loadAdresses() {
        try {
          const adrs = await api('/api/adresses');
          const adresseSelect = document.getElementById('adresse_id');
          adresseSelect.innerHTML = '<option value="">(Aucune)</option>';
          adrs.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = a.libelle || (`Adresse #${a.id}`); adresseSelect.appendChild(o); });
        } catch (e) { console.error('Error loading addresses:', e); }
      }

      async function loadClientData() {
        if (!isNew) {
          try {
            const client = await api(`/api/clients/${clientId}`);
            allRepresentants = await api(`/api/clients/${clientId}/representants`); // Load representatives here
            
            clientNomInput.value = client.nom_client || '';
            commentaireTextarea.value = client.commentaire || '';
            renderRepresentants();
          } catch (e) {
            alert(`Erreur de chargement du client: ${e.message}`);
            window.history.back();
          }
        }
      }

      mainForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          nom_client: clientNomInput.value.trim(),
          commentaire: commentaireTextarea.value.trim() || null,
        };
        if (!payload.nom_client) return alert('Le nom du client est obligatoire.');
        
        try {
          if (isNew) {
            const newClient = await api('/api/clients', { method: 'POST', body: JSON.stringify(payload) });
            alert('Client créé avec succès! Vous allez être redirigé pour ajouter des représentants.');
            window.location.href = `/client-edit.html?id=${newClient.id}`; 
          } else {
            await api(`/api/clients/${clientId}`, { method: 'PUT', body: JSON.stringify(payload) });
            alert('Client mis à jour.');
          }
        } catch (e) {
          alert(`Erreur: ${e.message}`);
        }
      });

      function renderRepresentants() {
        representantsList.innerHTML = '';
        if (allRepresentants.length === 0) {
          representantsList.innerHTML = '<li class="list-group-item text-muted">Aucun représentant lié.</li>';
          return;
        }
        allRepresentants.forEach(rep => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <div>
                <div class="fw-bold">${rep.nom || rep.email} ${rep.prenom || ''}</div>
                <div class="small text-muted">${rep.fonction || 'Représentant'}</div>
                <div class="small text-muted">
                    <i class="bi bi-envelope-fill"></i> ${rep.email || 'N/A'} 
                    ${rep.tel ? `| <i class="bi bi-telephone-fill"></i> ${rep.tel}` : ''}
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2 edit-representant-btn" data-id="${rep.client_representant_id}"><i class="bi bi-pencil"></i> Modifier</button>
                <button class="btn btn-sm btn-outline-danger delete-representant-btn" data-id="${rep.client_representant_id}"><i class="bi bi-trash"></i> Retirer</button>
            </div>
          `;
          // Attach listeners to newly created buttons
          li.querySelector('.edit-representant-btn').addEventListener('click', () => {
            // Populate modal with current rep data
            document.getElementById('representantId').value = rep.client_representant_id;
            document.getElementById('representantNom').value = rep.nom || '';
            document.getElementById('representantEmail').value = rep.email || '';
            document.getElementById('representantTel').value = rep.tel || '';
            document.getElementById('representantFonction').value = rep.fonction || '';
            document.getElementById('representantModalLabel').textContent = `Modifier représentant #${rep.client_representant_id}`;
            representantModal.show();
          });
          li.querySelector('.delete-representant-btn').addEventListener('click', async () => {
            if (!confirm('Retirer ce représentant du client ?')) return;
            try {
              await api(`/api/client_representant/${rep.client_representant_id}`, { method: 'DELETE' });
              loadRepresentatives(); // Refresh the list
            } catch (e) {
              alert(`Erreur: ${e.message}`);
            }
          });
          representantsList.appendChild(li);
        });
      }

      async function loadRepresentatives() { // Function to refresh representatives list
        if (isNew) return; // Should not load reps for new client
        try {
            allRepresentants = await api(`/api/clients/${clientId}/representants`);
            renderRepresentants();
        } catch (e) {
            representantsList.innerHTML = '<li class="list-group-item text-danger">Erreur de chargement des représentants.</li>';
        }
      }

      userSearchInput.addEventListener('input', async () => {
          const email = userSearchInput.value.trim();
          if (email.length < 3) {
              userSearchResults.innerHTML = '';
              return;
          }
          try {
              const users = await api(`/api/users/search?email=${encodeURIComponent(email)}`);
              userSearchResults.innerHTML = '';
              if (!users.length) {
                  userSearchResults.innerHTML = '<li class="list-group-item text-muted">Aucun utilisateur trouvé.</li>';
                  return;
              }
              users.forEach(user => {
                  // Check if user is already a representative
                  const isLinked = allRepresentants.some(rep => rep.user_id === user.id);
                  const li = document.createElement('li');
                  li.className = 'list-group-item d-flex justify-content-between align-items-center';
                  li.innerHTML = `<span>${user.email}</span>
                                  <button class="btn btn-sm ${isLinked ? 'btn-outline-secondary disabled' : 'btn-success'} link-user-btn" data-id="${user.id}" ${isLinked ? 'disabled' : ''}>
                                      ${isLinked ? 'Déjà lié' : 'Lier'}
                                  </button>`;
                  if (!isLinked) {
                      li.querySelector('.link-user-btn').addEventListener('click', async () => {
                          try {
                              await api(`/api/clients/${clientId}/representants`, { method: 'POST', body: JSON.stringify({ user_id: user.id }) });
                              await loadRepresentatives();
                              alert('Utilisateur lié avec succès.');
                              userSearchResults.innerHTML = ''; // Clear search
                              userSearchInput.value = '';
                          } catch (e) {
                              alert(`Erreur: ${e.message}`);
                          }
                      });
                  }
                  userSearchResults.appendChild(li);
              });
          } catch (e) {
              userSearchResults.innerHTML = '<li class="list-group-item text-danger">Erreur de recherche.</li>';
          }
      });

      createUserForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('user-email').value;
          const password = document.getElementById('user-password').value;
          const nom = document.getElementById('user-nom')?.value || '';
          const tel = document.getElementById('user-tel')?.value || '';
          const fonction = document.getElementById('user-fonction')?.value || '';
          try {
              const newUser = await api('/api/users', {
                  method: 'POST',
                  body: JSON.stringify({ email, password, role: 'ROLE_CLIENT' })
              });
              await api(`/api/clients/${clientId}/representants`, {
                  method: 'POST',
                  body: JSON.stringify({ user_id: newUser.id, nom, email, tel, fonction })
              });
              await loadRepresentatives();
              alert('Nouvel utilisateur créé et lié avec succès.');
              createUserForm.reset();
              // Optionally switch back to search tab or close modal
          } catch (e) {
              alert(`Erreur: ${e.message}`);
          }
      });

      // Event listener for opening the representant modal to reset forms and clear search
      document.getElementById('representantModal').addEventListener('show.bs.modal', () => {
        // Clear search results and input
        userSearchInput.value = '';
        userSearchResults.innerHTML = '';
        // Reset create user form
        createUserForm.reset();
        // Ensure "Lier un utilisateur existant" tab is active by default
        const searchTabBtn = document.getElementById('search-tab');
        const searchTabPane = document.getElementById('search-tab-pane');
        const activeTab = new bootstrap.Tab(searchTabBtn);
        activeTab.show();
      });

      // Modal d'édition de représentant
      if (saveRepBtn && editRepModal) {
        saveRepBtn.addEventListener('click', async () => {
          const repId = document.getElementById('edit-rep-id').value;
          const payload = {
            nom: document.getElementById('edit-rep-nom').value.trim(),
            email: document.getElementById('edit-rep-email').value.trim() || null,
            tel: document.getElementById('edit-rep-tel').value.trim() || null,
            fonction: document.getElementById('edit-rep-fonction').value.trim() || null,
          };
          if (!repId) return;
          try {
            await api(`/api/client_representant/${repId}`, { method: 'PUT', body: JSON.stringify(payload) });
            editRepFeedback.className = 'small text-success';
            editRepFeedback.textContent = 'Représentant mis à jour.';
            await loadRepresentatives();
            setTimeout(()=> editRepModal.hide(), 300);
          } catch (e) {
            editRepFeedback.className = 'small text-danger';
            editRepFeedback.textContent = e.message || 'Erreur lors de la mise à jour';
          }
        });
      }

      // Initial load
      await loadClientData();
    });
</script>
