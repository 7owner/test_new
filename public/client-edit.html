<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Modifier Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Navigation -->
  <script src="/nav.js?v=2"></script>
</head>

<body class="app-bg">

<main class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 id="title">Chargement...</h1>
    <a href="/clients.html" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Retour
    </a>
  </div>

  <!-- INFOS CLIENT -->
  <div class="card mb-4">
    <div class="card-header"><strong>Informations Générales</strong></div>

    <div class="card-body">
      <form id="clientForm">
        <div class="mb-3">
          <label class="form-label">Nom du client *</label>
          <input id="nom_client" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Commentaire</label>
          <textarea id="commentaire" class="form-control" rows="3"></textarea>
        </div>

        <button class="btn btn-primary"><i class="bi bi-save me-1"></i>Enregistrer</button>
      </form>
    </div>
  </div>

  <!-- REPRESENTANTS -->
  <div class="card mb-4" id="repBox" style="display:none;">
    <div class="card-header fw-bold">Représentants utilisateur</div>

    <ul id="repList" class="list-group list-group-flush"></ul>

    <div class="card-body border-top">
      <h6>Ajouter / Lier un représentant</h6>
      <form id="repForm" class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Nom (existant ou nouveau) *</label>
          <input id="rep_nom" class="form-control" required placeholder="Nom représentant">
        </div>
        <div class="col-md-6">
          <label class="form-label">Téléphone</label>
          <input id="rep_tel" class="form-control">
        </div>
        <div class="col-12">
          <label class="form-label">Email *</label>
          <input type="email" id="rep_email" class="form-control" required>
        </div>

        <button class="btn btn-success mt-2">
          <i class="bi bi-person-plus"></i> Ajouter / Lier
        </button>

        <div id="repMsg" class="mt-2 small"></div>
      </form>
    </div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const token = localStorage.getItem("token");
  if(!token) return location.href="/login.html";

  const headers = { "Content-Type":"application/json", "Authorization":"Bearer "+token };
  const clientId = new URLSearchParams(location.search).get("id");
  const isNew = !clientId;

  const title = document.getElementById("title");
  const repBox = document.getElementById("repBox");
  const repList = document.getElementById("repList");
  const repMsg = document.getElementById("repMsg");

  title.textContent = isNew ? "Créer un client" : `Modifier Client #${clientId}`;
  if(isNew) repBox.style.display="none";

  async function api(url,opt={}) {
    const r = await fetch(url,{...opt,headers});
    const b = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(b.error||"Erreur API");
    return b;
  }

  // === CHARGER CLIENT ===
  async function loadClient(){
    if(isNew) return;
    const c = await api(`/api/clients/${clientId}`);
    nom_client.value = c.nom_client;
    commentaire.value = c.commentaire||"";
    loadRepresentants();
  }

  // === CHARGER REPRESENTANTS ===
  async function loadRepresentants(){
    const reps = await api(`/api/clients/${clientId}/representants`);
    repList.innerHTML="";
    if(!reps.length){
      repList.innerHTML = `<li class="list-group-item text-muted">Aucun représentant</li>`;
      return;
    }
    reps.forEach(rep=>{
      repList.innerHTML+=`
        <li class="list-group-item d-flex justify-content-between">
          <div>
            <strong>${rep.nom||rep.email}</strong><br>
            <small class="text-muted">${rep.email}</small>
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeRep(${rep.client_representant_id})">
            <i class="bi bi-trash"></i>
          </button>
        </li>
      `;
    });
    repBox.style.display="";
  }

  window.removeRep = async (id)=>{
    if(!confirm("Retirer ce représentant ?")) return;
    await api(`/api/client_representant/${id}`,{method:"DELETE"});
    loadRepresentants();
  };

  // === SAUVE CLIENT ===
  document.getElementById("clientForm").onsubmit = async (e)=>{
    e.preventDefault();
    const payload = {
      nom_client: nom_client.value.trim(),
      commentaire: commentaire.value.trim()||null
    };

    if(isNew){
      const r = await api("/api/clients",{method:"POST",body:JSON.stringify(payload)});
      location.href=`/client-edit.html?id=${r.id}`;
    } else {
      await api(`/api/clients/${clientId}`,{method:"PUT",body:JSON.stringify(payload)});
      alert("Enregistré ✔");
    }
  };

  // === AJOUT REPRESENTANT ===
  document.getElementById("repForm").onsubmit = async (e)=>{
    e.preventDefault();
    repMsg.textContent="";

    const body = {
      nom: rep_nom.value.trim(),
      tel: rep_tel.value.trim(),
      email: rep_email.value.trim()
    };

    try {
      await api(`/api/clients/${clientId}/representant`,{
        method:"POST",
        body:JSON.stringify(body)
      });
      repMsg.className="text-success";
      repMsg.textContent="Représentant enregistré ✔";
      repForm.reset();
      loadRepresentants();
    } catch(err){
      repMsg.className="text-danger";
      repMsg.textContent=err.message;
    }
  };

  if(!isNew) loadClient();

});
</script>

</body>
</html>
