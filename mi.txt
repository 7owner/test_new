document.addEventListener('DOMContentLoaded', () => {
    const fetchDataBtn = document.getElementById('fetchDataBtn');
    const carListDiv = document.getElementById('carList');
    const addCarForm = document.getElementById('addCarForm');

    const adresseListDiv = document.getElementById('adresseList');
    const addAdresseForm = document.getElementById('addAdresseForm');

    const agenceListDiv = document.getElementById('agenceList');
    const addAgenceForm = document.getElementById('addAgenceForm');

    // Function to fetch and display cars
    const fetchCars = async () => {
        try {
            const response = await fetch('/api/cars');
            const cars = await response.json();
            carListDiv.innerHTML = ''; // Clear previous list
            if (cars.length === 0) {
                carListDiv.innerHTML = '<p>No cars found. Add one!</p>';
                return;
            }
            const ul = document.createElement('ul');
            cars.forEach(car => {
                const li = document.createElement('li');
                li.textContent = `${car.year} ${car.make} ${car.model} (${car.color}) - $${car.price_per_day}/day`;
                ul.appendChild(li);
            });
            carListDiv.appendChild(ul);
        } catch (error) {
            console.error('Error fetching cars:', error);
            carListDiv.innerHTML = '<p>Error loading cars.</p>';
        }
    };

    // Function to fetch and display adresses
    const fetchAdresses = async () => {
        try {
            const response = await fetch('/api/adresses');
            const adresses = await response.json();
            adresseListDiv.innerHTML = ''; // Clear previous list
            if (adresses.length === 0) {
                adresseListDiv.innerHTML = '<p>No adresses found. Add one!</p>';
                return;
            }
            const ul = document.createElement('ul');
            adresses.forEach(adresse => {
                const li = document.createElement('li');
                li.textContent = `${adresse.libelle || ''} - ${adresse.ligne1}, ${adresse.code_postal} ${adresse.ville}, ${adresse.pays}`; 
                ul.appendChild(li);
            });
            adresseListDiv.appendChild(ul);
        } catch (error) {
            console.error('Error fetching adresses:', error);
            adresseListDiv.innerHTML = '<p>Error loading adresses.</p>';
        }
    };

    // Function to fetch and display agences
    const fetchAgences = async () => {
        try {
            const response = await fetch('/api/agences');
            const agences = await response.json();
            agenceListDiv.innerHTML = ''; // Clear previous list
            if (agences.length === 0) {
                agenceListDiv.innerHTML = '<p>No agences found. Add one!</p>';
                return;
            }
            const ul = document.createElement('ul');
            agences.forEach(agence => {
                const li = document.createElement('li');
                li.textContent = `${agence.titre} (${agence.designation || ''}) - ${agence.email}`; 
                ul.appendChild(li);
            });
            agenceListDiv.appendChild(ul);
        } catch (error) {
            console.error('Error fetching agences:', error);
            agenceListDiv.innerHTML = '<p>Error loading agences.</p>';
        }
    };

    // Event listener for fetching data (now fetches agences)
    if (fetchDataBtn) {
        fetchDataBtn.addEventListener('click', fetchAgences);
    }

    // Event listener for adding a new car
    if (addCarForm) {
        addCarForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const make = document.getElementById('make').value;
            const model = document.getElementById('model').value;
            const year = parseInt(document.getElementById('year').value);
            const color = document.getElementById('color').value;
            const price_per_day = parseFloat(document.getElementById('price_per_day').value);
            const available = document.getElementById('available').checked;

            try {
                const response = await fetch('/api/cars', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ make, model, year, color, price_per_day, available }),
                });
                const newCar = await response.json();
                console.log('Car added:', newCar);
                addCarForm.reset(); // Clear form
                fetchCars(); // Refresh list
            } catch (error) {
                console.error('Error adding car:', error);
                alert('Failed to add car.');
            }
        });
    }

    // Event listener for adding a new adresse
    if (addAdresseForm) {
        addAdresseForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const libelle = document.getElementById('libelle').value;
            const ligne1 = document.getElementById('ligne1').value;
            const ligne2 = document.getElementById('ligne2').value;
            const code_postal = document.getElementById('code_postal').value;
            const ville = document.getElementById('ville').value;
            const region = document.getElementById('region').value;
            const pays = document.getElementById('pays').value;

            try {
                const response = await fetch('/api/adresses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ libelle, ligne1, ligne2, code_postal, ville, region, pays }),
                });
                const newAdresse = await response.json();
                console.log('Adresse added:', newAdresse);
                addAdresseForm.reset(); // Clear form
                fetchAdresses(); // Refresh list
            } catch (error) {
                console.error('Error adding adresse:', error);
                alert('Failed to add adresse.');
            }
        });
    }

    // Event listener for adding a new agence
    if (addAgenceForm) {
        addAgenceForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const titre = document.getElementById('titre').value;
            const designation = document.getElementById('designation').value;
            const adresse_id = parseInt(document.getElementById('adresse_id').value);
            const telephone = document.getElementById('telephone').value;
            const email = document.getElementById('email').value;

            try {
                const response = await fetch('/api/agences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ titre, designation, adresse_id, telephone, email }),
                });
                const newAgence = await response.json();
                console.log('Agence added:', newAgence);
                addAgenceForm.reset(); // Clear form
                fetchAgences(); // Refresh list
            } catch (error) {
                console.error('Error adding agence:', error);
                alert('Failed to add agence.');
            }
        });
    }

    // Initial load of agences
    fetchAgences();
});
