//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////
Enum sujet_type {
  maintenance
  intervention
}

Enum statut_rdv {
  Planifie
  Confirme
  Termine
  Annule
}

Enum etat_rapport {
  Pas_commence
  En_cours
  Termine
}

Enum doc_cible_type {
  Affaire
  Agent
  Agence
  Adresse
  Client
  Site
  RendezVous
  DOE
  Maintenance
  Intervention
  RapportMaintenance
  Achat
  Facture
  Reglement
  Formation
  Fonction
}

Enum doc_nature {
  Document
  Video
  Audio
  Autre
}

Enum statut_achat {
  Brouillon
  Valide
  Commande
  Recu_partiel
  Recu
  Annule
}

Enum statut_facture {
  Brouillon
  Emise
  Envoyee
  Payee_partielle
  Payee
  Annulee
}

Enum mode_reglement {
  Virement
  Cheque
  Carte
  Especes
  Traite
  Autre
}

Enum role_agence {
  Admin
  Manager
  Membre
}

Enum type_formation {
  Habilitation
  Certification
  Permis
}

//////////////////////////////////////////////////////
// RÉFÉRENTIELS
//////////////////////////////////////////////////////
Table adresse {
  id               bigint       [pk, increment]
  libelle          varchar(255)
  ligne1           varchar(255)
  ligne2           varchar(255)
  code_postal      varchar(40)
  ville            varchar(120)
  region           varchar(120)
  pays             varchar(120)
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
}

Table agence {
  id               bigint       [pk, increment]
  titre            varchar(255) [not null, note: 'Nom court ex: Agence Paris']
  designation      varchar(255)
  adresse_id       bigint       [ref: > adresse.id]
  telephone        varchar(50)
  email            varchar(255)
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
}

Table agent {
  matricule        varchar(20)  [pk, note: 'Matricule unique de l\'agent']
  nom              varchar(255) [not null]
  admin            bool         [not null, default: false]
  email            varchar(255)
  tel              varchar(50)
  actif            bool         [not null, default: true]
  date_entree      date
  commentaire      text
  agence_id        bigint       [not null, ref: > agence.id, note: 'Agence principale']
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
}

Table passeport {
  id                 bigint       [pk, increment]
  agent_matricule    varchar(20)  [not null, ref: > agent.matricule, note: '1:1 avec agent']
  permis             text         [note: 'Permis (B, C, nacelle...)']
  habilitations      text         [note: 'H0B0, BR, B2V...']
  certifications     text         [note: 'CACES, SST...']
  commentaire        text
  date_debut         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin           timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes { agent_matricule [unique, name: 'uq_passeport_agent'] }
}

Table equipe {
  id               bigint       [pk, increment]
  agence_id        bigint       [not null, ref: > agence.id]
  nom              varchar(255) [not null]
  description      text
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
}

Table agence_membre {
  id               bigint       [pk, increment]
  agence_id        bigint       [not null, ref: > agence.id]
  agent_matricule  varchar(20)  [not null, ref: > agent.matricule]
  role             role_agence  [not null, default: 'Membre']
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes { (agence_id, agent_matricule) [unique, name: 'uq_agence_membre'] }
}

Table agent_equipe {
  id               bigint       [pk, increment]
  equipe_id        bigint       [not null, ref: > equipe.id]
  agent_matricule  varchar(20)  [not null, ref: > agent.matricule]
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes { (equipe_id, agent_matricule) [unique, name: 'uq_agent_equipe'] }
}

Table fonction {
  id               bigint       [pk, increment]
  code             varchar(50)  [not null, note: 'Ex: TECH, CHEF_EQ, QSE']
  libelle          varchar(255) [not null]
  description      text
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes { code [unique, name: 'uq_fonction_code'] }
}

Table agent_fonction {
  id               bigint       [pk, increment]
  agent_matricule  varchar(20)  [not null, ref: > agent.matricule]
  fonction_id      bigint       [not null, ref: > fonction.id]
  principal        bool         [not null, default: false]
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes { (agent_matricule, fonction_id) [unique, name: 'uq_agent_fonction'] }
}

Table client {
  id               bigint       [pk, increment]
  nom_client       varchar(255) [not null]
  representant_nom varchar(255)
  representant_email varchar(255)
  representant_tel varchar(50)
  adresse_id       bigint       [ref: > adresse.id]
  commentaire      text
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
}

Table affaire {
  id               bigint       [pk, increment]
  nom_affaire      varchar(255) [not null]
  client_id        bigint       [ref: > client.id]
  description      text
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes { (client_id, nom_affaire) [name: 'idx_affaire_client_nom'] }
}

//////////////////////////////////////////////////////
// SITES, N:N AVEC AFFAIRES, DOE
//////////////////////////////////////////////////////
Table site {
  id               bigint       [pk, increment]
  nom_site         varchar(255) [not null]
  adresse_id       bigint       [ref: > adresse.id]
  commentaire      text
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
}

Table site_affaire {
  id               bigint       [pk, increment]
  site_id          bigint       [not null, ref: > site.id]
  affaire_id       bigint       [not null, ref: > affaire.id]
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    (site_id, affaire_id) [unique, name: 'uq_site_affaire']
    site_id               [name: 'idx_site_affaire_site']
    affaire_id            [name: 'idx_site_affaire_affaire']
  }
}

Table doe {
  id               bigint       [pk, increment]
  site_id          bigint       [not null, ref: > site.id]
  affaire_id       bigint       [not null, ref: > affaire.id]
  titre            varchar(255) [not null]
  description      text
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    (site_id, affaire_id, titre) [unique, name: 'uq_doe_site_affaire_titre']
    site_id                      [name: 'idx_doe_site']
    affaire_id                   [name: 'idx_doe_affaire']
  }
}

//////////////////////////////////////////////////////
// RENDEZ-VOUS (peuvent être rattachés à une intervention)
//////////////////////////////////////////////////////
Table rendez_vous {
  id               bigint       [pk, increment]
  site_id          bigint       [not null, ref: > site.id]
  intervention_id  bigint       [ref: > intervention.id, note: 'Plusieurs RDV pour une intervention']
  sujet            sujet_type   [not null]
  date_rdv         date         [not null]
  heure_rdv        time
  description      text
  statut           statut_rdv   [not null, default: 'Planifie']
  date_debut       timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp    [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    site_id         [name: 'idx_rdv_site']
    intervention_id [name: 'idx_rdv_intervention']
    date_rdv        [name: 'idx_rdv_date']
    sujet           [name: 'idx_rdv_sujet']
  }
}

//////////////////////////////////////////////////////
// MAINTENANCE, INTERVENTIONS CHAÎNABLES, RAPPORT
//////////////////////////////////////////////////////
Table maintenance {
  id               bigint        [pk, increment]
  doe_id           bigint        [not null, ref: > doe.id, note: 'Maintenance rattachée à un DOE']
  affaire_id       bigint        [not null, ref: > affaire.id, note: 'Lien explicite à l\'affaire']
  titre            varchar(255)
  description      text          [not null]
  etat             etat_rapport  [not null, default: 'Pas_commence']
  responsable      varchar(20)   [ref: > agent.matricule]
  date_debut       timestamp     [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp     [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    doe_id     [name: 'idx_maintenance_doe']
    affaire_id [name: 'idx_maintenance_affaire']
    etat       [name: 'idx_maintenance_etat']
  }
}

Table intervention {
  id                         bigint     [pk, increment]
  maintenance_id             bigint     [not null, ref: > maintenance.id]
  description                text       [not null]
  date_debut                 date       [not null]
  date_fin                   date
  intervention_precedente_id bigint     [ref: > intervention.id, note: 'Chaînage intervention → intervention suivante']
  date_debut_ts              timestamp  [not null, default: 'CURRENT_TIMESTAMP']
  date_fin_ts                timestamp  [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    maintenance_id             [name: 'idx_intervention_maintenance']
    intervention_precedente_id [name: 'idx_intervention_prec']
  }
}

Table rapport_maintenance {
  id                  bigint        [pk, increment]
  maintenance_id      bigint        [not null, ref: > maintenance.id]
  date_rapport        timestamp     [not null, default: 'CURRENT_TIMESTAMP']
  matricule           varchar(20)   [not null, ref: > agent.matricule]
  nom_client          varchar(255)
  adresse_client_id   bigint        [ref: > adresse.id]
  commentaire_interne text
  materiel_commander  text
  etat                etat_rapport  [not null, default: 'Pas_commence']
  date_debut          timestamp     [not null, default: 'CURRENT_TIMESTAMP']
  date_fin            timestamp     [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    maintenance_id [name: 'idx_rapport_maintenance']
    date_rapport   [name: 'idx_rapport_maintenance_date']
    etat           [name: 'idx_rapport_maintenance_etat']
  }
}

//////////////////////////////////////////////////////
// FORMATIONS (validité habilitations/certifications/permis)
//////////////////////////////////////////////////////
Table formation {
  id                 bigint          [pk, increment]
  agent_matricule    varchar(20)     [not null, ref: > agent.matricule]
  type               type_formation  [not null]
  libelle            varchar(255)    [not null]
  date_obtention     date
  date_expiration    date            [note: 'Timer de validité']
  organisme          varchar(255)
  commentaire        text
  cree_par           varchar(20)     [ref: > agent.matricule, note: 'Admin ayant créé']
  modifie_par        varchar(20)     [ref: > agent.matricule, note: 'Admin dernière modif']
  date_debut         timestamp       [not null, default: 'CURRENT_TIMESTAMP']
  date_fin           timestamp       [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    agent_matricule [name: 'idx_formation_agent']
    (agent_matricule, type, libelle) [name: 'idx_formation_unique_logique']
    date_expiration [name: 'idx_formation_expiration']
  }
}

//////////////////////////////////////////////////////
// IMAGES + ASSOCIATIONS
//////////////////////////////////////////////////////
Table images {
  id                 bigint       [pk, increment]
  nom_fichier        varchar(255) [not null]
  type_mime          varchar(100) [not null, default: 'image/jpeg']
  taille_octets      bigint       [not null]
  image_blob         bytea        [not null]
  commentaire_image  text
  auteur_matricule   varchar(20)  [ref: > agent.matricule]
  date_debut         timestamp    [not null, default: 'CURRENT_TIMESTAMP']
  date_fin           timestamp    [not null, default: 'CURRENT_TIMESTAMP']
}

Table rendez_vous_image {
  id               bigint   [pk, increment]
  rendez_vous_id   bigint   [not null, ref: > rendez_vous.id]
  image_id         bigint   [not null, ref: > images.id]

  indexes { (rendez_vous_id, image_id) [unique, name: 'uq_rdv_image'] }
}

Table rendu_intervention {
  id                bigint     [pk, increment]
  intervention_id   bigint     [not null, ref: > intervention.id]
  resume            text
  valeur            text
  date_debut        timestamp  [not null, default: 'CURRENT_TIMESTAMP']
  date_fin          timestamp  [not null, default: 'CURRENT_TIMESTAMP']
}

Table rendu_intervention_image {
  id                      bigint   [pk, increment]
  rendu_intervention_id   bigint   [not null, ref: > rendu_intervention.id]
  image_id                bigint   [not null, ref: > images.id]

  indexes { (rendu_intervention_id, image_id) [unique, name: 'uq_rendu_intervention_image'] }
}

//////////////////////////////////////////////////////
// ACHATS (PO) + lignes
//////////////////////////////////////////////////////
Table achat {
  id                      bigint        [pk, increment]
  reference_commande      varchar(100)
  affaire_id              bigint        [ref: > affaire.id]
  site_id                 bigint        [ref: > site.id]
  rapport_maintenance_id  bigint        [ref: > rapport_maintenance.id, note: 'Si achat lié à une maintenance']
  fournisseur_nom         varchar(255)  [not null]
  fournisseur_email       varchar(255)
  fournisseur_tel         varchar(50)
  devise                  varchar(3)    [not null, default: 'EUR']
  statut                  statut_achat  [not null, default: 'Brouillon']
  date_commande           date          [not null]
  montant_ht              numeric(14,2)
  montant_tva             numeric(14,2)
  montant_ttc             numeric(14,2)
  date_debut              timestamp     [not null, default: 'CURRENT_TIMESTAMP']
  date_fin                timestamp     [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    affaire_id   [name: 'idx_achat_affaire']
    site_id      [name: 'idx_achat_site']
    statut       [name: 'idx_achat_statut']
    date_commande [name: 'idx_achat_date']
  }
}

Table achat_ligne {
  id                bigint        [pk, increment]
  achat_id          bigint        [not null, ref: > achat.id]
  libelle           varchar(255)  [not null]
  description       text
  quantite          numeric(14,3) [not null, default: 1]
  unite             varchar(20)
  prix_unitaire_ht  numeric(14,4) [not null, default: 0]
  tva_taux          numeric(5,2)  [not null, default: 20.00]
  total_ligne_ht    numeric(14,2)

  indexes { achat_id [name: 'idx_achat_ligne_achat'] }
}

//////////////////////////////////////////////////////
// FACTURATION (AR) + lignes + règlements
//////////////////////////////////////////////////////
Table facture {
  id                bigint         [pk, increment]
  reference_facture varchar(100)   [not null]
  affaire_id        bigint         [ref: > affaire.id]
  site_id           bigint         [ref: > site.id]
  client_id         bigint         [ref: > client.id]
  maintenance_id    bigint         [ref: > maintenance.id]
  intervention_id   bigint         [ref: > intervention.id]
  devise            varchar(3)     [not null, default: 'EUR']
  statut            statut_facture [not null, default: 'Brouillon']
  date_facture      date           [not null]
  date_echeance     date
  montant_ht        numeric(14,2)
  montant_tva       numeric(14,2)
  montant_ttc       numeric(14,2)
  date_debut        timestamp      [not null, default: 'CURRENT_TIMESTAMP']
  date_fin          timestamp      [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    client_id   [name: 'idx_facture_client']
    affaire_id  [name: 'idx_facture_affaire']
    site_id     [name: 'idx_facture_site']
    statut      [name: 'idx_facture_statut']
    date_facture [name: 'idx_facture_date']
  }
}

Table facture_ligne {
  id               bigint        [pk, increment]
  facture_id       bigint        [not null, ref: > facture.id]
  libelle          varchar(255)  [not null]
  description      text
  quantite         numeric(14,3) [not null, default: 1]
  unite            varchar(20)
  prix_unitaire_ht numeric(14,4) [not null, default: 0]
  tva_taux         numeric(5,2)  [not null, default: 20.00]
  total_ligne_ht   numeric(14,2)

  indexes { facture_id [name: 'idx_facture_ligne_facture'] }
}

Table reglement {
  id                 bigint         [pk, increment]
  facture_id         bigint         [not null, ref: > facture.id]
  date_reglement     date           [not null]
  montant            numeric(14,2)  [not null]
  mode               mode_reglement [not null, default: 'Virement']
  reference_paiement varchar(100)
  note               text
  date_debut         timestamp      [not null, default: 'CURRENT_TIMESTAMP']
  date_fin           timestamp      [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    facture_id     [name: 'idx_reglement_facture']
    date_reglement [name: 'idx_reglement_date']
  }
}

//////////////////////////////////////////////////////
// DOCUMENTS (non-images) — traçabilité multi-cibles
//////////////////////////////////////////////////////
Table documents_repertoire {
  id               bigint          [pk, increment]
  cible_type       doc_cible_type  [not null]
  cible_id         bigint          [not null]
  nature           doc_nature      [not null, default: 'Document']
  nom_fichier      varchar(255)    [not null]
  type_mime        varchar(100)    [not null, default: 'application/octet-stream']
  taille_octets    bigint
  chemin_fichier   varchar(1024)
  checksum_sha256  varchar(64)
  auteur_matricule varchar(20)     [ref: > agent.matricule]
  date_debut       timestamp       [not null, default: 'CURRENT_TIMESTAMP']
  date_fin         timestamp       [not null, default: 'CURRENT_TIMESTAMP']

  indexes {
    (cible_type, cible_id)         [name: 'idx_docs_cible']
    (cible_type, cible_id, nature) [name: 'idx_docs_cible_nature']
    nom_fichier                    [name: 'idx_docs_nom_fichier']
    checksum_sha256                [name: 'idx_docs_checksum']
    date_debut                     [name: 'idx_docs_date']
  }
}
